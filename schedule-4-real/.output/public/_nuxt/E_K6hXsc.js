import{d as L,c as W,u as T,b as D,a as U}from"./BJAY-TfA.js";import{u as w}from"./BXTDGlMj.js";import{u as F}from"./DkzolNJN.js";import{l as N}from"./D-lbK2oh.js";let M=!1,y=null,i=null,l=null,h=null,S=0;const $=3e4;let O=null,I=!1,p=!1,b=!1;const m=N(!1);let v=!1;function Z(){return M||(M=!0,setTimeout(()=>{v||R()},0)),{connected:m,pause:()=>{v=!0,i&&(i.onclose=null,i.onerror=null,i.onmessage=null,i.close(),i=null),l&&(l.close(),l=null),h&&(clearTimeout(h),h=null),m.value=!1},resume:()=>{v=!1,!i&&!l&&(S=0,R())}}}function R(){const e=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_ws`,s=setTimeout(()=>{m.value||(i?.close(),k())},4e3);i=new WebSocket(e),i.onopen=()=>{clearTimeout(s),y="ws",m.value=!0,S=0,E()},i.onmessage=o=>{try{const n=JSON.parse(o.data);H(n)}catch{}},i.onclose=()=>{if(m.value=!1,p){const o=w();o.updateProgress={phase:"restarting",component:"web",current:0,total:0,error:null,timestamp:Date.now()}}y==="ws"&&P("ws")},i.onerror=()=>{clearTimeout(s),i?.close(),y!=="ws"&&k()}}function k(){const t=`${window.location.origin}/_sse`;l=new EventSource(t),l.onopen=()=>{y="sse",m.value=!0,S=0,E()},l.onmessage=e=>{try{const s=JSON.parse(e.data);H(s)}catch{}},l.onerror=()=>{if(m.value=!1,p){const e=w();e.updateProgress={phase:"restarting",component:"web",current:0,total:0,error:null,timestamp:Date.now()}}l?.close(),l=null,P("sse")}}function P(t){if(h)return;const e=Math.min(3e3*Math.pow(2,S),$);S++,h=setTimeout(()=>{h=null,t==="ws"?R():k()},e)}async function E(){if(!b){if(!I){I=!0;try{O=(await $fetch("/api/system/updates",{timeout:5e3}))?.installed?.web?.version||null}catch{}return}try{const t=await $fetch("/api/system/updates",{timeout:5e3}),e=t?.installed?.web?.version||null;if(O&&e&&e!==O){if(b)return;b=!0;try{localStorage.setItem("sf_update_just_applied","true")}catch{}const o=new URL(window.location.href);o.searchParams.set("_v",Date.now().toString()),window.location.replace(o.toString());return}if(p){p=!1;const o=w();o.updateProgress=null}const s=w();s.updateStatus=t}catch{}}}function H(t){if(!(v&&t.type!=="update-progress"&&t.type!=="device"))switch(t.type){case"sensor":A(t.data);break;case"outlet":B(t.data);break;case"light":j(t.data);break;case"soil":X(t.data);break;case"mqtt-raw":V(t.data);break;case"device":J(t.data);break;case"blower":x(t.data);break;case"fan":G(t.data);break;case"update-progress":q(t.data);break}}function q(t){const e=w(),s=t?.phase;p=["downloading","installing","restarting"].includes(s),e.updateProgress=t,s==="done"&&(p=!1,setTimeout(()=>{e.updateProgress?.phase==="done"&&(e.updateProgress=null,e.fetchUpdateStatus())},3e3)),s==="error"&&(p=!1)}const f={"1h":36e5,"4h":4*36e5,"6h":6*36e5,"12h":12*36e5,"24h":24*36e5,"48h":48*36e5,"7d":7*864e5,"30d":30*864e5,"60d":60*864e5,"90d":90*864e5};function A(t){const e=T();if(t.temp!==void 0||t.humi!==void 0){const s=new Date().toISOString(),o={temp:t.temp??e.current?.temp??0,humi:t.humi??e.current?.humi??0,co2:t.co2??e.current?.co2??0,vpd:t.vpd??e.current?.vpd??0,timestamp:s};if(e.current=o,e.history.length>0){const n=f[e.selectedRange]||f["4h"],r=Date.now()-n,a=e.history.filter(c=>new Date(c.timestamp).getTime()>r);a.push(o),e.history=a}}}let _=null;function B(t){const e=U();let s=!1;for(const[o,n]of Object.entries(t))if(o.startsWith("O")&&typeof n=="object"){const r=n,a=r.on??r.mOnOff??0,c=r.modeType??e.states[o]?.modeType??0,d=e.states[o]?.isOn??!1,u=a===1;d!==u&&(s=!0),e.states[o]?(e.states[o].mOnOff=a,e.states[o].isOn=u,e.states[o].modeType=c):(e.states[o]={mOnOff:a,isOn:u,modeType:c},s=!0)}s&&!_&&(_=setTimeout(()=>{_=null;const n=T().selectedRange||"4h";n!=="custom"&&e.fetchEvents(n),e.fetchLog()},2e3))}function j(t){const e=D();typeof e.updateFromWs=="function"&&e.updateFromWs(t)}function V(t){const e=w(),s=t?.payload?.msgId;if(s&&e.pendingRequestIds.has(s)){if(e.pendingRequestIds.delete(s),t.payload?.code===200&&!t.payload?.data)return;e.addRawMessage(t);return}e.rawLive&&e.addRawMessage(t)}function J(t){if(!t?.mac)return;F().updateDevice(t.mac,t)}function x(t){if(!t)return;W().updateBlower(t);const s=T();if(s.blowerHistory.length>0){const o=new Date().toISOString(),n=t.on??t.mOnOff??0,r=t.level??t.mLevel??0,a=n===1?r:0,c=f[s.selectedRange]||f["4h"],d=Date.now()-c,u=s.blowerHistory.filter(g=>new Date(g.timestamp).getTime()>d);u.push({timestamp:o,value:a}),s.blowerHistory=u}}function G(t){if(!t)return;L().updateFan(t)}function X(t){if(!Array.isArray(t)||t.length===0)return;const e=T(),s=new Date().toISOString();for(const n of t){if(n.id==="avg"||n.tempSoil===void 0&&n.humiSoil===void 0&&n.ECSoil===void 0)continue;const r=n.id,a={temp_soil:n.tempSoil??0,humi_soil:n.humiSoil??0,ec_soil:n.ECSoil??0,timestamp:s};e.updateSoilSensorCurrent(r,a);const c=e.soilSensorsHistory[r];if(c&&c.length>0){const d=f[e.selectedRange]||f["4h"],u=Date.now()-d,g=c.filter(C=>new Date(C.timestamp).getTime()>u);g.push(a),e.soilSensorsHistory={...e.soilSensorsHistory,[r]:g}}}const o=t.find(n=>n.id!=="avg");if(o){const n={temp_soil:o.tempSoil??e.soil?.temp_soil??0,humi_soil:o.humiSoil??e.soil?.humi_soil??0,ec_soil:o.ECSoil??e.soil?.ec_soil??0,timestamp:s};if(e.soil=n,e.soilHistory.length>0){const r=f[e.selectedRange]||f["4h"],a=Date.now()-r,c=e.soilHistory.filter(d=>new Date(d.timestamp).getTime()>a);c.push(n),e.soilHistory=c}}}export{Z as u};
