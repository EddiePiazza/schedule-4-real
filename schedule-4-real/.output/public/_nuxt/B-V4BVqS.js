import{_ as Oo}from"./NiRddhUQ.js";import{o as p,c as x,a as o,e as dn,x as be,b as A,w as Ce,h as c,d as q,I as xe,f as N,G as Oe,T as eo,$ as Fe,a0 as Uo,l as k,_ as $o,g as Tt,i as Qe,v as ht,k as He,n as ee,t as pe,F as et,r as tt,j as tn,m as Pe,K as Lo,y as Vo,L as Pn,A as In,E as Bo,q as zo,a1 as jo,H as Ko,B as Wo}from"./Cy0OlE_M.js";import{r as to}from"./BkBVC0nW.js";import{Y as Fo,f as Ho,u as Yo,d as Go,Z as Jo,_ as Zo,X as qo}from"./BMqIsnQ-.js";import{r as no}from"./DMpBdeQJ.js";import{a9 as rt,q as Xo,r as Qo,W as es,a5 as ts,p as ns,a6 as os,aa as ss,D as Jt,ab as as,A as rs,t as oo,o as is,k as ls,V as cs,ac as Mn}from"./C2DQffRO.js";import{r as ds}from"./C28eWdip.js";import{r as un}from"./D8W2gMXy.js";import{r as us}from"./Mom9Chyu.js";import{_ as fn}from"./DlAUqK2U.js";import{s as bt}from"./B8I8u6Mn.js";import{a as fs,b as ps,G as so,r as ms,c as Dn}from"./CM-eT7AK.js";import{r as Nn}from"./BFfgN0H-.js";import{r as hs,a as On}from"./BzrGATpS.js";function bs(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"})])}function Un(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{d:"M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 0 1 3.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0 1 21 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 0 1 7.5 16.125V3.375Z"}),o("path",{d:"M15 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 17.25 7.5h-1.875A.375.375 0 0 1 15 7.125V5.25ZM4.875 6H6v10.125A3.375 3.375 0 0 0 9.375 19.5H16.5v1.125c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V7.875C3 6.839 3.84 6 4.875 6Z"})])}function ys(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{d:"M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577a11.217 11.217 0 0 1 4.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z"}),o("path",{d:"M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z"}),o("path",{d:"M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z"})])}function ao(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"fill-rule":"evenodd",d:"M15.75 1.5a6.75 6.75 0 0 0-6.651 7.906c.067.39-.032.717-.221.906l-6.5 6.499a3 3 0 0 0-.878 2.121v2.818c0 .414.336.75.75.75H6a.75.75 0 0 0 .75-.75v-1.5h1.5A.75.75 0 0 0 9 19.5V18h1.5a.75.75 0 0 0 .53-.22l2.658-2.658c.19-.189.517-.288.906-.22A6.75 6.75 0 1 0 15.75 1.5Zm0 3a.75.75 0 0 0 0 1.5A2.25 2.25 0 0 1 18 8.25a.75.75 0 0 0 1.5 0 3.75 3.75 0 0 0-3.75-3.75Z","clip-rule":"evenodd"})])}function vs(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"fill-rule":"evenodd",d:"M19.902 4.098a3.75 3.75 0 0 0-5.304 0l-4.5 4.5a3.75 3.75 0 0 0 1.035 6.037.75.75 0 0 1-.646 1.353 5.25 5.25 0 0 1-1.449-8.45l4.5-4.5a5.25 5.25 0 1 1 7.424 7.424l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.757-1.757a3.75 3.75 0 0 0 0-5.304Zm-7.389 4.267a.75.75 0 0 1 1-.353 5.25 5.25 0 0 1 1.449 8.45l-4.5 4.5a5.25 5.25 0 1 1-7.424-7.424l1.757-1.757a.75.75 0 1 1 1.06 1.06l-1.757 1.757a3.75 3.75 0 1 0 5.304 5.304l4.5-4.5a3.75 3.75 0 0 0-1.035-6.037.75.75 0 0 1-.354-1Z","clip-rule":"evenodd"})])}function $n(e,t){return p(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{d:"M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z"}),o("path",{d:"M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.751 6.751 0 0 1-6 6.709v2.291h3a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5h3v-2.291a6.751 6.751 0 0 1-6-6.709v-1.5A.75.75 0 0 1 6 10.5Z"})])}const gs={class:"relative w-full max-w-3xl max-h-[85vh] overflow-y-auto rounded-2xl border border-white/10 bg-gray-950/95 shadow-2xl custom-scrollbar"},ws={class:"p-6 pb-4 border-b border-white/[0.06]"},xs={class:"flex items-center gap-3"},ks={class:"w-10 h-10 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center"},Ss={class:"p-6 space-y-6"},Cs={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},_s={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},Es={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},As={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},Ts={class:"space-y-3"},Rs={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},Ps={class:"flex items-center gap-2 mb-2"},Is={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},Ms={class:"flex items-center gap-2 mb-2"},Ds={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},Ns={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},Os=dn({__name:"Room3dPrivacyInfo",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const n=t;function s(){n("update:modelValue",!1)}return(r,a)=>(p(),be(eo,{to:"body"},[A(Oe,{"enter-active-class":"transition-all duration-300","leave-active-class":"transition-all duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[e.modelValue?(p(),x("div",{key:0,class:"fixed inset-0 z-[200] flex items-center justify-center p-4",onClick:xe(s,["self"])},[a[18]||(a[18]=o("div",{class:"absolute inset-0 bg-black/80 backdrop-blur-sm"},null,-1)),o("div",gs,[o("button",{onClick:s,class:"absolute top-4 right-4 z-10 p-1.5 rounded-lg text-white/40 hover:text-white/80 hover:bg-white/10 transition-all"},[A(c(to),{class:"w-5 h-5"})]),o("div",ws,[o("div",xs,[o("div",ks,[A(c(Fo),{class:"w-5 h-5 text-emerald-400"})]),a[0]||(a[0]=o("div",null,[o("h2",{class:"text-xl font-bold text-white"},"Anonymous & Private Rooms"),o("p",{class:"text-base text-white/40"},"How your privacy is protected")],-1))])]),o("div",Ss,[o("section",null,[o("h3",Cs,[A(c(ys),{class:"w-5 h-5 text-emerald-400"}),a[1]||(a[1]=q(" Zero Knowledge Architecture ",-1))]),a[2]||(a[2]=o("p",{class:"text-base text-white/60 leading-relaxed"},[q(" Your rooms use "),o("strong",{class:"text-white/80"},"onion-routed encryption"),q(" — the same principle behind Tor. When you share a room, neither the relay servers nor anyone monitoring the network can see who is connecting to whom, or what data is being exchanged. ")],-1))]),o("section",null,[o("h3",_s,[A(c(no),{class:"w-5 h-5 text-sky-400"}),a[3]||(a[3]=q(" How It Works ",-1))]),a[4]||(a[4]=o("div",{class:"bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base"},[o("div",{class:"space-y-2 text-white/50"},[o("div",{class:"flex items-center gap-2"},[o("span",{class:"text-emerald-400 font-bold w-16 shrink-0 text-right"},"You"),o("span",{class:"text-white/20"},"──"),o("span",{class:"bg-emerald-500/15 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20"},"encrypt"),o("span",{class:"text-white/20"},"──▶"),o("span",{class:"text-sky-400"},"Relay A")]),o("div",{class:"flex items-center gap-2 pl-20"},[o("span",{class:"text-white/20"},"──"),o("span",{class:"bg-sky-500/15 text-sky-400 px-2 py-0.5 rounded border border-sky-500/20"},"re-encrypt"),o("span",{class:"text-white/20"},"──▶"),o("span",{class:"text-purple-400"},"Relay B")]),o("div",{class:"flex items-center gap-2 pl-40"},[o("span",{class:"text-white/20"},"──"),o("span",{class:"bg-purple-500/15 text-purple-400 px-2 py-0.5 rounded border border-purple-500/20"},"decrypt"),o("span",{class:"text-white/20"},"──▶"),o("span",{class:"text-amber-400 font-bold"},"Guest")]),o("div",{class:"pt-2 border-t border-white/[0.06] text-white/30 text-base"}," Each relay only sees the previous and next hop — never both endpoints. ")])],-1))]),o("section",null,[o("h3",Es,[A(c(rt),{class:"w-5 h-5 text-amber-400"}),a[5]||(a[5]=q(" Encryption ",-1))]),a[6]||(a[6]=o("div",{class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},[o("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[o("div",{class:"text-base font-bold text-amber-400 mb-1"},"Key Exchange"),o("div",{class:"text-base text-white/50"},"X25519 (Curve25519) — unique session keys per connection, forward secrecy")]),o("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[o("div",{class:"text-base font-bold text-amber-400 mb-1"},"Data Encryption"),o("div",{class:"text-base text-white/50"},"XChaCha20-Poly1305 AEAD — 256-bit authenticated encryption")]),o("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[o("div",{class:"text-base font-bold text-amber-400 mb-1"},"Packet Padding"),o("div",{class:"text-base text-white/50"},"All packets are fixed 512 bytes — traffic analysis impossible")]),o("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[o("div",{class:"text-base font-bold text-amber-400 mb-1"},"Chaff Traffic"),o("div",{class:"text-base text-white/50"},"Constant noise between relays — hides when real data flows")])],-1))]),o("section",null,[o("h3",As,[A(c(ds),{class:"w-5 h-5 text-purple-400"}),a[7]||(a[7]=q(" Room Modes ",-1))]),o("div",Ts,[o("div",Rs,[o("div",Ps,[A(c(ao),{class:"w-4 h-4 text-emerald-400"}),a[8]||(a[8]=o("span",{class:"text-base font-bold text-emerald-400"},"Invite Only",-1))]),a[9]||(a[9]=o("p",{class:"text-base text-white/50 leading-relaxed"}," Your room is invisible to everyone. Only people with your encrypted invite link can join. The link contains an encrypted token that reveals nothing about your server or IP address. Share it via any messaging app — even if intercepted, it cannot be used to locate your server. ",-1))]),o("div",Is,[o("div",Ms,[A(c(un),{class:"w-4 h-4 text-sky-400"}),a[10]||(a[10]=o("span",{class:"text-base font-bold text-sky-400"},"Public",-1))]),a[11]||(a[11]=o("p",{class:"text-base text-white/50 leading-relaxed"},[q(" Your room appears in the Public Rooms browser so others can discover it. The listing is published through the onion network — the tracker that stores room listings is "),o("strong",{class:"text-white/70"},"blind"),q(": it only sees encrypted blobs and relay entry points, never your IP or room contents. Visitors connect through the same onion circuit, preserving both your anonymity and theirs. ")],-1))])])]),o("section",null,[o("h3",Ds,[A(c(us),{class:"w-5 h-5 text-rose-400"}),a[12]||(a[12]=q(" The Blind Tracker ",-1))]),a[13]||(a[13]=o("p",{class:"text-base text-white/60 leading-relaxed mb-3"}," The room directory (tracker) is designed to be completely blind: ",-1)),a[14]||(a[14]=o("ul",{class:"space-y-2 text-base text-white/50"},[o("li",{class:"flex items-start gap-2"},[o("span",{class:"text-emerald-400 mt-0.5 shrink-0"},"✓"),o("span",null,[q("Stores only "),o("strong",{class:"text-white/70"},"encrypted blobs"),q(" — cannot read room names, descriptions, or any metadata")])]),o("li",{class:"flex items-start gap-2"},[o("span",{class:"text-emerald-400 mt-0.5 shrink-0"},"✓"),o("span",null,[o("strong",{class:"text-white/70"},"No IP addresses"),q(" are stored — rooms are identified by relay entry points only")])]),o("li",{class:"flex items-start gap-2"},[o("span",{class:"text-emerald-400 mt-0.5 shrink-0"},"✓"),o("span",null,[o("strong",{class:"text-white/70"},"Ephemeral storage"),q(" — room listings expire automatically (TTL) and are never persisted to disk")])]),o("li",{class:"flex items-start gap-2"},[o("span",{class:"text-emerald-400 mt-0.5 shrink-0"},"✓"),o("span",null,[o("strong",{class:"text-white/70"},"No logs"),q(" — relay servers keep zero logs of connections, traffic, or metadata")])]),o("li",{class:"flex items-start gap-2"},[o("span",{class:"text-emerald-400 mt-0.5 shrink-0"},"✓"),o("span",null,[q("Even if a relay is compromised, it only sees encrypted traffic — "),o("strong",{class:"text-white/70"},"no readable content")])])],-1))]),o("section",null,[o("h3",Ns,[A(c(vs),{class:"w-5 h-5 text-teal-400"}),a[15]||(a[15]=q(" Invite Links ",-1))]),a[16]||(a[16]=o("p",{class:"text-base text-white/60 leading-relaxed"},[q(" Invite links contain an encrypted token that can only be decrypted by the app itself. The link URL points to a relay domain — "),o("strong",{class:"text-white/70"},"not your server"),q(". If someone inspects the link, they see only the relay's address and an opaque encrypted string. No IP addresses, room names, or identifying information is embedded in the link. ")],-1))]),a[17]||(a[17]=o("section",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},[o("h3",{class:"text-base font-bold text-white/60 uppercase tracking-wider mb-3"},"Technical Summary"),o("div",{class:"grid grid-cols-2 gap-x-6 gap-y-2 text-base"},[o("div",{class:"text-white/40"},"Protocol"),o("div",{class:"text-white/70"},"Onion routing (multi-hop)"),o("div",{class:"text-white/40"},"Key Exchange"),o("div",{class:"text-white/70"},"X25519 (Curve25519)"),o("div",{class:"text-white/40"},"Symmetric Cipher"),o("div",{class:"text-white/70"},"XChaCha20-Poly1305"),o("div",{class:"text-white/40"},"Hash Function"),o("div",{class:"text-white/70"},"BLAKE2b"),o("div",{class:"text-white/40"},"Packet Size"),o("div",{class:"text-white/70"},"Fixed 512 bytes"),o("div",{class:"text-white/40"},"Key Rotation"),o("div",{class:"text-white/70"},"Every 60 minutes"),o("div",{class:"text-white/40"},"Logging"),o("div",{class:"text-white/70"},"Zero — no logs anywhere"),o("div",{class:"text-white/40"},"Tracker Storage"),o("div",{class:"text-white/70"},"In-memory only (Redis ephemeral)"),o("div",{class:"text-white/40"},"Library"),o("div",{class:"text-white/70"},"libsodium (NaCl/TweetNaCl)")])],-1))])])])):N("",!0)]),_:1})]))}}),Us=Object.assign(fn(Os,[["__scopeId","data-v-2c69e695"]]),{__name:"Room3dPrivacyInfo"}),D=24,ct=16,fe=32,$s=512,W={HANDSHAKE_INIT:1,HANDSHAKE_REPLY:2,RELAY:16,DATA:32,ESTABLISH_RENDEZVOUS:48,RENDEZVOUS_ESTABLISHED:49,INTRODUCE:50,RENDEZVOUS_JOIN:51,TRACKER_REGISTER:64,TRACKER_QUERY:65,TRACKER_RESPONSE:66,TRACKER_HEARTBEAT:67,TRACKER_INTRODUCE:68,TRACKER_INTRODUCE_DATA:69,CIRCUIT_DESTROY:240};let j=null,Zt=null;async function Nt(){return j||(Zt||(Zt=$o(()=>import("./D93w9sP1.js"),[],import.meta.url).then(async e=>{const t=e.default||e;return await t.ready,j=t,t})),Zt)}function Ls(e,t,n){const s=j,r=s.randombytes_buf(D),a=new Uint8Array(4);new DataView(a.buffer).setUint32(0,n);const l=s.crypto_aead_xchacha20poly1305_ietf_encrypt(e,a,null,r,t),d=new Uint8Array(r.length+l.length);return d.set(r),d.set(l,r.length),d}function Vs(e,t,n){const s=j;if(e.length<D+ct)return null;const r=e.subarray(0,D),a=e.subarray(D),l=new Uint8Array(4);new DataView(l.buffer).setUint32(0,n);try{return s.crypto_aead_xchacha20poly1305_ietf_decrypt(null,a,l,r,t)}catch{return null}}function Ln(e,t,n){const s=t?new TextEncoder().encode(t):new Uint8Array(0),r=new Uint8Array(2+s.length+2+n.length);return r[0]=e,r[1]=s.length,r.set(s,2),new DataView(r.buffer).setUint16(2+s.length,n.length),r.set(n,4+s.length),r}function Bs(e){if(e.length<4)return null;const t=e[0],n=e[1],s=n>0?new TextDecoder().decode(e.subarray(2,2+n)):null,r=new DataView(e.buffer,e.byteOffset).getUint16(2+n),a=e.subarray(4+n,4+n+r);return{type:t,nextHop:s,payload:a}}function zs(e,t){if(e.length>=t)return e.subarray(0,t);const n=new Uint8Array(t);n.set(e);const s=j.randombytes_buf(t-e.length);return n.set(s,e.length),n}function Rt(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function ro(e){const t=new Uint8Array(e.length/2);for(let n=0;n<t.length;n++)t[n]=parseInt(e.slice(n*2,n*2+2),16);return t}const Vn="sf_room3d_room_secret";function js(){const e=j;if(typeof window>"u")return e.randombytes_buf(32);const t=localStorage.getItem(Vn);if(t&&t.length===64)return ro(t);const n=e.randombytes_buf(32);return localStorage.setItem(Vn,Rt(n)),n}function Bn(e){const t=j,n=js(),s=new TextEncoder().encode(e),r=new Uint8Array(s.length+n.length);return r.set(s),r.set(n,s.length),t.crypto_generichash(32,r)}class Ks{hops=[];ws=null;circuitId=0;messageQueue=[];dataCallback=null;_destroyed=!1;async build(t){const s=(await Nt()).randombytes_buf(4);this.circuitId=new DataView(s.buffer).getUint32(0);const r=t[0];this.ws=new WebSocket(r.url),this.ws.binaryType="arraybuffer",await new Promise((l,d)=>{this.ws.onopen=()=>l(),this.ws.onerror=()=>d(new Error(`Failed to connect to relay ${r.url}`))}),this.ws.onclose=()=>{this._destroyed};const a=await this._handshakeWithRelay();this.hops.push({url:r.url,sessionRx:a.rx,sessionTx:a.tx,publicKey:a.serverPk}),this.ws.onmessage=l=>{const d=new Uint8Array(l.data);this._handleIncoming(d)};for(let l=1;l<t.length;l++){const d=t[l],g=await this._extendCircuit(d);this.hops.push({url:d.url,sessionRx:g.rx,sessionTx:g.tx,publicKey:g.serverPk})}}send(t,n,s=null){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let r=Ln(n,s,t);for(let a=this.hops.length-1;a>=0;a--){const l=this.hops[a];a===this.hops.length-1||(r=Ln(W.RELAY,this.hops[a+1].url,r));const g=Ls(r,l.sessionTx,this.circuitId),T=g.subarray(0,D),S=g.subarray(D);r=new Uint8Array(D+4+S.length),r.set(T,0),new DataView(r.buffer).setUint32(D,this.circuitId),r.set(S,D+4)}this.ws.send(r)}onData(t){this.dataCallback=t}destroy(){this._destroyed=!0,this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null);for(const t of this.hops)t.sessionRx.fill(0),t.sessionTx.fill(0);this.hops=[],this.messageQueue=[]}_handleIncoming(t){let n=t;for(const r of this.hops){const a=Vs(n,r.sessionRx,this.circuitId);if(!a)return;n=a}const s=Bs(n);if(s){if(this.messageQueue.length>0){this.messageQueue.shift().resolve({type:s.type,payload:s.payload});return}this.dataCallback&&this.dataCallback(s.type,s.payload)}}_waitForMessage(t=1e4){return new Promise((n,s)=>{const r=setTimeout(()=>{const a=this.messageQueue.findIndex(l=>l.resolve===n);a>=0&&this.messageQueue.splice(a,1),s(new Error("Timeout waiting for relay response"))},t);this.messageQueue.push({resolve:a=>{clearTimeout(r),n(a)}})})}async _handshakeWithRelay(){const t=j,n=t.crypto_kx_keypair(),s=new Uint8Array(D+4+fe),r=t.randombytes_buf(D);s.set(r,0),new DataView(s.buffer).setUint32(D,this.circuitId),s.set(n.publicKey,D+4),this.ws.send(zs(s,$s));const a=await new Promise((X,I)=>{const ae=setTimeout(()=>{this.ws.onmessage=null,I(new Error("Handshake timeout"))},1e4);this.ws.onmessage=ce=>{clearTimeout(ae),X(new Uint8Array(ce.data))}}),l=new Uint8Array([83,70,80,75]),d=a.length>=4&&a[0]===l[0]&&a[1]===l[1]&&a[2]===l[2]&&a[3]===l[3];let g,T,S;if(d)g=a.subarray(4,4+fe),T=a.subarray(4+fe,4+fe+D),S=a.subarray(4+fe+D+4);else{const X=this.hops.length===0?this.ws?.url:"";if(!X)throw new Error("Cannot determine relay URL for PK fetch");const I=X.replace(/^wss:/,"https:").replace(/^ws:/,"http:")+"/pk",ae=await fetch(I);if(!ae.ok)throw new Error(`Failed to fetch relay PK from ${I}`);const ce=await ae.json();g=t.from_hex(ce.publicKey),T=a.subarray(0,D),S=a.subarray(D+4)}const _=t.crypto_kx_client_session_keys(n.publicKey,n.privateKey,g),U=1+fe+ct,H=S.subarray(0,U),oe=new Uint8Array(4);new DataView(oe.buffer).setUint32(0,this.circuitId);try{t.crypto_aead_xchacha20poly1305_ietf_decrypt(null,H,oe,T,_.sharedRx)}catch{throw new Error("Handshake verification failed — relay rejected or key mismatch")}return{rx:_.sharedRx,tx:_.sharedTx,serverPk:new Uint8Array(g)}}async _extendCircuit(t){const n=j,s=n.crypto_kx_keypair(),r=new Uint8Array(D+4+fe),a=n.randombytes_buf(D);r.set(a,0),new DataView(r.buffer).setUint32(D,this.circuitId),r.set(s.publicKey,D+4),this.send(r,W.RELAY,t.url);const d=(await this._waitForMessage()).payload,g=new Uint8Array([83,70,80,75]),S=d.length>=4&&d[0]===g[0]&&d[1]===g[1]&&d[2]===g[2]&&d[3]===g[3]?4:0;if(d.length<S+fe+D+4+ct+1)throw new Error("Extend handshake reply too short");const _=d.subarray(S,S+fe),U=n.crypto_kx_client_session_keys(s.publicKey,s.privateKey,_);return{rx:U.sharedRx,tx:U.sharedTx,serverPk:new Uint8Array(_)}}}class zn{rx=new Uint8Array(0);tx=new Uint8Array(0);nonceCounter=0;async initAsClient(t){const s=(await Nt()).crypto_kx_keypair();return this._keypair=s,s.publicKey}async completeAsClient(t){const n=j,s=this._keypair,r=n.crypto_kx_client_session_keys(s.publicKey,s.privateKey,t);this.rx=r.sharedRx,this.tx=r.sharedTx}async initAsServer(t){const n=await Nt(),s=n.crypto_kx_keypair(),r=n.crypto_kx_server_session_keys(s.publicKey,s.privateKey,t);return this.rx=r.sharedRx,this.tx=r.sharedTx,s.publicKey}encrypt(t){const n=j,s=n.randombytes_buf(D),r=n.crypto_aead_xchacha20poly1305_ietf_encrypt(t,null,null,s,this.tx),a=new Uint8Array(s.length+r.length);return a.set(s),a.set(r,s.length),a}decrypt(t){const n=j;if(t.length<D+ct)return null;const s=t.subarray(0,D),r=t.subarray(D);try{return n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,r,null,s,this.rx)}catch{return null}}destroy(){this.rx.fill(0),this.tx.fill(0)}}let mt=!1,ge=[],Ws="",Re=null;const we=[];let qt=null,Xt=null,We=null;function Fs(){const e=k(!1),t=k(!1),n=k([]),s=k(!1),r=k(null);async function a(){if(mt){e.value=!0;return}try{await Nt();const w=Uo(),m=w.public.onionRelayA||"wss://schedule4real.com/rooms",h=w.public.onionRelayB||"wss://r2.imaset.com";Ws=w.public.onionTracker||m,ge=[{url:m,publicKey:new Uint8Array(fe)},{url:h,publicKey:new Uint8Array(fe)}];const v=j,f=new TextEncoder().encode("spiderfarmer-room-metadata-v1");Re=v.crypto_generichash(32,f),mt=!0,e.value=!0}catch(w){r.value=w.message}}async function l(w){const m=new Ks,h=w||[...ge];return await m.build(h),we.push(m),m}function d(w){if(!Re)throw new Error("Not initialized");const m=j,h=JSON.stringify(w),v=new TextEncoder().encode(h),f=m.randombytes_buf(D),y=m.crypto_aead_xchacha20poly1305_ietf_encrypt(v,null,null,f,Re),M=new Uint8Array(f.length+y.length);return M.set(f),M.set(y,f.length),M}function g(w){if(!Re||w.length<D+ct)return null;const m=j,h=w.subarray(0,D),v=w.subarray(D);try{const f=m.crypto_aead_xchacha20poly1305_ietf_decrypt(null,v,null,h,Re),y=new TextDecoder().decode(f);return JSON.parse(y)}catch{return null}}async function T(w){mt||await a(),t.value=!0,r.value=null;try{const m=j,h=Bn(w.envId),v=d({envId:w.envId,name:w.name,description:w.description,capacity:w.capacity||8,tags:w.tags||[]}),f=await l([...ge].reverse()),y=ge[ge.length-1].url,M=new TextEncoder().encode(y),B=w.private?1:0,R=new Uint8Array(36+M.length+v.length);R[0]=W.TRACKER_REGISTER,R[1]=B,R.set(h,2),new DataView(R.buffer).setUint16(34,M.length),R.set(M,36),R.set(v,36+M.length),f.send(R,W.TRACKER_REGISTER);const ne=Rt(h);We=bt(()=>{if(f.ws?.readyState===WebSocket.OPEN){const $=new Uint8Array(33);$[0]=W.TRACKER_HEARTBEAT,$.set(h,1),f.send($,W.TRACKER_HEARTBEAT)}},6e4),qt=f,f.onData(($,Z)=>{$===W.TRACKER_INTRODUCE_DATA&&S(Z,w.envId).catch(de=>{})});const G={roomId:ne,keepAlive:()=>{if(f.ws?.readyState===WebSocket.OPEN){const $=new Uint8Array(33);$[0]=W.TRACKER_HEARTBEAT,$.set(h,1),f.send($,W.TRACKER_HEARTBEAT)}},unpublish:()=>{We&&clearInterval(We),We=null,f.destroy(),qt=null,Xt=null,t.value=!1}};return Xt=G,t.value=!1,G}catch(m){return r.value=m.message,t.value=!1,null}}async function S(w,m){const h=j;if(w.length<23)return;const v=w.subarray(0,20),f=new DataView(w.buffer,w.byteOffset+20).getUint16(0),y=new TextDecoder().decode(w.subarray(22,22+f)),M=ge.find(V=>V.url===y);if(!M)return;const R=[...ge.filter(V=>V.url!==y),M],ne=await l(R),G=h.crypto_kx_keypair(),$=new Uint8Array(20+fe);$.set(v),$.set(G.publicKey,20),ne.send($,W.RENDEZVOUS_JOIN);const Z=await Promise.race([new Promise(V=>{ne.onData((J,ie)=>{J===W.DATA&&ie.length>=fe&&V(ie.subarray(0,fe))})}),new Promise((V,J)=>setTimeout(()=>J(new Error("Visitor PK timeout")),15e3))]),de=h.crypto_kx_server_session_keys(G.publicKey,G.privateKey,Z),re=new zn;re.rx=de.sharedRx,re.tx=de.sharedTx;const ve=new TextEncoder().encode(JSON.stringify({envId:m})),ue=re.encrypt(ve);ne.send(ue,W.DATA),setTimeout(()=>{re.destroy(),ne.destroy();const V=we.indexOf(ne);V>=0&&we.splice(V,1)},3e3)}async function _(){const w=j,m=ge.map(f=>f.url.replace("wss://","https://").replace("ws://","http://")),h=new Map,v=await Promise.allSettled(m.map(async f=>{const y=await fetch(`${f}/rooms`,{signal:AbortSignal.timeout(8e3)});if(!y.ok)throw new Error(`HTTP ${y.status}`);return y.json()}));for(const f of v)if(f.status==="fulfilled"){for(const y of f.value.rooms)if(!h.has(y.id))try{const M=w.from_base64(y.metadata,w.base64_variants.ORIGINAL),B=g(M);B&&h.set(y.id,{roomId:y.id,envId:B.envId,name:B.name,description:B.description,capacity:B.capacity,tags:B.tags,entryRelay:y.relay})}catch{}}return[...h.values()]}async function U(){mt||await a(),s.value=!0,r.value=null;let w=[],m=null;try{const h=await l([...ge].reverse()),v=new Uint8Array(7);v[0]=W.TRACKER_QUERY,new DataView(v.buffer).setUint32(1,0),new DataView(v.buffer).setUint16(5,50);const f=new Promise(B=>{h.onData((R,ne)=>{R===W.TRACKER_RESPONSE&&B(ne)})});h.send(v,W.TRACKER_QUERY);const y=await Promise.race([f,new Promise((B,R)=>setTimeout(()=>R(new Error("Tracker query timeout")),8e3))]);if(y.length>=6){const B=new DataView(y.buffer,y.byteOffset).getUint16(4);let R=6;for(let ne=0;ne<B&&R<y.length&&!(R+36>y.length);ne++){const G=y.subarray(R,R+32),$=new DataView(y.buffer,y.byteOffset+R+32).getUint16(0),Z=new TextDecoder().decode(y.subarray(R+34,R+34+$)),de=new DataView(y.buffer,y.byteOffset+R+34+$).getUint16(0),re=y.subarray(R+36+$,R+36+$+de),ve=Rt(G),ue=g(re);ue&&w.push({roomId:ve,envId:ue.envId,name:ue.name,description:ue.description,capacity:ue.capacity,tags:ue.tags,entryRelay:Z}),R+=36+$+de}}h.destroy();const M=we.indexOf(h);M>=0&&we.splice(M,1)}catch(h){m=h.message}if(w.length===0)try{w=await _(),w.length>0}catch{}return w.length===0&&m&&(r.value=m),n.value=w,s.value=!1,w}async function H(w){mt||await a(),r.value=null;try{const m=j,h=[...ge],v=await l(h),f=h[h.length-1].url,y=m.randombytes_buf(20);if(v.send(new Uint8Array(y),W.ESTABLISH_RENDEZVOUS),!await Promise.race([new Promise(V=>{v.onData((J,ie)=>{J===W.RENDEZVOUS_ESTABLISHED&&V(ie[0]===1)})}),new Promise((V,J)=>setTimeout(()=>J(new Error("Rendezvous establish timeout")),1e4))]))throw v.destroy(),new Error("Failed to establish rendezvous");const B=await l([...ge].reverse()),R=new TextEncoder().encode(f),ne=ro(w),G=new Uint8Array(55+R.length);G[0]=W.TRACKER_INTRODUCE,G.set(ne,1),G.set(y,33),new DataView(G.buffer).setUint16(53,R.length),G.set(R,55),B.send(G,W.TRACKER_INTRODUCE);const $=new zn,Z=await $.initAsClient(v),de=await Promise.race([new Promise(V=>{v.onData((J,ie)=>{J===W.RENDEZVOUS_JOIN&&V(ie.subarray(1))})}),new Promise((V,J)=>setTimeout(()=>J(new Error("Host join timeout (30s)")),3e4))]);v.send(Z,W.DATA),await $.completeAsClient(de),B.destroy();const re=we.indexOf(B);re>=0&&we.splice(re,1);const ve=await Promise.race([new Promise(V=>{v.onData((J,ie)=>{if(J===W.DATA){const pt=$.decrypt(ie);if(pt)try{const Q=JSON.parse(new TextDecoder().decode(pt));Q.envId&&V(Q.envId)}catch{}}})}),new Promise((V,J)=>setTimeout(()=>J(new Error("Room info timeout")),1e4))]),ue={onData:null,onClose:null,send:V=>{const J=$.encrypt(V);v.send(J,W.DATA)},close:()=>{$.destroy(),v.destroy();const V=we.indexOf(v);V>=0&&we.splice(V,1),ue.onClose?.()}};return v.onData((V,J)=>{if(V===W.DATA){const ie=$.decrypt(J);ie&&ue.onData?.(ie)}}),{connection:ue,envId:ve}}catch(m){return r.value=m.message,null}}function oe(){We&&clearInterval(We),We=null;for(const w of we)w.destroy();we.length=0,qt=null,Xt=null,t.value=!1,s.value=!1}function X(w){if(!j)throw new Error("Not initialized");return Rt(Bn(w))}function I(w,m){if(!j||!Re)throw new Error("Not initialized");const h=j,v=new TextEncoder().encode(w),f=h.randombytes_buf(D),y=h.crypto_aead_xchacha20poly1305_ietf_encrypt(v,null,null,f,Re),M=new Uint8Array(f.length+y.length);return M.set(f),M.set(y,f.length),`${m}.${h.to_base64(M,h.base64_variants.URLSAFE_NO_PADDING)}`}function ae(w){if(!j||!Re)return null;const m=j;let h="",v="";if(w.startsWith("sfr:"))v=w.slice(4);else{const f=w.indexOf(".");if(f<1)return null;h=w.substring(0,f),v=w.substring(f+1)}try{const f=m.from_base64(v,m.base64_variants.URLSAFE_NO_PADDING);if(f.length<D+ct)return null;const y=f.subarray(0,D),M=f.subarray(D),B=m.crypto_aead_xchacha20poly1305_ietf_decrypt(null,M,null,y,Re);if(!B||B.length===0)return null;const R=new TextDecoder().decode(B);return{roomKey:h,envId:R}}catch{return null}}async function ce(){try{return await $fetch("/api/room3d/tunnel-info")}catch{return null}}return{isReady:Fe(e),isPublishing:Fe(t),isDiscovering:Fe(s),publicRooms:Fe(n),connectionError:Fe(r),init:a,publishRoom:T,discoverRooms:U,connectToRoom:H,destroyAll:oe,deriveRoomId:X,generateInviteToken:I,parseInviteToken:ae,fetchTunnelInfo:ce}}const io="sf_room3d_favorites",lo="sf_room3d_custom_names",Ue=k([]),nt=k({});let jn=!1;function Hs(){if(!(jn||typeof window>"u")){jn=!0;try{const e=localStorage.getItem(io);e&&(Ue.value=JSON.parse(e))}catch{}try{const e=localStorage.getItem(lo);e&&(nt.value=JSON.parse(e))}catch{}}}function Kn(){typeof window>"u"||localStorage.setItem(io,JSON.stringify(Ue.value))}function Ys(){typeof window>"u"||localStorage.setItem(lo,JSON.stringify(nt.value))}function Gs(){Hs();function e(l){Ue.value.some(d=>d.roomId===l.roomId)||(Ue.value.push({roomId:l.roomId,name:l.name,addedAt:Date.now()}),Kn())}function t(l){Ue.value=Ue.value.filter(d=>d.roomId!==l),Kn()}function n(l){return Ue.value.some(d=>d.roomId===l)}function s(l){n(l.roomId)?t(l.roomId):e(l)}function r(l,d){d.trim()?nt.value[l]=d.trim():delete nt.value[l],Ys()}function a(l){return nt.value[l.roomId]||l.name}return{favorites:Fe(Ue),customNames:Fe(nt),addFavorite:e,removeFavorite:t,isFavorite:n,toggleFavorite:s,setCustomName:r,getDisplayName:a}}const Js={class:"w-full max-w-4xl mx-auto"},Zs={class:"flex items-center gap-2 mb-3"},qs={class:"relative flex-1"},Xs=["disabled"],Qs={class:"max-h-[30vh] sm:max-h-[35vh] overflow-y-auto pr-0.5 pub-scroll"},ea={key:0,class:"flex flex-col items-center py-8"},ta={key:1,class:"text-center py-6"},na={class:"text-red-400/70 text-base mb-2"},oa={key:2,class:"text-center py-8"},sa={class:"text-white/40 text-base"},aa={key:3,class:"space-y-2"},ra=["onClick"],ia={class:"flex-1 min-w-0"},la={class:"flex items-center gap-2"},ca={class:"text-base font-bold text-white/80 group-hover:text-emerald-300 transition-colors truncate"},da={key:0,class:"text-base text-white/35 truncate mt-0.5"},ua=["onClick"],fa={key:0,class:"bg-black/50 border border-white/[0.12] border-t-0 border-amber-500/30 rounded-b-xl px-4 py-3 flex items-center gap-2"},pa=["onKeydown"],ma=["onClick"],ha=dn({__name:"Room3dPublicBrowser",props:{authenticated:{type:Boolean}},emits:["join-public-room"],setup(e,{emit:t}){const n=t,s=Fs(),r=Gs(),a=k(""),l=k([]),d=k(!1),g=k(null),T=k(null),S=k(""),_=k(null),{getDisplayName:U,isFavorite:H,toggleFavorite:oe}=r;function X(h){return H(h)}function I(h){oe(h)}const ae=Pe(()=>{let h=l.value;if(a.value.trim()){const v=a.value.toLowerCase();h=h.filter(f=>f.name.toLowerCase().includes(v)||f.description?.toLowerCase().includes(v)||f.tags?.some(y=>y.toLowerCase().includes(v)))}return[...h].sort((v,f)=>{const y=H(v.roomId)?1:0,M=H(f.roomId)?1:0;return y!==M?M-y:v.name.localeCompare(f.name)})});function ce(h){if(h.passwordProtected){try{const v=JSON.parse(localStorage.getItem("sf_room3d_room_passwords")||"{}");if(v[h.envId]){n("join-public-room",{...h,password:v[h.envId]});return}}catch{}if(T.value===h.roomId)return;T.value=h.roomId,S.value="",Lo(()=>{const v=_.value?.[0];v&&v.focus()});return}n("join-public-room",h)}function w(h){S.value&&(T.value=null,n("join-public-room",{...h,password:S.value}))}async function m(){d.value=!0,g.value=null,T.value=null;try{await s.init();const h=await s.discoverRooms();l.value=h,h.length===0&&s.connectionError.value&&(g.value=s.connectionError.value)}catch(h){g.value=h?.message||"Connection failed"}finally{d.value=!1}}return Tt(()=>{m()}),(h,v)=>(p(),x("div",Js,[o("div",Zs,[o("div",qs,[A(c(fs),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),Qe(o("input",{"onUpdate:modelValue":v[0]||(v[0]=f=>He(a)?a.value=f:null),type:"text",placeholder:"Search rooms...",class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors"},null,512),[[ht,c(a)]])]),o("button",{onClick:m,disabled:c(d),class:"p-2 rounded-xl bg-black/60 border border-white/20 hover:bg-emerald-500/10 hover:border-emerald-500/30 transition-all disabled:opacity-30",title:"Refresh"},[A(c(no),{class:ee(["w-5 h-5 text-white/50",{"animate-spin":c(d)}])},null,8,["class"])],8,Xs)]),o("div",Qs,[c(d)&&!c(l).length?(p(),x("div",ea,[...v[3]||(v[3]=[o("div",{class:"w-8 h-8 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin mb-3"},null,-1),o("p",{class:"text-white/40 text-base"},"Discovering rooms...",-1)])])):c(g)?(p(),x("div",ta,[o("p",na,pe(c(g)),1),o("button",{onClick:m,class:"text-base text-emerald-400/60 hover:text-emerald-400 transition-colors"},"Try again")])):!c(ae).length&&!c(d)?(p(),x("div",oa,[A(c(un),{class:"w-10 h-10 text-white/[0.08] mx-auto mb-2"}),o("p",sa,pe(c(a)?"No rooms match your search":"No public rooms yet"),1)])):(p(),x("div",aa,[(p(!0),x(et,null,tt(c(ae),f=>(p(),x("div",{key:f.roomId,class:"space-y-0"},[o("button",{onClick:y=>ce(f),class:ee(["group w-full text-left flex items-center gap-3 bg-black/50 border border-white/[0.12] px-4 py-3 transition-all",[c(T)===f.roomId?"rounded-t-xl border-b-0 border-amber-500/30 bg-amber-500/[0.04]":"rounded-xl hover:border-emerald-500/30 hover:bg-emerald-500/[0.06]"]])},[o("div",ia,[o("div",la,[o("h4",ca,pe(c(U)(f)),1),f.passwordProtected?(p(),be(c(rt),{key:0,class:"w-4 h-4 text-amber-400/60 flex-shrink-0"})):N("",!0),(p(!0),x(et,null,tt(f.tags?.slice(0,2),y=>(p(),x("span",{key:y,class:"hidden sm:inline px-1.5 py-0.5 rounded bg-white/[0.06] text-white/35 text-base leading-tight flex-shrink-0"},pe(y),1))),128))]),f.description?(p(),x("p",da,pe(f.description),1)):N("",!0)]),o("div",{onClick:xe(y=>I(f),["stop"]),class:"p-1 cursor-pointer flex-shrink-0"},[X(f.roomId)?(p(),be(c(ps),{key:0,class:"w-4 h-4 text-amber-400"})):(p(),be(c(bs),{key:1,class:"w-4 h-4 text-white/15 group-hover:text-white/30 transition-colors"}))],8,ua)],10,ra),c(T)===f.roomId?(p(),x("div",fa,[A(c(rt),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),Qe(o("input",{ref_for:!0,ref_key:"passwordInputRef",ref:_,"onUpdate:modelValue":v[1]||(v[1]=y=>He(S)?S.value=y:null),type:"password",placeholder:"Enter room password",maxlength:"32",onKeydown:[tn(y=>w(f),["enter"]),v[2]||(v[2]=tn(y=>T.value=null,["escape"]))],class:"flex-1 bg-black/60 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,pa),[[ht,c(S)]]),o("button",{onClick:y=>w(f),class:"px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-300 text-base font-medium hover:bg-amber-500/30 transition-colors"}," Join ",8,ma)])):N("",!0)]))),128))]))])]))}}),ba=Object.assign(fn(ha,[["__scopeId","data-v-be232ca8"]]),{__name:"Room3dPublicBrowser"}),_e=k();let F=null,te=null,L=null,nn=0,on=0;const Qt=new cs,sn=k(!1);let it=0;const Te=k([]),wt=k(""),an="sf_room3d_user_name",pn=k("");function ya(){const e=pn.value.trim();e?localStorage.setItem(an,e):localStorage.removeItem(an)}function va(){pn.value=localStorage.getItem(an)||""}const ga=k(),co=k(0);function wa(e){const t=e.target;if(!t)return;const n=t.scrollWidth/Go.length;co.value=Math.round(t.scrollLeft/n)}const xa=k({}),ka=k(""),Sa=Pe(()=>window.location.origin);let Be=null,se=[],Ye=0,Le=0;const le=k(0),rn=2.8;let Ot=null;const yt=new Set;async function Ca(){if(!_e.value||L)return;const e="ontouchstart"in window||navigator.maxTouchPoints>0;F=new Xo,te=new Qo(34,_e.value.clientWidth/_e.value.clientHeight,.1,50),te.position.set(0,1.25,4.8),te.lookAt(0,.6,0),L=new es({antialias:!e,alpha:!0}),L.setPixelRatio(Math.min(window.devicePixelRatio,e?1.5:2)),L.setSize(_e.value.clientWidth,_e.value.clientHeight),L.setClearColor(0,0),L.toneMapping=e?ts:ns,L.toneMappingExposure=1.6,e||(L.shadowMap.enabled=!0,L.shadowMap.type=os),_e.value.appendChild(L.domElement),F.fog=new ss(394767,.06);const t=new Jt(16772829,3.5);t.position.set(2,5,5),e||(t.castShadow=!0,t.shadow.mapSize.set(1024,1024),t.shadow.camera.near=.5,t.shadow.camera.far=15,t.shadow.bias=-.002),F.add(t);const n=new Jt(6724044,.8);n.position.set(-4,2,3),F.add(n);const s=new Jt(1096065,2);if(s.position.set(0,3,-5),F.add(s),!e){const r=new as(16777215,4,12,Math.PI/8,.6,1);r.position.set(0,5,3),r.target.position.set(0,0,rn),F.add(r),F.add(r.target)}F.add(new rs(3359829,e?1.2:.6)),Be=new oo,F.add(Be),window.addEventListener("resize",uo);try{await L.compileAsync(F,te)}catch{}on=performance.now(),mo()}function uo(){if(!_e.value||!L||!te)return;const e=_e.value.clientWidth,t=_e.value.clientHeight;te.aspect=e/t,te.updateProjectionMatrix(),L.setSize(e,t)}async function _a(){if(!F||!Be||Te.value.length===0)return;sn.value=!0;const e=++it,t=Te.value,n=t.length,s=Math.PI*2/n;if(!Ot)try{const l=new so,d=await new Promise((g,T)=>l.load("/data/appdata/models/characters/animations/Idle.glb",g,void 0,T));d.animations?.length&&(Ot=d.animations.find(g=>!g.name.includes("T-Pose"))||d.animations[d.animations.length-1])}catch{}if(e!==it)return;se=[],yt.clear();for(let l=0;l<n;l++){const d=l*s,g=new oo;g.position.set(Math.sin(d)*rn,0,Math.cos(d)*rn),Be.add(g),se.push({wrapper:g,model:null,mixer:null,file:t[l],loaded:!1})}const r=t.indexOf(wt.value);r>=0&&(le.value=r,Ye=Le=-r*s);const a=[le.value];if(n>1&&a.push(((le.value+1)%n+n)%n),n>2&&a.push(((le.value-1)%n+n)%n),await Promise.all(a.map(l=>fo(l,e))),e===it&&L&&F&&te){try{await L.compileAsync(F,te)}catch{}for(const d of a){const g=se[d];g?.model&&(g.model.visible=!0)}const l=new Map;F.traverse(d=>{d.frustumCulled&&(l.set(d,!0),d.frustumCulled=!1)}),L.render(F,te);for(const[d]of l)d.frustumCulled=!0;L.info.reset()}else for(const l of a){const d=se[l];d?.model&&(d.model.visible=!0)}po(),sn.value=!1}async function fo(e,t){const n=t??it;if(e<0||e>=se.length)return;const s=se[e];if(!(!s||s.loaded||yt.has(e))){yt.add(e);try{const r=new so,a=await new Promise((_,U)=>{r.load(`/data/appdata/models/characters/${encodeURIComponent(s.file)}`,_,void 0,U)});if(n!==it){a.scene.traverse(_=>{_.geometry&&_.geometry.dispose()});return}const l=a.scene,d=new is().setFromObject(l),g=d.max.y-d.min.y;if(g>0){const _=1.4/g;l.scale.setScalar(_),l.position.y=-d.min.y*_,l.position.x=-(d.min.x+d.max.x)/2*_,l.position.z=-(d.min.z+d.max.z)/2*_}l.visible=!1,s.wrapper.add(l),s.model=l;const T=a.animations||[];let S=T.find(_=>/idle/i.test(_.name)&&!_.name.includes("T-Pose"));!S&&T.length>0&&(S=T.find(_=>!_.name.includes("T-Pose"))||T[0]),!S&&Ot&&(S=Ot),S&&(s.mixer=new ls(l),s.mixer.clipAction(S).play()),s.loaded=!0}catch{}finally{yt.delete(e)}}}function Ea(e,t){e.model&&e.model.traverse(n=>{if(n.isMesh&&n.material){const s=Array.isArray(n.material)?n.material:[n.material];for(const r of s)r.transparent=!0,r.opacity=t}})}function po(){if(!se.length)return;const e=se.length;for(let t=0;t<e;t++){const n=((t-le.value)%e+e)%e,s=n>e/2?e-n:n,r=s===0?1.05:1;se[t].wrapper.scale.setScalar(r),se[t].wrapper.visible=s<=2,Ea(se[t],s<=1?1:.25)}}let Wn=0;function mo(){if(!L||!F||!te)return;nn=requestAnimationFrame(mo);const e=performance.now(),t=e,n=Math.min((t-on)/1e3,.1);on=t;for(const a of se)a.mixer&&a.mixer.update(n);if(Be){const a=Le-Ye;Math.abs(a)>.001?Ye+=a*Math.min(1,n*4):Ye=Le,Be.rotation.y=Ye;const l=te.position;for(const d of se){d.wrapper.getWorldPosition(Qt);const g=l.x-Qt.x,T=l.z-Qt.z,S=Math.atan2(g,T);d.wrapper.rotation.y=S-Be.rotation.y}}performance.now(),L.render(F,te);const s=performance.now();s-e>50&&s-Wn>2e3&&(Wn=s,L.info)}function mn(e){const t=Te.value.length;if(t<2)return;const n=le.value,s=Math.PI*2/t;for(le.value=(e%t+t)%t,Le=-le.value*s;Le-Ye>Math.PI;)Le-=Math.PI*2;for(;Le-Ye<-Math.PI;)Le+=Math.PI*2;wt.value=Te.value[le.value],po();const r=le.value>n||n===t-1&&le.value===0?1:-1,a=((le.value+r)%t+t)%t;fo(a).then(()=>{const l=se[a];l?.model&&!l.model.visible&&(L&&F&&te?L.compileAsync(F,te).then(()=>{l.model&&(l.model.visible=!0),L&&F&&te&&(L.render(F,te),L.info.reset())}).catch(()=>{l.model&&(l.model.visible=!0)}):l.model&&(l.model.visible=!0))})}function ho(){mn(le.value-1)}function bo(){mn(le.value+1)}let Fn=0;function Aa(e){if(e.preventDefault(),Te.value.length<2)return;const t=Date.now();t-Fn<200||(Fn=t,e.deltaY>0?bo():e.deltaY<0&&ho())}function Ta(){window.removeEventListener("resize",uo),cancelAnimationFrame(nn),nn=0,it++,yt.clear();for(const e of se)e.mixer&&e.mixer.stopAllAction(),Yo(e.wrapper);se=[],F&&(F.traverse(e=>{if(e.geometry&&e.geometry.dispose(),e.material){const t=Array.isArray(e.material)?e.material:[e.material];for(const n of t)n.dispose()}}),F=null),Be=null,L&&(L.domElement.remove(),L.dispose(),L=null),te=null}async function Ra(){try{const e=await $fetch("/api/room3d/characters");if(e?.length){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}Te.value=t}!Te.value.includes(wt.value)&&Te.value.length>0&&(wt.value=Te.value[0])}catch{}}function Pa(){return{lobbyCanvas:_e,lobbyCharLoading:sn,availableCharacters:Te,selectedCharacter:wt,displayName:pn,saveDisplayName:ya,loadDisplayName:va,roomScrollContainer:ga,activeRoomIdx:co,onRoomScroll:wa,editingCode:xa,copiedCode:ka,currentDomain:Sa,carouselSelectedIdx:le,initLobbyScene:Ca,disposeLobbyScene:Ta,initCarouselPositions:_a,lobbyRotateToIndex:mn,lobbyPrevChar:ho,lobbyNextChar:bo,onLobbyWheel:Aa,loadAvailableCharacters:Ra,charDisplayName:Ho}}const Ia=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}];let E=null,Y=null,vt=null,Ie=null,Ut=null;const K=new Map,Me=new Map;let O=null,yo=1,vo=20,Pt=null;const Ma=5e3,Da=1e4;let hn=!1;const Na=2,Oa=3e3;let ke=!1,Ua=null,ft=!1,Ee=null,gt=null,Ze=!1;const dt=new Map,$e=new Map,me=new Map;let bn=0,Ge="",yn=0;const go="room3d-voice-settings",Hn={mode:"vad",muted:!1,volume:80,spatialAudio:!0,autoJoin:!0};function $a(){try{const e=localStorage.getItem(go);if(e)return{...Hn,...JSON.parse(e)}}catch{}return{...Hn}}function St(){try{localStorage.setItem(go,JSON.stringify({mode:De.value,muted:he.value,volume:Xe.value,spatialAudio:Yt.value,autoJoin:vn.value}))}catch{}}const Ct=$a(),ze=k(!1),De=k(Ct.mode),he=k(Ct.muted),Ne=k(!1),qe=k(!1),Xe=k(Ct.volume),Yt=k(Ct.spatialAudio),vn=k(Ct.autoJoin),gn=k(!1),Ae=k("unknown"),Gt=Vo(new Map),La=8,Va=30,Ba=400;let It=null,ot=0,st=0,Je=!1,Mt=null,Ve=null;function ut(e){const t=Y?.getAudioTracks()[0];t&&(t.enabled=e)}function za(e,t){if(!E)return null;const n=K.get(t);if(!n)return null;if(n.source)return n;if(e.getAudioTracks().length===0)return null;const r=E.createMediaStreamSource(e),a=E.createGain();a.gain.value=Xe.value/100;const l=E.createPanner();l.panningModel="HRTF",l.distanceModel="inverse",l.refDistance=yo,l.maxDistance=vo,l.rolloffFactor=1.5,l.coneInnerAngle=360,l.coneOuterAngle=360,l.coneOuterGain=1;const d=E.createAnalyser();return d.fftSize=256,d.smoothingTimeConstant=.5,r.connect(a),a.connect(l),l.connect(d),d.connect(E.destination),n.source=r,n.gain=a,n.panner=l,n.analyser=d,n.stream=e,n}function wo(e){const t=new RTCPeerConnection({iceServers:Ia});return t.onicecandidate=n=>{n.candidate&&O&&O.sendVoiceSignal(e,"voice:ice",{candidate:n.candidate})},t.ontrack=n=>{const s=n.streams[0]||new MediaStream([n.track]);E&&E.state==="suspended"&&E.resume().catch(()=>{});const r=K.get(e);if(r&&!r.audioEl)try{const l=new Audio;l.srcObject=s,l.autoplay=!0,l.volume=Xe.value/100,l.play().then(()=>{}).catch(d=>{}),r.audioEl=l}catch{}K.get(e)?.audioEl||za(s,e)},t.onconnectionstatechange=()=>{if(t.connectionState==="connected"&&ke){let s=!0;for(const[,r]of K)if(r.pc.connectionState!=="connected"){s=!1;break}s&&pr()}},t.oniceconnectionstatechange=()=>{},t.onsignalingstatechange=()=>{},t}let xo=1;function ja(e,t=1){O=e,xo=t}async function Ka(){if(Y)return Ae.value="granted",!0;if(!navigator.mediaDevices?.getUserMedia)return Ge="getUserMedia not available (no HTTPS?)",Ae.value="unavailable",!1;try{return Y=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1}),Ae.value="granted",!0}catch(e){return Ge=e?.message||String(e)||"Mic denied",Ae.value=e?.name==="NotAllowedError"?"denied":"error",!1}}async function Wa(){if(Y){Ae.value="granted";return}if(!navigator.mediaDevices?.getUserMedia){Ae.value="unavailable";return}try{const e=await navigator.permissions.query({name:"microphone"});Ae.value=e.state==="granted"?"granted":e.state==="denied"?"denied":"prompt",e.onchange=()=>{Y||(Ae.value=e.state==="granted"?"granted":e.state==="denied"?"denied":"prompt")}}catch{Ae.value="prompt"}}async function Fa(e,t){e&&(O=e);const n=t??xo;if(yo=1*n,vo=20*n,!ze.value){if(!O){Ge="No multiplayer ref";return}Ge="";try{if(!Y){if(!navigator.mediaDevices?.getUserMedia){Ge="getUserMedia not available (no HTTPS?)";return}Y=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})}const s=Y.getAudioTracks()[0];if((!s||s.readyState!=="live")&&(Y=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})),E=new AudioContext,E.state==="suspended")try{await E.resume()}catch{}if(!Ze)try{await E.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await E.audioWorklet.addModule("/workers/audio-playback.worklet.js"),Ze=!0}catch{}const r=Y.getAudioTracks()[0];vt=r.clone();const a=new MediaStream([vt]);Ie=E.createAnalyser(),Ie.fftSize=512,Ie.smoothingTimeConstant=.5,Ut=new Uint8Array(Ie.frequencyBinCount),E.createMediaStreamSource(a).connect(Ie),r.enabled=De.value==="vad"&&!he.value,O.onVoiceSignal(Ga),O.onVoiceState(Ja),It=bt(Qa,100),Mt=bt(tr,100),Pt=bt(Za,Ma),ze.value=!0}catch(s){Ge=s?.message||String(s)||"Unknown error",Eo()}}}async function ko(e){if(!ze.value||!Y||!O||K.has(e))return;const n=(O.localPeerId?.value||"")<e,s=wo(e);for(const a of Y.getAudioTracks())s.addTrack(a,Y);const r={pc:s,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:n};if(K.set(e,r),n)try{const a=await s.createOffer();await s.setLocalDescription(a),O.sendVoiceSignal(e,"voice:offer",{sdp:s.localDescription}),r.offerSentAt=Date.now()}catch{K.delete(e),s.close()}setTimeout(()=>{const a=K.get(e);a&&a.pc.connectionState!=="connected"&&!ke&&So()},Oa)}async function Yn(e){const t=Me.get(e);if(!t||t.length===0)return;Me.delete(e);const n=K.get(e);if(n)for(const s of t)try{await n.pc.addIceCandidate(new RTCIceCandidate(s))}catch{}}function Ha(e,t,n){if(t===n)return e;const s=t/n,r=Math.round(e.length/s),a=new Int16Array(r);for(let l=0;l<r;l++){const d=l*s,g=Math.floor(d),T=Math.min(g+1,e.length-1),S=d-g;a[l]=Math.round(e[g]*(1-S)+e[T]*S)}return a}function Ya(e,t){if(E&&(E.state==="suspended"&&E.resume().catch(()=>{}),ke||(ke=!0,ft=!0,Co()),!(!t.audio||typeof t.audio!="string"))){yn++;try{const n=atob(t.audio),s=new Uint8Array(n.length);for(let g=0;g<n.length;g++)s[g]=n.charCodeAt(g);let r=new Int16Array(s.buffer,s.byteOffset,s.byteLength>>1);const a=t.sr||48e3,l=E.sampleRate;a!==l&&(r=Ha(r,a,l)),dt.has(e),dt.set(e,Date.now()),me.has(e)||mr(e);const d=me.get(e);if(!d)return;d.workletNode.port.postMessage(r.buffer,[r.buffer])}catch{}}}async function Ga(e,t,n){if(!(!Y||!O))if(t==="voice:offer"){let s=K.get(e);if(s&&s.pc.signalingState==="have-local-offer"){if((O.localPeerId?.value||"")>e)return;try{await s.pc.setLocalDescription({type:"rollback"})}catch{}}if(!s){const r=wo(e);for(const a of Y.getAudioTracks())r.addTrack(a,Y);s={pc:r,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:!1},K.set(e,s)}try{await s.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await Yn(e);const r=await s.pc.createAnswer();await s.pc.setLocalDescription(r),O.sendVoiceSignal(e,"voice:answer",{sdp:s.pc.localDescription})}catch{}}else if(t==="voice:answer"){const s=K.get(e);if(!s||s.pc.signalingState!=="have-local-offer")return;try{await s.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await Yn(e)}catch{}}else if(t==="voice:ice"){const s=K.get(e);if(!s){let r=Me.get(e);r||(r=[],Me.set(e,r)),r.push(n.candidate);return}if(n.candidate)if(s.pc.remoteDescription)try{await s.pc.addIceCandidate(new RTCIceCandidate(n.candidate))}catch{}else{let r=Me.get(e);r||(r=[],Me.set(e,r)),r.push(n.candidate)}}else t==="voice:relay"&&Ya(e,n)}function Ja(e,t){Gt.set(e,{...t}),Ve&&Ve(e,t.speaking)}function $t(e){const t=K.get(e);if(t){try{t.source?.disconnect()}catch{}try{t.gain?.disconnect()}catch{}try{t.panner?.disconnect()}catch{}try{t.analyser?.disconnect()}catch{}t.audioEl&&(t.audioEl.pause(),t.audioEl.srcObject=null,t.audioEl=null),t.pc.close(),K.delete(e)}wn(e),Gt.delete(e),Me.delete(e)}function Za(){if(!ze.value||!O)return;const e=Date.now();for(const[t,n]of K){const s=n.pc.connectionState,r=n.pc.signalingState;if(s==="connected"){$e.delete(t);continue}if(s==="failed"||s==="closed"){$t(t),$e.set(t,($e.get(t)||0)+1);continue}if(n.isOfferer&&n.offerSentAt>0&&r==="have-local-offer"&&e-n.offerSentAt>Da){$t(t),$e.set(t,($e.get(t)||0)+1);continue}}if(!ke){for(const[,t]of $e)if(t>=Na){So();break}}for(const t of O.remotePlayers.value.keys())K.has(t)||ko(t)}function qa(e,t){if(!E||E.state==="closed"||!Yt.value)return;const n=E.listener;if(e){const s=e.position;n.positionX?(n.positionX.value=s.x,n.positionY.value=s.y,n.positionZ.value=s.z):n.setPosition(s.x,s.y,s.z);const r={x:0,y:0,z:-1},a={x:0,y:1,z:0},l=e.quaternion,d=r.x,g=r.y,T=r.z,S=l.x,_=l.y,U=l.z,H=l.w,oe=H*d+_*T-U*g,X=H*g+U*d-S*T,I=H*T+S*g-_*d,ae=-S*d-_*g-U*T;r.x=oe*H+ae*-S+X*-U-I*-_,r.y=X*H+ae*-_+I*-S-oe*-U,r.z=I*H+ae*-U+oe*-_-X*-S;const ce=a.x,w=a.y,m=a.z,h=H*ce+_*m-U*w,v=H*w+U*ce-S*m,f=H*m+S*w-_*ce,y=-S*ce-_*w-U*m;a.x=h*H+y*-S+v*-U-f*-_,a.y=v*H+y*-_+f*-S-h*-U,a.z=f*H+y*-U+h*-_-v*-S,n.forwardX?(n.forwardX.value=r.x,n.forwardY.value=r.y,n.forwardZ.value=r.z,n.upX.value=a.x,n.upY.value=a.y,n.upZ.value=a.z):n.setOrientation(r.x,r.y,r.z,a.x,a.y,a.z)}for(const[s,r]of K){if(!r.panner)continue;const a=t.getPlayerPosition3D(s);a&&(r.panner.positionX?(r.panner.positionX.value=a.x,r.panner.positionY.value=a.y,r.panner.positionZ.value=a.z):r.panner.setPosition(a.x,a.y,a.z))}}function Xa(e){!ze.value||he.value||(qe.value=e,De.value==="ptt"&&(Ne.value=e,ut(e),O?.sendVoiceState({muted:!1,speaking:e})))}function Qa(){if(De.value!=="vad"||!Ie||!Ut||he.value||O&&O.remotePlayers.value.size===0){Je&&Gn();return}const e=Ut;Ie.getByteFrequencyData(e);let t=0;for(let r=0;r<e.length;r++)t+=e[r];const n=t/e.length,s=Date.now();n>La?(st=0,ot||(ot=s),!Je&&s-ot>=Va&&er()):(ot=0,Je&&(st||(st=s),s-st>=Ba&&Gn()))}function er(){Je=!0,Ne.value=!0,O?.sendVoiceState({muted:!1,speaking:!0})}function Gn(){Je=!1,!hn&&(Ne.value=!1,O?.sendVoiceState({muted:he.value,speaking:!1}))}function tr(){if(K.size===0&&me.size===0)return;const e=12;for(const[t,n]of K){if(!n.analyser)continue;const s=new Uint8Array(n.analyser.frequencyBinCount);n.analyser.getByteFrequencyData(s);let r=0;for(let d=0;d<s.length;d++)r+=s[d];const l=r/s.length>e;l!==n.speaking&&(n.speaking=l,Ve&&Ve(t,l))}if(me.size>0){const t=Date.now();for(const[n]of me){const s=dt.get(n)||0,r=t-s<300;Ve&&Ve(n,r)}}}function nr(e){De.value=e,e==="ptt"?(qe.value||(Ne.value=!1,ut(!1),O?.sendVoiceState({muted:he.value,speaking:!1})),Je=!1,ot=0,st=0):(qe.value=!1,he.value||ut(!0)),St()}function or(){he.value=!he.value,he.value?(Ne.value=!1,qe.value=!1,ut(!1),O?.sendVoiceState({muted:!0,speaking:!1})):De.value==="vad"&&ut(!0),St()}function sr(e){Xe.value=Math.max(0,Math.min(100,e));const t=Xe.value/100;for(const n of K.values())n.gain&&(n.gain.gain.value=t),n.audioEl&&(n.audioEl.volume=t);for(const n of me.values())n.gain.gain.value=t*2.5;St()}function ar(e){if(Yt.value=e,!e)for(const t of K.values())t.panner&&(t.panner.positionX?(t.panner.positionX.value=0,t.panner.positionY.value=0,t.panner.positionZ.value=0):t.panner.setPosition(0,0,0));St()}function rr(e){vn.value=e,St()}function ir(){gn.value=!0}function lr(){gn.value=!1}function cr(e){Ve=e}function dr(){return[...K.keys()]}function ur(){const e=[];for(const[n,s]of K)e.push({id:n.slice(0,6),conn:s.pc.connectionState,ice:s.pc.iceConnectionState,sig:s.pc.signalingState,hasRemoteDesc:!!s.pc.remoteDescription,hasTrack:!!s.stream,trackEnabled:s.stream?.getAudioTracks()[0]?.enabled??!1});const t=Y?.getAudioTracks()[0];return{lastInitError:Ge||"",audioCtx:E?.state||"none",sampleRate:E?.sampleRate||0,workletLoaded:Ze,captureActive:!!Ee,relayMode:ke,useGameWsRelay:ft,relaySendCount:bn,relayRecvCount:yn,voiceWs:Ua?.readyState===WebSocket.OPEN?"open":"closed",relayPeers:me.size,voiceEnabled:ze.value,localStream:!!Y,localTrackState:t?.readyState||"none",localTrackEnabled:t?.enabled??!1,localMuted:he.value,localSpeaking:Ne.value,voiceMode:De.value,mp:!!O,mpConnected:O?.connected?.value??!1,localPeerId:(O?.localPeerId?.value||"").slice(0,6),iceBuf:Me.size,peers:e}}function fr(){hn=!0,ut(!0),Ne.value=!0}function So(){ke||(ke=!0,ft=!0,E&&E.state==="suspended"&&E.resume().catch(()=>{}),Co())}function pr(){if(ke){ke=!1,ft=!1,_o();for(const e of[...me.keys()])wn(e);dt.clear(),$e.clear()}}async function Co(){if(!(Ee||!E||!Y)){if(!Ze)try{await E.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await E.audioWorklet.addModule("/workers/audio-playback.worklet.js"),Ze=!0}catch{return}gt=E.createMediaStreamSource(Y),Ee=new AudioWorkletNode(E,"audio-capture-processor"),Ee.port.onmessage=e=>{if(!he.value&&!(De.value==="ptt"&&!qe.value)&&ft&&O){const t=new Int16Array(e.data),n=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);let s="";for(let a=0;a<n.length;a++)s+=String.fromCharCode(n[a]);const r=btoa(s);O.sendVoiceRelay(r,E?.sampleRate||48e3),bn++}},gt.connect(Ee),Ee.connect(E.destination)}}function _o(){if(Ee){Ee.port.postMessage({type:"mute",value:!0});try{Ee.disconnect()}catch{}Ee=null}if(gt){try{gt.disconnect()}catch{}gt=null}}function mr(e){if(!(!E||me.has(e)||!Ze))try{const t=new AudioWorkletNode(E,"audio-playback-processor"),n=E.createGain();n.gain.value=Xe.value/100*2.5,t.connect(n),n.connect(E.destination),me.set(e,{workletNode:t,gain:n})}catch{}}function wn(e){const t=me.get(e);if(t){try{t.workletNode.port.postMessage({type:"reset"})}catch{}try{t.workletNode.disconnect()}catch{}try{t.gain.disconnect()}catch{}me.delete(e),dt.delete(e)}}function Eo(){It&&(clearInterval(It),It=null),Mt&&(clearInterval(Mt),Mt=null),Pt&&(clearInterval(Pt),Pt=null);for(const e of[...K.keys()])$t(e);if(Y){for(const e of Y.getTracks())e.stop();Y=null}vt&&(vt.stop(),vt=null);try{Ie?.disconnect()}catch{}Ie=null,Ut=null,_o();for(const e of[...me.keys()])wn(e);dt.clear(),$e.clear(),ke=!1,ft=!1,bn=0,yn=0,E&&E.state!=="closed"&&E.close().catch(()=>{}),E=null,Ze=!1,O&&(O.onVoiceSignal(null),O.onVoiceState(null)),O=null,ze.value=!1,Ne.value=!1,qe.value=!1,Je=!1,ot=0,st=0,hn=!1,Gt.clear(),Me.clear(),Ve=null}function hr(){return{voiceEnabled:ze,voiceMode:De,localMuted:he,localSpeaking:Ne,pttActive:qe,masterVolume:Xe,spatialEnabled:Yt,autoJoinVoice:vn,showVoiceSettings:gn,peerVoiceStates:Gt,micPermissionState:Ae,checkMicPermission:Wa,requestMicrophone:Ka,setMultiplayerRef:ja,initVoice:Fa,disposeVoice:Eo,connectToPeer:ko,disconnectPeer:$t,updateSpatialPositions:qa,setVoiceMode:nr,setPTT:Xa,toggleMute:or,setMasterVolume:sr,setSpatialAudio:ar,setAutoJoin:rr,openVoiceSettings:ir,closeVoiceSettings:lr,onPeerSpeakingChanged:cr,getConnectedPeerIds:dr,getVoiceDebugInfo:ur,forceEnableTransmit:fr}}const br={key:1,class:"absolute top-4 right-4 z-30"},yr={class:"px-3 py-1.5 rounded-full bg-black/70 backdrop-blur-sm border border-white/15 text-base text-gray-300 flex items-center gap-2"},vr={key:0,class:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none"},gr={class:"absolute top-0 left-0 right-0 z-20 text-center pt-5 pointer-events-none"},wr={class:"inline-block"},xr={class:"mt-2 flex items-center justify-center gap-2 flex-wrap"},kr={key:0,class:"inline-block bg-yellow-500/10 border border-yellow-500/30 rounded-full px-3 py-0.5"},Sr={key:0,class:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-64 bg-black/90 border border-red-500/30 rounded-lg p-3 text-left z-50 shadow-xl"},Cr={key:0,class:"mt-2 flex items-center justify-center gap-2 pointer-events-auto"},_r={class:"relative inline-flex items-center cursor-pointer"},Er={class:"absolute bottom-0 left-0 right-0 z-20 lobby-bottom-fade pointer-events-none"},Ar={key:0,class:"pointer-events-auto max-w-xs mx-auto px-4 pb-6 text-center"},Tr={key:0,class:"flex items-center justify-center gap-1.5 mb-4"},Rr=["disabled"],Pr={key:1,class:"mt-3 flex items-center gap-2"},Ir={class:"relative flex-1"},Mr=["disabled"],Dr={key:1,class:"max-w-6xl mx-auto px-0 pb-3 sm:px-6 sm:pb-6"},Nr={class:"text-center mb-3 sm:mb-4"},Or={key:0,class:"hidden sm:flex items-center justify-center gap-1.5 mb-2"},Ur={class:"flex justify-center"},$r={class:"flex items-center justify-center gap-3 sm:gap-4 mb-2 sm:mb-3 pointer-events-auto"},Lr={class:"flex items-center bg-black/60 rounded-xl p-0.5 border border-white/15"},Vr={key:0,class:"pointer-events-auto relative"},Br={class:"lobby-room-card group relative overflow-hidden rounded-2xl transition-all duration-300 hover:scale-[1.03]"},zr=["onClick"],jr={class:"relative h-44 sm:h-56 overflow-hidden"},Kr=["src","alt"],Wr={key:1,class:"w-full h-full bg-gradient-to-br from-gray-800/80 to-gray-900/80 flex items-center justify-center"},Fr={key:2,class:"absolute top-2 right-2 bg-amber-500/20 border border-amber-500/30 rounded-full px-2 py-0.5"},Hr={class:"absolute bottom-3 left-3 right-3"},Yr={class:"text-white font-bold text-lg sm:text-xl drop-shadow-lg group-hover:text-emerald-300 transition-colors leading-tight"},Gr={key:0,class:"text-white/50 text-base drop-shadow-lg truncate mt-0.5"},Jr=["onClick"],Zr=["onClick"],qr={class:"space-y-1.5"},Xr={class:"flex items-center justify-between"},Qr={class:"flex items-center gap-1.5 cursor-pointer"},ei={class:"relative inline-flex items-center"},ti=["checked","onChange"],ni={class:"flex items-center gap-1.5 cursor-pointer"},oi={class:"relative inline-flex items-center"},si=["checked","onChange"],ai={class:"flex items-center gap-2"},ri=["onClick"],ii=["onClick"],li=["onClick"],ci=["value","placeholder","onBlur"],di=["value","onBlur"],ui={class:"flex items-center gap-2"},fi=["value","onBlur"],pi={key:1,class:"flex items-center justify-center gap-1.5 mt-3 pointer-events-auto"},mi=["onClick"],hi={key:2,class:"pointer-events-auto"},bi={class:"flex items-center justify-between"},yi={class:"space-y-4"},vi={class:"flex items-center justify-between cursor-pointer"},gi={class:"relative inline-flex items-center"},wi=["checked"],xi={class:"flex items-center justify-between cursor-pointer"},ki={class:"relative inline-flex items-center"},Si=["checked"],Ci={class:"space-y-2"},_i={class:"flex items-center gap-2"},Ei=["value"],Ai={class:"space-y-2"},Ti={class:"flex items-center gap-2"},Ri=["value","placeholder"],Pi=["value"],Ii=dn({__name:"Room3dLobby",props:{environments:{},availableCharacters:{},selectedCharacter:{},carouselSelectedIdx:{},lobbyCharLoading:{type:Boolean},displayName:{},isDev:{type:Boolean},editMode:{type:Boolean},authenticated:{type:Boolean},roomSettings:{},inviteTokens:{},copiedToken:{},activeRoomIdx:{},guestMode:{type:Boolean},guestReady:{type:Boolean},guestOnlineCount:{},guestConnected:{type:Boolean},hideTokenPaste:{type:Boolean}},emits:["select-environment","prev-char","next-char","lobby-wheel","update-room-settings","copy-link","update:displayName","update:editMode","save-display-name","room-scroll","enter-room","join-public-room","join-by-token"],setup(e,{emit:t}){const n={isPublic:!0,inviteOnly:!1,publicName:"",publicDescription:"",password:""},s={isPublic:!1,inviteOnly:!0,publicName:"",publicDescription:"",password:""},r=e,a=t,{sidebarOpen:l}=Jo(),d=hr(),g=d.micPermissionState;Tt(async()=>{await d.checkMicPermission()});const T=k(!1);async function S(){if(T.value=!1,await d.requestMicrophone()){await d.checkMicPermission();return}g.value==="denied"&&(T.value=!0,setTimeout(()=>{T.value=!1},6e3))}const _=k(!1),U=k("");function H(){const b=U.value.trim();b.startsWith("sfr:")&&(a("join-by-token",b),U.value="")}const oe=k(null),X=k(null),I=k(null);function ae(b){I.value=b}function ce(b){X.value=null,oe.value=oe.value===b?null:b}function w(b){oe.value=null,X.value=X.value===b?null:b}function m(b,i){const P=r.roomSettings[b];return P&&i in P?P[i]:(b==="big_room"?n:s)[i]}function h(b,i){const P=i.target.value;a("update-room-settings",b,{publicName:P})}function v(b,i){const P=i.target.value;a("update-room-settings",b,{publicDescription:P})}function f(b,i){const P=i.target.value;a("update-room-settings",b,{password:P})}const y=Pe(()=>r.authenticated?r.environments:r.environments.filter(b=>!b.hidden)),M=Pe({get:()=>r.displayName,set:b=>a("update:displayName",b)}),B=Pe({get:()=>r.editMode,set:b=>a("update:editMode",b)}),R=k("rooms"),ne=k(),G=k(),$=k(),Z=k(0),de=k(3),re=Pe(()=>de.value===1),ve=Pe(()=>re.value?y.value.length:Math.max(1,Math.ceil(y.value.length/de.value))),ue=Pe(()=>{const b=y.value.length,i=de.value;if(re.value)return y.value;if(Z.value>=ve.value-1&&b>i)return y.value.slice(b-i);const P=Z.value*i;return y.value.slice(P,P+i)});function V(){Z.value>0&&Z.value--}function J(){Z.value<ve.value-1&&Z.value++}function ie(){const b=window.innerWidth;if(b<640){de.value=1;return}const i=404,P=Math.min(b-48,1152);de.value=Math.max(1,Math.floor(P/i))}Tt(()=>{ie(),window.addEventListener("resize",ie)}),Pn(()=>{window.removeEventListener("resize",ie)});const pt=Pa();In(ne,b=>{b&&(pt.lobbyCanvas.value=b)}),In(G,b=>{b&&(pt.roomScrollContainer.value=b)});let Q=null,Et=null;Tt(()=>{const b=$.value;if(!b)return;b.width=480,b.height=270;const i=b.getContext("2d");if(!i)return;Q=document.createElement("video"),Q.muted=!0,Q.loop=!0,Q.playsInline=!0,Q.preload="auto",Q.setAttribute("muted",""),Q.setAttribute("playsinline",""),Q.src="/data/appdata/video/loby-background.mp4";const P=Q;P.addEventListener("pause",()=>{P.readyState>=2&&setTimeout(()=>P.play().catch(()=>{}),50)}),P.play().catch(()=>{const Se=()=>{P.play().catch(()=>{})};document.addEventListener("click",Se,{once:!0}),document.addEventListener("touchstart",Se,{once:!0})});const Ke=()=>{P.readyState>=2&&!P.paused&&i.drawImage(P,0,0,480,270),P.paused&&P.readyState>=2&&P.play().catch(()=>{})};if("requestVideoFrameCallback"in P){const Se=()=>{Ke(),Q&&P.requestVideoFrameCallback(Se)};P.requestVideoFrameCallback(Se)}else Et=bt(Ke,42)}),Pn(()=>{Et&&(clearInterval(Et),Et=null),Q&&(Q.pause(),Q.removeAttribute("src"),Q.load(),Q=null)});let Cn=0,_n=0,En=!1;function Po(b){Cn=b.touches[0].clientX,_n=b.touches[0].clientY,En=!!b.target.closest(".lobby-bottom-fade")}function Io(b){if(En)return;const i=b.changedTouches[0].clientX-Cn,P=b.changedTouches[0].clientY-_n;Math.abs(i)>50&&Math.abs(i)>Math.abs(P)*1.5&&(i>0?a("prev-char"):a("next-char"))}function An(){a("save-display-name")}function Mo(b){if(Z.value=b,re.value&&G.value){const i=G.value.querySelectorAll(":scope > div > .flex.flex-col");i[b]&&i[b].scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})}}function Do(b){if(a("room-scroll",b),re.value&&G.value){const i=G.value,P=i.querySelectorAll(":scope > div > .flex.flex-col");if(!P.length)return;const Ke=i.scrollLeft+i.clientWidth/2;let Se=0,u=1/0;for(let z=0;z<P.length;z++){const Tn=P[z],No=Tn.offsetLeft+Tn.offsetWidth/2,Rn=Math.abs(No-Ke);Rn<u&&(u=Rn,Se=z)}Z.value=Se}}return(b,i)=>{const P=Oo,Ke=Us,Se=ba;return p(),x("div",{class:"absolute inset-0 z-30 lobby-bg overflow-hidden",onTouchstartPassive:Po,onTouchend:Io},[e.guestMode?N("",!0):(p(),x("button",{key:0,onClick:i[0]||(i[0]=u=>l.value=!0),class:"absolute top-3 left-3 z-30 p-2 text-white/40 hover:text-white/70 transition-colors"},[A(c(Zo),{class:"w-6 h-6"})])),i[53]||(i[53]=Bo('<div class="lobby-particle lobby-p1" data-v-03547be6></div><div class="lobby-particle lobby-p2" data-v-03547be6></div><div class="lobby-particle lobby-p3" data-v-03547be6></div><div class="lobby-particle lobby-p4" data-v-03547be6></div><div class="lobby-particle lobby-p5" data-v-03547be6></div><div class="lobby-particle lobby-p6" data-v-03547be6></div><div class="lobby-particle lobby-p7" data-v-03547be6></div><div class="lobby-particle lobby-p8" data-v-03547be6></div>',8)),o("canvas",{ref_key:"videoBgCanvas",ref:$,class:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{filter:"blur(4px)",opacity:"0.35"}},null,512),o("div",{ref_key:"lobbyCanvasEl",ref:ne,class:"absolute inset-0 z-[1]",onWheel:i[1]||(i[1]=xe(u=>b.$emit("lobby-wheel",u),["prevent"]))},null,544),i[54]||(i[54]=o("div",{class:"absolute inset-0 pointer-events-none lobby-vignette z-[2]"},null,-1)),e.guestMode?(p(),x("div",br,[o("div",yr,[o("div",{class:ee(["w-2 h-2 rounded-full",e.guestConnected?"bg-emerald-400 animate-pulse":"bg-gray-600"])},null,2),o("span",null,pe(e.guestOnlineCount??0)+" online",1)])])):N("",!0),A(Oe,{"enter-active-class":"transition-opacity duration-300","leave-active-class":"transition-opacity duration-300","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[e.lobbyCharLoading?(p(),x("div",vr,[...i[28]||(i[28]=[o("div",{class:"w-14 h-14 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin"},null,-1)])])):N("",!0)]),_:1}),o("div",gr,[o("div",wr,[i[34]||(i[34]=o("img",{src:"/data/appdata/images/SCHEDULE-4-REAL.svg",alt:"Schedule 4 Real",class:"mx-auto h-16 sm:h-24 select-none lobby-title-glow",draggable:"false"},null,-1)),i[35]||(i[35]=o("div",{class:"mx-auto mt-2 h-px w-56 bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent"},null,-1)),o("div",xr,[!e.authenticated&&!e.guestMode?(p(),x("div",kr,[...i[29]||(i[29]=[o("span",{class:"text-yellow-400/70 text-base font-medium"},"Guest Mode",-1)])])):N("",!0),c(g)==="denied"||c(g)==="error"||c(g)==="unavailable"?(p(),x("button",{key:1,onClick:S,class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-red-500/10 border-red-500/30 text-red-400 hover:bg-red-500/20 relative"},[A(c($n),{class:"w-3.5 h-3.5"}),i[31]||(i[31]=o("span",null,"Enable Mic",-1)),c(T)?(p(),x("div",Sr,[...i[30]||(i[30]=[o("p",{class:"text-red-300 text-base font-medium mb-1"},"Mic blocked by browser",-1),o("p",{class:"text-white/50 text-base leading-snug"},"Click the lock icon in the address bar, find Microphone, set to Allow, then reload.",-1)])])):N("",!0)])):c(g)==="prompt"?(p(),x("button",{key:2,onClick:S,class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-amber-500/10 border-amber-500/30 text-amber-400 hover:bg-amber-500/20"},[A(c($n),{class:"w-3.5 h-3.5"}),i[32]||(i[32]=o("span",null,"Enable Mic",-1))])):N("",!0),e.authenticated&&!e.guestMode?(p(),x("button",{key:3,onClick:i[2]||(i[2]=u=>_.value=!0),class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full bg-black/40 border border-white/10 text-white/40 hover:text-emerald-400 hover:border-emerald-500/30 hover:bg-emerald-500/10 transition-all text-base font-medium",title:"How privacy works"},[A(c(ms),{class:"w-3.5 h-3.5"}),i[33]||(i[33]=o("span",null,"Privacy info",-1))])):N("",!0)])]),A(P,null,{default:Ce(()=>[e.isDev&&e.authenticated?(p(),x("div",Cr,[o("label",_r,[Qe(o("input",{type:"checkbox","onUpdate:modelValue":i[3]||(i[3]=u=>He(B)?B.value=u:null),class:"sr-only peer"},null,512),[[Ko,c(B)]]),i[36]||(i[36]=o("div",{class:"w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-amber-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"},null,-1))]),i[37]||(i[37]=o("span",{class:"text-amber-400 text-base font-medium"},"Asset Editing Mode",-1))])):N("",!0)]),_:1})]),e.availableCharacters.length>1?(p(),x("button",{key:2,onClick:i[4]||(i[4]=u=>b.$emit("prev-char")),class:"absolute left-2 sm:left-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[A(c(Nn),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):N("",!0),e.availableCharacters.length>1?(p(),x("button",{key:3,onClick:i[5]||(i[5]=u=>b.$emit("next-char")),class:"absolute right-2 sm:right-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[A(c(Mn),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):N("",!0),o("div",Er,[e.guestMode?(p(),x("div",Ar,[e.availableCharacters.length>1?(p(),x("div",Tr,[(p(!0),x(et,null,tt(e.availableCharacters,(u,z)=>(p(),x("div",{key:z,class:ee(["h-1.5 rounded-full transition-all duration-300",z===e.carouselSelectedIdx?"bg-emerald-400 w-4":"bg-white/15 w-1.5"])},null,2))),128))])):N("",!0),Qe(o("input",{"onUpdate:modelValue":i[6]||(i[6]=u=>He(M)?M.value=u:null),type:"text",placeholder:"Enter your name",maxlength:"20",onBlur:i[7]||(i[7]=u=>An()),class:"w-full bg-black/60 border border-white/20 rounded-xl px-4 py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors mb-3"},null,544),[[ht,c(M)]]),o("button",{onClick:i[8]||(i[8]=u=>b.$emit("enter-room")),disabled:!e.guestReady||e.lobbyCharLoading,class:"w-full py-3 rounded-xl font-bold text-base text-white transition-all bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25"}," Enter Room ",8,Rr),e.hideTokenPaste?N("",!0):(p(),x("div",Pr,[o("div",Ir,[A(c(ao),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),Qe(o("input",{"onUpdate:modelValue":i[9]||(i[9]=u=>He(U)?U.value=u:null),type:"text",placeholder:"Paste invite token",onKeyup:tn(H,["enter"]),class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors font-mono"},null,544),[[ht,c(U)]])]),o("button",{onClick:H,disabled:!c(U).startsWith("sfr:"),class:"px-3 py-2 rounded-xl bg-emerald-500/25 border border-emerald-500/30 text-emerald-400 text-base font-bold hover:bg-emerald-500/35 transition-all disabled:opacity-20 disabled:cursor-not-allowed flex-shrink-0"}," Join ",8,Mr)]))])):(p(),x("div",Dr,[o("div",Nr,[e.availableCharacters.length>1?(p(),x("div",Or,[(p(!0),x(et,null,tt(e.availableCharacters,(u,z)=>(p(),x("div",{key:z,class:ee(["w-1.5 h-1.5 rounded-full transition-all duration-300",z===e.carouselSelectedIdx?"bg-emerald-400 w-4 rounded-full":"bg-white/15"])},null,2))),128))])):N("",!0),o("div",Ur,[Qe(o("input",{"onUpdate:modelValue":i[10]||(i[10]=u=>He(M)?M.value=u:null),type:"text",placeholder:"Your name",maxlength:"20",onBlur:i[11]||(i[11]=u=>An()),class:"pointer-events-auto w-48 sm:w-56 bg-black/60 border border-white/20 rounded-xl px-4 py-2 sm:py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,544),[[ht,c(M)]])])]),o("div",$r,[i[39]||(i[39]=o("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-r from-transparent to-white/10"},null,-1)),o("div",Lr,[o("button",{onClick:i[12]||(i[12]=u=>R.value="rooms"),class:ee(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all",c(R)==="rooms"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])}," My Rooms ",2),o("button",{onClick:i[13]||(i[13]=u=>R.value="public"),class:ee(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all flex items-center gap-1.5",c(R)==="public"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])},[A(c(un),{class:"w-3.5 h-3.5"}),i[38]||(i[38]=q(" Public ",-1))],2)]),i[40]||(i[40]=o("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-l from-transparent to-white/10"},null,-1))]),A(Ke,{modelValue:c(_),"onUpdate:modelValue":i[14]||(i[14]=u=>He(_)?_.value=u:null)},null,8,["modelValue"]),c(R)==="rooms"?(p(),x("div",Vr,[A(Oe,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(Z)>0?(p(),x("button",{key:0,onClick:V,class:"hidden sm:flex absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[A(c(Nn),{class:"w-4 h-4 text-white/60"})])):N("",!0)]),_:1}),o("div",{ref_key:"roomScrollEl",ref:G,onScroll:Do,class:"flex gap-3 sm:gap-5 overflow-x-auto snap-x snap-mandatory scrollbar-hide sm:overflow-visible sm:justify-center sm:px-0 items-start",style:zo(c(re)?"padding-left: 7.5vw; padding-right: 7.5vw;":"")},[A(jo,{name:"room-card",tag:"div",class:"contents"},{default:Ce(()=>[(p(!0),x(et,null,tt(c(ue),u=>(p(),x("div",{key:u.id,class:"flex flex-col items-stretch w-[85vw] sm:w-96 snap-center flex-shrink-0"},[o("div",Br,[o("button",{onClick:z=>b.$emit("select-environment",u,c(M).trim()||void 0),class:"w-full text-left"},[o("div",jr,[u.image?(p(),x("img",{key:0,src:u.image,alt:u.name,class:"w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"},null,8,Kr)):(p(),x("div",Wr,[(p(),be(Wo(u.icon),{class:"w-12 h-12 text-white/15"}))])),i[42]||(i[42]=o("div",{class:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-black/30"},null,-1)),u.hidden&&e.authenticated?(p(),x("div",Fr,[...i[41]||(i[41]=[o("span",{class:"text-amber-400 text-base font-medium"},"Hidden",-1)])])):N("",!0),o("div",Hr,[o("h3",Yr,pe(m(u.id,"publicName")||u.name),1),m(u.id,"publicDescription")?(p(),x("p",Gr,pe(m(u.id,"publicDescription")),1)):N("",!0)]),i[43]||(i[43]=o("div",{class:"hidden sm:flex absolute inset-0 items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"},[o("div",{class:"w-14 h-14 rounded-full bg-emerald-500/20 backdrop-blur-sm flex items-center justify-center border border-emerald-400/30"},[o("svg",{class:"w-6 h-6 text-emerald-300 ml-0.5",fill:"currentColor",viewBox:"0 0 24 24"},[o("path",{d:"M8 5v14l11-7z"})])])],-1))])],8,zr),e.authenticated?(p(),x("div",{key:0,class:"sm:hidden absolute top-2 left-2 flex items-center gap-1.5 z-10",onClick:i[15]||(i[15]=xe(()=>{},["stop"]))},[o("button",{onClick:z=>ae(u.id),class:"flex items-center gap-1 px-2 py-1 rounded-lg bg-black/60 backdrop-blur-sm border border-white/15 text-white/60 active:bg-white/15 transition-all text-base font-bold"},[A(c(hs),{class:"w-3.5 h-3.5"}),i[44]||(i[44]=o("span",null,"Options",-1))],8,Jr),e.inviteTokens[u.id]?(p(),x("button",{key:0,onClick:xe(z=>b.$emit("copy-link",u.id),["prevent"]),class:ee(["flex items-center gap-1 px-2 py-1 rounded-lg backdrop-blur-sm border transition-all text-base font-bold",e.copiedToken===u.id?"bg-emerald-500/30 border-emerald-500/40 text-emerald-300":"bg-black/60 border-white/15 text-white/60 active:bg-white/15"])},[e.copiedToken!==u.id?(p(),be(c(Un),{key:0,class:"w-3.5 h-3.5"})):(p(),be(c(On),{key:1,class:"w-3.5 h-3.5"})),o("span",null,pe(e.copiedToken===u.id?"Copied!":"Link"),1)],10,Zr)):N("",!0)])):N("",!0),e.authenticated?(p(),x("div",{key:1,class:"hidden sm:block bg-black/80 border-t border-white/[0.08] px-3 py-1.5",onClick:i[16]||(i[16]=xe(()=>{},["stop"]))},[o("div",qr,[o("div",Xr,[o("label",Qr,[o("div",ei,[o("input",{type:"checkbox",checked:m(u.id,"isPublic"),onChange:z=>b.$emit("update-room-settings",u.id,{isPublic:!m(u.id,"isPublic")}),class:"sr-only peer"},null,40,ti),i[45]||(i[45]=o("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),o("span",{class:ee(["text-base",m(u.id,"isPublic")?"text-emerald-400/80":"text-white/35"])},pe(m(u.id,"isPublic")?"Public visible":"Not public"),3)]),o("label",ni,[o("div",oi,[o("input",{type:"checkbox",checked:!m(u.id,"inviteOnly"),onChange:z=>b.$emit("update-room-settings",u.id,{inviteOnly:!m(u.id,"inviteOnly")}),class:"sr-only peer"},null,40,si),i[46]||(i[46]=o("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),o("span",{class:ee(["text-base",m(u.id,"inviteOnly")?"text-white/35":"text-sky-400/80"])},pe(m(u.id,"inviteOnly")?"Hidden on lobby":"Visible on lobby"),3)])]),o("div",ai,[o("button",{onClick:z=>w(u.id),class:ee(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",[m(u.id,"password")?"text-amber-400 bg-amber-500/10":"text-white/30 hover:text-white/50",c(X)===u.id?"ring-1 ring-amber-500/40":""]])},[m(u.id,"password")?(p(),be(c(rt),{key:0,class:"w-3.5 h-3.5"})):(p(),be(c(qo),{key:1,class:"w-3.5 h-3.5"})),o("span",null,pe(m(u.id,"password")?"Password set":"No password"),1)],10,ri),o("button",{onClick:z=>ce(u.id),class:ee(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",c(oe)===u.id?"text-emerald-400 bg-emerald-500/10 ring-1 ring-emerald-500/40":"text-white/30 hover:text-white/50"])},[A(c(Dn),{class:"w-3.5 h-3.5"}),i[47]||(i[47]=o("span",null,"Edit info",-1))],10,ii),i[48]||(i[48]=o("div",{class:"flex-1"},null,-1)),e.inviteTokens[u.id]?(p(),x("button",{key:0,onClick:xe(z=>b.$emit("copy-link",u.id),["prevent"]),class:ee(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",e.copiedToken===u.id?"text-emerald-400 bg-emerald-500/10":"text-white/30 hover:text-white/50"])},[e.copiedToken!==u.id?(p(),be(c(Un),{key:0,class:"w-3.5 h-3.5"})):(p(),be(c(On),{key:1,class:"w-3.5 h-3.5"})),o("span",null,pe(e.copiedToken===u.id?"Copied!":"Copy link"),1)],10,li)):N("",!0)])])])):N("",!0)]),A(Oe,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:Ce(()=>[c(oe)===u.id?(p(),x("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-white/[0.12] rounded-xl px-3 py-2 space-y-1.5",onClick:i[17]||(i[17]=xe(()=>{},["stop"]))},[o("input",{type:"text",value:m(u.id,"publicName"),maxlength:"60",placeholder:u.name,onBlur:z=>h(u.id,z),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,ci),o("input",{type:"text",value:m(u.id,"publicDescription"),maxlength:"200",placeholder:"Short description...",onBlur:z=>v(u.id,z),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,di)])):N("",!0)]),_:2},1024),A(Oe,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:Ce(()=>[c(X)===u.id?(p(),x("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-amber-500/20 rounded-xl px-3 py-2",onClick:i[18]||(i[18]=xe(()=>{},["stop"]))},[o("div",ui,[A(c(rt),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),o("input",{type:"text",value:m(u.id,"password"),maxlength:"32",placeholder:"Room password (leave empty to remove)",onBlur:z=>f(u.id,z),class:"flex-1 bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,fi)])])):N("",!0)]),_:2},1024)]))),128))]),_:1})],36),A(Oe,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(Z)<c(ve)-1?(p(),x("button",{key:0,onClick:J,class:"hidden sm:flex absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[A(c(Mn),{class:"w-4 h-4 text-white/60"})])):N("",!0)]),_:1})])):N("",!0),c(R)==="rooms"&&c(ve)>1?(p(),x("div",pi,[(p(!0),x(et,null,tt(c(ve),u=>(p(),x("button",{key:u,onClick:z=>Mo(u-1),class:ee(["h-1.5 rounded-full transition-all duration-300 cursor-pointer",u-1===c(Z)?"bg-emerald-400 w-5":"bg-white/15 w-1.5 hover:bg-white/30"])},null,10,mi))),128))])):N("",!0),c(R)==="public"?(p(),x("div",hi,[A(Se,{authenticated:e.authenticated,onJoinPublicRoom:i[19]||(i[19]=u=>b.$emit("join-public-room",u))},null,8,["authenticated"])])):N("",!0)]))]),(p(),be(eo,{to:"body"},[A(Oe,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-150","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(I)?(p(),x("div",{key:0,class:"fixed inset-0 z-[100] flex items-end justify-center bg-black/70 backdrop-blur-sm",onClick:i[27]||(i[27]=xe(u=>I.value=null,["self"]))},[A(Oe,{"enter-active-class":"transition-transform duration-200 ease-out","enter-from-class":"translate-y-full","leave-active-class":"transition-transform duration-150 ease-in","leave-to-class":"translate-y-full"},{default:Ce(()=>[c(I)?(p(),x("div",{key:0,class:"w-full max-w-md bg-gray-900/95 backdrop-blur-xl border-t border-white/15 rounded-t-3xl px-5 py-5 pb-8 space-y-5",onClick:i[26]||(i[26]=xe(()=>{},["stop"]))},[o("div",bi,[i[49]||(i[49]=o("h3",{class:"text-white font-bold text-lg"},"Room Options",-1)),o("button",{onClick:i[20]||(i[20]=u=>I.value=null),class:"p-2 -mr-2 text-white/40 active:text-white/70"},[A(c(to),{class:"w-5 h-5"})])]),o("div",yi,[o("label",vi,[o("span",{class:ee(["text-base font-medium",m(c(I),"isPublic")?"text-emerald-400":"text-white/50"])}," Public visible ",2),o("div",gi,[o("input",{type:"checkbox",checked:m(c(I),"isPublic"),onChange:i[21]||(i[21]=u=>b.$emit("update-room-settings",c(I),{isPublic:!m(c(I),"isPublic")})),class:"sr-only peer"},null,40,wi),i[50]||(i[50]=o("div",{class:"w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-4 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all"},null,-1))])]),o("label",xi,[o("span",{class:ee(["text-base font-medium",m(c(I),"inviteOnly")?"text-white/50":"text-sky-400"])}," Visible on lobby ",2),o("div",ki,[o("input",{type:"checkbox",checked:!m(c(I),"inviteOnly"),onChange:i[22]||(i[22]=u=>b.$emit("update-room-settings",c(I),{inviteOnly:!m(c(I),"inviteOnly")})),class:"sr-only peer"},null,40,Si),i[51]||(i[51]=o("div",{class:"w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-4 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all"},null,-1))])])]),o("div",Ci,[o("div",_i,[A(c(rt),{class:ee(["w-4 h-4",m(c(I),"password")?"text-amber-400":"text-white/30"])},null,8,["class"]),o("span",{class:ee(["text-base font-medium",m(c(I),"password")?"text-amber-400":"text-white/40"])},"Password",2)]),o("input",{type:"text",value:m(c(I),"password"),maxlength:"32",placeholder:"Room password (leave empty to remove)",onBlur:i[23]||(i[23]=u=>f(c(I),u)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,Ei)]),o("div",Ai,[o("div",Ti,[A(c(Dn),{class:"w-4 h-4 text-white/40"}),i[52]||(i[52]=o("span",{class:"text-base font-medium text-white/40"},"Public info",-1))]),o("input",{type:"text",value:m(c(I),"publicName"),maxlength:"60",placeholder:e.environments.find(u=>u.id===c(I))?.name||"Room name",onBlur:i[24]||(i[24]=u=>h(c(I),u)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,Ri),o("input",{type:"text",value:m(c(I),"publicDescription"),maxlength:"200",placeholder:"Short description...",onBlur:i[25]||(i[25]=u=>v(c(I),u)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,Pi)])])):N("",!0)]),_:1})])):N("",!0)]),_:1})]))],32)}}}),yl=Object.assign(fn(Ii,[["__scopeId","data-v-03547be6"]]),{__name:"Room3dLobby"});let C=null,lt=null,Lt=0,je=null,Ao,To,ln,xt=!1;const Mi=15e3;let en=0;const Di=50;let At={x:0,y:0,z:0},Jn=0,Zn="";const qn=.01,Xn=.02;let Vt=null,Bt=null,zt=null,at=null,jt=null,Kt=null,Wt=null,cn=null;const kt=[],_t=k(!1),Ft=k(!1),xn=k(""),ye=k(new Map),Ni=Pe(()=>ye.value.size+(_t.value?1:0));function vl(){return{connected:_t,wsConnected:Ft,localPeerId:xn,playerCount:Ni,remotePlayers:ye,connect:Zi,joinRoom:qi,leaveRoom:kn,sendLocalState:Qi,sendRoomStateChanged:Ji,onPlayerMoved:Ui,onRoomStateChanged:$i,onPlayersInit:Oi,sendObjectDelta:Vi,onObjectDelta:Li,sendVoiceSignal:Bi,sendVoiceState:zi,sendVoiceRelay:ji,onVoiceSignal:Ki,onVoiceState:Wi,getRoomId:()=>je,onPlayerLeft:Fi,sendTVChanged:Gi,onTVChanged:Hi,onServerError:Yi,dispose:el}}function Oi(e){zt=e}function Ui(e){Vt=e}function $i(e){Bt=e}let Ht=null;function Li(e){Ht=e}function Vi(e){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify(e))}catch{}}function Bi(e,t,n){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify({type:t,target:e,...n}))}catch{}}function zi(e){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify({type:"voice:state",...e}))}catch{}}function ji(e,t){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify({type:"voice:relay",audio:e,sr:t}))}catch{}}function Ki(e){if(at=e,e&&kt.length>0){const t=kt.splice(0);(async()=>{for(const n of t)try{await e(n.from,n.type,n.data)}catch{}})()}}function Wi(e){jt=e}function Fi(e){Kt=e}function Hi(e){Wt=e}function Yi(e){cn=e}function Gi(e,t){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify({type:"tv:changed",tvId:e,channelUrl:t}))}catch{}}function Ji(){if(!(!C||C.readyState!==WebSocket.OPEN))try{C.send(JSON.stringify({type:"room:state-changed"}))}catch{}}let Dt=null;function Zi(){xt=!1,!(C&&(C.readyState===WebSocket.OPEN||C.readyState===WebSocket.CONNECTING))&&Sn()}function qi(e,t,n,s,r){je&&kn(),je=e,Ao=t,To=s,ln=r,Dt=n||null,C&&C.readyState===WebSocket.OPEN?Ro():(!C||C.readyState===WebSocket.CLOSED)&&Sn()}function kn(){if(je&&C&&C.readyState===WebSocket.OPEN)try{C.send(JSON.stringify({type:"leave"}))}catch{}je=null,ye.value=new Map,_t.value=!1,xn.value=""}const Xi=3e4;function Qi(e,t,n){if(!C||C.readyState!==WebSocket.OPEN)return;const s=Date.now();if(s-en<Di)return;const r=s-en>Xi;if(!(ye.value.size===0&&!r)){if(!r){const a=e.x-At.x,l=e.y-At.y,d=e.z-At.z,g=a*a+l*l+d*d,T=Math.abs(t-Jn),S=T>Xn&&T<Math.PI*2-Xn;if(g<qn*qn&&!S&&n===Zn)return}en=s,At={...e},Jn=t,Zn=n;try{C.send(JSON.stringify({type:"move",position:e,rotationY:t,animation:n}))}catch{}}}function el(){xt=!0,kn(),tl(),Vt=null,Bt=null,zt=null,Ht=null,at=null,jt=null,Kt=null,Wt=null,kt.length=0}function Ro(){if(!C||C.readyState!==WebSocket.OPEN||!je)return;const e={type:"join",roomId:je,displayName:Ao,characterModel:To,position:Dt};ln&&(e.password=ln),C.send(JSON.stringify(e)),Dt&&C.send(JSON.stringify({type:"move",position:Dt,rotationY:0,animation:"idle"}))}function Sn(){if(C){const n=C;n.onclose=null,n.onmessage=null,n.onerror=null,n.onopen=null;try{n.close()}catch{}C=null}const t=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_room3d-ws`;try{C=new WebSocket(t)}catch{Qn();return}C.onopen=()=>{Lt=0,Ft.value=!0,je&&Ro()},C.onmessage=n=>{let s;try{s=JSON.parse(typeof n.data=="string"?n.data:"")}catch{return}nl(s)},C.onclose=n=>{Ft.value=!1,_t.value=!1,xt||Qn()},C.onerror=n=>{}}function tl(){if(lt&&(clearTimeout(lt),lt=null),Lt=0,C){const e=C;e.onclose=null,e.onmessage=null,e.onerror=null,e.onopen=null;try{e.close()}catch{}C=null}Ft.value=!1}function Qn(){if(lt||xt)return;const e=Math.min(1e3*Math.pow(2,Lt),Mi);Lt++,lt=setTimeout(()=>{lt=null,xt||Sn()},e)}function nl(e){switch(e.type){case"init":{xn.value=e.peerId,_t.value=!0;const t=new Map;for(const n of e.players||[])t.set(n.peerId,{peerId:n.peerId,displayName:n.displayName,characterModel:n.characterModel||"",color:n.color,position:n.position||{x:0,y:0,z:0},rotationY:n.rotationY||0,animation:n.animation||"idle",timestamp:Date.now()});ye.value=t,zt&&t.size>0&&zt([...t.values()]);break}case"player:joined":{const t=e.player;if(!t)break;const n=new Map(ye.value);n.set(t.peerId,{peerId:t.peerId,displayName:t.displayName,characterModel:t.characterModel||"",color:t.color,position:t.position||{x:0,y:0,z:0},rotationY:t.rotationY||0,animation:t.animation||"idle",timestamp:Date.now()}),ye.value=n;break}case"player:moved":{Vt&&Vt(e.peerId,e.position,e.rotationY,e.animation,e.seq??0);const t=ye.value.get(e.peerId);if(t)t.position=e.position,t.rotationY=e.rotationY,t.animation=e.animation,t.timestamp=Date.now();else{const n=new Map(ye.value);n.set(e.peerId,{peerId:e.peerId,displayName:e.peerId.slice(0,6),characterModel:"",color:"#60a5fa",position:e.position,rotationY:e.rotationY,animation:e.animation||"idle",timestamp:e.timestamp}),ye.value=n}break}case"player:left":{Kt&&Kt(e.peerId);const t=new Map(ye.value);t.delete(e.peerId),ye.value=t;break}case"room:state-changed":{Bt&&Bt();break}case"object:placed":case"object:deleted":case"object:moved":{Ht&&Ht(e);break}case"voice:offer":case"voice:answer":case"voice:ice":{at?at(e.from,e.type,e):kt.length<50&&kt.push({from:e.from,type:e.type,data:e});break}case"voice:relay":{at&&at(e.from,e.type,e);break}case"tv:changed":{Wt&&Wt(e.peerId,e.tvId,e.channelUrl??null);break}case"voice:state":{jt&&jt(e.peerId,{muted:e.muted,speaking:e.speaking});break}case"error":{cn&&cn(e.code,e.message);break}}}export{yl as _,Pa as a,vl as b,hr as c,Fs as d,ao as e,Un as r,Gs as u};
