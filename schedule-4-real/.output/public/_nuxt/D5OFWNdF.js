import{_ as qn}from"./9dOeXmI9.js";import{o as h,c as x,a as e,e as ws,x as ve,b as k,w as Ce,h as c,n as Q,d as P,f as O,I as ge,G as Le,T as bn,l as S,a0 as He,a1 as Xn,_ as Qn,g as Mt,i as st,v as wt,k as Ye,t as he,F as nt,r as ot,j as cs,m as Pe,K as eo,y as to,L as js,A as Vs,E as so,q as no,a2 as oo,H as ao,B as ro}from"./CrOvi5ql.js";import{r as yn}from"./DLeZR4-D.js";import{Y as zs,f as io,u as lo,d as co,Z as uo,_ as po,X as fo}from"./DGrIGiqA.js";import{aG as Ze,q as mo,r as ho,W as bo,ar as yo,p as vo,aD as wo,aH as xo,D as ts,az as go,A as ko,t as vn,o as So,k as Co,V as Ro,aI as Ks}from"./B-1bL4-x.js";import{r as ds}from"./DrMtWeIT.js";import{r as Eo}from"./DXygS-hN.js";import{r as Ut}from"./r0gahtD5.js";import{r as Fs,a as Ao}from"./C3gWS42n.js";import{r as _o}from"./DspdD5uO.js";import{_ as xs}from"./DlAUqK2U.js";import{s as ct}from"./CZklLOuI.js";import{a as To,b as Po,G as wn,r as Io,c as Ws}from"./BVUotoKX.js";import{r as Hs}from"./CQFNeBSk.js";import{r as Mo,a as Ys}from"./Cc7Ca6Qt.js";function Do(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"})])}function ss(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"fill-rule":"evenodd",d:"M14.447 3.026a.75.75 0 0 1 .527.921l-4.5 16.5a.75.75 0 0 1-1.448-.394l4.5-16.5a.75.75 0 0 1 .921-.527ZM16.72 6.22a.75.75 0 0 1 1.06 0l5.25 5.25a.75.75 0 0 1 0 1.06l-5.25 5.25a.75.75 0 1 1-1.06-1.06L21.44 12l-4.72-4.72a.75.75 0 0 1 0-1.06Zm-9.44 0a.75.75 0 0 1 0 1.06L2.56 12l4.72 4.72a.75.75 0 0 1-1.06 1.06L.97 12.53a.75.75 0 0 1 0-1.06l5.25-5.25a.75.75 0 0 1 1.06 0Z","clip-rule":"evenodd"})])}function Js(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{d:"M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 0 1 3.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0 1 21 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 0 1 7.5 16.125V3.375Z"}),e("path",{d:"M15 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 17.25 7.5h-1.875A.375.375 0 0 1 15 7.125V5.25ZM4.875 6H6v10.125A3.375 3.375 0 0 0 9.375 19.5H16.5v1.125c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V7.875C3 6.839 3.84 6 4.875 6Z"})])}function Gs(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{d:"M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577a11.217 11.217 0 0 1 4.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z"}),e("path",{d:"M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z"}),e("path",{d:"M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z"})])}function xn(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"fill-rule":"evenodd",d:"M15.75 1.5a6.75 6.75 0 0 0-6.651 7.906c.067.39-.032.717-.221.906l-6.5 6.499a3 3 0 0 0-.878 2.121v2.818c0 .414.336.75.75.75H6a.75.75 0 0 0 .75-.75v-1.5h1.5A.75.75 0 0 0 9 19.5V18h1.5a.75.75 0 0 0 .53-.22l2.658-2.658c.19-.189.517-.288.906-.22A6.75 6.75 0 1 0 15.75 1.5Zm0 3a.75.75 0 0 0 0 1.5A2.25 2.25 0 0 1 18 8.25a.75.75 0 0 0 1.5 0 3.75 3.75 0 0 0-3.75-3.75Z","clip-rule":"evenodd"})])}function Zs(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{"fill-rule":"evenodd",d:"M19.902 4.098a3.75 3.75 0 0 0-5.304 0l-4.5 4.5a3.75 3.75 0 0 0 1.035 6.037.75.75 0 0 1-.646 1.353 5.25 5.25 0 0 1-1.449-8.45l4.5-4.5a5.25 5.25 0 1 1 7.424 7.424l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.757-1.757a3.75 3.75 0 0 0 0-5.304Zm-7.389 4.267a.75.75 0 0 1 1-.353 5.25 5.25 0 0 1 1.449 8.45l-4.5 4.5a5.25 5.25 0 1 1-7.424-7.424l1.757-1.757a.75.75 0 1 1 1.06 1.06l-1.757 1.757a3.75 3.75 0 1 0 5.304 5.304l4.5-4.5a3.75 3.75 0 0 0-1.035-6.037.75.75 0 0 1-.354-1Z","clip-rule":"evenodd"})])}function qs(t,s){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[e("path",{d:"M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z"}),e("path",{d:"M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.751 6.751 0 0 1-6 6.709v2.291h3a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5h3v-2.291a6.751 6.751 0 0 1-6-6.709v-1.5A.75.75 0 0 1 6 10.5Z"})])}const Oo={class:"relative w-full max-w-3xl max-h-[85vh] flex flex-col rounded-2xl border border-white/10 bg-gray-950/95 shadow-2xl overflow-hidden"},No={class:"p-6 pb-4 border-b border-white/[0.06]"},Lo={class:"flex items-center gap-3"},$o={class:"w-10 h-10 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center"},Uo={class:"flex gap-2 mt-4"},Bo={class:"flex-1 overflow-y-auto custom-scrollbar"},jo={key:0,class:"p-6 space-y-6"},Vo={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},zo={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},Ko={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},Fo={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},Wo={class:"space-y-3"},Ho={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},Yo={class:"flex items-center gap-2 mb-2"},Jo={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},Go={class:"flex items-center gap-2 mb-2"},Zo={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},qo={class:"bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-5"},Xo={class:"flex items-start gap-3"},Qo={key:1,class:"p-6 space-y-6"},ea={class:"bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 flex items-start gap-3"},ta={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},sa={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},na={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},oa={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},aa={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},ra={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},ia={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},la={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},ca={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},da=ws({__name:"Room3dPrivacyInfo",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(t,{emit:s}){const n=s,a=S("simple");function r(){n("update:modelValue",!1)}return(i,o)=>(h(),ve(bn,{to:"body"},[k(Le,{"enter-active-class":"transition-all duration-300","leave-active-class":"transition-all duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[t.modelValue?(h(),x("div",{key:0,class:"fixed inset-0 z-[200] flex items-center justify-center p-4",onClick:ge(r,["self"])},[o[43]||(o[43]=e("div",{class:"absolute inset-0 bg-black/80 backdrop-blur-sm"},null,-1)),e("div",Oo,[e("button",{onClick:r,class:"absolute top-4 right-4 z-10 p-1.5 rounded-lg text-white/40 hover:text-white/80 hover:bg-white/10 transition-all"},[k(c(yn),{class:"w-5 h-5"})]),e("div",No,[e("div",Lo,[e("div",$o,[k(c(zs),{class:"w-5 h-5 text-emerald-400"})]),o[2]||(o[2]=e("div",null,[e("h2",{class:"text-xl font-bold text-white"},"Anonymous & Private Rooms"),e("p",{class:"text-base text-white/40"},"How your privacy is protected")],-1))]),e("div",Uo,[e("button",{onClick:o[0]||(o[0]=d=>a.value="simple"),class:Q(["px-4 py-2 text-base font-medium rounded-lg transition-all flex items-center gap-2",c(a)==="simple"?"bg-emerald-500/20 text-emerald-400 border border-emerald-500/30":"text-white/40 hover:text-white/60 hover:bg-white/5"])},[k(c(Gs),{class:"w-4 h-4"}),o[3]||(o[3]=P(" Simple ",-1))],2),e("button",{onClick:o[1]||(o[1]=d=>a.value="experts"),class:Q(["px-4 py-2 text-base font-medium rounded-lg transition-all flex items-center gap-2",c(a)==="experts"?"bg-amber-500/20 text-amber-400 border border-amber-500/30":"text-white/40 hover:text-white/60 hover:bg-white/5"])},[k(c(ss),{class:"w-4 h-4"}),o[4]||(o[4]=P(" Experts ",-1))],2)])]),e("div",Bo,[c(a)==="simple"?(h(),x("div",jo,[e("section",null,[e("h3",Vo,[k(c(Ze),{class:"w-5 h-5 text-emerald-400"}),o[5]||(o[5]=P(' What does "Anonymous & Private" mean? ',-1))]),o[6]||(o[6]=e("p",{class:"text-base text-white/60 leading-relaxed"},[P(" When you share your 3D room with someone, "),e("strong",{class:"text-white/80"},"nobody can find out who you are"),P(" or "),e("strong",{class:"text-white/80"},"where your computer is"),P(". Not us, not the servers in between, not anyone listening on the network. Your room is like a secret meeting point that only the people you invite can reach. ")],-1))]),e("section",null,[e("h3",zo,[k(c(ds),{class:"w-5 h-5 text-sky-400"}),o[7]||(o[7]=P(" How does it work? ",-1))]),o[8]||(o[8]=e("p",{class:"text-base text-white/60 leading-relaxed mb-4"},[P(" Imagine you want to send a letter to a friend, but you don't want anyone to know who sent it or who received it. Instead of mailing it directly, you put the letter inside "),e("strong",{class:"text-white/80"},"two sealed envelopes"),P(": ")],-1)),o[9]||(o[9]=e("div",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-5 space-y-4"},[e("div",{class:"flex items-start gap-3"},[e("div",{class:"w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center shrink-0 mt-0.5"},[e("span",{class:"text-emerald-400 font-bold text-base"},"1")]),e("div",null,[e("p",{class:"text-base text-white/80 font-medium"},"You seal the letter in an inner envelope"),e("p",{class:"text-base text-white/50 mt-1"},"Only your friend has the key to open it. The relay servers can never read it.")])]),e("div",{class:"flex items-start gap-3"},[e("div",{class:"w-8 h-8 rounded-full bg-sky-500/20 border border-sky-500/30 flex items-center justify-center shrink-0 mt-0.5"},[e("span",{class:"text-sky-400 font-bold text-base"},"2")]),e("div",null,[e("p",{class:"text-base text-white/80 font-medium"},'You put that inside an outer envelope addressed to "Relay A"'),e("p",{class:"text-base text-white/50 mt-1"},`Relay A opens its envelope and finds instructions: "send this to Relay B". But Relay A can't open the inner envelope â€” it doesn't have the key.`)])]),e("div",{class:"flex items-start gap-3"},[e("div",{class:"w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/30 flex items-center justify-center shrink-0 mt-0.5"},[e("span",{class:"text-purple-400 font-bold text-base"},"3")]),e("div",null,[e("p",{class:"text-base text-white/80 font-medium"},"Relay B passes it to your friend"),e("p",{class:"text-base text-white/50 mt-1"},"Relay B knows the letter came from Relay A, but has no idea who originally sent it. Your friend opens the inner envelope and reads the letter.")])]),e("div",{class:"border-t border-white/[0.06] pt-4 mt-2"},[e("div",{class:"flex items-center justify-center gap-2 flex-wrap"},[e("div",{class:"px-3 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-center"},[e("div",{class:"text-lg"},"ðŸ‘¤"),e("div",{class:"text-base font-medium text-emerald-400"},"You")]),e("div",{class:"text-white/20 text-base"},"â†’ ðŸ”’ â†’"),e("div",{class:"px-3 py-2 bg-sky-500/10 border border-sky-500/20 rounded-lg text-center"},[e("div",{class:"text-lg"},"ðŸ“¬"),e("div",{class:"text-base font-medium text-sky-400"},"Relay A"),e("div",{class:"text-base text-white/30"},"sees: you")]),e("div",{class:"text-white/20 text-base"},"â†’ ðŸ”’ â†’"),e("div",{class:"px-3 py-2 bg-purple-500/10 border border-purple-500/20 rounded-lg text-center"},[e("div",{class:"text-lg"},"ðŸ“¬"),e("div",{class:"text-base font-medium text-purple-400"},"Relay B"),e("div",{class:"text-base text-white/30"},"sees: friend")]),e("div",{class:"text-white/20 text-base"},"â†’ ðŸ”’ â†’"),e("div",{class:"px-3 py-2 bg-amber-500/10 border border-amber-500/20 rounded-lg text-center"},[e("div",{class:"text-lg"},"ðŸ‘¤"),e("div",{class:"text-base font-medium text-amber-400"},"Friend")])]),e("p",{class:"text-base text-white/30 text-center mt-3"}," No single relay knows both who sent it AND who received it ")])],-1))]),e("section",null,[e("h3",Ko,[k(c(Gs),{class:"w-5 h-5 text-emerald-400"}),o[10]||(o[10]=P(" What the servers CANNOT see ",-1))]),o[11]||(o[11]=e("div",{class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},[e("div",{class:"bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3"},[e("span",{class:"text-emerald-400 text-lg shrink-0"},"âœ—"),e("div",null,[e("p",{class:"text-base font-medium text-white/80"},"Your IP address"),e("p",{class:"text-base text-white/40 mt-0.5"},"The relay that talks to your friend doesn't know who you are")])]),e("div",{class:"bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3"},[e("span",{class:"text-emerald-400 text-lg shrink-0"},"âœ—"),e("div",null,[e("p",{class:"text-base font-medium text-white/80"},"Your room content"),e("p",{class:"text-base text-white/40 mt-0.5"},"3D objects, chat, voice â€” all encrypted end-to-end")])]),e("div",{class:"bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3"},[e("span",{class:"text-emerald-400 text-lg shrink-0"},"âœ—"),e("div",null,[e("p",{class:"text-base font-medium text-white/80"},"Your room name or description"),e("p",{class:"text-base text-white/40 mt-0.5"},"Even public room listings are encrypted blobs")])]),e("div",{class:"bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3"},[e("span",{class:"text-emerald-400 text-lg shrink-0"},"âœ—"),e("div",null,[e("p",{class:"text-base font-medium text-white/80"},"Who is talking to whom"),e("p",{class:"text-base text-white/40 mt-0.5"},"With 2 relays, neither one knows both sides")])])],-1))]),e("section",null,[e("h3",Fo,[k(c(Eo),{class:"w-5 h-5 text-purple-400"}),o[12]||(o[12]=P(" Two ways to share your room ",-1))]),e("div",Wo,[e("div",Ho,[e("div",Yo,[k(c(xn),{class:"w-4 h-4 text-emerald-400"}),o[13]||(o[13]=e("span",{class:"text-base font-bold text-emerald-400"},"Invite Only (default)",-1))]),o[14]||(o[14]=e("p",{class:"text-base text-white/50 leading-relaxed"}," Your room is completely invisible. You create a special link and send it to people you trust. The link looks like a random code â€” it doesn't contain your name, IP address, or any clue about your computer. Even if someone finds the link, they can't figure out where your server is. ",-1))]),e("div",Jo,[e("div",Go,[k(c(Ut),{class:"w-4 h-4 text-sky-400"}),o[15]||(o[15]=e("span",{class:"text-base font-bold text-sky-400"},"Public",-1))]),o[16]||(o[16]=e("p",{class:"text-base text-white/50 leading-relaxed"},` Your room appears in a public list so anyone can browse and join. But the directory is "blind" â€” it stores your room name as an encrypted blob that only visitors' apps can decrypt. The servers that host the list have no idea what rooms they're listing. `,-1))])])]),e("section",null,[e("h3",Zo,[k(c(Zs),{class:"w-5 h-5 text-teal-400"}),o[17]||(o[17]=P(" About invite links ",-1))]),o[18]||(o[18]=e("p",{class:"text-base text-white/60 leading-relaxed"},[P(" When you create an invite link, the URL points to a "),e("strong",{class:"text-white/80"},"relay server"),P(", not your computer. The link contains an encrypted token that the relay passes along but "),e("strong",{class:"text-white/80"},"cannot read"),P(". Think of it like giving someone a sealed envelope with a relay's address on it â€” the relay delivers the envelope but can't open it to see what's inside. ")],-1))]),e("section",qo,[e("div",Xo,[k(c(zs),{class:"w-6 h-6 text-emerald-400 shrink-0 mt-0.5"}),o[19]||(o[19]=e("div",null,[e("p",{class:"text-base font-bold text-emerald-400 mb-2"},"The bottom line"),e("p",{class:"text-base text-white/60 leading-relaxed"}," Your room connection bounces through 2 random servers. Each server only sees the server before and after it â€” never the full picture. All your data (3D objects, chat, voice, movements) is encrypted so that only you and your visitors can read it. No accounts, no phone numbers, no emails â€” just share a link and connect anonymously. ")],-1))])])])):O("",!0),c(a)==="experts"?(h(),x("div",Qo,[e("div",ea,[k(c(ss),{class:"w-5 h-5 text-amber-400 shrink-0 mt-0.5"}),o[20]||(o[20]=e("div",null,[e("p",{class:"text-base font-bold text-amber-400 mb-1"},"Fully auditable â€” all source files referenced below"),e("p",{class:"text-base text-white/50"}," The entire relay and client communication stack is open source. Every claim in this document can be verified by reading the referenced source files. No trust required â€” verify it yourself. ")],-1))]),e("section",null,[e("h3",ta,[k(c(ds),{class:"w-5 h-5 text-sky-400"}),o[21]||(o[21]=P(" Protocol Overview ",-1))]),o[22]||(o[22]=e("p",{class:"text-base text-white/60 leading-relaxed mb-3"},[P(" The system implements a custom "),e("strong",{class:"text-white/80"},"onion routing protocol"),P(" with 2-hop circuits, inspired by Tor's design but purpose-built for real-time WebSocket communication. Connections are established via "),e("strong",{class:"text-white/80"},"telescoping circuit extension"),P(": the client performs a key exchange with each relay sequentially, building a layered encryption tunnel. ")],-1)),o[23]||(o[23]=e("div",{class:"bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base"},[e("div",{class:"space-y-2 text-white/50"},[e("div",{class:"flex items-center gap-2"},[e("span",{class:"text-emerald-400 font-bold w-14 shrink-0 text-right"},"Client"),e("span",{class:"text-white/20"},"â”€â”€"),e("span",{class:"bg-emerald-500/15 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20"},"KX + encrypt(encrypt(data, K_B), K_A)"),e("span",{class:"text-white/20"},"â”€â”€â–¶"),e("span",{class:"text-sky-400"},"Relay A")]),e("div",{class:"flex items-center gap-2 pl-20"},[e("span",{class:"text-white/20"},"â”€â”€"),e("span",{class:"bg-sky-500/15 text-sky-400 px-2 py-0.5 rounded border border-sky-500/20"},"decrypt(K_A) â†’ forward encrypt(data, K_B)"),e("span",{class:"text-white/20"},"â”€â”€â–¶"),e("span",{class:"text-purple-400"},"Relay B")]),e("div",{class:"flex items-center gap-2 pl-40"},[e("span",{class:"text-white/20"},"â”€â”€"),e("span",{class:"bg-purple-500/15 text-purple-400 px-2 py-0.5 rounded border border-purple-500/20"},"decrypt(K_B) â†’ plaintext"),e("span",{class:"text-white/20"},"â”€â”€â–¶"),e("span",{class:"text-amber-400 font-bold"},"Peer")]),e("div",{class:"pt-2 border-t border-white/[0.06] text-white/30"}," K_A, K_B = independent XChaCha20-Poly1305 session keys per hop ")])],-1))]),e("section",null,[e("h3",sa,[k(c(Ze),{class:"w-5 h-5 text-amber-400"}),o[24]||(o[24]=P(" Cryptographic Primitives ",-1))]),o[25]||(o[25]=e("div",{class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},[e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Key Exchange"),e("div",{class:"text-base text-white/50 mb-2"},"X25519 (Curve25519 Diffie-Hellman)"),e("div",{class:"text-base text-white/30 font-mono"},"crypto.cjs â†’ clientSessionKeys() / serverSessionKeys()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Symmetric Cipher"),e("div",{class:"text-base text-white/50 mb-2"},"XChaCha20-Poly1305 AEAD (256-bit key, 192-bit nonce)"),e("div",{class:"text-base text-white/30 font-mono"},"crypto.cjs â†’ encrypt() / decrypt()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Authentication"),e("div",{class:"text-base text-white/50 mb-2"},"Poly1305 MAC with per-circuit AAD (circuit ID as associated data)"),e("div",{class:"text-base text-white/30 font-mono"},"relay.cjs â†’ sendToCircuit() aad = circuitId")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Hash Function"),e("div",{class:"text-base text-white/50 mb-2"},"BLAKE2b (used for metadata key derivation)"),e("div",{class:"text-base text-white/30 font-mono"},"useOnionClient.ts â†’ crypto_generichash()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Gossip Signing"),e("div",{class:"text-base text-white/50 mb-2"},"Ed25519 digital signatures on peer announcements"),e("div",{class:"text-base text-white/30 font-mono"},"gossip.cjs â†’ signAnnouncement() / verifyAnnouncement()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-amber-400 mb-1"},"Library"),e("div",{class:"text-base text-white/50 mb-2"},"libsodium (NaCl) â€” server: sodium-native, client: libsodium-wrappers-sumo"),e("div",{class:"text-base text-white/30 font-mono"},"Audited, battle-tested, no custom crypto")])],-1))]),e("section",null,[e("h3",na,[k(c(Fs),{class:"w-5 h-5 text-purple-400"}),o[26]||(o[26]=P(" Circuit Lifecycle ",-1))]),o[27]||(o[27]=e("div",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-3"},[e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-emerald-400 font-bold text-base w-5 shrink-0"},"1."),e("div",null,[e("p",{class:"text-base text-white/70 font-medium"},"Handshake with Relay A"),e("p",{class:"text-base text-white/40"},"Client generates ephemeral X25519 keypair, sends public key + random circuit ID. Relay A derives shared keys via crypto_kx_server_session_keys(). Client derives same keys via crypto_kx_client_session_keys()."),e("p",{class:"text-base text-white/30 font-mono mt-1"},"relay.cjs:137 â†’ handleHandshake()")])]),e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-sky-400 font-bold text-base w-5 shrink-0"},"2."),e("div",null,[e("p",{class:"text-base text-white/70 font-medium"},"Circuit extension to Relay B"),e("p",{class:"text-base text-white/40"},"Client sends a RELAY message (0x10) through the encrypted tunnel to Relay A, containing Relay B's URL + a new handshake for Relay B. Relay A opens a WebSocket to Relay B and forwards the handshake â€” it cannot read Relay B's session keys."),e("p",{class:"text-base text-white/30 font-mono mt-1"},"relay.cjs:290 â†’ forwardToHop()")])]),e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-purple-400 font-bold text-base w-5 shrink-0"},"3."),e("div",null,[e("p",{class:"text-base text-white/70 font-medium"},"Two-layer encryption established"),e("p",{class:"text-base text-white/40"},"Client now has independent session keys with both relays. Every packet is double-encrypted: first with Relay B's key, then with Relay A's key. Each relay peels exactly one layer and forwards the rest."),e("p",{class:"text-base text-white/30 font-mono mt-1"},"useOnionClient.ts â†’ OnionCircuit.build()")])]),e("div",{class:"flex items-start gap-3"},[e("span",{class:"text-amber-400 font-bold text-base w-5 shrink-0"},"4."),e("div",null,[e("p",{class:"text-base text-white/70 font-medium"},"Rendezvous point"),e("p",{class:"text-base text-white/40"},"Room host establishes a rendezvous on Relay B with a random 20-byte cookie. Visitor joins the rendezvous with the same cookie. Relay B pairs the two circuits â€” it never sees the content (still E2E encrypted between peers)."),e("p",{class:"text-base text-white/30 font-mono mt-1"},"rendezvous.cjs â†’ establishRendezvous() / joinRendezvous()")])])],-1))]),e("section",null,[e("h3",oa,[k(c(_o),{class:"w-5 h-5 text-sky-400"}),o[28]||(o[28]=P(" Wire Format ",-1))]),o[29]||(o[29]=e("div",{class:"bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base text-white/50 space-y-2"},[e("p",{class:"text-white/70"},"Packet on the wire (encrypted):"),e("p",null,"| nonce (24B) | circuit_id (4B) | ciphertext (MAC 16B + payload) |"),e("p",{class:"text-white/70 mt-3"},"Decrypted inner message:"),e("p",null,"| msg_type (1B) | next_hop_len (1B) | [next_hop] | payload_len (2B) | payload |"),e("p",{class:"text-white/70 mt-3"},"Message types (relay.cjs MSG enum):"),e("p",null,"0x01 HANDSHAKE_INIT Â  0x02 HANDSHAKE_REPLY"),e("p",null,"0x10 RELAY (extend) Â Â  0x20 DATA (E2E payload)"),e("p",null,"0x30 ESTABLISH_RENDEZVOUS Â  0x33 RENDEZVOUS_JOIN"),e("p",null,"0x40-0x45 TRACKER_* Â  0xF0 CIRCUIT_DESTROY"),e("p",null,"0xFF CHAFF (noise, dropped on receipt)")],-1))]),e("section",null,[e("h3",aa,[k(c(Ao),{class:"w-5 h-5 text-rose-400"}),o[30]||(o[30]=P(" Traffic Analysis Resistance ",-1))]),o[31]||(o[31]=e("div",{class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},[e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-rose-400 mb-1"},"Fixed Packet Size"),e("div",{class:"text-base text-white/50"},"All packets padded to 1024 bytes (configurable). No payload size leakage."),e("div",{class:"text-base text-white/30 font-mono mt-1"},"crypto.cjs â†’ padPacket()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-rose-400 mb-1"},"Chaff Traffic"),e("div",{class:"text-base text-white/50"},"Random noise packets (0xFF) between relay peers. Hides when real data flows."),e("div",{class:"text-base text-white/30 font-mono mt-1"},"chaff.cjs â†’ startChaff()")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-rose-400 mb-1"},"Timing Jitter"),e("div",{class:"text-base text-white/50"},"Configurable random delay (maxJitter) on message forwarding to resist timing correlation."),e("div",{class:"text-base text-white/30 font-mono mt-1"},"relay.cjs:133 â†’ setTimeout(processMessage, jitter)")]),e("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[e("div",{class:"text-base font-bold text-rose-400 mb-1"},"Key Rotation"),e("div",{class:"text-base text-white/50"},"Relay keypairs rotate every 60 min. Previous keypair accepted for 2 min grace period, then zeroed."),e("div",{class:"text-base text-white/30 font-mono mt-1"},"relay.cjs:352 â†’ rotateKeys()")])],-1))]),e("section",null,[e("h3",ra,[k(c(Fs),{class:"w-5 h-5 text-emerald-400"}),o[32]||(o[32]=P(" Blind Tracker Design ",-1))]),o[33]||(o[33]=e("p",{class:"text-base text-white/60 leading-relaxed mb-3"},[P(" The room tracker (for public room discovery) is designed so that it "),e("strong",{class:"text-white/80"},"cannot read any room metadata"),P(". Room listings are encrypted client-side with a symmetric key derived from a well-known seed using BLAKE2b. All clients derive the same key, so they can decrypt listings â€” but the tracker itself only stores opaque base64 blobs. ")],-1)),o[34]||(o[34]=e("div",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-2 text-base"},[e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-emerald-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"Encrypted metadata:"),P(" Room name, description, envId â€” all encrypted with XChaCha20-Poly1305 before reaching the tracker")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-emerald-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"No IP addresses stored:"),P(" Rooms identified by relay WebSocket URL only (e.g. wss://relay.example.com/relay)")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-emerald-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"In-memory only:"),P(" Room listings stored in JavaScript Maps, never persisted to disk. TTL-based expiry.")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-emerald-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"Registration through circuits:"),P(" Room registration (TRACKER_REGISTER 0x40) travels through the onion circuit, so the tracker never sees the registrant's IP")])]),e("p",{class:"text-white/30 font-mono pt-2 border-t border-white/[0.06]"}," tracker.cjs â†’ processRegister() | useOnionClient.ts â†’ publishRoom() ")],-1))]),e("section",null,[e("h3",ia,[k(c(Ut),{class:"w-5 h-5 text-blue-400"}),o[35]||(o[35]=P(" Gossip Protocol & Peer Discovery ",-1))]),o[36]||(o[36]=e("p",{class:"text-base text-white/60 leading-relaxed mb-3"}," Relays discover each other via a gossip protocol. Each relay generates an Ed25519 identity keypair on first boot and announces itself to known peers. Announcements include the relay's URL, public keys, tracker status, and a timestamp â€” all signed with the relay's Ed25519 key. ",-1)),o[37]||(o[37]=e("div",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-2 text-base"},[e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-blue-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"Ed25519 signatures:"),P(" Every announcement is signed â€” relays reject announcements with invalid signatures or timestamps in the future")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-blue-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"Propagation:"),P(" When a relay receives a new peer, it gossips the announcement to all other known peers (flood fill with deduplication)")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-blue-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"TTL expiry:"),P(" Peers that don't re-announce within the TTL window are pruned. No permanent storage of peer data.")])]),e("div",{class:"flex items-start gap-2"},[e("span",{class:"text-blue-400 shrink-0"},"âœ“"),e("span",{class:"text-white/50"},[e("strong",{class:"text-white/70"},"Client peer directory:"),P(" Clients fetch /peers from known relays, probe latency, and cache results in localStorage. Relays sorted by latency for optimal circuit building.")])]),e("p",{class:"text-white/30 font-mono pt-2 border-t border-white/[0.06]"}," gossip.cjs â†’ announceToAll() / handleAnnouncement() | useOnionClient.ts â†’ refreshPeerDirectory() ")],-1))]),e("section",null,[e("h3",la,[k(c(Zs),{class:"w-5 h-5 text-teal-400"}),o[38]||(o[38]=P(" Invite Link Token Format ",-1))]),o[39]||(o[39]=e("div",{class:"bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base text-white/50 space-y-2"},[e("p",{class:"text-white/70"},"Token structure:"),e("p",null,"ROOMKEY.BASE64(xchacha20_encrypt(envId, metadataKey))"),e("p",{class:"text-white/70 mt-3"},"Where:"),e("p",null,'metadataKey = BLAKE2b(32, "spiderfarmer-room-metadata-v1")'),e("p",null,"ROOMKEY = 32-byte random key stored in data/room3d/tunnel-key.json"),e("p",{class:"text-white/70 mt-3"},"The URL points to a relay domain:"),e("p",null,"https://relay.example.com/join/ROOMKEY.TOKEN"),e("p",{class:"text-white/30 mt-3 border-t border-white/[0.06] pt-2"},"The relay resolves the room key to a connected tunnel host, creates a session cookie, and proxies the visitor's connection. The relay never sees the decrypted envId.")],-1))]),e("section",null,[e("h3",ca,[k(c(ss),{class:"w-5 h-5 text-amber-400"}),o[40]||(o[40]=P(" Source File Reference ",-1))]),o[41]||(o[41]=e("div",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},[e("div",{class:"grid grid-cols-1 gap-2 text-base"},[e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/relay.cjs"),e("span",{class:"text-white/50"},"Circuit management, packet handling, handshake, message routing, rendezvous forwarding")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/crypto.cjs"),e("span",{class:"text-white/50"},"X25519 key exchange, XChaCha20-Poly1305 encrypt/decrypt, packet padding, random bytes")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/circuits.cjs"),e("span",{class:"text-white/50"},"Circuit registry (Map), collision detection, circuit TTL, destroy logic")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/rendezvous.cjs"),e("span",{class:"text-white/50"},"Rendezvous point management â€” cookie-based circuit pairing for E2E data relay")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/tracker.cjs"),e("span",{class:"text-white/50"},"Blind tracker â€” stores encrypted room blobs, TTL expiry, TRACKER_* message handling")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/gossip.cjs"),e("span",{class:"text-white/50"},"Peer discovery â€” Ed25519-signed announcements, flood propagation, peer pruning")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/chaff.cjs"),e("span",{class:"text-white/50"},"Chaff traffic generator â€” random noise packets between relay peers")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/rate-limit.cjs"),e("span",{class:"text-white/50"},"Per-IP rate limiting for all HTTP and WebSocket endpoints")]),e("div",{class:"flex items-start gap-3 py-1.5 border-b border-white/[0.04]"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"relay/index.cjs"),e("span",{class:"text-white/50"},"HTTP server, CORS, WebSocket upgrade, join page, tunnel proxy, tracker integration")]),e("div",{class:"flex items-start gap-3 py-1.5"},[e("span",{class:"text-amber-400 font-mono w-56 shrink-0"},"useOnionClient.ts"),e("span",{class:"text-white/50"},"Client composable â€” circuit building, room publishing, peer discovery, E2E crypto, rendezvous")])]),e("p",{class:"text-base text-white/30 mt-3 pt-2 border-t border-white/[0.06]"},[P(" All files located under "),e("span",{class:"font-mono"},"src/services/relay/"),P(" (server) and "),e("span",{class:"font-mono"},"app/composables/room3d/"),P(" (client) ")])],-1))]),o[42]||(o[42]=e("section",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},[e("h3",{class:"text-base font-bold text-white/60 uppercase tracking-wider mb-3"},"Technical Summary"),e("div",{class:"grid grid-cols-2 gap-x-6 gap-y-2 text-base"},[e("div",{class:"text-white/40"},"Protocol"),e("div",{class:"text-white/70"},"Onion routing, 2-hop circuits (telescoping extension)"),e("div",{class:"text-white/40"},"Key Exchange"),e("div",{class:"text-white/70"},"X25519 (Curve25519 DH)"),e("div",{class:"text-white/40"},"Symmetric Cipher"),e("div",{class:"text-white/70"},"XChaCha20-Poly1305 AEAD (256-bit key, 192-bit nonce)"),e("div",{class:"text-white/40"},"MAC / Authentication"),e("div",{class:"text-white/70"},"Poly1305 with circuit ID as AAD"),e("div",{class:"text-white/40"},"Hash Function"),e("div",{class:"text-white/70"},"BLAKE2b (key derivation, metadata)"),e("div",{class:"text-white/40"},"Gossip Signatures"),e("div",{class:"text-white/70"},"Ed25519 (peer announcements)"),e("div",{class:"text-white/40"},"Packet Size"),e("div",{class:"text-white/70"},"Fixed 1024 bytes (padded)"),e("div",{class:"text-white/40"},"Key Rotation"),e("div",{class:"text-white/70"},"Every 60 minutes (2-min grace period)"),e("div",{class:"text-white/40"},"Logging"),e("div",{class:"text-white/70"},"Zero â€” no connection, traffic, or metadata logs"),e("div",{class:"text-white/40"},"Tracker Storage"),e("div",{class:"text-white/70"},"In-memory Maps only (JavaScript), TTL-based expiry"),e("div",{class:"text-white/40"},"Library"),e("div",{class:"text-white/70"},"libsodium (sodium-native server, libsodium-wrappers-sumo client)"),e("div",{class:"text-white/40"},"Peer Discovery"),e("div",{class:"text-white/70"},"Gossip protocol with Ed25519-signed announcements, flood propagation")])],-1))])):O("",!0)])])])):O("",!0)]),_:1})]))}}),ua=Object.assign(xs(da,[["__scopeId","data-v-854eaa7a"]]),{__name:"Room3dPrivacyInfo"}),N=24,pt=16,me=32,pa=512,H={HANDSHAKE_INIT:1,HANDSHAKE_REPLY:2,RELAY:16,DATA:32,ESTABLISH_RENDEZVOUS:48,RENDEZVOUS_ESTABLISHED:49,INTRODUCE:50,RENDEZVOUS_JOIN:51,TRACKER_REGISTER:64,TRACKER_QUERY:65,TRACKER_RESPONSE:66,TRACKER_HEARTBEAT:67,TRACKER_INTRODUCE:68,TRACKER_INTRODUCE_DATA:69,CIRCUIT_DESTROY:240};let F=null,ns=null;async function Bt(){return F||(ns||(ns=Qn(()=>import("./D93w9sP1.js"),[],import.meta.url).then(async t=>{const s=t.default||t;return await s.ready,F=s,s})),ns)}function fa(t,s,n){const a=F,r=a.randombytes_buf(N),i=new Uint8Array(4);new DataView(i.buffer).setUint32(0,n);const o=a.crypto_aead_xchacha20poly1305_ietf_encrypt(t,i,null,r,s),d=new Uint8Array(r.length+o.length);return d.set(r),d.set(o,r.length),d}function ma(t,s,n){const a=F;if(t.length<N+pt)return null;const r=t.subarray(0,N),i=t.subarray(N),o=new Uint8Array(4);new DataView(o.buffer).setUint32(0,n);try{return a.crypto_aead_xchacha20poly1305_ietf_decrypt(null,i,o,r,s)}catch{return null}}function Xs(t,s,n){const a=s?new TextEncoder().encode(s):new Uint8Array(0),r=new Uint8Array(2+a.length+2+n.length);return r[0]=t,r[1]=a.length,r.set(a,2),new DataView(r.buffer).setUint16(2+a.length,n.length),r.set(n,4+a.length),r}function ha(t){if(t.length<4)return null;const s=t[0],n=t[1],a=n>0?new TextDecoder().decode(t.subarray(2,2+n)):null,r=new DataView(t.buffer,t.byteOffset).getUint16(2+n),i=t.subarray(4+n,4+n+r);return{type:s,nextHop:a,payload:i}}function ba(t,s){if(t.length>=s)return t.subarray(0,s);const n=new Uint8Array(s);n.set(t);const a=F.randombytes_buf(s-t.length);return n.set(a,t.length),n}function Dt(t){return Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("")}function gn(t){const s=new Uint8Array(t.length/2);for(let n=0;n<s.length;n++)s[n]=parseInt(t.slice(n*2,n*2+2),16);return s}const Qs="sf_room3d_room_secret";function ya(){const t=F;if(typeof window>"u")return t.randombytes_buf(32);const s=localStorage.getItem(Qs);if(s&&s.length===64)return gn(s);const n=t.randombytes_buf(32);return localStorage.setItem(Qs,Dt(n)),n}function en(t){const s=F,n=ya(),a=new TextEncoder().encode(t),r=new Uint8Array(a.length+n.length);return r.set(a),r.set(n,a.length),s.crypto_generichash(32,r)}class Pt{hops=[];ws=null;circuitId=0;messageQueue=[];dataCallback=null;_destroyed=!1;async build(s){const a=(await Bt()).randombytes_buf(4);this.circuitId=new DataView(a.buffer).getUint32(0);const r=s[0];this.ws=new WebSocket(r.url),this.ws.binaryType="arraybuffer",await new Promise((o,d)=>{this.ws.onopen=()=>o(),this.ws.onerror=()=>d(new Error(`Failed to connect to relay ${r.url}`))}),this.ws.onclose=()=>{this._destroyed};const i=await this._handshakeWithRelay();this.hops.push({url:r.url,sessionRx:i.rx,sessionTx:i.tx,publicKey:i.serverPk}),this.ws.onmessage=o=>{const d=new Uint8Array(o.data);this._handleIncoming(d)};for(let o=1;o<s.length;o++){const d=s[o],w=await this._extendCircuit(d);this.hops.push({url:d.url,sessionRx:w.rx,sessionTx:w.tx,publicKey:w.serverPk})}}send(s,n,a=null){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let r=Xs(n,a,s);for(let i=this.hops.length-1;i>=0;i--){const o=this.hops[i];i===this.hops.length-1||(r=Xs(H.RELAY,this.hops[i+1].url,r));const w=fa(r,o.sessionTx,this.circuitId),I=w.subarray(0,N),C=w.subarray(N);r=new Uint8Array(N+4+C.length),r.set(I,0),new DataView(r.buffer).setUint32(N,this.circuitId),r.set(C,N+4)}this.ws.send(r)}onData(s){this.dataCallback=s}destroy(){this._destroyed=!0,this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null);for(const s of this.hops)s.sessionRx.fill(0),s.sessionTx.fill(0);this.hops=[],this.messageQueue=[]}_handleIncoming(s){let n=s;for(const r of this.hops){const i=ma(n,r.sessionRx,this.circuitId);if(!i)return;n=i}const a=ha(n);if(a){if(this.messageQueue.length>0){this.messageQueue.shift().resolve({type:a.type,payload:a.payload});return}this.dataCallback&&this.dataCallback(a.type,a.payload)}}_waitForMessage(s=1e4){return new Promise((n,a)=>{const r=setTimeout(()=>{const i=this.messageQueue.findIndex(o=>o.resolve===n);i>=0&&this.messageQueue.splice(i,1),a(new Error("Timeout waiting for relay response"))},s);this.messageQueue.push({resolve:i=>{clearTimeout(r),n(i)}})})}async _handshakeWithRelay(){const s=F,n=s.crypto_kx_keypair(),a=new Uint8Array(N+4+me),r=s.randombytes_buf(N);a.set(r,0),new DataView(a.buffer).setUint32(N,this.circuitId),a.set(n.publicKey,N+4),this.ws.send(ba(a,pa));const i=await new Promise((te,D)=>{const de=setTimeout(()=>{this.ws.onmessage=null,D(new Error("Handshake timeout"))},1e4);this.ws.onmessage=pe=>{clearTimeout(de),te(new Uint8Array(pe.data))}}),o=new Uint8Array([83,70,80,75]),d=i.length>=4&&i[0]===o[0]&&i[1]===o[1]&&i[2]===o[2]&&i[3]===o[3];let w,I,C;if(d)w=i.subarray(4,4+me),I=i.subarray(4+me,4+me+N),C=i.subarray(4+me+N+4);else{const te=this.hops.length===0?this.ws?.url:"";if(!te)throw new Error("Cannot determine relay URL for PK fetch");const D=te.replace(/^wss:/,"https:").replace(/^ws:/,"http:")+"/pk",de=await fetch(D);if(!de.ok)throw new Error(`Failed to fetch relay PK from ${D}`);const pe=await de.json();w=s.from_hex(pe.publicKey),I=i.subarray(0,N),C=i.subarray(N+4)}const _=s.crypto_kx_client_session_keys(n.publicKey,n.privateKey,w),U=1+me+pt,J=C.subarray(0,U),re=new Uint8Array(4);new DataView(re.buffer).setUint32(0,this.circuitId);try{s.crypto_aead_xchacha20poly1305_ietf_decrypt(null,J,re,I,_.sharedRx)}catch{throw new Error("Handshake verification failed â€” relay rejected or key mismatch")}return{rx:_.sharedRx,tx:_.sharedTx,serverPk:new Uint8Array(w)}}async _extendCircuit(s){const n=F,a=n.crypto_kx_keypair(),r=new Uint8Array(N+4+me),i=n.randombytes_buf(N);r.set(i,0),new DataView(r.buffer).setUint32(N,this.circuitId),r.set(a.publicKey,N+4),this.send(r,H.RELAY,s.url);const d=(await this._waitForMessage()).payload,w=new Uint8Array([83,70,80,75]),C=d.length>=4&&d[0]===w[0]&&d[1]===w[1]&&d[2]===w[2]&&d[3]===w[3]?4:0;if(d.length<C+me+N+4+pt+1)throw new Error("Extend handshake reply too short");const _=d.subarray(C,C+me),U=n.crypto_kx_client_session_keys(a.publicKey,a.privateKey,_);return{rx:U.sharedRx,tx:U.sharedTx,serverPk:new Uint8Array(_)}}}class tn{rx=new Uint8Array(0);tx=new Uint8Array(0);nonceCounter=0;async initAsClient(s){const a=(await Bt()).crypto_kx_keypair();return this._keypair=a,a.publicKey}async completeAsClient(s){const n=F,a=this._keypair,r=n.crypto_kx_client_session_keys(a.publicKey,a.privateKey,s);this.rx=r.sharedRx,this.tx=r.sharedTx}async initAsServer(s){const n=await Bt(),a=n.crypto_kx_keypair(),r=n.crypto_kx_server_session_keys(a.publicKey,a.privateKey,s);return this.rx=r.sharedRx,this.tx=r.sharedTx,a.publicKey}encrypt(s){const n=F,a=n.randombytes_buf(N),r=n.crypto_aead_xchacha20poly1305_ietf_encrypt(s,null,null,a,this.tx),i=new Uint8Array(a.length+r.length);return i.set(a),i.set(r,a.length),i}decrypt(s){const n=F;if(s.length<N+pt)return null;const a=s.subarray(0,N),r=s.subarray(N);try{return n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,r,null,a,this.rx)}catch{return null}}destroy(){this.rx.fill(0),this.tx.fill(0)}}const kn="sf_onion_peers";let le=[],bt=null,us={};const va=5*6e4,gs=5,qe=["wss://schedule4real.com/rooms","wss://r2.imaset.com"],Sn=200;function ks(t){if(!t||typeof t!="string"||!t.startsWith("wss://")&&!t.startsWith("ws://")||t.length>256)return!1;try{const n=new URL(t.replace(/^wss:/,"https:").replace(/^ws:/,"http:")).hostname;return!(n==="localhost"||n==="127.0.0.1"||n==="::1"||n==="0.0.0.0"||/^10\./.test(n)||/^172\.(1[6-9]|2\d|3[01])\./.test(n)||/^192\.168\./.test(n)||/^169\.254\./.test(n))}catch{return!1}}function wa(){if(typeof window>"u")return[];try{const t=localStorage.getItem(kn);if(!t||t.length>256*1024)return[];const s=JSON.parse(t);return Array.isArray(s.peers)?s.peers.filter(n=>ks(n.url)).slice(0,Sn).map(n=>({...n,latency:typeof n.latency=="number"&&isFinite(n.latency)?n.latency:1/0})):[]}catch{return[]}}function xa(t){if(!(typeof window>"u"))try{localStorage.setItem(kn,JSON.stringify({peers:t,savedAt:Date.now()}))}catch{}}function jt(t){const s=t.replace(/^wss:/,"https:").replace(/^ws:/,"http:");try{const n=new URL(s);return`${n.protocol}//${n.host}`}catch{return s}}function ga(){le.sort((t,s)=>{if(t.failures!==s.failures)return t.failures-s.failures;const n=isFinite(t.latency)?0:1,a=isFinite(s.latency)?0:1;if(n!==a)return n-a;if(isFinite(t.latency)&&isFinite(s.latency)&&t.latency!==s.latency)return t.latency-s.latency;const r=qe.includes(t.url)?0:1,i=qe.includes(s.url)?0:1;return r!==i?r-i:s.lastSeen-t.lastSeen})}async function ka(t){const s=t.map(r=>jt(r)),n=await $fetch("/api/room3d/onion-peers",{params:{relays:s.join(",")},timeout:1e4});return!n?.peers||!Array.isArray(n.peers)?{peers:[],relayRtts:{},meshRtts:{}}:{peers:n.peers.slice(0,200).filter(r=>r.url&&ks(r.url)).map(r=>({url:r.url,pk:r.pk||"",tracker:!!r.tracker,failures:Math.min(r.failures||0,gs),latency:1/0,lastSeen:r.lastSeen||0})),relayRtts:n.relayRtts||{},meshRtts:n.meshRtts||{}}}function Sa(t){for(const s of t){if(!ks(s.url))continue;const n=le.find(a=>a.url===s.url);if(n)s.pk&&!n.pk&&(n.pk=s.pk),s.tracker&&(n.tracker=!0),s.lastSeen>n.lastSeen&&(n.lastSeen=s.lastSeen);else{if(le.length>=Sn)continue;le.push({...s})}}}async function os(){const t=[...qe,...le.filter(s=>!qe.includes(s.url)).map(s=>s.url)];try{const{peers:s,relayRtts:n,meshRtts:a}=await ka(t);Sa(s);for(const i of le){const o=jt(i.url);n[o]!==void 0&&(i.latency=n[o])}us={};for(const[i,o]of Object.entries(a)){const d=le.find(w=>jt(w.url)===i)?.url;d&&(us[d]=o)}ga(),xa(le);const r=Object.keys(n).length}catch{}}function yt(){return le.filter(t=>t.failures<gs).map(t=>({url:t.url,publicKey:new Uint8Array(me)}))}function Ca(){return le.filter(t=>t.tracker&&t.failures<gs)}function sn(t){const s=le.find(n=>n.url===t);s&&s.failures++}let vt=!1,Te=null;const fe=[];let as=null,rs=null,We=null;function Ra(){const t=S(!1),s=S(!1),n=S([]),a=S(!1),r=S(null);async function i(){if(vt){t.value=!0;return}try{await Bt();const f=Xn(),b=[f.public.onionRelayA||qe[0],f.public.onionRelayB||qe[1]].filter(Boolean),m=wa();m.length&&(le=m);for(const u of b)le.find(g=>g.url===u)||le.push({url:u,pk:"",tracker:!0,failures:0,latency:1/0,lastSeen:0});Te=F.crypto_generichash(32,new TextEncoder().encode("spiderfarmer-room-metadata-v1")),vt=!0,t.value=!0,os().catch(()=>{}),bt||(bt=ct(()=>{os().catch(()=>{})},va))}catch(f){r.value=f.message}}async function o(f){if(f){const y=new Pt;return await y.build(f),fe.push(y),y}const b=yt();if(!b.length)throw new Error("No usable relays available");if(b.length>=2){const y=[],u=Math.min(b.length,8);for(let g=0;g<u-1;g++)for(let R=g+1;R<u;R++){const E=b[g].url,se=b[R].url,L=le.find(X=>X.url===E),G=le.find(X=>X.url===se),B=L?.latency??1/0,j=G?.latency??1/0,ne=us[E]?.[se]??1/0;let q;if(isFinite(B)&&isFinite(j)){const X=isFinite(ne)?ne:B+j;q=B+X+j}else isFinite(B)||isFinite(j)?q=(isFinite(B)?B:500)+(isFinite(j)?j:500):q=1e4+g*100+R;y.push({i:g,j:R,score:q})}y.sort((g,R)=>g.score-R.score);for(const{i:g,j:R}of y.slice(0,6))try{const E=new Pt;return await E.build([b[g],b[R]]),fe.push(E),E}catch{sn(b[g].url)}}for(const y of b)try{const u=new Pt;return await u.build([y]),fe.push(u),u}catch{sn(y.url)}await os();const m=yt();if(m.length){const y=new Pt;return await y.build([m[0]]),fe.push(y),y}throw new Error("All relay circuits failed")}function d(f){if(!Te)throw new Error("Not initialized");const b=F,m=JSON.stringify(f),y=new TextEncoder().encode(m),u=b.randombytes_buf(N),g=b.crypto_aead_xchacha20poly1305_ietf_encrypt(y,null,null,u,Te),R=new Uint8Array(u.length+g.length);return R.set(u),R.set(g,u.length),R}function w(f){if(!Te||f.length<N+pt)return null;const b=F,m=f.subarray(0,N),y=f.subarray(N);try{const u=b.crypto_aead_xchacha20poly1305_ietf_decrypt(null,y,null,m,Te),g=new TextDecoder().decode(u);return JSON.parse(g)}catch{return null}}async function I(f){vt||await i(),s.value=!0,r.value=null;try{const b=F,m=en(f.envId),y=d({envId:f.envId,name:f.name,description:f.description,capacity:f.capacity||8,tags:f.tags||[]}),u=await o(),R=yt()[0]?.url||qe[0],E=new TextEncoder().encode(R),se=f.private?1:0,L=new Uint8Array(36+E.length+y.length);L[0]=H.TRACKER_REGISTER,L[1]=se,L.set(m,2),new DataView(L.buffer).setUint16(34,E.length),L.set(E,36),L.set(y,36+E.length),u.send(L,H.TRACKER_REGISTER);const G=Dt(m);We=ct(()=>{if(u.ws?.readyState===WebSocket.OPEN){const j=new Uint8Array(33);j[0]=H.TRACKER_HEARTBEAT,j.set(m,1),u.send(j,H.TRACKER_HEARTBEAT)}},6e4),as=u,u.onData((j,ne)=>{j===H.TRACKER_INTRODUCE_DATA&&C(ne,f.envId).catch(q=>{})});const B={roomId:G,keepAlive:()=>{if(u.ws?.readyState===WebSocket.OPEN){const j=new Uint8Array(33);j[0]=H.TRACKER_HEARTBEAT,j.set(m,1),u.send(j,H.TRACKER_HEARTBEAT)}},unpublish:()=>{We&&clearInterval(We),We=null,u.destroy(),as=null,rs=null,s.value=!1}};return rs=B,s.value=!1,B}catch(b){return r.value=b.message,s.value=!1,null}}async function C(f,b){const m=F;if(f.length<23)return;const y=f.subarray(0,20),u=new DataView(f.buffer,f.byteOffset+20).getUint16(0),g=new TextDecoder().decode(f.subarray(22,22+u));let R=yt().find(z=>z.url===g);R||(R={url:g,publicKey:new Uint8Array(me)});const E=yt().filter(z=>z.url!==g),se=E.length>0?[E[0],R]:[R],L=await o(se),G=m.crypto_kx_keypair(),B=new Uint8Array(20+me);B.set(y),B.set(G.publicKey,20),L.send(B,H.RENDEZVOUS_JOIN);const j=await Promise.race([new Promise(z=>{L.onData((ie,Ne)=>{ie===H.DATA&&Ne.length>=me&&z(Ne.subarray(0,me))})}),new Promise((z,ie)=>setTimeout(()=>ie(new Error("Visitor PK timeout")),15e3))]),ne=m.crypto_kx_server_session_keys(G.publicKey,G.privateKey,j),q=new tn;q.rx=ne.sharedRx,q.tx=ne.sharedTx;const X=new TextEncoder().encode(JSON.stringify({envId:b})),ee=q.encrypt(X);L.send(ee,H.DATA),setTimeout(()=>{q.destroy(),L.destroy();const z=fe.indexOf(L);z>=0&&fe.splice(z,1)},3e3)}async function _(){const f=F,b=Ca().map(y=>jt(y.url)),m=new Map;if(!b.length)return[];try{const y=await $fetch("/api/room3d/onion-rooms",{params:{trackers:b.join(",")},timeout:1e4});if(y?.rooms){for(const u of y.rooms)if(!m.has(u.id))try{const g=f.from_base64(u.metadata,f.base64_variants.ORIGINAL),R=w(g);R&&m.set(u.id,{roomId:u.id,envId:R.envId,name:R.name,description:R.description,capacity:R.capacity,tags:R.tags,entryRelay:u.relay})}catch{}}}catch{}return[...m.values()]}async function U(){const f=[],b=await o(),m=new Uint8Array(7);m[0]=H.TRACKER_QUERY,new DataView(m.buffer).setUint32(1,0),new DataView(m.buffer).setUint16(5,50);const y=new Promise(R=>{b.onData((E,se)=>{E===H.TRACKER_RESPONSE&&R(se)})});b.send(m,H.TRACKER_QUERY);const u=await Promise.race([y,new Promise((R,E)=>setTimeout(()=>E(new Error("Tracker query timeout")),8e3))]);if(u.length>=6){const R=new DataView(u.buffer,u.byteOffset).getUint16(4);let E=6;for(let se=0;se<R&&E<u.length&&!(E+36>u.length);se++){const L=u.subarray(E,E+32),G=new DataView(u.buffer,u.byteOffset+E+32).getUint16(0),B=new TextDecoder().decode(u.subarray(E+34,E+34+G)),j=new DataView(u.buffer,u.byteOffset+E+34+G).getUint16(0),ne=u.subarray(E+36+G,E+36+G+j),q=Dt(L),X=w(ne);X&&f.push({roomId:q,envId:X.envId,name:X.name,description:X.description,capacity:X.capacity,tags:X.tags,entryRelay:B}),E+=36+G+j}}b.destroy();const g=fe.indexOf(b);return g>=0&&fe.splice(g,1),f}async function J(){vt||await i(),a.value=!0,r.value=null;let f=[];try{const b=U().then(g=>({source:"circuit",rooms:g})).catch(()=>({source:"circuit",rooms:[]})),m=_().then(g=>({source:"http",rooms:g})).catch(()=>({source:"http",rooms:[]})),u=(await Promise.all([b,m])).filter(g=>g.rooms.length>0);if(u.length>0){const g=u.find(R=>R.source==="circuit");f=g?g.rooms:u[0].rooms}}catch(b){r.value=b.message}return n.value=f,a.value=!1,f}async function re(f){vt||await i(),r.value=null;try{const b=F,m=await o(),y=m.hops[m.hops.length-1].url,u=b.randombytes_buf(20);if(m.send(new Uint8Array(u),H.ESTABLISH_RENDEZVOUS),!await Promise.race([new Promise(ee=>{m.onData((z,ie)=>{z===H.RENDEZVOUS_ESTABLISHED&&ee(ie[0]===1)})}),new Promise((ee,z)=>setTimeout(()=>z(new Error("Rendezvous establish timeout")),1e4))]))throw m.destroy(),new Error("Failed to establish rendezvous");const R=await o(),E=new TextEncoder().encode(y),se=gn(f),L=new Uint8Array(55+E.length);L[0]=H.TRACKER_INTRODUCE,L.set(se,1),L.set(u,33),new DataView(L.buffer).setUint16(53,E.length),L.set(E,55),R.send(L,H.TRACKER_INTRODUCE);const G=new tn,B=await G.initAsClient(m),j=await Promise.race([new Promise(ee=>{m.onData((z,ie)=>{z===H.RENDEZVOUS_JOIN&&ee(ie)})}),new Promise((ee,z)=>setTimeout(()=>z(new Error("Host join timeout (30s)")),3e4))]);m.send(B,H.DATA),await G.completeAsClient(j),R.destroy();const ne=fe.indexOf(R);ne>=0&&fe.splice(ne,1);const q=await Promise.race([new Promise(ee=>{m.onData((z,ie)=>{if(z===H.DATA){const Ne=G.decrypt(ie);if(Ne)try{const oe=JSON.parse(new TextDecoder().decode(Ne));oe.envId&&ee(oe.envId)}catch{}}})}),new Promise((ee,z)=>setTimeout(()=>z(new Error("Room info timeout")),1e4))]),X={onData:null,onClose:null,send:ee=>{const z=G.encrypt(ee);m.send(z,H.DATA)},close:()=>{G.destroy(),m.destroy();const ee=fe.indexOf(m);ee>=0&&fe.splice(ee,1),X.onClose?.()}};return m.onData((ee,z)=>{if(ee===H.DATA){const ie=G.decrypt(z);ie&&X.onData?.(ie)}}),{connection:X,envId:q}}catch(b){return r.value=b.message,null}}function te(){We&&clearInterval(We),We=null,bt&&clearInterval(bt),bt=null;for(const f of fe)f.destroy();fe.length=0,as=null,rs=null,s.value=!1,a.value=!1}function D(f){if(!F)throw new Error("Not initialized");return Dt(en(f))}function de(f,b){if(!F||!Te)throw new Error("Not initialized");const m=F,y=new TextEncoder().encode(f),u=m.randombytes_buf(N),g=m.crypto_aead_xchacha20poly1305_ietf_encrypt(y,null,null,u,Te),R=new Uint8Array(u.length+g.length);return R.set(u),R.set(g,u.length),`${b}.${m.to_base64(R,m.base64_variants.URLSAFE_NO_PADDING)}`}function pe(f){if(!F||!Te)return null;const b=F;let m="",y="";if(f.startsWith("sfr:"))y=f.slice(4);else{const u=f.indexOf(".");if(u<1)return null;m=f.substring(0,u),y=f.substring(u+1)}try{const u=b.from_base64(y,b.base64_variants.URLSAFE_NO_PADDING);if(u.length<N+pt)return null;const g=u.subarray(0,N),R=u.subarray(N),E=b.crypto_aead_xchacha20poly1305_ietf_decrypt(null,R,null,g,Te);if(!E||E.length===0)return null;const se=new TextDecoder().decode(E);return{roomKey:m,envId:se}}catch{return null}}async function xe(){try{return await $fetch("/api/room3d/tunnel-info")}catch{return null}}return{isReady:He(t),isPublishing:He(s),isDiscovering:He(a),publicRooms:He(n),connectionError:He(r),init:i,publishRoom:I,discoverRooms:J,connectToRoom:re,destroyAll:te,deriveRoomId:D,generateInviteToken:de,parseInviteToken:pe,fetchTunnelInfo:xe}}const Cn="sf_room3d_favorites",Rn="sf_room3d_custom_names",$e=S([]),at=S({});let nn=!1;function Ea(){if(!(nn||typeof window>"u")){nn=!0;try{const t=localStorage.getItem(Cn);t&&($e.value=JSON.parse(t))}catch{}try{const t=localStorage.getItem(Rn);t&&(at.value=JSON.parse(t))}catch{}}}function on(){typeof window>"u"||localStorage.setItem(Cn,JSON.stringify($e.value))}function Aa(){typeof window>"u"||localStorage.setItem(Rn,JSON.stringify(at.value))}function _a(){Ea();function t(o){$e.value.some(d=>d.roomId===o.roomId)||($e.value.push({roomId:o.roomId,name:o.name,addedAt:Date.now()}),on())}function s(o){$e.value=$e.value.filter(d=>d.roomId!==o),on()}function n(o){return $e.value.some(d=>d.roomId===o)}function a(o){n(o.roomId)?s(o.roomId):t(o)}function r(o,d){d.trim()?at.value[o]=d.trim():delete at.value[o],Aa()}function i(o){return at.value[o.roomId]||o.name}return{favorites:He($e),customNames:He(at),addFavorite:t,removeFavorite:s,isFavorite:n,toggleFavorite:a,setCustomName:r,getDisplayName:i}}const Ta={class:"w-full max-w-4xl mx-auto"},Pa={class:"flex items-center gap-2 mb-3"},Ia={class:"relative flex-1"},Ma=["disabled"],Da={class:"max-h-[30vh] sm:max-h-[35vh] overflow-y-auto pr-0.5 pub-scroll"},Oa={key:0,class:"flex flex-col items-center py-8"},Na={key:1,class:"text-center py-6"},La={class:"text-red-400/70 text-base mb-2"},$a={key:2,class:"text-center py-8"},Ua={class:"text-white/40 text-base"},Ba={key:3,class:"space-y-2"},ja=["onClick"],Va={class:"flex-1 min-w-0"},za={class:"flex items-center gap-2"},Ka={class:"text-base font-bold text-white/80 group-hover:text-emerald-300 transition-colors truncate"},Fa={key:0,class:"text-base text-white/35 truncate mt-0.5"},Wa=["onClick"],Ha={key:0,class:"bg-black/50 border border-white/[0.12] border-t-0 border-amber-500/30 rounded-b-xl px-4 py-3 flex items-center gap-2"},Ya=["onKeydown"],Ja=["onClick"],Ga=ws({__name:"Room3dPublicBrowser",props:{authenticated:{type:Boolean}},emits:["join-public-room"],setup(t,{emit:s}){const n=s,a=Ra(),r=_a(),i=S(""),o=S([]),d=S(!1),w=S(null),I=S(null),C=S(""),_=S(null),{getDisplayName:U,isFavorite:J,toggleFavorite:re}=r;function te(b){return J(b)}function D(b){re(b)}const de=Pe(()=>{let b=o.value;if(i.value.trim()){const m=i.value.toLowerCase();b=b.filter(y=>y.name.toLowerCase().includes(m)||y.description?.toLowerCase().includes(m)||y.tags?.some(u=>u.toLowerCase().includes(m)))}return[...b].sort((m,y)=>{const u=J(m.roomId)?1:0,g=J(y.roomId)?1:0;return u!==g?g-u:m.name.localeCompare(y.name)})});function pe(b){if(b.passwordProtected){try{const m=JSON.parse(localStorage.getItem("sf_room3d_room_passwords")||"{}");if(m[b.envId]){n("join-public-room",{...b,password:m[b.envId]});return}}catch{}if(I.value===b.roomId)return;I.value=b.roomId,C.value="",eo(()=>{const m=_.value?.[0];m&&m.focus()});return}n("join-public-room",b)}function xe(b){C.value&&(I.value=null,n("join-public-room",{...b,password:C.value}))}async function f(){d.value=!0,w.value=null,I.value=null;try{await a.init();const b=await a.discoverRooms();o.value=b,b.length===0&&a.connectionError.value&&(w.value=a.connectionError.value)}catch(b){w.value=b?.message||"Connection failed"}finally{d.value=!1}}return Mt(()=>{f()}),(b,m)=>(h(),x("div",Ta,[e("div",Pa,[e("div",Ia,[k(c(To),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),st(e("input",{"onUpdate:modelValue":m[0]||(m[0]=y=>Ye(i)?i.value=y:null),type:"text",placeholder:"Search rooms...",class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors"},null,512),[[wt,c(i)]])]),e("button",{onClick:f,disabled:c(d),class:"p-2 rounded-xl bg-black/60 border border-white/20 hover:bg-emerald-500/10 hover:border-emerald-500/30 transition-all disabled:opacity-30",title:"Refresh"},[k(c(ds),{class:Q(["w-5 h-5 text-white/50",{"animate-spin":c(d)}])},null,8,["class"])],8,Ma)]),e("div",Da,[c(d)&&!c(o).length?(h(),x("div",Oa,[...m[3]||(m[3]=[e("div",{class:"w-8 h-8 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin mb-3"},null,-1),e("p",{class:"text-white/40 text-base"},"Discovering rooms...",-1)])])):c(w)?(h(),x("div",Na,[e("p",La,he(c(w)),1),e("button",{onClick:f,class:"text-base text-emerald-400/60 hover:text-emerald-400 transition-colors"},"Try again")])):!c(de).length&&!c(d)?(h(),x("div",$a,[k(c(Ut),{class:"w-10 h-10 text-white/[0.08] mx-auto mb-2"}),e("p",Ua,he(c(i)?"No rooms match your search":"No public rooms yet"),1)])):(h(),x("div",Ba,[(h(!0),x(nt,null,ot(c(de),y=>(h(),x("div",{key:y.roomId,class:"space-y-0"},[e("button",{onClick:u=>pe(y),class:Q(["group w-full text-left flex items-center gap-3 bg-black/50 border border-white/[0.12] px-4 py-3 transition-all",[c(I)===y.roomId?"rounded-t-xl border-b-0 border-amber-500/30 bg-amber-500/[0.04]":"rounded-xl hover:border-emerald-500/30 hover:bg-emerald-500/[0.06]"]])},[e("div",Va,[e("div",za,[e("h4",Ka,he(c(U)(y)),1),y.passwordProtected?(h(),ve(c(Ze),{key:0,class:"w-4 h-4 text-amber-400/60 flex-shrink-0"})):O("",!0),(h(!0),x(nt,null,ot(y.tags?.slice(0,2),u=>(h(),x("span",{key:u,class:"hidden sm:inline px-1.5 py-0.5 rounded bg-white/[0.06] text-white/35 text-base leading-tight flex-shrink-0"},he(u),1))),128))]),y.description?(h(),x("p",Fa,he(y.description),1)):O("",!0)]),e("div",{onClick:ge(u=>D(y),["stop"]),class:"p-1 cursor-pointer flex-shrink-0"},[te(y.roomId)?(h(),ve(c(Po),{key:0,class:"w-4 h-4 text-amber-400"})):(h(),ve(c(Do),{key:1,class:"w-4 h-4 text-white/15 group-hover:text-white/30 transition-colors"}))],8,Wa)],10,ja),c(I)===y.roomId?(h(),x("div",Ha,[k(c(Ze),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),st(e("input",{ref_for:!0,ref_key:"passwordInputRef",ref:_,"onUpdate:modelValue":m[1]||(m[1]=u=>Ye(C)?C.value=u:null),type:"password",placeholder:"Enter room password",maxlength:"32",onKeydown:[cs(u=>xe(y),["enter"]),m[2]||(m[2]=cs(u=>I.value=null,["escape"]))],class:"flex-1 bg-black/60 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,Ya),[[wt,c(C)]]),e("button",{onClick:u=>xe(y),class:"px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-300 text-base font-medium hover:bg-amber-500/30 transition-colors"}," Join ",8,Ja)])):O("",!0)]))),128))]))])]))}}),Za=Object.assign(xs(Ga,[["__scopeId","data-v-be232ca8"]]),{__name:"Room3dPublicBrowser"}),Re=S();let Y=null,ae=null,V=null,ps=0,fs=0;const is=new Ro,ms=S(!1);let dt=0;const _e=S([]),St=S(""),hs="sf_room3d_user_name",Ss=S("");function qa(){const t=Ss.value.trim();t?localStorage.setItem(hs,t):localStorage.removeItem(hs)}function Xa(){Ss.value=localStorage.getItem(hs)||""}const Qa=S(),En=S(0);function er(t){const s=t.target;if(!s)return;const n=s.scrollWidth/co.length;En.value=Math.round(s.scrollLeft/n)}const tr=S({}),sr=S(""),nr=Pe(()=>window.location.origin);let Ve=null,ce=[],Je=0,Be=0;const ue=S(0),bs=2.8;let Vt=null;const xt=new Set;async function or(){if(!Re.value||V)return;const t="ontouchstart"in window||navigator.maxTouchPoints>0;Y=new mo,ae=new ho(34,Re.value.clientWidth/Re.value.clientHeight,.1,50),ae.position.set(0,1.25,4.8),ae.lookAt(0,.6,0),V=new bo({antialias:!t,alpha:!0}),V.setPixelRatio(Math.min(window.devicePixelRatio,t?1.5:2)),V.setSize(Re.value.clientWidth,Re.value.clientHeight),V.setClearColor(0,0),V.toneMapping=t?yo:vo,V.toneMappingExposure=1.6,t||(V.shadowMap.enabled=!0,V.shadowMap.type=wo),Re.value.appendChild(V.domElement),Y.fog=new xo(394767,.06);const s=new ts(16772829,3.5);s.position.set(2,5,5),t||(s.castShadow=!0,s.shadow.mapSize.set(1024,1024),s.shadow.camera.near=.5,s.shadow.camera.far=15,s.shadow.bias=-.002),Y.add(s);const n=new ts(6724044,.8);n.position.set(-4,2,3),Y.add(n);const a=new ts(1096065,2);if(a.position.set(0,3,-5),Y.add(a),!t){const r=new go(16777215,4,12,Math.PI/8,.6,1);r.position.set(0,5,3),r.target.position.set(0,0,bs),Y.add(r),Y.add(r.target)}Y.add(new ko(3359829,t?1.2:.6)),Ve=new vn,Y.add(Ve),window.addEventListener("resize",An);try{await V.compileAsync(Y,ae)}catch{}fs=performance.now(),Pn()}function An(){if(!Re.value||!V||!ae)return;const t=Re.value.clientWidth,s=Re.value.clientHeight;ae.aspect=t/s,ae.updateProjectionMatrix(),V.setSize(t,s)}async function ar(){if(!Y||!Ve||_e.value.length===0)return;ms.value=!0;const t=++dt,s=_e.value,n=s.length,a=Math.PI*2/n;if(!Vt)try{const o=new wn,d=await new Promise((w,I)=>o.load("/data/appdata/models/characters/animations/Idle.glb",w,void 0,I));d.animations?.length&&(Vt=d.animations.find(w=>!w.name.includes("T-Pose"))||d.animations[d.animations.length-1])}catch{}if(t!==dt)return;ce=[],xt.clear();for(let o=0;o<n;o++){const d=o*a,w=new vn;w.position.set(Math.sin(d)*bs,0,Math.cos(d)*bs),Ve.add(w),ce.push({wrapper:w,model:null,mixer:null,file:s[o],loaded:!1})}const r=s.indexOf(St.value);r>=0&&(ue.value=r,Je=Be=-r*a);const i=[ue.value];if(n>1&&i.push(((ue.value+1)%n+n)%n),n>2&&i.push(((ue.value-1)%n+n)%n),await Promise.all(i.map(o=>_n(o,t))),t===dt&&V&&Y&&ae){try{await V.compileAsync(Y,ae)}catch{}for(const d of i){const w=ce[d];w?.model&&(w.model.visible=!0)}const o=new Map;Y.traverse(d=>{d.frustumCulled&&(o.set(d,!0),d.frustumCulled=!1)}),V.render(Y,ae);for(const[d]of o)d.frustumCulled=!0;V.info.reset()}else for(const o of i){const d=ce[o];d?.model&&(d.model.visible=!0)}Tn(),ms.value=!1}async function _n(t,s){const n=s??dt;if(t<0||t>=ce.length)return;const a=ce[t];if(!(!a||a.loaded||xt.has(t))){xt.add(t);try{const r=new wn,i=await new Promise((_,U)=>{r.load(`/data/appdata/models/characters/${encodeURIComponent(a.file)}`,_,void 0,U)});if(n!==dt){i.scene.traverse(_=>{_.geometry&&_.geometry.dispose()});return}const o=i.scene,d=new So().setFromObject(o),w=d.max.y-d.min.y;if(w>0){const _=1.4/w;o.scale.setScalar(_),o.position.y=-d.min.y*_,o.position.x=-(d.min.x+d.max.x)/2*_,o.position.z=-(d.min.z+d.max.z)/2*_}o.visible=!1,a.wrapper.add(o),a.model=o;const I=i.animations||[];let C=I.find(_=>/idle/i.test(_.name)&&!_.name.includes("T-Pose"));!C&&I.length>0&&(C=I.find(_=>!_.name.includes("T-Pose"))||I[0]),!C&&Vt&&(C=Vt),C&&(a.mixer=new Co(o),a.mixer.clipAction(C).play()),a.loaded=!0}catch{}finally{xt.delete(t)}}}function rr(t,s){t.model&&t.model.traverse(n=>{if(n.isMesh&&n.material){const a=Array.isArray(n.material)?n.material:[n.material];for(const r of a)r.transparent=!0,r.opacity=s}})}function Tn(){if(!ce.length)return;const t=ce.length;for(let s=0;s<t;s++){const n=((s-ue.value)%t+t)%t,a=n>t/2?t-n:n,r=a===0?1.05:1;ce[s].wrapper.scale.setScalar(r),ce[s].wrapper.visible=a<=2,rr(ce[s],a<=1?1:.25)}}let an=0;function Pn(){if(!V||!Y||!ae)return;ps=requestAnimationFrame(Pn);const t=performance.now(),s=t,n=Math.min((s-fs)/1e3,.1);fs=s;for(const i of ce)i.mixer&&i.mixer.update(n);if(Ve){const i=Be-Je;Math.abs(i)>.001?Je+=i*Math.min(1,n*4):Je=Be,Ve.rotation.y=Je;const o=ae.position;for(const d of ce){d.wrapper.getWorldPosition(is);const w=o.x-is.x,I=o.z-is.z,C=Math.atan2(w,I);d.wrapper.rotation.y=C-Ve.rotation.y}}performance.now(),V.render(Y,ae);const a=performance.now();a-t>50&&a-an>2e3&&(an=a,V.info)}function Cs(t){const s=_e.value.length;if(s<2)return;const n=ue.value,a=Math.PI*2/s;for(ue.value=(t%s+s)%s,Be=-ue.value*a;Be-Je>Math.PI;)Be-=Math.PI*2;for(;Be-Je<-Math.PI;)Be+=Math.PI*2;St.value=_e.value[ue.value],Tn();const r=ue.value>n||n===s-1&&ue.value===0?1:-1,i=((ue.value+r)%s+s)%s;_n(i).then(()=>{const o=ce[i];o?.model&&!o.model.visible&&(V&&Y&&ae?V.compileAsync(Y,ae).then(()=>{o.model&&(o.model.visible=!0),V&&Y&&ae&&(V.render(Y,ae),V.info.reset())}).catch(()=>{o.model&&(o.model.visible=!0)}):o.model&&(o.model.visible=!0))})}function In(){Cs(ue.value-1)}function Mn(){Cs(ue.value+1)}let rn=0;function ir(t){if(t.preventDefault(),_e.value.length<2)return;const s=Date.now();s-rn<200||(rn=s,t.deltaY>0?Mn():t.deltaY<0&&In())}function lr(){window.removeEventListener("resize",An),cancelAnimationFrame(ps),ps=0,dt++,xt.clear();for(const t of ce)t.mixer&&t.mixer.stopAllAction(),lo(t.wrapper);ce=[],Y&&(Y.traverse(t=>{if(t.geometry&&t.geometry.dispose(),t.material){const s=Array.isArray(t.material)?t.material:[t.material];for(const n of s)n.dispose()}}),Y=null),Ve=null,V&&(V.domElement.remove(),V.dispose(),V=null),ae=null}async function cr(){try{const t=await $fetch("/api/room3d/characters");if(t?.length){const s=[...t];for(let n=s.length-1;n>0;n--){const a=Math.floor(Math.random()*(n+1));[s[n],s[a]]=[s[a],s[n]]}_e.value=s}!_e.value.includes(St.value)&&_e.value.length>0&&(St.value=_e.value[0])}catch{}}function dr(){return{lobbyCanvas:Re,lobbyCharLoading:ms,availableCharacters:_e,selectedCharacter:St,displayName:Ss,saveDisplayName:qa,loadDisplayName:Xa,roomScrollContainer:Qa,activeRoomIdx:En,onRoomScroll:er,editingCode:tr,copiedCode:sr,currentDomain:nr,carouselSelectedIdx:ue,initLobbyScene:or,disposeLobbyScene:lr,initCarouselPositions:ar,lobbyRotateToIndex:Cs,lobbyPrevChar:In,lobbyNextChar:Mn,onLobbyWheel:ir,loadAvailableCharacters:cr,charDisplayName:io}}const ur=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}];let T=null,Z=null,gt=null,Ie=null,zt=null;const W=new Map,Me=new Map;let $=null,Dn=1,On=20,Ot=null;const pr=5e3,fr=1e4;let Rs=!1;const mr=2,hr=3e3;let ke=!1,br=null,ht=!1,Ee=null,kt=null,Qe=!1;const ft=new Map,Ue=new Map,be=new Map;let Es=0,Ge="",As=0;const Nn="room3d-voice-settings",ln={mode:"vad",muted:!1,volume:80,spatialAudio:!0,autoJoin:!0};function yr(){try{const t=localStorage.getItem(Nn);if(t)return{...ln,...JSON.parse(t)}}catch{}return{...ln}}function Et(){try{localStorage.setItem(Nn,JSON.stringify({mode:De.value,muted:ye.value,volume:tt.value,spatialAudio:Qt.value,autoJoin:_s.value}))}catch{}}const At=yr(),ze=S(!1),De=S(At.mode),ye=S(At.muted),Oe=S(!1),et=S(!1),tt=S(At.volume),Qt=S(At.spatialAudio),_s=S(At.autoJoin),Ts=S(!1),Ae=S("unknown"),es=to(new Map),vr=8,wr=30,xr=400;let Nt=null,rt=0,it=0,Xe=!1,Lt=null,je=null;function mt(t){const s=Z?.getAudioTracks()[0];s&&(s.enabled=t)}function gr(t,s){if(!T)return null;const n=W.get(s);if(!n)return null;if(n.source)return n;if(t.getAudioTracks().length===0)return null;const r=T.createMediaStreamSource(t),i=T.createGain();i.gain.value=tt.value/100;const o=T.createPanner();o.panningModel="HRTF",o.distanceModel="inverse",o.refDistance=Dn,o.maxDistance=On,o.rolloffFactor=1.5,o.coneInnerAngle=360,o.coneOuterAngle=360,o.coneOuterGain=1;const d=T.createAnalyser();return d.fftSize=256,d.smoothingTimeConstant=.5,r.connect(i),i.connect(o),o.connect(d),d.connect(T.destination),n.source=r,n.gain=i,n.panner=o,n.analyser=d,n.stream=t,n}function Ln(t){const s=new RTCPeerConnection({iceServers:ur});return s.onicecandidate=n=>{n.candidate&&$&&$.sendVoiceSignal(t,"voice:ice",{candidate:n.candidate})},s.ontrack=n=>{const a=n.streams[0]||new MediaStream([n.track]);T&&T.state==="suspended"&&T.resume().catch(()=>{});const r=W.get(t);if(r&&!r.audioEl)try{const o=new Audio;o.srcObject=a,o.autoplay=!0,o.volume=tt.value/100,o.play().then(()=>{}).catch(d=>{}),r.audioEl=o}catch{}W.get(t)?.audioEl||gr(a,t)},s.onconnectionstatechange=()=>{if(s.connectionState==="connected"&&ke){let a=!0;for(const[,r]of W)if(r.pc.connectionState!=="connected"){a=!1;break}a&&Yr()}},s.oniceconnectionstatechange=()=>{},s.onsignalingstatechange=()=>{},s}let $n=1;function kr(t,s=1){$=t,$n=s}async function Sr(){if(Z)return Ae.value="granted",!0;if(!navigator.mediaDevices?.getUserMedia)return Ge="getUserMedia not available (no HTTPS?)",Ae.value="unavailable",!1;try{return Z=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1}),Ae.value="granted",!0}catch(t){return Ge=t?.message||String(t)||"Mic denied",Ae.value=t?.name==="NotAllowedError"?"denied":"error",!1}}async function Cr(){if(Z){Ae.value="granted";return}if(!navigator.mediaDevices?.getUserMedia){Ae.value="unavailable";return}try{const t=await navigator.permissions.query({name:"microphone"});Ae.value=t.state==="granted"?"granted":t.state==="denied"?"denied":"prompt",t.onchange=()=>{Z||(Ae.value=t.state==="granted"?"granted":t.state==="denied"?"denied":"prompt")}}catch{Ae.value="prompt"}}async function Rr(t,s){t&&($=t);const n=s??$n;if(Dn=1*n,On=20*n,!ze.value){if(!$){Ge="No multiplayer ref";return}Ge="";try{if(!Z){if(!navigator.mediaDevices?.getUserMedia){Ge="getUserMedia not available (no HTTPS?)";return}Z=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})}const a=Z.getAudioTracks()[0];if((!a||a.readyState!=="live")&&(Z=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})),T=new AudioContext,T.state==="suspended")try{await T.resume()}catch{}if(!Qe)try{await T.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await T.audioWorklet.addModule("/workers/audio-playback.worklet.js"),Qe=!0}catch{}const r=Z.getAudioTracks()[0];gt=r.clone();const i=new MediaStream([gt]);Ie=T.createAnalyser(),Ie.fftSize=512,Ie.smoothingTimeConstant=.5,zt=new Uint8Array(Ie.frequencyBinCount),T.createMediaStreamSource(i).connect(Ie),r.enabled=De.value==="vad"&&!ye.value,$.onVoiceSignal(_r),$.onVoiceState(Tr),Nt=ct(Dr,100),Lt=ct(Nr,100),Ot=ct(Pr,pr),ze.value=!0}catch(a){Ge=a?.message||String(a)||"Unknown error",zn()}}}async function Un(t){if(!ze.value||!Z||!$||W.has(t))return;const n=($.localPeerId?.value||"")<t,a=Ln(t);for(const i of Z.getAudioTracks())a.addTrack(i,Z);const r={pc:a,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:n};if(W.set(t,r),n)try{const i=await a.createOffer();await a.setLocalDescription(i),$.sendVoiceSignal(t,"voice:offer",{sdp:a.localDescription}),r.offerSentAt=Date.now()}catch{W.delete(t),a.close()}setTimeout(()=>{const i=W.get(t);i&&i.pc.connectionState!=="connected"&&!ke&&Bn()},hr)}async function cn(t){const s=Me.get(t);if(!s||s.length===0)return;Me.delete(t);const n=W.get(t);if(n)for(const a of s)try{await n.pc.addIceCandidate(new RTCIceCandidate(a))}catch{}}function Er(t,s,n){if(s===n)return t;const a=s/n,r=Math.round(t.length/a),i=new Int16Array(r);for(let o=0;o<r;o++){const d=o*a,w=Math.floor(d),I=Math.min(w+1,t.length-1),C=d-w;i[o]=Math.round(t[w]*(1-C)+t[I]*C)}return i}function Ar(t,s){if(T&&(T.state==="suspended"&&T.resume().catch(()=>{}),ke||(ke=!0,ht=!0,jn()),!(!s.audio||typeof s.audio!="string"))){As++;try{const n=atob(s.audio),a=new Uint8Array(n.length);for(let w=0;w<n.length;w++)a[w]=n.charCodeAt(w);let r=new Int16Array(a.buffer,a.byteOffset,a.byteLength>>1);const i=s.sr||48e3,o=T.sampleRate;i!==o&&(r=Er(r,i,o)),ft.has(t),ft.set(t,Date.now()),be.has(t)||Jr(t);const d=be.get(t);if(!d)return;d.workletNode.port.postMessage(r.buffer,[r.buffer])}catch{}}}async function _r(t,s,n){if(!(!Z||!$))if(s==="voice:offer"){let a=W.get(t);if(a&&a.pc.signalingState==="have-local-offer"){if(($.localPeerId?.value||"")>t)return;try{await a.pc.setLocalDescription({type:"rollback"})}catch{}}if(!a){const r=Ln(t);for(const i of Z.getAudioTracks())r.addTrack(i,Z);a={pc:r,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:!1},W.set(t,a)}try{await a.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await cn(t);const r=await a.pc.createAnswer();await a.pc.setLocalDescription(r),$.sendVoiceSignal(t,"voice:answer",{sdp:a.pc.localDescription})}catch{}}else if(s==="voice:answer"){const a=W.get(t);if(!a||a.pc.signalingState!=="have-local-offer")return;try{await a.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await cn(t)}catch{}}else if(s==="voice:ice"){const a=W.get(t);if(!a){let r=Me.get(t);r||(r=[],Me.set(t,r)),r.push(n.candidate);return}if(n.candidate)if(a.pc.remoteDescription)try{await a.pc.addIceCandidate(new RTCIceCandidate(n.candidate))}catch{}else{let r=Me.get(t);r||(r=[],Me.set(t,r)),r.push(n.candidate)}}else s==="voice:relay"&&Ar(t,n)}function Tr(t,s){es.set(t,{...s}),je&&je(t,s.speaking)}function Kt(t){const s=W.get(t);if(s){try{s.source?.disconnect()}catch{}try{s.gain?.disconnect()}catch{}try{s.panner?.disconnect()}catch{}try{s.analyser?.disconnect()}catch{}s.audioEl&&(s.audioEl.pause(),s.audioEl.srcObject=null,s.audioEl=null),s.pc.close(),W.delete(t)}Ps(t),es.delete(t),Me.delete(t)}function Pr(){if(!ze.value||!$)return;const t=Date.now();for(const[s,n]of W){const a=n.pc.connectionState,r=n.pc.signalingState;if(a==="connected"){Ue.delete(s);continue}if(a==="failed"||a==="closed"){Kt(s),Ue.set(s,(Ue.get(s)||0)+1);continue}if(n.isOfferer&&n.offerSentAt>0&&r==="have-local-offer"&&t-n.offerSentAt>fr){Kt(s),Ue.set(s,(Ue.get(s)||0)+1);continue}}if(!ke){for(const[,s]of Ue)if(s>=mr){Bn();break}}for(const s of $.remotePlayers.value.keys())W.has(s)||Un(s)}function Ir(t,s){if(!T||T.state==="closed"||!Qt.value)return;const n=T.listener;if(t){const a=t.position;n.positionX?(n.positionX.value=a.x,n.positionY.value=a.y,n.positionZ.value=a.z):n.setPosition(a.x,a.y,a.z);const r={x:0,y:0,z:-1},i={x:0,y:1,z:0},o=t.quaternion,d=r.x,w=r.y,I=r.z,C=o.x,_=o.y,U=o.z,J=o.w,re=J*d+_*I-U*w,te=J*w+U*d-C*I,D=J*I+C*w-_*d,de=-C*d-_*w-U*I;r.x=re*J+de*-C+te*-U-D*-_,r.y=te*J+de*-_+D*-C-re*-U,r.z=D*J+de*-U+re*-_-te*-C;const pe=i.x,xe=i.y,f=i.z,b=J*pe+_*f-U*xe,m=J*xe+U*pe-C*f,y=J*f+C*xe-_*pe,u=-C*pe-_*xe-U*f;i.x=b*J+u*-C+m*-U-y*-_,i.y=m*J+u*-_+y*-C-b*-U,i.z=y*J+u*-U+b*-_-m*-C,n.forwardX?(n.forwardX.value=r.x,n.forwardY.value=r.y,n.forwardZ.value=r.z,n.upX.value=i.x,n.upY.value=i.y,n.upZ.value=i.z):n.setOrientation(r.x,r.y,r.z,i.x,i.y,i.z)}for(const[a,r]of W){if(!r.panner)continue;const i=s.getPlayerPosition3D(a);i&&(r.panner.positionX?(r.panner.positionX.value=i.x,r.panner.positionY.value=i.y,r.panner.positionZ.value=i.z):r.panner.setPosition(i.x,i.y,i.z))}}function Mr(t){!ze.value||ye.value||(et.value=t,De.value==="ptt"&&(Oe.value=t,mt(t),$?.sendVoiceState({muted:!1,speaking:t})))}function Dr(){if(De.value!=="vad"||!Ie||!zt||ye.value||$&&$.remotePlayers.value.size===0){Xe&&dn();return}const t=zt;Ie.getByteFrequencyData(t);let s=0;for(let r=0;r<t.length;r++)s+=t[r];const n=s/t.length,a=Date.now();n>vr?(it=0,rt||(rt=a),!Xe&&a-rt>=wr&&Or()):(rt=0,Xe&&(it||(it=a),a-it>=xr&&dn()))}function Or(){Xe=!0,Oe.value=!0,$?.sendVoiceState({muted:!1,speaking:!0})}function dn(){Xe=!1,!Rs&&(Oe.value=!1,$?.sendVoiceState({muted:ye.value,speaking:!1}))}function Nr(){if(W.size===0&&be.size===0)return;const t=12;for(const[s,n]of W){if(!n.analyser)continue;const a=new Uint8Array(n.analyser.frequencyBinCount);n.analyser.getByteFrequencyData(a);let r=0;for(let d=0;d<a.length;d++)r+=a[d];const o=r/a.length>t;o!==n.speaking&&(n.speaking=o,je&&je(s,o))}if(be.size>0){const s=Date.now();for(const[n]of be){const a=ft.get(n)||0,r=s-a<300;je&&je(n,r)}}}function Lr(t){De.value=t,t==="ptt"?(et.value||(Oe.value=!1,mt(!1),$?.sendVoiceState({muted:ye.value,speaking:!1})),Xe=!1,rt=0,it=0):(et.value=!1,ye.value||mt(!0)),Et()}function $r(){ye.value=!ye.value,ye.value?(Oe.value=!1,et.value=!1,mt(!1),$?.sendVoiceState({muted:!0,speaking:!1})):De.value==="vad"&&mt(!0),Et()}function Ur(t){tt.value=Math.max(0,Math.min(100,t));const s=tt.value/100;for(const n of W.values())n.gain&&(n.gain.gain.value=s),n.audioEl&&(n.audioEl.volume=s);for(const n of be.values())n.gain.gain.value=s*2.5;Et()}function Br(t){if(Qt.value=t,!t)for(const s of W.values())s.panner&&(s.panner.positionX?(s.panner.positionX.value=0,s.panner.positionY.value=0,s.panner.positionZ.value=0):s.panner.setPosition(0,0,0));Et()}function jr(t){_s.value=t,Et()}function Vr(){Ts.value=!0}function zr(){Ts.value=!1}function Kr(t){je=t}function Fr(){return[...W.keys()]}function Wr(){const t=[];for(const[n,a]of W)t.push({id:n.slice(0,6),conn:a.pc.connectionState,ice:a.pc.iceConnectionState,sig:a.pc.signalingState,hasRemoteDesc:!!a.pc.remoteDescription,hasTrack:!!a.stream,trackEnabled:a.stream?.getAudioTracks()[0]?.enabled??!1});const s=Z?.getAudioTracks()[0];return{lastInitError:Ge||"",audioCtx:T?.state||"none",sampleRate:T?.sampleRate||0,workletLoaded:Qe,captureActive:!!Ee,relayMode:ke,useGameWsRelay:ht,relaySendCount:Es,relayRecvCount:As,voiceWs:br?.readyState===WebSocket.OPEN?"open":"closed",relayPeers:be.size,voiceEnabled:ze.value,localStream:!!Z,localTrackState:s?.readyState||"none",localTrackEnabled:s?.enabled??!1,localMuted:ye.value,localSpeaking:Oe.value,voiceMode:De.value,mp:!!$,mpConnected:$?.connected?.value??!1,localPeerId:($?.localPeerId?.value||"").slice(0,6),iceBuf:Me.size,peers:t}}function Hr(){Rs=!0,mt(!0),Oe.value=!0}function Bn(){ke||(ke=!0,ht=!0,T&&T.state==="suspended"&&T.resume().catch(()=>{}),jn())}function Yr(){if(ke){ke=!1,ht=!1,Vn();for(const t of[...be.keys()])Ps(t);ft.clear(),Ue.clear()}}async function jn(){if(!(Ee||!T||!Z)){if(!Qe)try{await T.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await T.audioWorklet.addModule("/workers/audio-playback.worklet.js"),Qe=!0}catch{return}kt=T.createMediaStreamSource(Z),Ee=new AudioWorkletNode(T,"audio-capture-processor"),Ee.port.onmessage=t=>{if(!ye.value&&!(De.value==="ptt"&&!et.value)&&ht&&$){const s=new Int16Array(t.data),n=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);let a="";for(let i=0;i<n.length;i++)a+=String.fromCharCode(n[i]);const r=btoa(a);$.sendVoiceRelay(r,T?.sampleRate||48e3),Es++}},kt.connect(Ee),Ee.connect(T.destination)}}function Vn(){if(Ee){Ee.port.postMessage({type:"mute",value:!0});try{Ee.disconnect()}catch{}Ee=null}if(kt){try{kt.disconnect()}catch{}kt=null}}function Jr(t){if(!(!T||be.has(t)||!Qe))try{const s=new AudioWorkletNode(T,"audio-playback-processor"),n=T.createGain();n.gain.value=tt.value/100*2.5,s.connect(n),n.connect(T.destination),be.set(t,{workletNode:s,gain:n})}catch{}}function Ps(t){const s=be.get(t);if(s){try{s.workletNode.port.postMessage({type:"reset"})}catch{}try{s.workletNode.disconnect()}catch{}try{s.gain.disconnect()}catch{}be.delete(t),ft.delete(t)}}function zn(){Nt&&(clearInterval(Nt),Nt=null),Lt&&(clearInterval(Lt),Lt=null),Ot&&(clearInterval(Ot),Ot=null);for(const t of[...W.keys()])Kt(t);if(Z){for(const t of Z.getTracks())t.stop();Z=null}gt&&(gt.stop(),gt=null);try{Ie?.disconnect()}catch{}Ie=null,zt=null,Vn();for(const t of[...be.keys()])Ps(t);ft.clear(),Ue.clear(),ke=!1,ht=!1,Es=0,As=0,T&&T.state!=="closed"&&T.close().catch(()=>{}),T=null,Qe=!1,$&&($.onVoiceSignal(null),$.onVoiceState(null)),$=null,ze.value=!1,Oe.value=!1,et.value=!1,Xe=!1,rt=0,it=0,Rs=!1,es.clear(),Me.clear(),je=null}function Gr(){return{voiceEnabled:ze,voiceMode:De,localMuted:ye,localSpeaking:Oe,pttActive:et,masterVolume:tt,spatialEnabled:Qt,autoJoinVoice:_s,showVoiceSettings:Ts,peerVoiceStates:es,micPermissionState:Ae,checkMicPermission:Cr,requestMicrophone:Sr,setMultiplayerRef:kr,initVoice:Rr,disposeVoice:zn,connectToPeer:Un,disconnectPeer:Kt,updateSpatialPositions:Ir,setVoiceMode:Lr,setPTT:Mr,toggleMute:$r,setMasterVolume:Ur,setSpatialAudio:Br,setAutoJoin:jr,openVoiceSettings:Vr,closeVoiceSettings:zr,onPeerSpeakingChanged:Kr,getConnectedPeerIds:Fr,getVoiceDebugInfo:Wr,forceEnableTransmit:Hr}}const Zr={key:1,class:"absolute top-4 right-4 z-30"},qr={class:"px-3 py-1.5 rounded-full bg-black/70 backdrop-blur-sm border border-white/15 text-base text-gray-300 flex items-center gap-2"},Xr={key:0,class:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none"},Qr={class:"absolute top-0 left-0 right-0 z-20 text-center pt-5 pointer-events-none"},ei={class:"inline-block"},ti={class:"mt-2 flex items-center justify-center gap-2 flex-wrap"},si={key:0,class:"inline-block bg-yellow-500/10 border border-yellow-500/30 rounded-full px-3 py-0.5"},ni={key:0,class:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-64 bg-black/90 border border-red-500/30 rounded-lg p-3 text-left z-50 shadow-xl"},oi={key:0,class:"mt-2 flex items-center justify-center gap-2 pointer-events-auto"},ai={class:"relative inline-flex items-center cursor-pointer"},ri={class:"absolute bottom-0 left-0 right-0 z-20 lobby-bottom-fade pointer-events-none"},ii={key:0,class:"pointer-events-auto max-w-xs mx-auto px-4 pb-6 text-center"},li={key:0,class:"flex items-center justify-center gap-1.5 mb-4"},ci=["disabled"],di={key:1,class:"mt-3 flex items-center gap-2"},ui={class:"relative flex-1"},pi=["disabled"],fi={key:1,class:"max-w-6xl mx-auto px-0 pb-3 sm:px-6 sm:pb-6"},mi={class:"text-center mb-3 sm:mb-4"},hi={key:0,class:"hidden sm:flex items-center justify-center gap-1.5 mb-2"},bi={class:"flex justify-center"},yi={class:"flex items-center justify-center gap-3 sm:gap-4 mb-2 sm:mb-3 pointer-events-auto"},vi={class:"flex items-center bg-black/60 rounded-xl p-0.5 border border-white/15"},wi={key:0,class:"pointer-events-auto relative"},xi={class:"lobby-room-card group relative overflow-hidden rounded-2xl transition-all duration-300 hover:scale-[1.03]"},gi=["onClick"],ki={class:"relative h-44 sm:h-56 overflow-hidden"},Si=["src","alt"],Ci={key:1,class:"w-full h-full bg-gradient-to-br from-gray-800/80 to-gray-900/80 flex items-center justify-center"},Ri={key:2,class:"absolute top-2 right-2 bg-amber-500/20 border border-amber-500/30 rounded-full px-2 py-0.5"},Ei={class:"absolute bottom-3 left-3 right-3"},Ai={class:"text-white font-bold text-lg sm:text-xl drop-shadow-lg group-hover:text-emerald-300 transition-colors leading-tight"},_i={key:0,class:"text-white/50 text-base drop-shadow-lg truncate mt-0.5"},Ti=["onClick"],Pi=["onClick"],Ii={class:"space-y-1.5"},Mi={class:"flex items-center justify-between"},Di={class:"flex items-center gap-1.5 cursor-pointer"},Oi={class:"relative inline-flex items-center"},Ni=["checked","onChange"],Li={class:"flex items-center gap-1.5 cursor-pointer"},$i={class:"relative inline-flex items-center"},Ui=["checked","onChange"],Bi={class:"flex items-center gap-2"},ji=["onClick"],Vi=["onClick"],zi=["onClick"],Ki=["value","placeholder","onBlur"],Fi=["value","onBlur"],Wi={class:"flex items-center gap-2"},Hi=["value","onBlur"],Yi={key:1,class:"flex items-center justify-center gap-1.5 mt-3 pointer-events-auto"},Ji=["onClick"],Gi={key:2,class:"pointer-events-auto"},Zi={class:"flex items-center justify-between"},qi={class:"space-y-4"},Xi={class:"flex items-center justify-between cursor-pointer"},Qi={class:"relative inline-flex items-center"},el=["checked"],tl={class:"flex items-center justify-between cursor-pointer"},sl={class:"relative inline-flex items-center"},nl=["checked"],ol={class:"space-y-2"},al={class:"flex items-center gap-2"},rl=["value"],il={class:"space-y-2"},ll={class:"flex items-center gap-2"},cl=["value","placeholder"],dl=["value"],ul=ws({__name:"Room3dLobby",props:{environments:{},availableCharacters:{},selectedCharacter:{},carouselSelectedIdx:{},lobbyCharLoading:{type:Boolean},displayName:{},isDev:{type:Boolean},editMode:{type:Boolean},authenticated:{type:Boolean},roomSettings:{},inviteTokens:{},copiedToken:{},activeRoomIdx:{},guestMode:{type:Boolean},guestReady:{type:Boolean},guestOnlineCount:{},guestConnected:{type:Boolean},hideTokenPaste:{type:Boolean}},emits:["select-environment","prev-char","next-char","lobby-wheel","update-room-settings","copy-link","update:displayName","update:editMode","save-display-name","room-scroll","enter-room","join-public-room","join-by-token"],setup(t,{emit:s}){const n={isPublic:!0,inviteOnly:!1,publicName:"",publicDescription:"",password:""},a={isPublic:!1,inviteOnly:!0,publicName:"",publicDescription:"",password:""},r=t,i=s,{sidebarOpen:o}=uo(),d=Gr(),w=d.micPermissionState;Mt(async()=>{await d.checkMicPermission()});const I=S(!1);async function C(){if(I.value=!1,await d.requestMicrophone()){await d.checkMicPermission();return}w.value==="denied"&&(I.value=!0,setTimeout(()=>{I.value=!1},6e3))}const _=S(!1),U=S("");function J(){const v=U.value.trim();v.startsWith("sfr:")&&(i("join-by-token",v),U.value="")}const re=S(null),te=S(null),D=S(null);function de(v){D.value=v}function pe(v){te.value=null,re.value=re.value===v?null:v}function xe(v){re.value=null,te.value=te.value===v?null:v}function f(v,l){const M=r.roomSettings[v];return M&&l in M?M[l]:(v==="big_room"?n:a)[l]}function b(v,l){const M=l.target.value;i("update-room-settings",v,{publicName:M})}function m(v,l){const M=l.target.value;i("update-room-settings",v,{publicDescription:M})}function y(v,l){const M=l.target.value;i("update-room-settings",v,{password:M})}const u=Pe(()=>r.authenticated?r.environments:r.environments.filter(v=>!v.hidden)),g=Pe({get:()=>r.displayName,set:v=>i("update:displayName",v)}),R=Pe({get:()=>r.editMode,set:v=>i("update:editMode",v)}),E=S("rooms"),se=S(),L=S(),G=S(),B=S(0),j=S(3),ne=Pe(()=>j.value===1),q=Pe(()=>ne.value?u.value.length:Math.max(1,Math.ceil(u.value.length/j.value))),X=Pe(()=>{const v=u.value.length,l=j.value;if(ne.value)return u.value;if(B.value>=q.value-1&&v>l)return u.value.slice(v-l);const M=B.value*l;return u.value.slice(M,M+l)});function ee(){B.value>0&&B.value--}function z(){B.value<q.value-1&&B.value++}function ie(){const v=window.innerWidth;if(v<640){j.value=1;return}const l=404,M=Math.min(v-48,1152);j.value=Math.max(1,Math.floor(M/l))}Mt(()=>{ie(),window.addEventListener("resize",ie)}),js(()=>{window.removeEventListener("resize",ie)});const Ne=dr();Vs(se,v=>{v&&(Ne.lobbyCanvas.value=v)}),Vs(L,v=>{v&&(Ne.roomScrollContainer.value=v)});let oe=null,Tt=null;Mt(()=>{const v=G.value;if(!v)return;v.width=480,v.height=270;const l=v.getContext("2d");if(!l)return;oe=document.createElement("video"),oe.muted=!0,oe.loop=!0,oe.playsInline=!0,oe.preload="auto",oe.setAttribute("muted",""),oe.setAttribute("playsinline",""),oe.src="/data/appdata/video/loby-background.mp4";const M=oe;M.addEventListener("pause",()=>{M.readyState>=2&&setTimeout(()=>M.play().catch(()=>{}),50)}),M.play().catch(()=>{const Se=()=>{M.play().catch(()=>{})};document.addEventListener("click",Se,{once:!0}),document.addEventListener("touchstart",Se,{once:!0})});const Fe=()=>{M.readyState>=2&&!M.paused&&l.drawImage(M,0,0,480,270),M.paused&&M.readyState>=2&&M.play().catch(()=>{})};if("requestVideoFrameCallback"in M){const Se=()=>{Fe(),oe&&M.requestVideoFrameCallback(Se)};M.requestVideoFrameCallback(Se)}else Tt=ct(Fe,42)}),js(()=>{Tt&&(clearInterval(Tt),Tt=null),oe&&(oe.pause(),oe.removeAttribute("src"),oe.load(),oe=null)});let Os=0,Ns=0,Ls=!1;function Hn(v){Os=v.touches[0].clientX,Ns=v.touches[0].clientY,Ls=!!v.target.closest(".lobby-bottom-fade")}function Yn(v){if(Ls)return;const l=v.changedTouches[0].clientX-Os,M=v.changedTouches[0].clientY-Ns;Math.abs(l)>50&&Math.abs(l)>Math.abs(M)*1.5&&(l>0?i("prev-char"):i("next-char"))}function $s(){i("save-display-name")}function Jn(v){if(B.value=v,ne.value&&L.value){const l=L.value.querySelectorAll(":scope > div > .flex.flex-col");l[v]&&l[v].scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})}}function Gn(v){if(i("room-scroll",v),ne.value&&L.value){const l=L.value,M=l.querySelectorAll(":scope > div > .flex.flex-col");if(!M.length)return;const Fe=l.scrollLeft+l.clientWidth/2;let Se=0,p=1/0;for(let K=0;K<M.length;K++){const Us=M[K],Zn=Us.offsetLeft+Us.offsetWidth/2,Bs=Math.abs(Zn-Fe);Bs<p&&(p=Bs,Se=K)}B.value=Se}}return(v,l)=>{const M=qn,Fe=ua,Se=Za;return h(),x("div",{class:"absolute inset-0 z-30 lobby-bg overflow-hidden",onTouchstartPassive:Hn,onTouchend:Yn},[t.guestMode?O("",!0):(h(),x("button",{key:0,onClick:l[0]||(l[0]=p=>o.value=!0),class:"absolute top-3 left-3 z-30 p-2 text-white/40 hover:text-white/70 transition-colors"},[k(c(po),{class:"w-6 h-6"})])),l[53]||(l[53]=so('<div class="lobby-particle lobby-p1" data-v-03547be6></div><div class="lobby-particle lobby-p2" data-v-03547be6></div><div class="lobby-particle lobby-p3" data-v-03547be6></div><div class="lobby-particle lobby-p4" data-v-03547be6></div><div class="lobby-particle lobby-p5" data-v-03547be6></div><div class="lobby-particle lobby-p6" data-v-03547be6></div><div class="lobby-particle lobby-p7" data-v-03547be6></div><div class="lobby-particle lobby-p8" data-v-03547be6></div>',8)),e("canvas",{ref_key:"videoBgCanvas",ref:G,class:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{filter:"blur(4px)",opacity:"0.35"}},null,512),e("div",{ref_key:"lobbyCanvasEl",ref:se,class:"absolute inset-0 z-[1]",onWheel:l[1]||(l[1]=ge(p=>v.$emit("lobby-wheel",p),["prevent"]))},null,544),l[54]||(l[54]=e("div",{class:"absolute inset-0 pointer-events-none lobby-vignette z-[2]"},null,-1)),t.guestMode?(h(),x("div",Zr,[e("div",qr,[e("div",{class:Q(["w-2 h-2 rounded-full",t.guestConnected?"bg-emerald-400 animate-pulse":"bg-gray-600"])},null,2),e("span",null,he(t.guestOnlineCount??0)+" online",1)])])):O("",!0),k(Le,{"enter-active-class":"transition-opacity duration-300","leave-active-class":"transition-opacity duration-300","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[t.lobbyCharLoading?(h(),x("div",Xr,[...l[28]||(l[28]=[e("div",{class:"w-14 h-14 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin"},null,-1)])])):O("",!0)]),_:1}),e("div",Qr,[e("div",ei,[l[34]||(l[34]=e("img",{src:"/data/appdata/images/SCHEDULE-4-REAL.svg",alt:"Schedule 4 Real",class:"mx-auto h-16 sm:h-24 select-none lobby-title-glow",draggable:"false"},null,-1)),l[35]||(l[35]=e("div",{class:"mx-auto mt-2 h-px w-56 bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent"},null,-1)),e("div",ti,[!t.authenticated&&!t.guestMode?(h(),x("div",si,[...l[29]||(l[29]=[e("span",{class:"text-yellow-400/70 text-base font-medium"},"Guest Mode",-1)])])):O("",!0),c(w)==="denied"||c(w)==="error"||c(w)==="unavailable"?(h(),x("button",{key:1,onClick:C,class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-red-500/10 border-red-500/30 text-red-400 hover:bg-red-500/20 relative"},[k(c(qs),{class:"w-3.5 h-3.5"}),l[31]||(l[31]=e("span",null,"Enable Mic",-1)),c(I)?(h(),x("div",ni,[...l[30]||(l[30]=[e("p",{class:"text-red-300 text-base font-medium mb-1"},"Mic blocked by browser",-1),e("p",{class:"text-white/50 text-base leading-snug"},"Click the lock icon in the address bar, find Microphone, set to Allow, then reload.",-1)])])):O("",!0)])):c(w)==="prompt"?(h(),x("button",{key:2,onClick:C,class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-amber-500/10 border-amber-500/30 text-amber-400 hover:bg-amber-500/20"},[k(c(qs),{class:"w-3.5 h-3.5"}),l[32]||(l[32]=e("span",null,"Enable Mic",-1))])):O("",!0),t.authenticated&&!t.guestMode?(h(),x("button",{key:3,onClick:l[2]||(l[2]=p=>_.value=!0),class:"pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full bg-black/40 border border-white/10 text-white/40 hover:text-emerald-400 hover:border-emerald-500/30 hover:bg-emerald-500/10 transition-all text-base font-medium",title:"How privacy works"},[k(c(Io),{class:"w-3.5 h-3.5"}),l[33]||(l[33]=e("span",null,"Privacy info",-1))])):O("",!0)])]),k(M,null,{default:Ce(()=>[t.isDev&&t.authenticated?(h(),x("div",oi,[e("label",ai,[st(e("input",{type:"checkbox","onUpdate:modelValue":l[3]||(l[3]=p=>Ye(R)?R.value=p:null),class:"sr-only peer"},null,512),[[ao,c(R)]]),l[36]||(l[36]=e("div",{class:"w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-amber-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"},null,-1))]),l[37]||(l[37]=e("span",{class:"text-amber-400 text-base font-medium"},"Asset Editing Mode",-1))])):O("",!0)]),_:1})]),t.availableCharacters.length>1?(h(),x("button",{key:2,onClick:l[4]||(l[4]=p=>v.$emit("prev-char")),class:"absolute left-2 sm:left-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[k(c(Hs),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):O("",!0),t.availableCharacters.length>1?(h(),x("button",{key:3,onClick:l[5]||(l[5]=p=>v.$emit("next-char")),class:"absolute right-2 sm:right-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[k(c(Ks),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):O("",!0),e("div",ri,[t.guestMode?(h(),x("div",ii,[t.availableCharacters.length>1?(h(),x("div",li,[(h(!0),x(nt,null,ot(t.availableCharacters,(p,K)=>(h(),x("div",{key:K,class:Q(["h-1.5 rounded-full transition-all duration-300",K===t.carouselSelectedIdx?"bg-emerald-400 w-4":"bg-white/15 w-1.5"])},null,2))),128))])):O("",!0),st(e("input",{"onUpdate:modelValue":l[6]||(l[6]=p=>Ye(g)?g.value=p:null),type:"text",placeholder:"Enter your name",maxlength:"20",onBlur:l[7]||(l[7]=p=>$s()),class:"w-full bg-black/60 border border-white/20 rounded-xl px-4 py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors mb-3"},null,544),[[wt,c(g)]]),e("button",{onClick:l[8]||(l[8]=p=>v.$emit("enter-room")),disabled:!t.guestReady||t.lobbyCharLoading,class:"w-full py-3 rounded-xl font-bold text-base text-white transition-all bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25"}," Enter Room ",8,ci),t.hideTokenPaste?O("",!0):(h(),x("div",di,[e("div",ui,[k(c(xn),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),st(e("input",{"onUpdate:modelValue":l[9]||(l[9]=p=>Ye(U)?U.value=p:null),type:"text",placeholder:"Paste invite token",onKeyup:cs(J,["enter"]),class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors font-mono"},null,544),[[wt,c(U)]])]),e("button",{onClick:J,disabled:!c(U).startsWith("sfr:"),class:"px-3 py-2 rounded-xl bg-emerald-500/25 border border-emerald-500/30 text-emerald-400 text-base font-bold hover:bg-emerald-500/35 transition-all disabled:opacity-20 disabled:cursor-not-allowed flex-shrink-0"}," Join ",8,pi)]))])):(h(),x("div",fi,[e("div",mi,[t.availableCharacters.length>1?(h(),x("div",hi,[(h(!0),x(nt,null,ot(t.availableCharacters,(p,K)=>(h(),x("div",{key:K,class:Q(["w-1.5 h-1.5 rounded-full transition-all duration-300",K===t.carouselSelectedIdx?"bg-emerald-400 w-4 rounded-full":"bg-white/15"])},null,2))),128))])):O("",!0),e("div",bi,[st(e("input",{"onUpdate:modelValue":l[10]||(l[10]=p=>Ye(g)?g.value=p:null),type:"text",placeholder:"Your name",maxlength:"20",onBlur:l[11]||(l[11]=p=>$s()),class:"pointer-events-auto w-48 sm:w-56 bg-black/60 border border-white/20 rounded-xl px-4 py-2 sm:py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,544),[[wt,c(g)]])])]),e("div",yi,[l[39]||(l[39]=e("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-r from-transparent to-white/10"},null,-1)),e("div",vi,[e("button",{onClick:l[12]||(l[12]=p=>E.value="rooms"),class:Q(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all",c(E)==="rooms"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])}," My Rooms ",2),e("button",{onClick:l[13]||(l[13]=p=>E.value="public"),class:Q(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all flex items-center gap-1.5",c(E)==="public"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])},[k(c(Ut),{class:"w-3.5 h-3.5"}),l[38]||(l[38]=P(" Public ",-1))],2)]),l[40]||(l[40]=e("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-l from-transparent to-white/10"},null,-1))]),k(Fe,{modelValue:c(_),"onUpdate:modelValue":l[14]||(l[14]=p=>Ye(_)?_.value=p:null)},null,8,["modelValue"]),c(E)==="rooms"?(h(),x("div",wi,[k(Le,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(B)>0?(h(),x("button",{key:0,onClick:ee,class:"hidden sm:flex absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[k(c(Hs),{class:"w-4 h-4 text-white/60"})])):O("",!0)]),_:1}),e("div",{ref_key:"roomScrollEl",ref:L,onScroll:Gn,class:"flex gap-3 sm:gap-5 overflow-x-auto snap-x snap-mandatory scrollbar-hide sm:overflow-visible sm:justify-center sm:px-0 items-start",style:no(c(ne)?"padding-left: 7.5vw; padding-right: 7.5vw;":"")},[k(oo,{name:"room-card",tag:"div",class:"contents"},{default:Ce(()=>[(h(!0),x(nt,null,ot(c(X),p=>(h(),x("div",{key:p.id,class:"flex flex-col items-stretch w-[85vw] sm:w-96 snap-center flex-shrink-0"},[e("div",xi,[e("button",{onClick:K=>v.$emit("select-environment",p,c(g).trim()||void 0),class:"w-full text-left"},[e("div",ki,[p.image?(h(),x("img",{key:0,src:p.image,alt:p.name,class:"w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"},null,8,Si)):(h(),x("div",Ci,[(h(),ve(ro(p.icon),{class:"w-12 h-12 text-white/15"}))])),l[42]||(l[42]=e("div",{class:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-black/30"},null,-1)),p.hidden&&t.authenticated?(h(),x("div",Ri,[...l[41]||(l[41]=[e("span",{class:"text-amber-400 text-base font-medium"},"Hidden",-1)])])):O("",!0),e("div",Ei,[e("h3",Ai,he(f(p.id,"publicName")||p.name),1),f(p.id,"publicDescription")?(h(),x("p",_i,he(f(p.id,"publicDescription")),1)):O("",!0)]),l[43]||(l[43]=e("div",{class:"hidden sm:flex absolute inset-0 items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"},[e("div",{class:"w-14 h-14 rounded-full bg-emerald-500/20 backdrop-blur-sm flex items-center justify-center border border-emerald-400/30"},[e("svg",{class:"w-6 h-6 text-emerald-300 ml-0.5",fill:"currentColor",viewBox:"0 0 24 24"},[e("path",{d:"M8 5v14l11-7z"})])])],-1))])],8,gi),t.authenticated?(h(),x("div",{key:0,class:"sm:hidden absolute top-2 left-2 flex items-center gap-1.5 z-10",onClick:l[15]||(l[15]=ge(()=>{},["stop"]))},[e("button",{onClick:K=>de(p.id),class:"flex items-center gap-1 px-2 py-1 rounded-lg bg-black/60 backdrop-blur-sm border border-white/15 text-white/60 active:bg-white/15 transition-all text-base font-bold"},[k(c(Mo),{class:"w-3.5 h-3.5"}),l[44]||(l[44]=e("span",null,"Options",-1))],8,Ti),t.inviteTokens[p.id]?(h(),x("button",{key:0,onClick:ge(K=>v.$emit("copy-link",p.id),["prevent"]),class:Q(["flex items-center gap-1 px-2 py-1 rounded-lg backdrop-blur-sm border transition-all text-base font-bold",t.copiedToken===p.id?"bg-emerald-500/30 border-emerald-500/40 text-emerald-300":"bg-black/60 border-white/15 text-white/60 active:bg-white/15"])},[t.copiedToken!==p.id?(h(),ve(c(Js),{key:0,class:"w-3.5 h-3.5"})):(h(),ve(c(Ys),{key:1,class:"w-3.5 h-3.5"})),e("span",null,he(t.copiedToken===p.id?"Copied!":"Link"),1)],10,Pi)):O("",!0)])):O("",!0),t.authenticated?(h(),x("div",{key:1,class:"hidden sm:block bg-black/80 border-t border-white/[0.08] px-3 py-1.5",onClick:l[16]||(l[16]=ge(()=>{},["stop"]))},[e("div",Ii,[e("div",Mi,[e("label",Di,[e("div",Oi,[e("input",{type:"checkbox",checked:f(p.id,"isPublic"),onChange:K=>v.$emit("update-room-settings",p.id,{isPublic:!f(p.id,"isPublic")}),class:"sr-only peer"},null,40,Ni),l[45]||(l[45]=e("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),e("span",{class:Q(["text-base",f(p.id,"isPublic")?"text-emerald-400/80":"text-white/35"])},he(f(p.id,"isPublic")?"Public visible":"Not public"),3)]),e("label",Li,[e("div",$i,[e("input",{type:"checkbox",checked:!f(p.id,"inviteOnly"),onChange:K=>v.$emit("update-room-settings",p.id,{inviteOnly:!f(p.id,"inviteOnly")}),class:"sr-only peer"},null,40,Ui),l[46]||(l[46]=e("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),e("span",{class:Q(["text-base",f(p.id,"inviteOnly")?"text-white/35":"text-sky-400/80"])},he(f(p.id,"inviteOnly")?"Hidden on lobby":"Visible on lobby"),3)])]),e("div",Bi,[e("button",{onClick:K=>xe(p.id),class:Q(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",[f(p.id,"password")?"text-amber-400 bg-amber-500/10":"text-white/30 hover:text-white/50",c(te)===p.id?"ring-1 ring-amber-500/40":""]])},[f(p.id,"password")?(h(),ve(c(Ze),{key:0,class:"w-3.5 h-3.5"})):(h(),ve(c(fo),{key:1,class:"w-3.5 h-3.5"})),e("span",null,he(f(p.id,"password")?"Password set":"No password"),1)],10,ji),e("button",{onClick:K=>pe(p.id),class:Q(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",c(re)===p.id?"text-emerald-400 bg-emerald-500/10 ring-1 ring-emerald-500/40":"text-white/30 hover:text-white/50"])},[k(c(Ws),{class:"w-3.5 h-3.5"}),l[47]||(l[47]=e("span",null,"Edit info",-1))],10,Vi),l[48]||(l[48]=e("div",{class:"flex-1"},null,-1)),t.inviteTokens[p.id]?(h(),x("button",{key:0,onClick:ge(K=>v.$emit("copy-link",p.id),["prevent"]),class:Q(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",t.copiedToken===p.id?"text-emerald-400 bg-emerald-500/10":"text-white/30 hover:text-white/50"])},[t.copiedToken!==p.id?(h(),ve(c(Js),{key:0,class:"w-3.5 h-3.5"})):(h(),ve(c(Ys),{key:1,class:"w-3.5 h-3.5"})),e("span",null,he(t.copiedToken===p.id?"Copied!":"Copy link"),1)],10,zi)):O("",!0)])])])):O("",!0)]),k(Le,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:Ce(()=>[c(re)===p.id?(h(),x("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-white/[0.12] rounded-xl px-3 py-2 space-y-1.5",onClick:l[17]||(l[17]=ge(()=>{},["stop"]))},[e("input",{type:"text",value:f(p.id,"publicName"),maxlength:"60",placeholder:p.name,onBlur:K=>b(p.id,K),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,Ki),e("input",{type:"text",value:f(p.id,"publicDescription"),maxlength:"200",placeholder:"Short description...",onBlur:K=>m(p.id,K),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,Fi)])):O("",!0)]),_:2},1024),k(Le,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:Ce(()=>[c(te)===p.id?(h(),x("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-amber-500/20 rounded-xl px-3 py-2",onClick:l[18]||(l[18]=ge(()=>{},["stop"]))},[e("div",Wi,[k(c(Ze),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),e("input",{type:"text",value:f(p.id,"password"),maxlength:"32",placeholder:"Room password (leave empty to remove)",onBlur:K=>y(p.id,K),class:"flex-1 bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,Hi)])])):O("",!0)]),_:2},1024)]))),128))]),_:1})],36),k(Le,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(B)<c(q)-1?(h(),x("button",{key:0,onClick:z,class:"hidden sm:flex absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[k(c(Ks),{class:"w-4 h-4 text-white/60"})])):O("",!0)]),_:1})])):O("",!0),c(E)==="rooms"&&c(q)>1?(h(),x("div",Yi,[(h(!0),x(nt,null,ot(c(q),p=>(h(),x("button",{key:p,onClick:K=>Jn(p-1),class:Q(["h-1.5 rounded-full transition-all duration-300 cursor-pointer",p-1===c(B)?"bg-emerald-400 w-5":"bg-white/15 w-1.5 hover:bg-white/30"])},null,10,Ji))),128))])):O("",!0),c(E)==="public"?(h(),x("div",Gi,[k(Se,{authenticated:t.authenticated,onJoinPublicRoom:l[19]||(l[19]=p=>v.$emit("join-public-room",p))},null,8,["authenticated"])])):O("",!0)]))]),(h(),ve(bn,{to:"body"},[k(Le,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-150","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:Ce(()=>[c(D)?(h(),x("div",{key:0,class:"fixed inset-0 z-[100] flex items-end justify-center bg-black/70 backdrop-blur-sm",onClick:l[27]||(l[27]=ge(p=>D.value=null,["self"]))},[k(Le,{"enter-active-class":"transition-transform duration-200 ease-out","enter-from-class":"translate-y-full","leave-active-class":"transition-transform duration-150 ease-in","leave-to-class":"translate-y-full"},{default:Ce(()=>[c(D)?(h(),x("div",{key:0,class:"w-full max-w-md bg-gray-900/95 backdrop-blur-xl border-t border-white/15 rounded-t-3xl px-5 py-5 pb-8 space-y-5",onClick:l[26]||(l[26]=ge(()=>{},["stop"]))},[e("div",Zi,[l[49]||(l[49]=e("h3",{class:"text-white font-bold text-lg"},"Room Options",-1)),e("button",{onClick:l[20]||(l[20]=p=>D.value=null),class:"p-2 -mr-2 text-white/40 active:text-white/70"},[k(c(yn),{class:"w-5 h-5"})])]),e("div",qi,[e("label",Xi,[e("span",{class:Q(["text-base font-medium",f(c(D),"isPublic")?"text-emerald-400":"text-white/50"])}," Public visible ",2),e("div",Qi,[e("input",{type:"checkbox",checked:f(c(D),"isPublic"),onChange:l[21]||(l[21]=p=>v.$emit("update-room-settings",c(D),{isPublic:!f(c(D),"isPublic")})),class:"sr-only peer"},null,40,el),l[50]||(l[50]=e("div",{class:"w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-4 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all"},null,-1))])]),e("label",tl,[e("span",{class:Q(["text-base font-medium",f(c(D),"inviteOnly")?"text-white/50":"text-sky-400"])}," Visible on lobby ",2),e("div",sl,[e("input",{type:"checkbox",checked:!f(c(D),"inviteOnly"),onChange:l[22]||(l[22]=p=>v.$emit("update-room-settings",c(D),{inviteOnly:!f(c(D),"inviteOnly")})),class:"sr-only peer"},null,40,nl),l[51]||(l[51]=e("div",{class:"w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-4 after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all"},null,-1))])])]),e("div",ol,[e("div",al,[k(c(Ze),{class:Q(["w-4 h-4",f(c(D),"password")?"text-amber-400":"text-white/30"])},null,8,["class"]),e("span",{class:Q(["text-base font-medium",f(c(D),"password")?"text-amber-400":"text-white/40"])},"Password",2)]),e("input",{type:"text",value:f(c(D),"password"),maxlength:"32",placeholder:"Room password (leave empty to remove)",onBlur:l[23]||(l[23]=p=>y(c(D),p)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,rl)]),e("div",il,[e("div",ll,[k(c(Ws),{class:"w-4 h-4 text-white/40"}),l[52]||(l[52]=e("span",{class:"text-base font-medium text-white/40"},"Public info",-1))]),e("input",{type:"text",value:f(c(D),"publicName"),maxlength:"60",placeholder:t.environments.find(p=>p.id===c(D))?.name||"Room name",onBlur:l[24]||(l[24]=p=>b(c(D),p)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,cl),e("input",{type:"text",value:f(c(D),"publicDescription"),maxlength:"200",placeholder:"Short description...",onBlur:l[25]||(l[25]=p=>m(c(D),p)),class:"w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,dl)])])):O("",!0)]),_:1})])):O("",!0)]),_:1})]))],32)}}}),Xl=Object.assign(xs(ul,[["__scopeId","data-v-03547be6"]]),{__name:"Room3dLobby"});let A=null,ut=null,Ft=0,Ke=null,Kn,Fn,ys,Ct=!1;const pl=15e3;let ls=0;const fl=50;let It={x:0,y:0,z:0},un=0,pn="";const fn=.01,mn=.02;let Wt=null,Ht=null,Yt=null,lt=null,Jt=null,Gt=null,Zt=null,vs=null;const Rt=[],_t=S(!1),qt=S(!1),Is=S(""),we=S(new Map),ml=Pe(()=>we.value.size+(_t.value?1:0));function Ql(){return{connected:_t,wsConnected:qt,localPeerId:Is,playerCount:ml,remotePlayers:we,connect:Pl,joinRoom:Il,leaveRoom:Ms,sendLocalState:Dl,sendRoomStateChanged:Tl,onPlayerMoved:bl,onRoomStateChanged:yl,onPlayersInit:hl,sendObjectDelta:wl,onObjectDelta:vl,sendVoiceSignal:xl,sendVoiceState:gl,sendVoiceRelay:kl,onVoiceSignal:Sl,onVoiceState:Cl,getRoomId:()=>Ke,onPlayerLeft:Rl,sendTVChanged:_l,onTVChanged:El,onServerError:Al,dispose:Ol}}function hl(t){Yt=t}function bl(t){Wt=t}function yl(t){Ht=t}let Xt=null;function vl(t){Xt=t}function wl(t){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify(t))}catch{}}function xl(t,s,n){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify({type:s,target:t,...n}))}catch{}}function gl(t){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify({type:"voice:state",...t}))}catch{}}function kl(t,s){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify({type:"voice:relay",audio:t,sr:s}))}catch{}}function Sl(t){if(lt=t,t&&Rt.length>0){const s=Rt.splice(0);(async()=>{for(const n of s)try{await t(n.from,n.type,n.data)}catch{}})()}}function Cl(t){Jt=t}function Rl(t){Gt=t}function El(t){Zt=t}function Al(t){vs=t}function _l(t,s){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify({type:"tv:changed",tvId:t,channelUrl:s}))}catch{}}function Tl(){if(!(!A||A.readyState!==WebSocket.OPEN))try{A.send(JSON.stringify({type:"room:state-changed"}))}catch{}}let $t=null;function Pl(){Ct=!1,!(A&&(A.readyState===WebSocket.OPEN||A.readyState===WebSocket.CONNECTING))&&Ds()}function Il(t,s,n,a,r){Ke&&Ms(),Ke=t,Kn=s,Fn=a,ys=r,$t=n||null,A&&A.readyState===WebSocket.OPEN?Wn():(!A||A.readyState===WebSocket.CLOSED)&&Ds()}function Ms(){if(Ke&&A&&A.readyState===WebSocket.OPEN)try{A.send(JSON.stringify({type:"leave"}))}catch{}Ke=null,we.value=new Map,_t.value=!1,Is.value=""}const Ml=3e4;function Dl(t,s,n){if(!A||A.readyState!==WebSocket.OPEN)return;const a=Date.now();if(a-ls<fl)return;const r=a-ls>Ml;if(!(we.value.size===0&&!r)){if(!r){const i=t.x-It.x,o=t.y-It.y,d=t.z-It.z,w=i*i+o*o+d*d,I=Math.abs(s-un),C=I>mn&&I<Math.PI*2-mn;if(w<fn*fn&&!C&&n===pn)return}ls=a,It={...t},un=s,pn=n;try{A.send(JSON.stringify({type:"move",position:t,rotationY:s,animation:n}))}catch{}}}function Ol(){Ct=!0,Ms(),Nl(),Wt=null,Ht=null,Yt=null,Xt=null,lt=null,Jt=null,Gt=null,Zt=null,Rt.length=0}function Wn(){if(!A||A.readyState!==WebSocket.OPEN||!Ke)return;const t={type:"join",roomId:Ke,displayName:Kn,characterModel:Fn,position:$t};ys&&(t.password=ys),A.send(JSON.stringify(t)),$t&&A.send(JSON.stringify({type:"move",position:$t,rotationY:0,animation:"idle"}))}function Ds(){if(A){const n=A;n.onclose=null,n.onmessage=null,n.onerror=null,n.onopen=null;try{n.close()}catch{}A=null}const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_room3d-ws`;try{A=new WebSocket(s)}catch{hn();return}A.onopen=()=>{Ft=0,qt.value=!0,Ke&&Wn()},A.onmessage=n=>{let a;try{a=JSON.parse(typeof n.data=="string"?n.data:"")}catch{return}Ll(a)},A.onclose=n=>{qt.value=!1,_t.value=!1,Ct||hn()},A.onerror=n=>{}}function Nl(){if(ut&&(clearTimeout(ut),ut=null),Ft=0,A){const t=A;t.onclose=null,t.onmessage=null,t.onerror=null,t.onopen=null;try{t.close()}catch{}A=null}qt.value=!1}function hn(){if(ut||Ct)return;const t=Math.min(1e3*Math.pow(2,Ft),pl);Ft++,ut=setTimeout(()=>{ut=null,Ct||Ds()},t)}function Ll(t){switch(t.type){case"init":{Is.value=t.peerId,_t.value=!0;const s=new Map;for(const n of t.players||[])s.set(n.peerId,{peerId:n.peerId,displayName:n.displayName,characterModel:n.characterModel||"",color:n.color,position:n.position||{x:0,y:0,z:0},rotationY:n.rotationY||0,animation:n.animation||"idle",timestamp:Date.now()});we.value=s,Yt&&s.size>0&&Yt([...s.values()]);break}case"player:joined":{const s=t.player;if(!s)break;const n=new Map(we.value);n.set(s.peerId,{peerId:s.peerId,displayName:s.displayName,characterModel:s.characterModel||"",color:s.color,position:s.position||{x:0,y:0,z:0},rotationY:s.rotationY||0,animation:s.animation||"idle",timestamp:Date.now()}),we.value=n;break}case"player:moved":{Wt&&Wt(t.peerId,t.position,t.rotationY,t.animation,t.seq??0);const s=we.value.get(t.peerId);if(s)s.position=t.position,s.rotationY=t.rotationY,s.animation=t.animation,s.timestamp=Date.now();else{const n=new Map(we.value);n.set(t.peerId,{peerId:t.peerId,displayName:t.peerId.slice(0,6),characterModel:"",color:"#60a5fa",position:t.position,rotationY:t.rotationY,animation:t.animation||"idle",timestamp:t.timestamp}),we.value=n}break}case"player:left":{Gt&&Gt(t.peerId);const s=new Map(we.value);s.delete(t.peerId),we.value=s;break}case"room:state-changed":{Ht&&Ht();break}case"object:placed":case"object:deleted":case"object:moved":{Xt&&Xt(t);break}case"voice:offer":case"voice:answer":case"voice:ice":{lt?lt(t.from,t.type,t):Rt.length<50&&Rt.push({from:t.from,type:t.type,data:t});break}case"voice:relay":{lt&&lt(t.from,t.type,t);break}case"tv:changed":{Zt&&Zt(t.peerId,t.tvId,t.channelUrl??null);break}case"voice:state":{Jt&&Jt(t.peerId,{muted:t.muted,speaking:t.speaking});break}case"error":{vs&&vs(t.code,t.message);break}}}export{Xl as _,dr as a,Ql as b,Gr as c,Ra as d,xn as e,Zs as f,Js as r,_a as u};
