import{J as y,A as _,L as D,l as d,k as F,e as N,g as I,o as T,c as S,h as v,E as L,f as E,a as h,t as j,m as U}from"./D0ex2YLX.js";function z(l){const u=F(l)?l:d(l),s=d(null),i=d("idle"),f=d(""),t=d(null),{getAuthHeaders:a}=y();let e=null,o=null,n=null,r=null,c=!1;async function g(){if(u.value){if(i.value="connecting",f.value="",c){b();return}try{e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"}),e.ontrack=A=>{s.value&&A.streams[0]&&(s.value.srcObject=A.streams[0])};let m=!1;e.onconnectionstatechange=()=>{e?.connectionState==="connected"&&(m=!0,t.value="webrtc",n&&(clearTimeout(n),n=null)),(e?.connectionState==="failed"||e?.connectionState==="disconnected")&&(m?(i.value="error",f.value="Connection lost",V()):(c=!0,w(),b()))},n=setTimeout(()=>{n=null,e&&e.connectionState!=="connected"&&(c=!0,w(),b())},5e3);const $=await e.createOffer();await e.setLocalDescription($);const B={"Content-Type":"application/sdp",...a()},k=await fetch(`/api/cameras/webrtc?src=${encodeURIComponent(u.value)}`,{method:"POST",headers:B,body:$.sdp});if(!k.ok)throw new Error(`Server error: ${k.status}`);const H=await k.text();await e.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:H}))}catch{n&&(clearTimeout(n),n=null),c=!0,w(),b()}}}function b(){if(!u.value||!s.value)return;i.value="connecting",t.value="mse";const m=s.value;m.srcObject=null,r=new AbortController,m.src=`/api/cameras/stream/${encodeURIComponent(u.value)}`,m.play().catch(()=>{})}function w(){if(n&&(clearTimeout(n),n=null),e){try{e.close()}catch{}e=null}s.value&&(s.value.srcObject=null)}function C(){o&&(clearTimeout(o),o=null),w(),r&&(r.abort(),r=null),s.value&&(s.value.srcObject=null,s.value.src=""),t.value=null,i.value="idle"}function x(){C(),g()}function V(){o||(o=setTimeout(()=>{o=null,x()},5e3))}function P(){i.value="playing"}return _(u,()=>{u.value?x():C()}),D(()=>C()),{videoEl:s,status:i,errorMessage:f,streamMode:t,connect:g,disconnect:C,reconnect:x,onVideoPlaying:P}}const q={class:"relative bg-black rounded-lg overflow-hidden aspect-video group"},J={key:0,class:"absolute inset-0 flex items-center justify-center z-10"},W={key:1,class:"absolute inset-0 flex flex-col items-center justify-center gap-3 z-10"},G={class:"text-red-400 text-base"},K={class:"absolute top-2 left-2 bg-black/60 text-white text-base px-2 py-0.5 rounded backdrop-blur-sm"},Q=N({__name:"CameraStream",props:{cameraId:{},cameraName:{}},setup(l){const u=l,{videoEl:s,status:i,errorMessage:f,connect:t,reconnect:a,onVideoPlaying:e}=z(U(()=>u.cameraId)),o=d(null);_(o,r=>{s.value=r},{immediate:!0}),I(()=>{t()});function n(){const r=o.value;r&&(document.fullscreenElement?document.exitFullscreen():r.requestFullscreen())}return(r,c)=>(T(),S("div",q,[v(i)==="connecting"?(T(),S("div",J,[...c[2]||(c[2]=[L('<div class="flex items-center gap-2 text-white/60"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><span class="text-base">Connecting...</span></div>',1)])])):E("",!0),v(i)==="error"?(T(),S("div",W,[h("span",G,j(v(f)),1),h("button",{class:"px-4 py-1.5 bg-white/10 hover:bg-white/20 text-white text-base rounded-lg transition-colors",onClick:c[0]||(c[0]=(...g)=>v(a)&&v(a)(...g))}," Retry ")])):E("",!0),h("video",{ref_key:"videoRef",ref:o,autoplay:"",muted:"",playsinline:"",class:"w-full h-full object-contain",onLoadeddata:c[1]||(c[1]=(...g)=>v(e)&&v(e)(...g))},null,544),h("div",K,j(l.cameraName),1),h("button",{class:"absolute top-2 right-2 bg-black/60 text-white/70 hover:text-white p-1.5 rounded opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm",onClick:n,title:"Fullscreen"},[...c[3]||(c[3]=[h("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[h("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"})],-1)])])]))}}),Y=Object.assign(Q,{__name:"SystemCameraStream"}),p=d([]),R=d(!1),M=d(!1);let O=!1;function Z(){async function l(){R.value=!0;try{const{getAuthHeaders:t}=y(),a=await $fetch("/api/cameras",{headers:t()});p.value=a.cameras,M.value=a.go2rtcRunning,O=!0}catch{}finally{R.value=!1}}async function u(t){try{const{getAuthHeaders:a}=y(),e=await $fetch("/api/cameras",{method:"POST",headers:a(),body:t});if(e.success)return p.value.push(e.camera),setTimeout(()=>l(),3e3),e.camera}catch{}return null}async function s(t,a){try{const{getAuthHeaders:e}=y(),o=await $fetch(`/api/cameras/${t}`,{method:"PUT",headers:e(),body:a});if(o.success){const n=p.value.findIndex(r=>r.id===t);return n!==-1&&(p.value[n]=o.camera),setTimeout(()=>l(),3e3),!0}}catch{}return!1}async function i(t){try{const{getAuthHeaders:a}=y();return await $fetch(`/api/cameras/${t}`,{method:"DELETE",headers:a()}),p.value=p.value.filter(e=>e.id!==t),!0}catch{}return!1}async function f(t){try{const{getAuthHeaders:a}=y();return await $fetch(`/api/cameras/${t}/test`,{method:"POST",headers:a()})}catch{return{success:!1,message:"Request failed"}}}return O||l(),{cameras:p,loading:R,go2rtcRunning:M,fetchCameras:l,addCamera:u,updateCamera:s,deleteCamera:i,testCamera:f}}export{Y as C,Z as u};
