import{_ as nr}from"./BgaH9cfx.js";import{o as L,c as O,a as g,l as z,N as Tn,e as so,x as He,b as H,w as et,h as D,d as ae,I as xt,f as X,G as Nt,T as sr,$ as vt,a0 as or,_ as ir,g as Us,i as Ot,v as an,k as St,n as Te,t as ke,F as Vt,r as zt,j as Os,m as ot,K as rr,L as vo,A as So,E as ar,a1 as lr,H as cr,B as ur,y as fr}from"./pzMHNs7z.js";import{r as dr}from"./DqN0YPfp.js";import{a as pr,b as yr,u as mr,c as hr,r as br}from"./BgVTJ8Xa.js";import{r as li}from"./BnSGBtte.js";import{r as pn,a as Ao}from"./CCBoZ6fd.js";import{r as gr}from"./Be5hXZTC.js";import{r as oo}from"./B4jOAn6A.js";import{r as wr}from"./BaCsVXF-.js";import{_ as io}from"./DlAUqK2U.js";import{s as ln}from"./BEguKlIH.js";import{q as Se,j as ut,n as ci,V as U,ac as Ye,g as ui,f as ft,ad as Lt,B as xr,y as vr,ae as fi,R as Sr,af as To,a as wn,ag as di,ah as pi,O as yi,ai as mi,aj as Ar,ak as Tr,al as hi,M as kr,b as bi,i as gi,N as wi,am as _r,an as Pr,s as Cr,t as Er,W as Rr,a7 as Ir,r as Br,a8 as Mr,ao as Dr,D as xs,ap as Nr,A as Lr,v as xi,p as vi,k as Ur,ab as Or,aq as Vr}from"./0hy1JgKJ.js";import{r as ko}from"./BkDMy9PT.js";import{r as zr}from"./Cc0p6j7u.js";function $r(e,t){return L(),O("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[g("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z"})])}function Fr(e,t){return L(),O("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[g("path",{d:"M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 0 1 3.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0 1 21 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 0 1 7.5 16.125V3.375Z"}),g("path",{d:"M15 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 17.25 7.5h-1.875A.375.375 0 0 1 15 7.125V5.25ZM4.875 6H6v10.125A3.375 3.375 0 0 0 9.375 19.5H16.5v1.125c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V7.875C3 6.839 3.84 6 4.875 6Z"})])}function Hr(e,t){return L(),O("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[g("path",{d:"M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577a11.217 11.217 0 0 1 4.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z"}),g("path",{d:"M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z"}),g("path",{d:"M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z"})])}function Si(e,t){return L(),O("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[g("path",{"fill-rule":"evenodd",d:"M15.75 1.5a6.75 6.75 0 0 0-6.651 7.906c.067.39-.032.717-.221.906l-6.5 6.499a3 3 0 0 0-.878 2.121v2.818c0 .414.336.75.75.75H6a.75.75 0 0 0 .75-.75v-1.5h1.5A.75.75 0 0 0 9 19.5V18h1.5a.75.75 0 0 0 .53-.22l2.658-2.658c.19-.189.517-.288.906-.22A6.75 6.75 0 1 0 15.75 1.5Zm0 3a.75.75 0 0 0 0 1.5A2.25 2.25 0 0 1 18 8.25a.75.75 0 0 0 1.5 0 3.75 3.75 0 0 0-3.75-3.75Z","clip-rule":"evenodd"})])}function jr(e,t){return L(),O("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon"},[g("path",{"fill-rule":"evenodd",d:"M19.902 4.098a3.75 3.75 0 0 0-5.304 0l-4.5 4.5a3.75 3.75 0 0 0 1.035 6.037.75.75 0 0 1-.646 1.353 5.25 5.25 0 0 1-1.449-8.45l4.5-4.5a5.25 5.25 0 1 1 7.424 7.424l-1.757 1.757a.75.75 0 1 1-1.06-1.06l1.757-1.757a3.75 3.75 0 0 0 0-5.304Zm-7.389 4.267a.75.75 0 0 1 1-.353 5.25 5.25 0 0 1 1.449 8.45l-4.5 4.5a5.25 5.25 0 1 1-7.424-7.424l1.757-1.757a.75.75 0 1 1 1.06 1.06l-1.757 1.757a3.75 3.75 0 1 0 5.304 5.304l4.5-4.5a3.75 3.75 0 0 0-1.035-6.037.75.75 0 0 1-.354-1Z","clip-rule":"evenodd"})])}const Ai=0,Kr=1,Wr=2,_o=2,vs=1.25,Po=1,he=32,le=he/4,Ti=65535,Fn=Math.pow(2,-24),ro=Symbol("SKIP_GENERATION"),ki={strategy:Ai,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[ro]:!1};function ne(e,t,n){return n.min.x=t[e],n.min.y=t[e+1],n.min.z=t[e+2],n.max.x=t[e+3],n.max.y=t[e+4],n.max.z=t[e+5],n}function Co(e){let t=-1,n=-1/0;for(let s=0;s<3;s++){const o=e[s+3]-e[s];o>n&&(n=o,t=s)}return t}function Eo(e,t){t.set(e)}function Ro(e,t,n){let s,o;for(let i=0;i<3;i++){const r=i+3;s=e[i],o=t[i],n[i]=s<o?s:o,s=e[r],o=t[r],n[r]=s>o?s:o}}function kn(e,t,n){for(let s=0;s<3;s++){const o=t[e+2*s],i=t[e+2*s+1],r=o-i,a=o+i;r<n[s]&&(n[s]=r),a>n[s+3]&&(n[s+3]=a)}}function Gt(e){const t=e[3]-e[0],n=e[4]-e[1],s=e[5]-e[2];return 2*(t*n+n*s+s*t)}function ce(e,t){return t[e+15]===Ti}function be(e,t){return t[e+6]}function we(e,t){return t[e+14]}function de(e){return e+le}function pe(e,t){const n=t[e+6];return e+n*le}function ao(e,t){return t[e+7]}function Ss(e,t,n,s,o){let i=1/0,r=1/0,a=1/0,l=-1/0,d=-1/0,c=-1/0,f=1/0,u=1/0,p=1/0,S=-1/0,k=-1/0,A=-1/0;const _=e.offset||0;for(let b=(t-_)*6,y=(t+n-_)*6;b<y;b+=6){const h=e[b+0],m=e[b+1],x=h-m,w=h+m;x<i&&(i=x),w>l&&(l=w),h<f&&(f=h),h>S&&(S=h);const v=e[b+2],C=e[b+3],T=v-C,E=v+C;T<r&&(r=T),E>d&&(d=E),v<u&&(u=v),v>k&&(k=v);const P=e[b+4],I=e[b+5],B=P-I,V=P+I;B<a&&(a=B),V>c&&(c=V),P<p&&(p=P),P>A&&(A=P)}s[0]=i,s[1]=r,s[2]=a,s[3]=l,s[4]=d,s[5]=c,o[0]=f,o[1]=u,o[2]=p,o[3]=S,o[4]=k,o[5]=A}const $e=32,Yr=(e,t)=>e.candidate-t.candidate,Ge=new Array($e).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),_n=new Float32Array(6);function qr(e,t,n,s,o,i){let r=-1,a=0;if(i===Ai)r=Co(t),r!==-1&&(a=(t[r]+t[r+3])/2);else if(i===Kr)r=Co(e),r!==-1&&(a=Zr(n,s,o,r));else if(i===Wr){const l=Gt(e);let d=vs*o;const c=n.offset||0,f=(s-c)*6,u=(s+o-c)*6;for(let p=0;p<3;p++){const S=t[p],_=(t[p+3]-S)/$e;if(o<$e/4){const b=[...Ge];b.length=o;let y=0;for(let m=f;m<u;m+=6,y++){const x=b[y];x.candidate=n[m+2*p],x.count=0;const{bounds:w,leftCacheBounds:v,rightCacheBounds:C}=x;for(let T=0;T<3;T++)C[T]=1/0,C[T+3]=-1/0,v[T]=1/0,v[T+3]=-1/0,w[T]=1/0,w[T+3]=-1/0;kn(m,n,w)}b.sort(Yr);let h=o;for(let m=0;m<h;m++){const x=b[m];for(;m+1<h&&b[m+1].candidate===x.candidate;)b.splice(m+1,1),h--}for(let m=f;m<u;m+=6){const x=n[m+2*p];for(let w=0;w<h;w++){const v=b[w];x>=v.candidate?kn(m,n,v.rightCacheBounds):(kn(m,n,v.leftCacheBounds),v.count++)}}for(let m=0;m<h;m++){const x=b[m],w=x.count,v=o-x.count,C=x.leftCacheBounds,T=x.rightCacheBounds;let E=0;w!==0&&(E=Gt(C)/l);let P=0;v!==0&&(P=Gt(T)/l);const I=Po+vs*(E*w+P*v);I<d&&(r=p,d=I,a=x.candidate)}}else{for(let h=0;h<$e;h++){const m=Ge[h];m.count=0,m.candidate=S+_+h*_;const x=m.bounds;for(let w=0;w<3;w++)x[w]=1/0,x[w+3]=-1/0}for(let h=f;h<u;h+=6){let w=~~((n[h+2*p]-S)/_);w>=$e&&(w=$e-1);const v=Ge[w];v.count++,kn(h,n,v.bounds)}const b=Ge[$e-1];Eo(b.bounds,b.rightCacheBounds);for(let h=$e-2;h>=0;h--){const m=Ge[h],x=Ge[h+1];Ro(m.bounds,x.rightCacheBounds,m.rightCacheBounds)}let y=0;for(let h=0;h<$e-1;h++){const m=Ge[h],x=m.count,w=m.bounds,C=Ge[h+1].rightCacheBounds;x!==0&&(y===0?Eo(w,_n):Ro(w,_n,_n)),y+=x;let T=0,E=0;y!==0&&(T=Gt(_n)/l);const P=o-y;P!==0&&(E=Gt(C)/l);const I=Po+vs*(T*y+E*P);I<d&&(r=p,d=I,a=m.candidate)}}}}return{axis:r,pos:a}}function Zr(e,t,n,s){let o=0;const i=e.offset;for(let r=t,a=t+n;r<a;r++)o+=e[(r-i)*6+s*2];return o/n}class As{constructor(){this.boundingData=new Float32Array(6)}}function Xr(e,t,n,s,o,i){let r=s,a=s+o-1;const l=i.pos,d=i.axis*2,c=n.offset||0;for(;;){for(;r<=a&&n[(r-c)*6+d]<l;)r++;for(;r<=a&&n[(a-c)*6+d]>=l;)a--;if(r<a){for(let f=0;f<t;f++){let u=e[r*t+f];e[r*t+f]=e[a*t+f],e[a*t+f]=u}for(let f=0;f<6;f++){const u=r-c,p=a-c,S=n[u*6+f];n[u*6+f]=n[p*6+f],n[p*6+f]=S}r++,a--}else return r}}let _i,Hn,Vs,Pi;const Jr=Math.pow(2,32);function zs(e){return"count"in e?1:1+zs(e.left)+zs(e.right)}function Gr(e,t,n){return _i=new Float32Array(n),Hn=new Uint32Array(n),Vs=new Uint16Array(n),Pi=new Uint8Array(n),$s(e,t)}function $s(e,t){const n=e/4,s=e/2,o="count"in t,i=t.boundingData;for(let r=0;r<6;r++)_i[n+r]=i[r];if(o)return t.buffer?(Pi.set(new Uint8Array(t.buffer),e),e+t.buffer.byteLength):(Hn[n+6]=t.offset,Vs[s+14]=t.count,Vs[s+15]=Ti,e+he);{const{left:r,right:a,splitAxis:l}=t,d=e+he;let c=$s(d,r);const f=e/he,p=c/he-f;if(p>Jr)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return Hn[n+6]=p,Hn[n+7]=l,$s(c,a)}}function Qr(e,t,n,s,o,i){const{maxDepth:r,verbose:a,maxLeafSize:l,strategy:d,onProgress:c}=o,f=e.primitiveBuffer,u=e.primitiveBufferStride,p=new Float32Array(6);let S=!1;const k=new As;return Ss(t,n,s,k.boundingData,p),_(k,n,s,p),k;function A(b){c&&c((b-i.offset)/i.count)}function _(b,y,h,m=null,x=0){if(!S&&x>=r&&(S=!0),h<=l||x>=r)return A(y+h),b.offset=y,b.count=h,b;const w=qr(b.boundingData,m,t,y,h,d);if(w.axis===-1)return A(y+h),b.offset=y,b.count=h,b;const v=Xr(f,u,t,y,h,w);if(v===y||v===y+h)A(y+h),b.offset=y,b.count=h;else{b.splitAxis=w.axis;const C=new As,T=y,E=v-y;b.left=C,Ss(t,T,E,C.boundingData,p),_(C,T,E,p,x+1);const P=new As,I=v,B=h-E;b.right=P,Ss(t,I,B,P.boundingData,p),_(P,I,B,p,x+1)}return b}}function ea(e,t){const n=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=e.getRootRanges(t.range),o=s[0],i=s[s.length-1],r={offset:o.offset,count:i.offset+i.count-o.offset},a=new Float32Array(6*r.count);a.offset=r.offset,e.computePrimitiveBounds(r.offset,r.count,a),e._roots=s.map(l=>{const d=Qr(e,a,l.offset,l.count,t,r),c=zs(d),f=new n(he*c);return Gr(0,d,f),f})}class lo{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class ta{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let n=null;this.setBuffer=s=>{n&&t.push(n),n=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{n=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const ee=new ta;let rt,$t;const Pt=[],Pn=new lo(()=>new Se);function na(e,t,n,s,o,i){rt=Pn.getPrimitive(),$t=Pn.getPrimitive(),Pt.push(rt,$t),ee.setBuffer(e._roots[t]);const r=Fs(0,e.geometry,n,s,o,i);ee.clearBuffer(),Pn.releasePrimitive(rt),Pn.releasePrimitive($t),Pt.pop(),Pt.pop();const a=Pt.length;return a>0&&($t=Pt[a-1],rt=Pt[a-2]),r}function Fs(e,t,n,s,o=null,i=0,r=0){const{float32Array:a,uint16Array:l,uint32Array:d}=ee;let c=e*2;if(ce(c,l)){const u=be(e,d),p=we(c,l);return ne(e,a,rt),s(u,p,!1,r,i+e/le,rt)}else{let T=function(P){const{uint16Array:I,uint32Array:B}=ee;let V=P*2;for(;!ce(V,I);)P=de(P),V=P*2;return be(P,B)},E=function(P){const{uint16Array:I,uint32Array:B}=ee;let V=P*2;for(;!ce(V,I);)P=pe(P,B),V=P*2;return be(P,B)+we(V,I)};const u=de(e),p=pe(e,d);let S=u,k=p,A,_,b,y;if(o&&(b=rt,y=$t,ne(S,a,b),ne(k,a,y),A=o(b),_=o(y),_<A)){S=p,k=u;const P=A;A=_,_=P,b=y}b||(b=rt,ne(S,a,b));const h=ce(S*2,l),m=n(b,h,A,r+1,i+S/le);let x;if(m===_o){const P=T(S),B=E(S)-P;x=s(P,B,!0,r+1,i+S/le,b)}else x=m&&Fs(S,t,n,s,o,i,r+1);if(x)return!0;y=$t,ne(k,a,y);const w=ce(k*2,l),v=n(y,w,_,r+1,i+k/le);let C;if(v===_o){const P=T(k),B=E(k)-P;C=s(P,B,!0,r+1,i+k/le,y)}else C=v&&Fs(k,t,n,s,o,i,r+1);return!!C}}const cn=new ee.constructor,Jn=new ee.constructor,tt=new lo(()=>new Se),Ct=new Se,Et=new Se,Ts=new Se,ks=new Se;let _s=!1;function sa(e,t,n,s){if(_s)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");_s=!0;const o=e._roots,i=t._roots;let r,a=0,l=0;const d=new ut().copy(n).invert();for(let c=0,f=o.length;c<f;c++){cn.setBuffer(o[c]),l=0;const u=tt.getPrimitive();ne(0,cn.float32Array,u),u.applyMatrix4(d);for(let p=0,S=i.length;p<S&&(Jn.setBuffer(i[p]),r=Ne(0,0,n,d,s,a,l,0,0,u),Jn.clearBuffer(),l+=i[p].byteLength/he,!r);p++);if(tt.releasePrimitive(u),cn.clearBuffer(),a+=o[c].byteLength/he,r)break}return _s=!1,r}function Ne(e,t,n,s,o,i=0,r=0,a=0,l=0,d=null,c=!1){let f,u;c?(f=Jn,u=cn):(f=cn,u=Jn);const p=f.float32Array,S=f.uint32Array,k=f.uint16Array,A=u.float32Array,_=u.uint32Array,b=u.uint16Array,y=e*2,h=t*2,m=ce(y,k),x=ce(h,b);let w=!1;if(x&&m)c?w=o(be(t,_),we(t*2,b),be(e,S),we(e*2,k),l,r+t/le,a,i+e/le):w=o(be(e,S),we(e*2,k),be(t,_),we(t*2,b),a,i+e/le,l,r+t/le);else if(x){const v=tt.getPrimitive();ne(t,A,v),v.applyMatrix4(n);const C=de(e),T=pe(e,S);ne(C,p,Ct),ne(T,p,Et);const E=v.intersectsBox(Ct),P=v.intersectsBox(Et);w=E&&Ne(t,C,s,n,o,r,i,l,a+1,v,!c)||P&&Ne(t,T,s,n,o,r,i,l,a+1,v,!c),tt.releasePrimitive(v)}else{const v=de(t),C=pe(t,_);ne(v,A,Ts),ne(C,A,ks);const T=d.intersectsBox(Ts),E=d.intersectsBox(ks);if(T&&E)w=Ne(e,v,n,s,o,i,r,a,l+1,d,c)||Ne(e,C,n,s,o,i,r,a,l+1,d,c);else if(T)if(m)w=Ne(e,v,n,s,o,i,r,a,l+1,d,c);else{const P=tt.getPrimitive();P.copy(Ts).applyMatrix4(n);const I=de(e),B=pe(e,S);ne(I,p,Ct),ne(B,p,Et);const V=P.intersectsBox(Ct),K=P.intersectsBox(Et);w=V&&Ne(v,I,s,n,o,r,i,l,a+1,P,!c)||K&&Ne(v,B,s,n,o,r,i,l,a+1,P,!c),tt.releasePrimitive(P)}else if(E)if(m)w=Ne(e,C,n,s,o,i,r,a,l+1,d,c);else{const P=tt.getPrimitive();P.copy(ks).applyMatrix4(n);const I=de(e),B=pe(e,S);ne(I,p,Ct),ne(B,p,Et);const V=P.intersectsBox(Ct),K=P.intersectsBox(Et);w=V&&Ne(C,I,s,n,o,r,i,l,a+1,P,!c)||K&&Ne(C,B,s,n,o,r,i,l,a+1,P,!c),tt.releasePrimitive(P)}}return w}const Io=new Se,Rt=new Float32Array(6);class oa{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(t){t={...ki,...t},ea(this,t)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(t,n,s,o){let i=1/0,r=1/0,a=1/0,l=-1/0,d=-1/0,c=-1/0;for(let f=t,u=t+n;f<u;f++){this.writePrimitiveBounds(f,Rt,0);const[p,S,k,A,_,b]=Rt;p<i&&(i=p),A>l&&(l=A),S<r&&(r=S),_>d&&(d=_),k<a&&(a=k),b>c&&(c=b)}return s[o+0]=i,s[o+1]=r,s[o+2]=a,s[o+3]=l,s[o+4]=d,s[o+5]=c,s}computePrimitiveBounds(t,n,s){const o=s.offset||0;for(let i=t,r=t+n;i<r;i++){this.writePrimitiveBounds(i,Rt,0);const[a,l,d,c,f,u]=Rt,p=(a+c)/2,S=(l+f)/2,k=(d+u)/2,A=(c-a)/2,_=(f-l)/2,b=(u-d)/2,y=(i-o)*6;s[y+0]=p,s[y+1]=A+(Math.abs(p)+A)*Fn,s[y+2]=S,s[y+3]=_+(Math.abs(S)+_)*Fn,s[y+4]=k,s[y+5]=b+(Math.abs(k)+b)*Fn}return s}shiftPrimitiveOffsets(t){const n=this._indirectBuffer;if(n)for(let s=0,o=n.length;s<o;s++)n[s]+=t;else{const s=this._roots;for(let o=0;o<s.length;o++){const i=s[o],r=new Uint32Array(i),a=new Uint16Array(i),l=i.byteLength/he;for(let d=0;d<l;d++){const c=le*d,f=2*c;ce(f,a)&&(r[c+6]+=t)}}}}traverse(t,n=0){const s=this._roots[n],o=new Uint32Array(s),i=new Uint16Array(s);r(0);function r(a,l=0){const d=a*2,c=ce(d,i);if(c){const f=o[a+6],u=i[d+14];t(l,c,new Float32Array(s,a*4,6),f,u)}else{const f=de(a),u=pe(a,o),p=ao(a,o);t(l,c,new Float32Array(s,a*4,6),p)||(r(f,l+1),r(u,l+1))}}}refit(){const t=this._roots;for(let n=0,s=t.length;n<s;n++){const o=t[n],i=new Uint32Array(o),r=new Uint16Array(o),a=new Float32Array(o),l=o.byteLength/he;for(let d=l-1;d>=0;d--){const c=d*le,f=c*2;if(ce(f,r)){const p=be(c,i),S=we(f,r);this.writePrimitiveRangeBounds(p,S,Rt,0),a.set(Rt,c)}else{const p=de(c),S=pe(c,i);for(let k=0;k<3;k++){const A=a[p+k],_=a[p+k+3],b=a[S+k],y=a[S+k+3];a[c+k]=A<b?A:b,a[c+k+3]=_>y?_:y}}}}}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(s=>{ne(0,new Float32Array(s),Io),t.union(Io)}),t}shapecast(t){let{boundsTraverseOrder:n,intersectsBounds:s,intersectsRange:o,intersectsPrimitive:i,scratchPrimitive:r,iterate:a}=t;if(o&&i){const f=o;o=(u,p,S,k,A)=>f(u,p,S,k,A)?!0:a(u,p,this,i,S,k,r)}else o||(i?o=(f,u,p,S)=>a(f,u,this,i,p,S,r):o=(f,u,p)=>p);let l=!1,d=0;const c=this._roots;for(let f=0,u=c.length;f<u;f++){const p=c[f];if(l=na(this,f,s,o,n,d),l)break;d+=p.byteLength/he}return l}bvhcast(t,n,s){let{intersectsRanges:o}=s;return sa(this,t,n,o)}}function ia(){return typeof SharedArrayBuffer<"u"}function co(e){return e.index?e.index.count:e.attributes.position.count}function ys(e){return co(e)/3}function ra(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}function aa(e,t){if(!e.index){const n=e.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,o=ra(n,s);e.setIndex(new ci(o,1));for(let i=0;i<n;i++)o[i]=i}}function la(e,t,n){const s=co(e)/n,o=t||e.drawRange,i=o.start/n,r=(o.start+o.count)/n,a=Math.max(0,i),l=Math.min(s,r)-a;return{offset:Math.floor(a),count:Math.floor(l)}}function ca(e,t){return e.groups.map(n=>({offset:n.start/t,count:n.count/t}))}function Bo(e,t,n){const s=la(e,t,n),o=ca(e,n);if(!o.length)return[s];const i=[],r=s.offset,a=s.offset+s.count,l=co(e)/n,d=[];for(const u of o){const{offset:p,count:S}=u,k=p,A=isFinite(S)?S:l-p,_=p+A;k<a&&_>r&&(d.push({pos:Math.max(r,k),isStart:!0}),d.push({pos:Math.min(a,_),isStart:!1}))}d.sort((u,p)=>u.pos!==p.pos?u.pos-p.pos:u.type==="end"?-1:1);let c=0,f=null;for(const u of d){const p=u.pos;c!==0&&p!==f&&i.push({offset:f,count:p-f}),c+=u.isStart?1:-1,f=p}return i}function ua(e,t){const n=e[e.length-1],s=n.offset+n.count>2**16,o=e.reduce((d,c)=>d+c.count,0),i=s?4:2,r=t?new SharedArrayBuffer(o*i):new ArrayBuffer(o*i),a=s?new Uint32Array(r):new Uint16Array(r);let l=0;for(let d=0;d<e.length;d++){const{offset:c,count:f}=e[d];for(let u=0;u<f;u++)a[l+u]=c+u;l+=f}return a}class fa extends oa{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(t){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(t){}constructor(t,n={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(n.useSharedArrayBuffer&&!ia())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=t,this.resolvePrimitiveIndex=n.indirect?s=>this._indirectBuffer[s]:s=>s,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,n={...ki,...n},n[ro]||this.init(n)}init(t){const{geometry:n,primitiveStride:s}=this;if(t.indirect){const o=Bo(n,t.range,s),i=ua(o,t.useSharedArrayBuffer);this._indirectBuffer=i}else aa(n,t);super.init(t),!n.boundingBox&&t.setBoundingBox&&(n.boundingBox=this.getBoundingBox(new Se))}getRootRanges(t){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:Bo(this.geometry,t,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class qe{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,n){let s=1/0,o=-1/0;for(let i=0,r=t.length;i<r;i++){const l=t[i][n];s=l<s?l:s,o=l>o?l:o}this.min=s,this.max=o}setFromPoints(t,n){let s=1/0,o=-1/0;for(let i=0,r=n.length;i<r;i++){const a=n[i],l=t.dot(a);s=l<s?l:s,o=l>o?l:o}this.min=s,this.max=o}isSeparated(t){return this.min>t.max||t.min>this.max}}qe.prototype.setFromBox=(function(){const e=new U;return function(n,s){const o=s.min,i=s.max;let r=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let d=0;d<=1;d++)for(let c=0;c<=1;c++){e.x=o.x*l+i.x*(1-l),e.y=o.y*d+i.y*(1-d),e.z=o.z*c+i.z*(1-c);const f=n.dot(e);r=Math.min(f,r),a=Math.max(f,a)}this.min=r,this.max=a}})();const da=(function(){const e=new U,t=new U,n=new U;return function(o,i,r){const a=o.start,l=e,d=i.start,c=t;n.subVectors(a,d),e.subVectors(o.end,o.start),t.subVectors(i.end,i.start);const f=n.dot(c),u=c.dot(l),p=c.dot(c),S=n.dot(l),A=l.dot(l)*p-u*u;let _,b;A!==0?_=(f*u-S*p)/A:_=0,b=(f+_*u)/p,r.x=_,r.y=b}})(),uo=(function(){const e=new ft,t=new U,n=new U;return function(o,i,r,a){da(o,i,e);let l=e.x,d=e.y;if(l>=0&&l<=1&&d>=0&&d<=1){o.at(l,r),i.at(d,a);return}else if(l>=0&&l<=1){d<0?i.at(0,a):i.at(1,a),o.closestPointToPoint(a,!0,r);return}else if(d>=0&&d<=1){l<0?o.at(0,r):o.at(1,r),i.closestPointToPoint(r,!0,a);return}else{let c;l<0?c=o.start:c=o.end;let f;d<0?f=i.start:f=i.end;const u=t,p=n;if(o.closestPointToPoint(f,!0,t),i.closestPointToPoint(c,!0,n),u.distanceToSquared(f)<=p.distanceToSquared(c)){r.copy(u),a.copy(f);return}else{r.copy(c),a.copy(p);return}}}})(),pa=(function(){const e=new U,t=new U,n=new ui,s=new Ye;return function(i,r){const{radius:a,center:l}=i,{a:d,b:c,c:f}=r;if(s.start=d,s.end=c,s.closestPointToPoint(l,!0,e).distanceTo(l)<=a||(s.start=d,s.end=f,s.closestPointToPoint(l,!0,e).distanceTo(l)<=a)||(s.start=c,s.end=f,s.closestPointToPoint(l,!0,e).distanceTo(l)<=a))return!0;const k=r.getPlane(n);if(Math.abs(k.distanceToPoint(l))<=a){const _=k.projectPoint(l,t);if(r.containsPoint(_))return!0}return!1}})(),ya=["x","y","z"],Fe=1e-15,Mo=Fe*Fe;function Re(e){return Math.abs(e)<Fe}class Le extends Lt{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new U),this.satBounds=new Array(4).fill().map(()=>new qe),this.points=[this.a,this.b,this.c],this.plane=new ui,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new Ye,this.needsUpdate=!0}intersectsSphere(t){return pa(t,this)}update(){const t=this.a,n=this.b,s=this.c,o=this.points,i=this.satAxes,r=this.satBounds,a=i[0],l=r[0];this.getNormal(a),l.setFromPoints(a,o);const d=i[1],c=r[1];d.subVectors(t,n),c.setFromPoints(d,o);const f=i[2],u=r[2];f.subVectors(n,s),u.setFromPoints(f,o);const p=i[3],S=r[3];p.subVectors(s,t),S.setFromPoints(p,o);const k=d.length(),A=f.length(),_=p.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,k<Fe?A<Fe||_<Fe?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(s)):A<Fe?_<Fe?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(n),this.degenerateSegment.end.copy(t)):_<Fe&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(s),this.degenerateSegment.end.copy(n)),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}Le.prototype.closestPointToSegment=(function(){const e=new U,t=new U,n=new Ye;return function(o,i=null,r=null){const{start:a,end:l}=o,d=this.points;let c,f=1/0;for(let u=0;u<3;u++){const p=(u+1)%3;n.start.copy(d[u]),n.end.copy(d[p]),uo(n,o,e,t),c=e.distanceToSquared(t),c<f&&(f=c,i&&i.copy(e),r&&r.copy(t))}return this.closestPointToPoint(a,e),c=a.distanceToSquared(e),c<f&&(f=c,i&&i.copy(e),r&&r.copy(a)),this.closestPointToPoint(l,e),c=l.distanceToSquared(e),c<f&&(f=c,i&&i.copy(e),r&&r.copy(l)),Math.sqrt(f)}})();Le.prototype.intersectsTriangle=(function(){const e=new Le,t=new qe,n=new qe,s=new U,o=new U,i=new U,r=new U,a=new Ye,l=new Ye,d=new U,c=new ft,f=new ft;function u(y,h,m,x){const w=s;!y.isDegenerateIntoPoint&&!y.isDegenerateIntoSegment?w.copy(y.plane.normal):w.copy(h.plane.normal);const v=y.satBounds,C=y.satAxes;for(let P=1;P<4;P++){const I=v[P],B=C[P];if(t.setFromPoints(B,h.points),I.isSeparated(t)||(r.copy(w).cross(B),t.setFromPoints(r,y.points),n.setFromPoints(r,h.points),t.isSeparated(n)))return!1}const T=h.satBounds,E=h.satAxes;for(let P=1;P<4;P++){const I=T[P],B=E[P];if(t.setFromPoints(B,y.points),I.isSeparated(t)||(r.crossVectors(w,B),t.setFromPoints(r,y.points),n.setFromPoints(r,h.points),t.isSeparated(n)))return!1}return m&&(m.start.set(0,0,0),m.end.set(0,0,0)),!0}function p(y,h,m,x,w,v,C,T,E,P,I){let B=C/(C-T);P.x=x+(w-x)*B,I.start.subVectors(h,y).multiplyScalar(B).add(y),B=C/(C-E),P.y=x+(v-x)*B,I.end.subVectors(m,y).multiplyScalar(B).add(y)}function S(y,h,m,x,w,v,C,T,E,P,I){if(w>0)p(y.c,y.a,y.b,x,h,m,E,C,T,P,I);else if(v>0)p(y.b,y.a,y.c,m,h,x,T,C,E,P,I);else if(T*E>0||C!=0)p(y.a,y.b,y.c,h,m,x,C,T,E,P,I);else if(T!=0)p(y.b,y.a,y.c,m,h,x,T,C,E,P,I);else if(E!=0)p(y.c,y.a,y.b,x,h,m,E,C,T,P,I);else return!0;return!1}function k(y,h,m,x){const w=h.degenerateSegment,v=y.plane.distanceToPoint(w.start),C=y.plane.distanceToPoint(w.end);return Re(v)?Re(C)?u(y,h,m,x):(m&&(m.start.copy(w.start),m.end.copy(w.start)),y.containsPoint(w.start)):Re(C)?(m&&(m.start.copy(w.end),m.end.copy(w.end)),y.containsPoint(w.end)):y.plane.intersectLine(w,s)!=null?(m&&(m.start.copy(s),m.end.copy(s)),y.containsPoint(s)):!1}function A(y,h,m){const x=h.a;return Re(y.plane.distanceToPoint(x))&&y.containsPoint(x)?(m&&(m.start.copy(x),m.end.copy(x)),!0):!1}function _(y,h,m){const x=y.degenerateSegment,w=h.a;return x.closestPointToPoint(w,!0,s),w.distanceToSquared(s)<Mo?(m&&(m.start.copy(w),m.end.copy(w)),!0):!1}function b(y,h,m,x){if(y.isDegenerateIntoSegment)if(h.isDegenerateIntoSegment){const w=y.degenerateSegment,v=h.degenerateSegment,C=o,T=i;w.delta(C),v.delta(T);const E=s.subVectors(v.start,w.start),P=C.x*T.y-C.y*T.x;if(Re(P))return!1;const I=(E.x*T.y-E.y*T.x)/P,B=-(C.x*E.y-C.y*E.x)/P;if(I<0||I>1||B<0||B>1)return!1;const V=w.start.z+C.z*I,K=v.start.z+T.z*B;return Re(V-K)?(m&&(m.start.copy(w.start).addScaledVector(C,I),m.end.copy(w.start).addScaledVector(C,I)),!0):!1}else return h.isDegenerateIntoPoint?_(y,h,m):k(h,y,m,x);else{if(y.isDegenerateIntoPoint)return h.isDegenerateIntoPoint?h.a.distanceToSquared(y.a)<Mo?(m&&(m.start.copy(y.a),m.end.copy(y.a)),!0):!1:h.isDegenerateIntoSegment?_(h,y,m):A(h,y,m);if(h.isDegenerateIntoPoint)return A(y,h,m);if(h.isDegenerateIntoSegment)return k(y,h,m,x)}}return function(h,m=null,x=!1){this.needsUpdate&&this.update(),h.isExtendedTriangle?h.needsUpdate&&h.update():(e.copy(h),e.update(),h=e);const w=b(this,h,m,x);if(w!==void 0)return w;const v=this.plane,C=h.plane;let T=C.distanceToPoint(this.a),E=C.distanceToPoint(this.b),P=C.distanceToPoint(this.c);Re(T)&&(T=0),Re(E)&&(E=0),Re(P)&&(P=0);const I=T*E,B=T*P;if(I>0&&B>0)return!1;let V=v.distanceToPoint(h.a),K=v.distanceToPoint(h.b),Z=v.distanceToPoint(h.c);Re(V)&&(V=0),Re(K)&&(K=0),Re(Z)&&(Z=0);const Ae=V*K,ue=V*Z;if(Ae>0&&ue>0)return!1;o.copy(v.normal),i.copy(C.normal);const W=o.cross(i);let J=0,ye=Math.abs(W.x);const Je=Math.abs(W.y);Je>ye&&(ye=Je,J=1),Math.abs(W.z)>ye&&(J=2);const N=ya[J],R=this.a[N],Y=this.b[N],mt=this.c[N],gs=h.a[N],M=h.b[N],ie=h.c[N];if(S(this,R,Y,mt,I,B,T,E,P,c,a))return u(this,h,m,x);if(S(h,gs,M,ie,Ae,ue,V,K,Z,f,l))return u(this,h,m,x);if(c.y<c.x){const ws=c.y;c.y=c.x,c.x=ws,d.copy(a.start),a.start.copy(a.end),a.end.copy(d)}if(f.y<f.x){const ws=f.y;f.y=f.x,f.x=ws,d.copy(l.start),l.start.copy(l.end),l.end.copy(d)}return c.y<f.x||f.y<c.x?!1:(m&&(f.x>c.x?m.start.copy(l.start):m.start.copy(a.start),f.y<c.y?m.end.copy(l.end):m.end.copy(a.end)),!0)}})();Le.prototype.distanceToPoint=(function(){const e=new U;return function(n){return this.closestPointToPoint(n,e),n.distanceTo(e)}})();Le.prototype.distanceToTriangle=(function(){const e=new U,t=new U,n=["a","b","c"],s=new Ye,o=new Ye;return function(r,a=null,l=null){const d=a||l?s:null;if(this.intersectsTriangle(r,d))return(a||l)&&(a&&d.getCenter(a),l&&d.getCenter(l)),0;let c=1/0;for(let f=0;f<3;f++){let u;const p=n[f],S=r[p];this.closestPointToPoint(S,e),u=S.distanceToSquared(e),u<c&&(c=u,a&&a.copy(e),l&&l.copy(S));const k=this[p];r.closestPointToPoint(k,e),u=k.distanceToSquared(e),u<c&&(c=u,a&&a.copy(k),l&&l.copy(e))}for(let f=0;f<3;f++){const u=n[f],p=n[(f+1)%3];s.set(this[u],this[p]);for(let S=0;S<3;S++){const k=n[S],A=n[(S+1)%3];o.set(r[k],r[A]),uo(s,o,e,t);const _=e.distanceToSquared(t);_<c&&(c=_,a&&a.copy(e),l&&l.copy(t))}}return Math.sqrt(c)}})();class xe{constructor(t,n,s){this.isOrientedBox=!0,this.min=new U,this.max=new U,this.matrix=new ut,this.invMatrix=new ut,this.points=new Array(8).fill().map(()=>new U),this.satAxes=new Array(3).fill().map(()=>new U),this.satBounds=new Array(3).fill().map(()=>new qe),this.alignedSatBounds=new Array(3).fill().map(()=>new qe),this.needsUpdate=!1,t&&this.min.copy(t),n&&this.max.copy(n),s&&this.matrix.copy(s)}set(t,n,s){this.min.copy(t),this.max.copy(n),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}xe.prototype.update=(function(){return function(){const t=this.matrix,n=this.min,s=this.max,o=this.points;for(let d=0;d<=1;d++)for(let c=0;c<=1;c++)for(let f=0;f<=1;f++){const u=1*d|2*c|4*f,p=o[u];p.x=d?s.x:n.x,p.y=c?s.y:n.y,p.z=f?s.z:n.z,p.applyMatrix4(t)}const i=this.satBounds,r=this.satAxes,a=o[0];for(let d=0;d<3;d++){const c=r[d],f=i[d],u=1<<d,p=o[u];c.subVectors(a,p),f.setFromPoints(c,o)}const l=this.alignedSatBounds;l[0].setFromPointsField(o,"x"),l[1].setFromPointsField(o,"y"),l[2].setFromPointsField(o,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();xe.prototype.intersectsBox=(function(){const e=new qe;return function(n){this.needsUpdate&&this.update();const s=n.min,o=n.max,i=this.satBounds,r=this.satAxes,a=this.alignedSatBounds;if(e.min=s.x,e.max=o.x,a[0].isSeparated(e)||(e.min=s.y,e.max=o.y,a[1].isSeparated(e))||(e.min=s.z,e.max=o.z,a[2].isSeparated(e)))return!1;for(let l=0;l<3;l++){const d=r[l],c=i[l];if(e.setFromBox(d,n),c.isSeparated(e))return!1}return!0}})();xe.prototype.intersectsTriangle=(function(){const e=new Le,t=new Array(3),n=new qe,s=new qe,o=new U;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(e.copy(r),e.update(),r=e);const a=this.satBounds,l=this.satAxes;t[0]=r.a,t[1]=r.b,t[2]=r.c;for(let u=0;u<3;u++){const p=a[u],S=l[u];if(n.setFromPoints(S,t),p.isSeparated(n))return!1}const d=r.satBounds,c=r.satAxes,f=this.points;for(let u=0;u<3;u++){const p=d[u],S=c[u];if(n.setFromPoints(S,f),p.isSeparated(n))return!1}for(let u=0;u<3;u++){const p=l[u];for(let S=0;S<4;S++){const k=c[S];if(o.crossVectors(p,k),n.setFromPoints(o,t),s.setFromPoints(o,f),n.isSeparated(s))return!1}}return!0}})();xe.prototype.closestPointToPoint=(function(){return function(t,n){return this.needsUpdate&&this.update(),n.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),n}})();xe.prototype.distanceToPoint=(function(){const e=new U;return function(n){return this.closestPointToPoint(n,e),n.distanceTo(e)}})();xe.prototype.distanceToBox=(function(){const e=["x","y","z"],t=new Array(12).fill().map(()=>new Ye),n=new Array(12).fill().map(()=>new Ye),s=new U,o=new U;return function(r,a=0,l=null,d=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(l||d)&&(r.getCenter(o),this.closestPointToPoint(o,s),r.closestPointToPoint(s,o),l&&l.copy(s),d&&d.copy(o)),0;const c=a*a,f=r.min,u=r.max,p=this.points;let S=1/0;for(let A=0;A<8;A++){const _=p[A];o.copy(_).clamp(f,u);const b=_.distanceToSquared(o);if(b<S&&(S=b,l&&l.copy(_),d&&d.copy(o),b<c))return Math.sqrt(b)}let k=0;for(let A=0;A<3;A++)for(let _=0;_<=1;_++)for(let b=0;b<=1;b++){const y=(A+1)%3,h=(A+2)%3,m=_<<y|b<<h,x=1<<A|_<<y|b<<h,w=p[m],v=p[x];t[k].set(w,v);const T=e[A],E=e[y],P=e[h],I=n[k],B=I.start,V=I.end;B[T]=f[T],B[E]=_?f[E]:u[E],B[P]=b?f[P]:u[E],V[T]=u[T],V[E]=_?f[E]:u[E],V[P]=b?f[P]:u[E],k++}for(let A=0;A<=1;A++)for(let _=0;_<=1;_++)for(let b=0;b<=1;b++){o.x=A?u.x:f.x,o.y=_?u.y:f.y,o.z=b?u.z:f.z,this.closestPointToPoint(o,s);const y=o.distanceToSquared(s);if(y<S&&(S=y,l&&l.copy(s),d&&d.copy(o),y<c))return Math.sqrt(y)}for(let A=0;A<12;A++){const _=t[A];for(let b=0;b<12;b++){const y=n[b];uo(_,y,s,o);const h=s.distanceToSquared(o);if(h<S&&(S=h,l&&l.copy(s),d&&d.copy(o),h<c))return Math.sqrt(h)}}return Math.sqrt(S)}})();class ma extends lo{constructor(){super(()=>new Le)}}const Be=new ma,Qt=new U,Ps=new U;function ha(e,t,n={},s=0,o=1/0){const i=s*s,r=o*o;let a=1/0,l=null;if(e.shapecast({boundsTraverseOrder:c=>(Qt.copy(t).clamp(c.min,c.max),Qt.distanceToSquared(t)),intersectsBounds:(c,f,u)=>u<a&&u<r,intersectsTriangle:(c,f)=>{c.closestPointToPoint(t,Qt);const u=t.distanceToSquared(Qt);return u<a&&(Ps.copy(Qt),a=u,l=f),u<i}}),a===1/0)return null;const d=Math.sqrt(a);return n.point?n.point.copy(Ps):n.point=Ps.clone(),n.distance=d,n.faceIndex=l,n}const Cn=parseInt(fi)>=169,ba=parseInt(fi)<=161,ht=new U,bt=new U,gt=new U,En=new ft,Rn=new ft,In=new ft,Do=new U,No=new U,Lo=new U,en=new U;function ga(e,t,n,s,o,i,r,a){let l;if(i===xr?l=e.intersectTriangle(s,n,t,!0,o):l=e.intersectTriangle(t,n,s,i!==vr,o),l===null)return null;const d=e.origin.distanceTo(o);return d<r||d>a?null:{distance:d,point:o.clone()}}function Uo(e,t,n,s,o,i,r,a,l,d,c){ht.fromBufferAttribute(t,i),bt.fromBufferAttribute(t,r),gt.fromBufferAttribute(t,a);const f=ga(e,ht,bt,gt,en,l,d,c);if(f){if(s){En.fromBufferAttribute(s,i),Rn.fromBufferAttribute(s,r),In.fromBufferAttribute(s,a),f.uv=new ft;const p=Lt.getInterpolation(en,ht,bt,gt,En,Rn,In,f.uv);Cn||(f.uv=p)}if(o){En.fromBufferAttribute(o,i),Rn.fromBufferAttribute(o,r),In.fromBufferAttribute(o,a),f.uv1=new ft;const p=Lt.getInterpolation(en,ht,bt,gt,En,Rn,In,f.uv1);Cn||(f.uv1=p),ba&&(f.uv2=f.uv1)}if(n){Do.fromBufferAttribute(n,i),No.fromBufferAttribute(n,r),Lo.fromBufferAttribute(n,a),f.normal=new U;const p=Lt.getInterpolation(en,ht,bt,gt,Do,No,Lo,f.normal);f.normal.dot(e.direction)>0&&f.normal.multiplyScalar(-1),Cn||(f.normal=p)}const u={a:i,b:r,c:a,normal:new U,materialIndex:0};if(Lt.getNormal(ht,bt,gt,u.normal),f.face=u,f.faceIndex=i,Cn){const p=new U;Lt.getBarycoord(en,ht,bt,gt,p),f.barycoord=p}}return f}function Oo(e){return e&&e.isMaterial?e.side:e}function ms(e,t,n,s,o,i,r){const a=s*3;let l=a+0,d=a+1,c=a+2;const{index:f,groups:u}=e;e.index&&(l=f.getX(l),d=f.getX(d),c=f.getX(c));const{position:p,normal:S,uv:k,uv1:A}=e.attributes;if(Array.isArray(t)){const _=s*3;for(let b=0,y=u.length;b<y;b++){const{start:h,count:m,materialIndex:x}=u[b];if(_>=h&&_<h+m){const w=Oo(t[x]),v=Uo(n,p,S,k,A,l,d,c,w,i,r);if(v)if(v.faceIndex=s,v.face.materialIndex=x,o)o.push(v);else return v}}}else{const _=Oo(t),b=Uo(n,p,S,k,A,l,d,c,_,i,r);if(b)if(b.faceIndex=s,b.face.materialIndex=0,o)o.push(b);else return b}return null}function re(e,t,n,s){const o=e.a,i=e.b,r=e.c;let a=t,l=t+1,d=t+2;n&&(a=n.getX(a),l=n.getX(l),d=n.getX(d)),o.x=s.getX(a),o.y=s.getY(a),o.z=s.getZ(a),i.x=s.getX(l),i.y=s.getY(l),i.z=s.getZ(l),r.x=s.getX(d),r.y=s.getY(d),r.z=s.getZ(d)}function wa(e,t,n,s,o,i,r,a){const{geometry:l,_indirectBuffer:d}=e;for(let c=s,f=s+o;c<f;c++)ms(l,t,n,c,i,r,a)}function xa(e,t,n,s,o,i,r){const{geometry:a,_indirectBuffer:l}=e;let d=1/0,c=null;for(let f=s,u=s+o;f<u;f++){let p;p=ms(a,t,n,f,null,i,r),p&&p.distance<d&&(c=p,d=p.distance)}return c}function va(e,t,n,s,o,i,r){const{geometry:a}=n,{index:l}=a,d=a.attributes.position;for(let c=e,f=t+e;c<f;c++){let u;if(u=c,re(r,u*3,l,d),r.needsUpdate=!0,s(r,u,o,i))return!0}return!1}function Sa(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const n=e.geometry,s=n.index?n.index.array:null,o=n.attributes.position;let i,r,a,l,d=0;const c=e._roots;for(let u=0,p=c.length;u<p;u++)i=c[u],r=new Uint32Array(i),a=new Uint16Array(i),l=new Float32Array(i),f(0,d),d+=i.byteLength;function f(u,p,S=!1){const k=u*2;if(ce(k,a)){const A=be(u,r),_=we(k,a);let b=1/0,y=1/0,h=1/0,m=-1/0,x=-1/0,w=-1/0;for(let v=3*A,C=3*(A+_);v<C;v++){let T=s[v];const E=o.getX(T),P=o.getY(T),I=o.getZ(T);E<b&&(b=E),E>m&&(m=E),P<y&&(y=P),P>x&&(x=P),I<h&&(h=I),I>w&&(w=I)}return l[u+0]!==b||l[u+1]!==y||l[u+2]!==h||l[u+3]!==m||l[u+4]!==x||l[u+5]!==w?(l[u+0]=b,l[u+1]=y,l[u+2]=h,l[u+3]=m,l[u+4]=x,l[u+5]=w,!0):!1}else{const A=de(u),_=pe(u,r);let b=S,y=!1,h=!1;if(t){if(!b){const T=A/le+p/he,E=_/le+p/he;y=t.has(T),h=t.has(E),b=!y&&!h}}else y=!0,h=!0;const m=b||y,x=b||h;let w=!1;m&&(w=f(A,p,b));let v=!1;x&&(v=f(_,p,b));const C=w||v;if(C)for(let T=0;T<3;T++){const E=A+T,P=_+T,I=l[E],B=l[E+3],V=l[P],K=l[P+3];l[u+T]=I<V?I:V,l[u+T+3]=B>K?B:K}return C}}}function dt(e,t,n,s,o){let i,r,a,l,d,c;const f=1/n.direction.x,u=1/n.direction.y,p=1/n.direction.z,S=n.origin.x,k=n.origin.y,A=n.origin.z;let _=t[e],b=t[e+3],y=t[e+1],h=t[e+3+1],m=t[e+2],x=t[e+3+2];return f>=0?(i=(_-S)*f,r=(b-S)*f):(i=(b-S)*f,r=(_-S)*f),u>=0?(a=(y-k)*u,l=(h-k)*u):(a=(h-k)*u,l=(y-k)*u),i>l||a>r||((a>i||isNaN(i))&&(i=a),(l<r||isNaN(r))&&(r=l),p>=0?(d=(m-A)*p,c=(x-A)*p):(d=(x-A)*p,c=(m-A)*p),i>c||d>r)?!1:((d>i||i!==i)&&(i=d),(c<r||r!==r)&&(r=c),i<=o&&r>=s)}function Aa(e,t,n,s,o,i,r,a){const{geometry:l,_indirectBuffer:d}=e;for(let c=s,f=s+o;c<f;c++){let u=d?d[c]:c;ms(l,t,n,u,i,r,a)}}function Ta(e,t,n,s,o,i,r){const{geometry:a,_indirectBuffer:l}=e;let d=1/0,c=null;for(let f=s,u=s+o;f<u;f++){let p;p=ms(a,t,n,l?l[f]:f,null,i,r),p&&p.distance<d&&(c=p,d=p.distance)}return c}function ka(e,t,n,s,o,i,r){const{geometry:a}=n,{index:l}=a,d=a.attributes.position;for(let c=e,f=t+e;c<f;c++){let u;if(u=n.resolveTriangleIndex(c),re(r,u*3,l,d),r.needsUpdate=!0,s(r,u,o,i))return!0}return!1}function _a(e,t,n,s,o,i,r){ee.setBuffer(e._roots[t]),Hs(0,e,n,s,o,i,r),ee.clearBuffer()}function Hs(e,t,n,s,o,i,r){const{float32Array:a,uint16Array:l,uint32Array:d}=ee,c=e*2;if(ce(c,l)){const u=be(e,d),p=we(c,l);wa(t,n,s,u,p,o,i,r)}else{const u=de(e);dt(u,a,s,i,r)&&Hs(u,t,n,s,o,i,r);const p=pe(e,d);dt(p,a,s,i,r)&&Hs(p,t,n,s,o,i,r)}}const Pa=["x","y","z"];function Ca(e,t,n,s,o,i){ee.setBuffer(e._roots[t]);const r=js(0,e,n,s,o,i);return ee.clearBuffer(),r}function js(e,t,n,s,o,i){const{float32Array:r,uint16Array:a,uint32Array:l}=ee;let d=e*2;if(ce(d,a)){const f=be(e,l),u=we(d,a);return xa(t,n,s,f,u,o,i)}else{const f=ao(e,l),u=Pa[f],S=s.direction[u]>=0;let k,A;S?(k=de(e),A=pe(e,l)):(k=pe(e,l),A=de(e));const b=dt(k,r,s,o,i)?js(k,t,n,s,o,i):null;if(b){const m=b.point[u];if(S?m<=r[A+f]:m>=r[A+f+3])return b}const h=dt(A,r,s,o,i)?js(A,t,n,s,o,i):null;return b&&h?b.distance<=h.distance?b:h:b||h||null}}const Bn=new Se,It=new Le,Bt=new Le,tn=new ut,Vo=new xe,Mn=new xe;function Ea(e,t,n,s){ee.setBuffer(e._roots[t]);const o=Ks(0,e,n,s);return ee.clearBuffer(),o}function Ks(e,t,n,s,o=null){const{float32Array:i,uint16Array:r,uint32Array:a}=ee;let l=e*2;if(o===null&&(n.boundingBox||n.computeBoundingBox(),Vo.set(n.boundingBox.min,n.boundingBox.max,s),o=Vo),ce(l,r)){const c=t.geometry,f=c.index,u=c.attributes.position,p=n.index,S=n.attributes.position,k=be(e,a),A=we(l,r);if(tn.copy(s).invert(),n.boundsTree)return ne(e,i,Mn),Mn.matrix.copy(tn),Mn.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:b=>Mn.intersectsBox(b),intersectsTriangle:b=>{b.a.applyMatrix4(s),b.b.applyMatrix4(s),b.c.applyMatrix4(s),b.needsUpdate=!0;for(let y=k*3,h=(A+k)*3;y<h;y+=3)if(re(Bt,y,f,u),Bt.needsUpdate=!0,b.intersectsTriangle(Bt))return!0;return!1}});{const _=ys(n);for(let b=k*3,y=(A+k)*3;b<y;b+=3){re(It,b,f,u),It.a.applyMatrix4(tn),It.b.applyMatrix4(tn),It.c.applyMatrix4(tn),It.needsUpdate=!0;for(let h=0,m=_*3;h<m;h+=3)if(re(Bt,h,p,S),Bt.needsUpdate=!0,It.intersectsTriangle(Bt))return!0}}}else{const c=de(e),f=pe(e,a);return ne(c,i,Bn),!!(o.intersectsBox(Bn)&&Ks(c,t,n,s,o)||(ne(f,i,Bn),o.intersectsBox(Bn)&&Ks(f,t,n,s,o)))}}const Dn=new ut,Cs=new xe,nn=new xe,Ra=new U,Ia=new U,Ba=new U,Ma=new U;function Da(e,t,n,s={},o={},i=0,r=1/0){t.boundingBox||t.computeBoundingBox(),Cs.set(t.boundingBox.min,t.boundingBox.max,n),Cs.needsUpdate=!0;const a=e.geometry,l=a.attributes.position,d=a.index,c=t.attributes.position,f=t.index,u=Be.getPrimitive(),p=Be.getPrimitive();let S=Ra,k=Ia,A=null,_=null;o&&(A=Ba,_=Ma);let b=1/0,y=null,h=null;return Dn.copy(n).invert(),nn.matrix.copy(Dn),e.shapecast({boundsTraverseOrder:m=>Cs.distanceToBox(m),intersectsBounds:(m,x,w)=>w<b&&w<r?(x&&(nn.min.copy(m.min),nn.max.copy(m.max),nn.needsUpdate=!0),!0):!1,intersectsRange:(m,x)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:v=>nn.distanceToBox(v),intersectsBounds:(v,C,T)=>T<b&&T<r,intersectsRange:(v,C)=>{for(let T=v,E=v+C;T<E;T++){re(p,3*T,f,c),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let P=m,I=m+x;P<I;P++){re(u,3*P,d,l),u.needsUpdate=!0;const B=u.distanceToTriangle(p,S,A);if(B<b&&(k.copy(S),_&&_.copy(A),b=B,y=P,h=T),B<i)return!0}}}});{const w=ys(t);for(let v=0,C=w;v<C;v++){re(p,3*v,f,c),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let T=m,E=m+x;T<E;T++){re(u,3*T,d,l),u.needsUpdate=!0;const P=u.distanceToTriangle(p,S,A);if(P<b&&(k.copy(S),_&&_.copy(A),b=P,y=T,h=v),P<i)return!0}}}}}),Be.releasePrimitive(u),Be.releasePrimitive(p),b===1/0?null:(s.point?s.point.copy(k):s.point=k.clone(),s.distance=b,s.faceIndex=y,o&&(o.point?o.point.copy(_):o.point=_.clone(),o.point.applyMatrix4(Dn),k.applyMatrix4(Dn),o.distance=k.sub(o.point).length(),o.faceIndex=h),s)}function Na(e,t=null){t&&Array.isArray(t)&&(t=new Set(t));const n=e.geometry,s=n.index?n.index.array:null,o=n.attributes.position;let i,r,a,l,d=0;const c=e._roots;for(let u=0,p=c.length;u<p;u++)i=c[u],r=new Uint32Array(i),a=new Uint16Array(i),l=new Float32Array(i),f(0,d),d+=i.byteLength;function f(u,p,S=!1){const k=u*2;if(ce(k,a)){const A=be(u,r),_=we(k,a);let b=1/0,y=1/0,h=1/0,m=-1/0,x=-1/0,w=-1/0;for(let v=A,C=A+_;v<C;v++){const T=3*e.resolveTriangleIndex(v);for(let E=0;E<3;E++){let P=T+E;P=s?s[P]:P;const I=o.getX(P),B=o.getY(P),V=o.getZ(P);I<b&&(b=I),I>m&&(m=I),B<y&&(y=B),B>x&&(x=B),V<h&&(h=V),V>w&&(w=V)}}return l[u+0]!==b||l[u+1]!==y||l[u+2]!==h||l[u+3]!==m||l[u+4]!==x||l[u+5]!==w?(l[u+0]=b,l[u+1]=y,l[u+2]=h,l[u+3]=m,l[u+4]=x,l[u+5]=w,!0):!1}else{const A=de(u),_=pe(u,r);let b=S,y=!1,h=!1;if(t){if(!b){const T=A/le+p/he,E=_/le+p/he;y=t.has(T),h=t.has(E),b=!y&&!h}}else y=!0,h=!0;const m=b||y,x=b||h;let w=!1;m&&(w=f(A,p,b));let v=!1;x&&(v=f(_,p,b));const C=w||v;if(C)for(let T=0;T<3;T++){const E=A+T,P=_+T,I=l[E],B=l[E+3],V=l[P],K=l[P+3];l[u+T]=I<V?I:V,l[u+T+3]=B>K?B:K}return C}}}function La(e,t,n,s,o,i,r){ee.setBuffer(e._roots[t]),Ws(0,e,n,s,o,i,r),ee.clearBuffer()}function Ws(e,t,n,s,o,i,r){const{float32Array:a,uint16Array:l,uint32Array:d}=ee,c=e*2;if(ce(c,l)){const u=be(e,d),p=we(c,l);Aa(t,n,s,u,p,o,i,r)}else{const u=de(e);dt(u,a,s,i,r)&&Ws(u,t,n,s,o,i,r);const p=pe(e,d);dt(p,a,s,i,r)&&Ws(p,t,n,s,o,i,r)}}const Ua=["x","y","z"];function Oa(e,t,n,s,o,i){ee.setBuffer(e._roots[t]);const r=Ys(0,e,n,s,o,i);return ee.clearBuffer(),r}function Ys(e,t,n,s,o,i){const{float32Array:r,uint16Array:a,uint32Array:l}=ee;let d=e*2;if(ce(d,a)){const f=be(e,l),u=we(d,a);return Ta(t,n,s,f,u,o,i)}else{const f=ao(e,l),u=Ua[f],S=s.direction[u]>=0;let k,A;S?(k=de(e),A=pe(e,l)):(k=pe(e,l),A=de(e));const b=dt(k,r,s,o,i)?Ys(k,t,n,s,o,i):null;if(b){const m=b.point[u];if(S?m<=r[A+f]:m>=r[A+f+3])return b}const h=dt(A,r,s,o,i)?Ys(A,t,n,s,o,i):null;return b&&h?b.distance<=h.distance?b:h:b||h||null}}const Nn=new Se,Mt=new Le,Dt=new Le,sn=new ut,zo=new xe,Ln=new xe;function Va(e,t,n,s){ee.setBuffer(e._roots[t]);const o=qs(0,e,n,s);return ee.clearBuffer(),o}function qs(e,t,n,s,o=null){const{float32Array:i,uint16Array:r,uint32Array:a}=ee;let l=e*2;if(o===null&&(n.boundingBox||n.computeBoundingBox(),zo.set(n.boundingBox.min,n.boundingBox.max,s),o=zo),ce(l,r)){const c=t.geometry,f=c.index,u=c.attributes.position,p=n.index,S=n.attributes.position,k=be(e,a),A=we(l,r);if(sn.copy(s).invert(),n.boundsTree)return ne(e,i,Ln),Ln.matrix.copy(sn),Ln.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:b=>Ln.intersectsBox(b),intersectsTriangle:b=>{b.a.applyMatrix4(s),b.b.applyMatrix4(s),b.c.applyMatrix4(s),b.needsUpdate=!0;for(let y=k,h=A+k;y<h;y++)if(re(Dt,3*t.resolveTriangleIndex(y),f,u),Dt.needsUpdate=!0,b.intersectsTriangle(Dt))return!0;return!1}});{const _=ys(n);for(let b=k,y=A+k;b<y;b++){const h=t.resolveTriangleIndex(b);re(Mt,3*h,f,u),Mt.a.applyMatrix4(sn),Mt.b.applyMatrix4(sn),Mt.c.applyMatrix4(sn),Mt.needsUpdate=!0;for(let m=0,x=_*3;m<x;m+=3)if(re(Dt,m,p,S),Dt.needsUpdate=!0,Mt.intersectsTriangle(Dt))return!0}}}else{const c=de(e),f=pe(e,a);return ne(c,i,Nn),!!(o.intersectsBox(Nn)&&qs(c,t,n,s,o)||(ne(f,i,Nn),o.intersectsBox(Nn)&&qs(f,t,n,s,o)))}}const Un=new ut,Es=new xe,on=new xe,za=new U,$a=new U,Fa=new U,Ha=new U;function ja(e,t,n,s={},o={},i=0,r=1/0){t.boundingBox||t.computeBoundingBox(),Es.set(t.boundingBox.min,t.boundingBox.max,n),Es.needsUpdate=!0;const a=e.geometry,l=a.attributes.position,d=a.index,c=t.attributes.position,f=t.index,u=Be.getPrimitive(),p=Be.getPrimitive();let S=za,k=$a,A=null,_=null;o&&(A=Fa,_=Ha);let b=1/0,y=null,h=null;return Un.copy(n).invert(),on.matrix.copy(Un),e.shapecast({boundsTraverseOrder:m=>Es.distanceToBox(m),intersectsBounds:(m,x,w)=>w<b&&w<r?(x&&(on.min.copy(m.min),on.max.copy(m.max),on.needsUpdate=!0),!0):!1,intersectsRange:(m,x)=>{if(t.boundsTree){const w=t.boundsTree;return w.shapecast({boundsTraverseOrder:v=>on.distanceToBox(v),intersectsBounds:(v,C,T)=>T<b&&T<r,intersectsRange:(v,C)=>{for(let T=v,E=v+C;T<E;T++){const P=w.resolveTriangleIndex(T);re(p,3*P,f,c),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let I=m,B=m+x;I<B;I++){const V=e.resolveTriangleIndex(I);re(u,3*V,d,l),u.needsUpdate=!0;const K=u.distanceToTriangle(p,S,A);if(K<b&&(k.copy(S),_&&_.copy(A),b=K,y=I,h=T),K<i)return!0}}}})}else{const w=ys(t);for(let v=0,C=w;v<C;v++){re(p,3*v,f,c),p.a.applyMatrix4(n),p.b.applyMatrix4(n),p.c.applyMatrix4(n),p.needsUpdate=!0;for(let T=m,E=m+x;T<E;T++){const P=e.resolveTriangleIndex(T);re(u,3*P,d,l),u.needsUpdate=!0;const I=u.distanceToTriangle(p,S,A);if(I<b&&(k.copy(S),_&&_.copy(A),b=I,y=T,h=v),I<i)return!0}}}}}),Be.releasePrimitive(u),Be.releasePrimitive(p),b===1/0?null:(s.point?s.point.copy(k):s.point=k.clone(),s.distance=b,s.faceIndex=y,o&&(o.point?o.point.copy(_):o.point=_.clone(),o.point.applyMatrix4(Un),k.applyMatrix4(Un),o.distance=k.sub(o.point).length(),o.faceIndex=h),s)}function $o(e,t,n){return e===null?null:(e.point.applyMatrix4(t.matrixWorld),e.distance=e.point.distanceTo(n.ray.origin),e.object=t,e)}const On=new xe,Vn=new Sr,Fo=new U,Ho=new ut,jo=new U,Rs=["getX","getY","getZ"];class Gn extends fa{static serialize(t,n={}){n={cloneBuffers:!0,...n};const s=t.geometry,o=t._roots,i=t._indirectBuffer,r=s.getIndex(),a={version:1,roots:null,index:null,indirectBuffer:null};return n.cloneBuffers?(a.roots=o.map(l=>l.slice()),a.index=r?r.array.slice():null,a.indirectBuffer=i?i.slice():null):(a.roots=o,a.index=r?r.array:null,a.indirectBuffer=i),a}static deserialize(t,n,s={}){s={setIndex:!0,indirect:!!t.indirectBuffer,...s};const{index:o,roots:i,indirectBuffer:r}=t;t.version||l(i);const a=new Gn(n,{...s,[ro]:!0});if(a._roots=i,a._indirectBuffer=r||null,s.setIndex){const d=n.getIndex();if(d===null){const c=new ci(t.index,1,!1);n.setIndex(c)}else d.array!==o&&(d.array.set(o),d.needsUpdate=!0)}return a;function l(d){for(let c=0;c<d.length;c++){const f=d[c],u=new Uint32Array(f),p=new Uint16Array(f);for(let S=0,k=f.byteLength/he;S<k;S++){const A=le*S,_=2*A;ce(_,p)||(u[A+6]=u[A+6]/le-S)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(t,n={}){n.maxLeafTris&&(n={...n,maxLeafSize:n.maxLeafTris}),super(t,n)}shiftTriangleOffsets(t){return super.shiftPrimitiveOffsets(t)}writePrimitiveBounds(t,n,s){const o=this.geometry,i=this._indirectBuffer,r=o.attributes.position,a=o.index?o.index.array:null,d=(i?i[t]:t)*3;let c=d+0,f=d+1,u=d+2;a&&(c=a[c],f=a[f],u=a[u]);for(let p=0;p<3;p++){const S=r[Rs[p]](c),k=r[Rs[p]](f),A=r[Rs[p]](u);let _=S;k<_&&(_=k),A<_&&(_=A);let b=S;k>b&&(b=k),A>b&&(b=A),n[s+p]=_,n[s+p+3]=b}return n}computePrimitiveBounds(t,n,s){const o=this.geometry,i=this._indirectBuffer,r=o.attributes.position,a=o.index?o.index.array:null,l=r.normalized;if(t<0||n+t-s.offset>s.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const d=r.array,c=r.offset||0;let f=3;r.isInterleavedBufferAttribute&&(f=r.data.stride);const u=["getX","getY","getZ"],p=s.offset;for(let S=t,k=t+n;S<k;S++){const _=(i?i[S]:S)*3,b=(S-p)*6;let y=_+0,h=_+1,m=_+2;a&&(y=a[y],h=a[h],m=a[m]),l||(y=y*f+c,h=h*f+c,m=m*f+c);for(let x=0;x<3;x++){let w,v,C;l?(w=r[u[x]](y),v=r[u[x]](h),C=r[u[x]](m)):(w=d[y+x],v=d[h+x],C=d[m+x]);let T=w;v<T&&(T=v),C<T&&(T=C);let E=w;v>E&&(E=v),C>E&&(E=C);const P=(E-T)/2,I=x*2;s[b+I+0]=T+P,s[b+I+1]=P+(Math.abs(T)+P)*Fn}}return s}raycastObject3D(t,n,s=[]){const{material:o}=t;if(o===void 0)return;Ho.copy(t.matrixWorld).invert(),Vn.copy(n.ray).applyMatrix4(Ho),jo.setFromMatrixScale(t.matrixWorld),Fo.copy(Vn.direction).multiply(jo);const i=Fo.length(),r=n.near/i,a=n.far/i;if(n.firstHitOnly===!0){let l=this.raycastFirst(Vn,o,r,a);l=$o(l,t,n),l&&s.push(l)}else{const l=this.raycast(Vn,o,r,a);for(let d=0,c=l.length;d<c;d++){const f=$o(l[d],t,n);f&&s.push(f)}}return s}refit(t=null){return(this.indirect?Na:Sa)(this,t)}raycast(t,n=To,s=0,o=1/0){const i=this._roots,r=[],a=this.indirect?La:_a;for(let l=0,d=i.length;l<d;l++)a(this,l,n,t,r,s,o);return r}raycastFirst(t,n=To,s=0,o=1/0){const i=this._roots;let r=null;const a=this.indirect?Oa:Ca;for(let l=0,d=i.length;l<d;l++){const c=a(this,l,n,t,s,o);c!=null&&(r==null||c.distance<r.distance)&&(r=c)}return r}intersectsGeometry(t,n){let s=!1;const o=this._roots,i=this.indirect?Va:Ea;for(let r=0,a=o.length;r<a&&(s=i(this,r,t,n),!s);r++);return s}shapecast(t){const n=Be.getPrimitive(),s=super.shapecast({...t,intersectsPrimitive:t.intersectsTriangle,scratchPrimitive:n,iterate:this.indirect?ka:va});return Be.releasePrimitive(n),s}bvhcast(t,n,s){let{intersectsRanges:o,intersectsTriangles:i}=s;const r=Be.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,d=this.indirect?S=>{const k=this.resolveTriangleIndex(S);re(r,k*3,a,l)}:S=>{re(r,S*3,a,l)},c=Be.getPrimitive(),f=t.geometry.index,u=t.geometry.attributes.position,p=t.indirect?S=>{const k=t.resolveTriangleIndex(S);re(c,k*3,f,u)}:S=>{re(c,S*3,f,u)};if(i){if(!(t instanceof Gn))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const S=(k,A,_,b,y,h,m,x)=>{for(let w=_,v=_+b;w<v;w++){p(w),c.a.applyMatrix4(n),c.b.applyMatrix4(n),c.c.applyMatrix4(n),c.needsUpdate=!0;for(let C=k,T=k+A;C<T;C++)if(d(C),r.needsUpdate=!0,i(r,c,C,w,y,h,m,x))return!0}return!1};if(o){const k=o;o=function(A,_,b,y,h,m,x,w){return k(A,_,b,y,h,m,x,w)?!0:S(A,_,b,y,h,m,x,w)}}else o=S}return super.bvhcast(t,n,{intersectsRanges:o})}intersectsBox(t,n){return On.set(t.min,t.max,n),On.needsUpdate=!0,this.shapecast({intersectsBounds:s=>On.intersectsBox(s),intersectsTriangle:s=>On.intersectsTriangle(s)})}intersectsSphere(t){return this.shapecast({intersectsBounds:n=>t.intersectsBox(n),intersectsTriangle:n=>n.intersectsSphere(t)})}closestPointToGeometry(t,n,s={},o={},i=0,r=1/0){return(this.indirect?ja:Da)(this,t,n,s,o,i,r)}closestPointToPoint(t,n={},s=0,o=1/0){return ha(this,t,n,s,o)}}const Ut={Mesh:wn.prototype.raycast,Line:yi.prototype.raycast,LineSegments:di.prototype.raycast,LineLoop:pi.prototype.raycast,Points:mi.prototype.raycast,BatchedMesh:Tr.prototype.raycast},me=new wn,zn=[];function Ka(e,t){if(this.isBatchedMesh)Wa.call(this,e,t);else{const{geometry:n}=this;if(n.boundsTree)n.boundsTree.raycastObject3D(this,e,t);else{let s;if(this instanceof wn)s=Ut.Mesh;else if(this instanceof di)s=Ut.LineSegments;else if(this instanceof pi)s=Ut.LineLoop;else if(this instanceof yi)s=Ut.Line;else if(this instanceof mi)s=Ut.Points;else throw new Error("BVH: Fallback raycast function not found.");s.call(this,e,t)}}}function Wa(e,t){if(this.boundsTrees){const n=this.boundsTrees,s=this._drawInfo||this._instanceInfo,o=this._drawRanges||this._geometryInfo,i=this.matrixWorld;me.material=this.material,me.geometry=this.geometry;const r=me.geometry.boundsTree,a=me.geometry.drawRange;me.geometry.boundingSphere===null&&(me.geometry.boundingSphere=new Ar);for(let l=0,d=s.length;l<d;l++){if(!this.getVisibleAt(l))continue;const c=s[l].geometryIndex;if(me.geometry.boundsTree=n[c],this.getMatrixAt(l,me.matrixWorld).premultiply(i),!me.geometry.boundsTree){this.getBoundingBoxAt(c,me.geometry.boundingBox),this.getBoundingSphereAt(c,me.geometry.boundingSphere);const f=o[c];me.geometry.setDrawRange(f.start,f.count)}me.raycast(e,zn);for(let f=0,u=zn.length;f<u;f++){const p=zn[f];p.object=this,p.batchId=l,t.push(p)}zn.length=0}me.geometry.boundsTree=r,me.geometry.drawRange=a,me.material=null,me.geometry=null}else Ut.BatchedMesh.call(this,e,t)}function Ya(e={}){const{type:t=Gn}=e;return this.boundsTree=new t(this,e),this.boundsTree}function qa(){this.boundsTree=null}wi.prototype.computeBoundsTree=Ya;wi.prototype.disposeBoundsTree=qa;wn.prototype.raycast=Ka;const Zs=[];function Hf(e){Zs.length=0,Zs.push(...e)}let Ci=null,Ei=null,Ri=null,Ii=null;function jf(){return Ci}function Za(){return Ei}function Kf(){return Ri}function Wf(){return Ii}function Yf(e){Ci=e}function qf(e){Ei=e}function Zf(e){Ri=e}function Xf(e){Ii=e}let Xa=1.7,Ja=0,Ga=200,Qa=.4,el=1;function Jf(e){Xa=e}function Gf(e){Ja=e}function Qf(e){Ga=e}function ed(e){Qa=e}function td(e){el=e}const nd=z(!1),sd=!1,od=z(!1),yn=[],Ko=[],Wo=[],id=new Map,rd=new gi,ad=new gi,tl=[];for(let e=0;e<8;e++){const t=e/8*Math.PI*2;tl.push(new U(Math.cos(t),0,Math.sin(t)))}const ld=new bi(26248),cd=.8,ud=new bi(21862),fd=.4;function dd(e){return Math.round(e*1e4)/1e4}function pd(e){return e.split("/").pop()||""}function nl(e){return e.replace(/\.glb$/i,"").replace(/[-_]/g," ").replace(/\b\w/g,t=>t.toUpperCase())}const Is=new U;function yd(){return Za().getWorldDirection(Is),Math.atan2(Is.x,Is.z)}function Qe(e){e&&(e.source?.data?.close&&e.source.data.close(),e.dispose())}function sl(e){e.traverse(t=>{if(t.geometry&&t.geometry.dispose(),t.material){const n=Array.isArray(t.material)?t.material:[t.material];for(const s of n)Qe(s.map),Qe(s.normalMap),Qe(s.roughnessMap),Qe(s.metalnessMap),Qe(s.emissiveMap),Qe(s.aoMap),Qe(s.lightMap),Qe(s.alphaMap),s.dispose()}})}function md(e){e.traverse(t=>{t.geometry&&t.geometry.dispose()})}function hd(e,t,n){const s=[];return e.traverse(o=>{if(!o.isMesh||o.userData.isDisplayZone)return;const i=Array.isArray(o.material)?o.material:[o.material];for(const r of i)r.emissive&&(s.push({mesh:o,origEmissive:r.emissive.clone(),origEmissiveIntensity:r.emissiveIntensity??1}),r.emissive.copy(t),r.emissiveIntensity=n)}),s}function bd(e){for(const t of e){const n=Array.isArray(t.mesh.material)?t.mesh.material:[t.mesh.material];for(const s of n)s.emissive&&(s.emissive.copy(t.origEmissive),s.emissiveIntensity=t.origEmissiveIntensity)}}function gd(e){Bi(e),e.traverse(t=>{if(!t.isMesh)return;let n=yn.indexOf(t);n>=0&&yn.splice(n,1),n=Ko.indexOf(t),n>=0&&Ko.splice(n,1)})}const ol=200;function il(e){const t=e.geometry;if(!t||t.boundsTree)return;const n=t.index;(n?n.count/3:(t.attributes?.position?.count??0)/3)>ol&&t.computeBoundsTree({strategy:0,maxLeafSize:10})}function rl(e){e.traverse(t=>{t.isMesh&&il(t)})}const jn=[];let Kn=!1;function wd(e){jn.push(e),Kn||al()}function al(){if(jn.length===0){Kn=!1;return}Kn=!0;const e=()=>{const t=jn.shift();t&&rl(t),jn.length>0?typeof Tn<"u"?Tn(e,{timeout:500}):setTimeout(e,0):Kn=!1};typeof Tn<"u"?Tn(e,{timeout:500}):setTimeout(e,0)}const ll=new kr({visible:!1}),Qn=new Map,at=new U,es=new U;function cl(e){Bi(e);const t=new Se().setFromObject(e);if(t.isEmpty())return;t.getSize(at),t.getCenter(es);const n=new hi(at.x,at.y,at.z);n.computeBoundingSphere();const s=new wn(n,ll);s.position.copy(es),s.visible=!1,s.matrixAutoUpdate=!1,s.updateMatrix(),s.matrixWorld.copy(s.matrix),s.userData.isCollisionProxy=!0,yn.push(s),Qn.set(e,s)}function Bi(e){const t=Qn.get(e);if(!t)return;const n=yn.indexOf(t);n>=0&&yn.splice(n,1),t.geometry.dispose(),Qn.delete(e)}function xd(e){for(let t=0;t<Wo.length;t++){const n=Wo[t],s=Qn.get(n.group),o=e?.[t]??new Se().setFromObject(n.group);o.isEmpty()||(o.getSize(at),o.getCenter(es),s?(s.geometry.dispose(),s.geometry=new hi(at.x,at.y,at.z),s.geometry.computeBoundingSphere(),s.position.copy(es),s.updateMatrix(),s.matrixWorld.copy(s.matrix)):cl(n.group))}}const ul={class:"relative w-full max-w-3xl max-h-[85vh] overflow-y-auto rounded-2xl border border-white/10 bg-gray-950/95 shadow-2xl custom-scrollbar"},fl={class:"p-6 pb-4 border-b border-white/[0.06]"},dl={class:"flex items-center gap-3"},pl={class:"w-10 h-10 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center"},yl={class:"p-6 space-y-6"},ml={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},hl={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},bl={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},gl={class:"text-lg font-bold text-white mb-3 flex items-center gap-2"},wl={class:"space-y-3"},xl={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},vl={class:"flex items-center gap-2 mb-2"},Sl={class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},Al={class:"flex items-center gap-2 mb-2"},Tl={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},kl={class:"text-lg font-bold text-white mb-2 flex items-center gap-2"},_l=so({__name:"Room3dPrivacyInfo",props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const n=t;function s(){n("update:modelValue",!1)}return(o,i)=>(L(),He(sr,{to:"body"},[H(Nt,{"enter-active-class":"transition-all duration-300","leave-active-class":"transition-all duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:et(()=>[e.modelValue?(L(),O("div",{key:0,class:"fixed inset-0 z-[200] flex items-center justify-center p-4",onClick:xt(s,["self"])},[i[18]||(i[18]=g("div",{class:"absolute inset-0 bg-black/80 backdrop-blur-sm"},null,-1)),g("div",ul,[g("button",{onClick:s,class:"absolute top-4 right-4 z-10 p-1.5 rounded-lg text-white/40 hover:text-white/80 hover:bg-white/10 transition-all"},[H(D(dr),{class:"w-5 h-5"})]),g("div",fl,[g("div",dl,[g("div",pl,[H(D(pr),{class:"w-5 h-5 text-emerald-400"})]),i[0]||(i[0]=g("div",null,[g("h2",{class:"text-xl font-bold text-white"},"Anonymous & Private Rooms"),g("p",{class:"text-base text-white/40"},"How your privacy is protected")],-1))])]),g("div",yl,[g("section",null,[g("h3",ml,[H(D(Hr),{class:"w-5 h-5 text-emerald-400"}),i[1]||(i[1]=ae(" Zero Knowledge Architecture ",-1))]),i[2]||(i[2]=g("p",{class:"text-base text-white/60 leading-relaxed"},[ae(" Your rooms use "),g("strong",{class:"text-white/80"},"onion-routed encryption"),ae("  the same principle behind Tor. When you share a room, neither the relay servers nor anyone monitoring the network can see who is connecting to whom, or what data is being exchanged. ")],-1))]),g("section",null,[g("h3",hl,[H(D(li),{class:"w-5 h-5 text-sky-400"}),i[3]||(i[3]=ae(" How It Works ",-1))]),i[4]||(i[4]=g("div",{class:"bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base"},[g("div",{class:"space-y-2 text-white/50"},[g("div",{class:"flex items-center gap-2"},[g("span",{class:"text-emerald-400 font-bold w-16 shrink-0 text-right"},"You"),g("span",{class:"text-white/20"},""),g("span",{class:"bg-emerald-500/15 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20"},"encrypt"),g("span",{class:"text-white/20"},""),g("span",{class:"text-sky-400"},"Relay A")]),g("div",{class:"flex items-center gap-2 pl-20"},[g("span",{class:"text-white/20"},""),g("span",{class:"bg-sky-500/15 text-sky-400 px-2 py-0.5 rounded border border-sky-500/20"},"re-encrypt"),g("span",{class:"text-white/20"},""),g("span",{class:"text-purple-400"},"Relay B")]),g("div",{class:"flex items-center gap-2 pl-40"},[g("span",{class:"text-white/20"},""),g("span",{class:"bg-purple-500/15 text-purple-400 px-2 py-0.5 rounded border border-purple-500/20"},"decrypt"),g("span",{class:"text-white/20"},""),g("span",{class:"text-amber-400 font-bold"},"Guest")]),g("div",{class:"pt-2 border-t border-white/[0.06] text-white/30 text-base"}," Each relay only sees the previous and next hop  never both endpoints. ")])],-1))]),g("section",null,[g("h3",bl,[H(D(pn),{class:"w-5 h-5 text-amber-400"}),i[5]||(i[5]=ae(" Encryption ",-1))]),i[6]||(i[6]=g("div",{class:"grid grid-cols-1 sm:grid-cols-2 gap-3"},[g("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[g("div",{class:"text-base font-bold text-amber-400 mb-1"},"Key Exchange"),g("div",{class:"text-base text-white/50"},"X25519 (Curve25519)  unique session keys per connection, forward secrecy")]),g("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[g("div",{class:"text-base font-bold text-amber-400 mb-1"},"Data Encryption"),g("div",{class:"text-base text-white/50"},"XChaCha20-Poly1305 AEAD  256-bit authenticated encryption")]),g("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[g("div",{class:"text-base font-bold text-amber-400 mb-1"},"Packet Padding"),g("div",{class:"text-base text-white/50"},"All packets are fixed 512 bytes  traffic analysis impossible")]),g("div",{class:"bg-black/30 rounded-lg border border-white/[0.06] p-3"},[g("div",{class:"text-base font-bold text-amber-400 mb-1"},"Chaff Traffic"),g("div",{class:"text-base text-white/50"},"Constant noise between relays  hides when real data flows")])],-1))]),g("section",null,[g("h3",gl,[H(D(gr),{class:"w-5 h-5 text-purple-400"}),i[7]||(i[7]=ae(" Room Modes ",-1))]),g("div",wl,[g("div",xl,[g("div",vl,[H(D(Si),{class:"w-4 h-4 text-emerald-400"}),i[8]||(i[8]=g("span",{class:"text-base font-bold text-emerald-400"},"Invite Only",-1))]),i[9]||(i[9]=g("p",{class:"text-base text-white/50 leading-relaxed"}," Your room is invisible to everyone. Only people with your encrypted invite link can join. The link contains an encrypted token that reveals nothing about your server or IP address. Share it via any messaging app  even if intercepted, it cannot be used to locate your server. ",-1))]),g("div",Sl,[g("div",Al,[H(D(oo),{class:"w-4 h-4 text-sky-400"}),i[10]||(i[10]=g("span",{class:"text-base font-bold text-sky-400"},"Public",-1))]),i[11]||(i[11]=g("p",{class:"text-base text-white/50 leading-relaxed"},[ae(" Your room appears in the Public Rooms browser so others can discover it. The listing is published through the onion network  the tracker that stores room listings is "),g("strong",{class:"text-white/70"},"blind"),ae(": it only sees encrypted blobs and relay entry points, never your IP or room contents. Visitors connect through the same onion circuit, preserving both your anonymity and theirs. ")],-1))])])]),g("section",null,[g("h3",Tl,[H(D(wr),{class:"w-5 h-5 text-rose-400"}),i[12]||(i[12]=ae(" The Blind Tracker ",-1))]),i[13]||(i[13]=g("p",{class:"text-base text-white/60 leading-relaxed mb-3"}," The room directory (tracker) is designed to be completely blind: ",-1)),i[14]||(i[14]=g("ul",{class:"space-y-2 text-base text-white/50"},[g("li",{class:"flex items-start gap-2"},[g("span",{class:"text-emerald-400 mt-0.5 shrink-0"},""),g("span",null,[ae("Stores only "),g("strong",{class:"text-white/70"},"encrypted blobs"),ae("  cannot read room names, descriptions, or any metadata")])]),g("li",{class:"flex items-start gap-2"},[g("span",{class:"text-emerald-400 mt-0.5 shrink-0"},""),g("span",null,[g("strong",{class:"text-white/70"},"No IP addresses"),ae(" are stored  rooms are identified by relay entry points only")])]),g("li",{class:"flex items-start gap-2"},[g("span",{class:"text-emerald-400 mt-0.5 shrink-0"},""),g("span",null,[g("strong",{class:"text-white/70"},"Ephemeral storage"),ae("  room listings expire automatically (TTL) and are never persisted to disk")])]),g("li",{class:"flex items-start gap-2"},[g("span",{class:"text-emerald-400 mt-0.5 shrink-0"},""),g("span",null,[g("strong",{class:"text-white/70"},"No logs"),ae("  relay servers keep zero logs of connections, traffic, or metadata")])]),g("li",{class:"flex items-start gap-2"},[g("span",{class:"text-emerald-400 mt-0.5 shrink-0"},""),g("span",null,[ae("Even if a relay is compromised, it only sees encrypted traffic  "),g("strong",{class:"text-white/70"},"no readable content")])])],-1))]),g("section",null,[g("h3",kl,[H(D(jr),{class:"w-5 h-5 text-teal-400"}),i[15]||(i[15]=ae(" Invite Links ",-1))]),i[16]||(i[16]=g("p",{class:"text-base text-white/60 leading-relaxed"},[ae(" Invite links contain an encrypted token that can only be decrypted by the app itself. The link URL points to a relay domain  "),g("strong",{class:"text-white/70"},"not your server"),ae(". If someone inspects the link, they see only the relay's address and an opaque encrypted string. No IP addresses, room names, or identifying information is embedded in the link. ")],-1))]),i[17]||(i[17]=g("section",{class:"bg-black/30 rounded-xl border border-white/[0.06] p-4"},[g("h3",{class:"text-base font-bold text-white/60 uppercase tracking-wider mb-3"},"Technical Summary"),g("div",{class:"grid grid-cols-2 gap-x-6 gap-y-2 text-base"},[g("div",{class:"text-white/40"},"Protocol"),g("div",{class:"text-white/70"},"Onion routing (multi-hop)"),g("div",{class:"text-white/40"},"Key Exchange"),g("div",{class:"text-white/70"},"X25519 (Curve25519)"),g("div",{class:"text-white/40"},"Symmetric Cipher"),g("div",{class:"text-white/70"},"XChaCha20-Poly1305"),g("div",{class:"text-white/40"},"Hash Function"),g("div",{class:"text-white/70"},"BLAKE2b"),g("div",{class:"text-white/40"},"Packet Size"),g("div",{class:"text-white/70"},"Fixed 512 bytes"),g("div",{class:"text-white/40"},"Key Rotation"),g("div",{class:"text-white/70"},"Every 60 minutes"),g("div",{class:"text-white/40"},"Logging"),g("div",{class:"text-white/70"},"Zero  no logs anywhere"),g("div",{class:"text-white/40"},"Tracker Storage"),g("div",{class:"text-white/70"},"In-memory only (Redis ephemeral)"),g("div",{class:"text-white/40"},"Library"),g("div",{class:"text-white/70"},"libsodium (NaCl/TweetNaCl)")])],-1))])])])):X("",!0)]),_:1})]))}}),Pl=Object.assign(io(_l,[["__scopeId","data-v-2c69e695"]]),{__name:"Room3dPrivacyInfo"}),j=24,Yt=16,ve=32,Cl=512,te={HANDSHAKE_INIT:1,HANDSHAKE_REPLY:2,RELAY:16,DATA:32,ESTABLISH_RENDEZVOUS:48,RENDEZVOUS_ESTABLISHED:49,INTRODUCE:50,RENDEZVOUS_JOIN:51,TRACKER_REGISTER:64,TRACKER_QUERY:65,TRACKER_RESPONSE:66,TRACKER_HEARTBEAT:67,TRACKER_INTRODUCE:68,TRACKER_INTRODUCE_DATA:69,CIRCUIT_DESTROY:240};let G=null,Bs=null;async function ts(){return G||(Bs||(Bs=ir(()=>import("./D93w9sP1.js"),[],import.meta.url).then(async e=>{const t=e.default||e;return await t.ready,G=t,t})),Bs)}function El(e,t,n){const s=G,o=s.randombytes_buf(j),i=new Uint8Array(4);new DataView(i.buffer).setUint32(0,n);const r=s.crypto_aead_xchacha20poly1305_ietf_encrypt(e,i,null,o,t),a=new Uint8Array(o.length+r.length);return a.set(o),a.set(r,o.length),a}function Rl(e,t,n){const s=G;if(e.length<j+Yt)return null;const o=e.subarray(0,j),i=e.subarray(j),r=new Uint8Array(4);new DataView(r.buffer).setUint32(0,n);try{return s.crypto_aead_xchacha20poly1305_ietf_decrypt(null,i,r,o,t)}catch{return null}}function Yo(e,t,n){const s=t?new TextEncoder().encode(t):new Uint8Array(0),o=new Uint8Array(2+s.length+2+n.length);return o[0]=e,o[1]=s.length,o.set(s,2),new DataView(o.buffer).setUint16(2+s.length,n.length),o.set(n,4+s.length),o}function Il(e){if(e.length<4)return null;const t=e[0],n=e[1],s=n>0?new TextDecoder().decode(e.subarray(2,2+n)):null,o=new DataView(e.buffer,e.byteOffset).getUint16(2+n),i=e.subarray(4+n,4+n+o);return{type:t,nextHop:s,payload:i}}function Bl(e,t){if(e.length>=t)return e.subarray(0,t);const n=new Uint8Array(t);n.set(e);const s=G.randombytes_buf(t-e.length);return n.set(s,e.length),n}function Wn(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Mi(e){const t=new Uint8Array(e.length/2);for(let n=0;n<t.length;n++)t[n]=parseInt(e.slice(n*2,n*2+2),16);return t}const qo="sf_room3d_room_secret";function Ml(){const e=G;if(typeof window>"u")return e.randombytes_buf(32);const t=localStorage.getItem(qo);if(t&&t.length===64)return Mi(t);const n=e.randombytes_buf(32);return localStorage.setItem(qo,Wn(n)),n}function Zo(e){const t=G,n=Ml(),s=new TextEncoder().encode(e),o=new Uint8Array(s.length+n.length);return o.set(s),o.set(n,s.length),t.crypto_generichash(32,o)}class Dl{hops=[];ws=null;circuitId=0;messageQueue=[];dataCallback=null;_destroyed=!1;async build(t){const s=(await ts()).randombytes_buf(4);this.circuitId=new DataView(s.buffer).getUint32(0);const o=t[0];this.ws=new WebSocket(o.url),this.ws.binaryType="arraybuffer",await new Promise((r,a)=>{this.ws.onopen=()=>r(),this.ws.onerror=()=>a(new Error(`Failed to connect to relay ${o.url}`))}),this.ws.onclose=()=>{this._destroyed};const i=await this._handshakeWithRelay();this.hops.push({url:o.url,sessionRx:i.rx,sessionTx:i.tx,publicKey:i.serverPk}),this.ws.onmessage=r=>{const a=new Uint8Array(r.data);this._handleIncoming(a)};for(let r=1;r<t.length;r++){const a=t[r],l=await this._extendCircuit(a);this.hops.push({url:a.url,sessionRx:l.rx,sessionTx:l.tx,publicKey:l.serverPk})}}send(t,n,s=null){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let o=Yo(n,s,t);for(let i=this.hops.length-1;i>=0;i--){const r=this.hops[i];i===this.hops.length-1||(o=Yo(te.RELAY,this.hops[i+1].url,o));const l=El(o,r.sessionTx,this.circuitId),d=l.subarray(0,j),c=l.subarray(j);o=new Uint8Array(j+4+c.length),o.set(d,0),new DataView(o.buffer).setUint32(j,this.circuitId),o.set(c,j+4)}this.ws.send(o)}onData(t){this.dataCallback=t}destroy(){this._destroyed=!0,this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null);for(const t of this.hops)t.sessionRx.fill(0),t.sessionTx.fill(0);this.hops=[],this.messageQueue=[]}_handleIncoming(t){let n=t;for(const o of this.hops){const i=Rl(n,o.sessionRx,this.circuitId);if(!i)return;n=i}const s=Il(n);if(s){if(this.messageQueue.length>0){this.messageQueue.shift().resolve({type:s.type,payload:s.payload});return}this.dataCallback&&this.dataCallback(s.type,s.payload)}}_waitForMessage(t=1e4){return new Promise((n,s)=>{const o=setTimeout(()=>{const i=this.messageQueue.findIndex(r=>r.resolve===n);i>=0&&this.messageQueue.splice(i,1),s(new Error("Timeout waiting for relay response"))},t);this.messageQueue.push({resolve:i=>{clearTimeout(o),n(i)}})})}async _handshakeWithRelay(){const t=G,n=t.crypto_kx_keypair(),s=new Uint8Array(j+4+ve),o=t.randombytes_buf(j);s.set(o,0),new DataView(s.buffer).setUint32(j,this.circuitId),s.set(n.publicKey,j+4),this.ws.send(Bl(s,Cl));const i=await new Promise((k,A)=>{const _=setTimeout(()=>{this.ws.onmessage=null,A(new Error("Handshake timeout"))},1e4);this.ws.onmessage=b=>{clearTimeout(_),k(new Uint8Array(b.data))}}),r=new Uint8Array([83,70,80,75]),a=i.length>=4&&i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3];let l,d,c;if(a)l=i.subarray(4,4+ve),d=i.subarray(4+ve,4+ve+j),c=i.subarray(4+ve+j+4);else{const k=this.hops.length===0?this.ws?.url:"";if(!k)throw new Error("Cannot determine relay URL for PK fetch");const A=k.replace(/^wss:/,"https:").replace(/^ws:/,"http:")+"/pk",_=await fetch(A);if(!_.ok)throw new Error(`Failed to fetch relay PK from ${A}`);const b=await _.json();l=t.from_hex(b.publicKey),d=i.subarray(0,j),c=i.subarray(j+4)}const f=t.crypto_kx_client_session_keys(n.publicKey,n.privateKey,l),u=1+ve+Yt,p=c.subarray(0,u),S=new Uint8Array(4);new DataView(S.buffer).setUint32(0,this.circuitId);try{t.crypto_aead_xchacha20poly1305_ietf_decrypt(null,p,S,d,f.sharedRx)}catch{throw new Error("Handshake verification failed  relay rejected or key mismatch")}return{rx:f.sharedRx,tx:f.sharedTx,serverPk:new Uint8Array(l)}}async _extendCircuit(t){const n=G,s=n.crypto_kx_keypair(),o=new Uint8Array(j+4+ve),i=n.randombytes_buf(j);o.set(i,0),new DataView(o.buffer).setUint32(j,this.circuitId),o.set(s.publicKey,j+4),this.send(o,te.RELAY,t.url);const a=(await this._waitForMessage()).payload,l=new Uint8Array([83,70,80,75]),c=a.length>=4&&a[0]===l[0]&&a[1]===l[1]&&a[2]===l[2]&&a[3]===l[3]?4:0;if(a.length<c+ve+j+4+Yt+1)throw new Error("Extend handshake reply too short");const f=a.subarray(c,c+ve),u=n.crypto_kx_client_session_keys(s.publicKey,s.privateKey,f);return{rx:u.sharedRx,tx:u.sharedTx,serverPk:new Uint8Array(f)}}}class Xo{rx=new Uint8Array(0);tx=new Uint8Array(0);nonceCounter=0;async initAsClient(t){const s=(await ts()).crypto_kx_keypair();return this._keypair=s,s.publicKey}async completeAsClient(t){const n=G,s=this._keypair,o=n.crypto_kx_client_session_keys(s.publicKey,s.privateKey,t);this.rx=o.sharedRx,this.tx=o.sharedTx}async initAsServer(t){const n=await ts(),s=n.crypto_kx_keypair(),o=n.crypto_kx_server_session_keys(s.publicKey,s.privateKey,t);return this.rx=o.sharedRx,this.tx=o.sharedTx,s.publicKey}encrypt(t){const n=G,s=n.randombytes_buf(j),o=n.crypto_aead_xchacha20poly1305_ietf_encrypt(t,null,null,s,this.tx),i=new Uint8Array(s.length+o.length);return i.set(s),i.set(o,s.length),i}decrypt(t){const n=G;if(t.length<j+Yt)return null;const s=t.subarray(0,j),o=t.subarray(j);try{return n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,o,null,s,this.rx)}catch{return null}}destroy(){this.rx.fill(0),this.tx.fill(0)}}let rn=!1,Me=[],Nl="",ze=null;const De=[];let Ms=null,Ds=null,wt=null;function Ll(){const e=z(!1),t=z(!1),n=z([]),s=z(!1),o=z(null);async function i(){if(rn){e.value=!0;return}try{await ts();const y=or(),h=y.public.onionRelayA||"wss://schedule4real.com/rooms",m=y.public.onionRelayB||"wss://r2.imaset.com";Nl=y.public.onionTracker||h,Me=[{url:h,publicKey:new Uint8Array(ve)},{url:m,publicKey:new Uint8Array(ve)}];const x=G,w=new TextEncoder().encode("spiderfarmer-room-metadata-v1");ze=x.crypto_generichash(32,w),rn=!0,e.value=!0}catch(y){o.value=y.message}}async function r(y){const h=new Dl,m=y||[...Me];return await h.build(m),De.push(h),h}function a(y){if(!ze)throw new Error("Not initialized");const h=G,m=JSON.stringify(y),x=new TextEncoder().encode(m),w=h.randombytes_buf(j),v=h.crypto_aead_xchacha20poly1305_ietf_encrypt(x,null,null,w,ze),C=new Uint8Array(w.length+v.length);return C.set(w),C.set(v,w.length),C}function l(y){if(!ze||y.length<j+Yt)return null;const h=G,m=y.subarray(0,j),x=y.subarray(j);try{const w=h.crypto_aead_xchacha20poly1305_ietf_decrypt(null,x,null,m,ze),v=new TextDecoder().decode(w);return JSON.parse(v)}catch{return null}}async function d(y){rn||await i(),t.value=!0,o.value=null;try{const h=G,m=Zo(y.envId),x=a({envId:y.envId,name:y.name,description:y.description,capacity:y.capacity||8,tags:y.tags||[]}),w=await r([...Me].reverse()),v=Me[Me.length-1].url,C=new TextEncoder().encode(v),T=y.private?1:0,E=new Uint8Array(36+C.length+x.length);E[0]=te.TRACKER_REGISTER,E[1]=T,E.set(m,2),new DataView(E.buffer).setUint16(34,C.length),E.set(C,36),E.set(x,36+C.length),w.send(E,te.TRACKER_REGISTER);const P=Wn(m);wt=ln(()=>{if(w.ws?.readyState===WebSocket.OPEN){const B=new Uint8Array(33);B[0]=te.TRACKER_HEARTBEAT,B.set(m,1),w.send(B,te.TRACKER_HEARTBEAT)}},6e4),Ms=w,w.onData((B,V)=>{B===te.TRACKER_INTRODUCE_DATA&&c(V,y.envId).catch(K=>{})});const I={roomId:P,keepAlive:()=>{if(w.ws?.readyState===WebSocket.OPEN){const B=new Uint8Array(33);B[0]=te.TRACKER_HEARTBEAT,B.set(m,1),w.send(B,te.TRACKER_HEARTBEAT)}},unpublish:()=>{wt&&clearInterval(wt),wt=null,w.destroy(),Ms=null,Ds=null,t.value=!1}};return Ds=I,t.value=!1,I}catch(h){return o.value=h.message,t.value=!1,null}}async function c(y,h){const m=G;if(y.length<23)return;const x=y.subarray(0,20),w=new DataView(y.buffer,y.byteOffset+20).getUint16(0),v=new TextDecoder().decode(y.subarray(22,22+w)),C=Me.find(W=>W.url===v);if(!C)return;const E=[...Me.filter(W=>W.url!==v),C],P=await r(E),I=m.crypto_kx_keypair(),B=new Uint8Array(20+ve);B.set(x),B.set(I.publicKey,20),P.send(B,te.RENDEZVOUS_JOIN);const V=await Promise.race([new Promise(W=>{P.onData((J,ye)=>{J===te.DATA&&ye.length>=ve&&W(ye.subarray(0,ve))})}),new Promise((W,J)=>setTimeout(()=>J(new Error("Visitor PK timeout")),15e3))]),K=m.crypto_kx_server_session_keys(I.publicKey,I.privateKey,V),Z=new Xo;Z.rx=K.sharedRx,Z.tx=K.sharedTx;const Ae=new TextEncoder().encode(JSON.stringify({envId:h})),ue=Z.encrypt(Ae);P.send(ue,te.DATA),setTimeout(()=>{Z.destroy(),P.destroy();const W=De.indexOf(P);W>=0&&De.splice(W,1)},3e3)}async function f(){const y=G,h=Me.map(w=>w.url.replace("wss://","https://").replace("ws://","http://")),m=new Map,x=await Promise.allSettled(h.map(async w=>{const v=await fetch(`${w}/rooms`,{signal:AbortSignal.timeout(8e3)});if(!v.ok)throw new Error(`HTTP ${v.status}`);return v.json()}));for(const w of x)if(w.status==="fulfilled"){for(const v of w.value.rooms)if(!m.has(v.id))try{const C=y.from_base64(v.metadata,y.base64_variants.ORIGINAL),T=l(C);T&&m.set(v.id,{roomId:v.id,envId:T.envId,name:T.name,description:T.description,capacity:T.capacity,tags:T.tags,entryRelay:v.relay})}catch{}}return[...m.values()]}async function u(){rn||await i(),s.value=!0,o.value=null;let y=[],h=null;try{const m=await r([...Me].reverse()),x=new Uint8Array(7);x[0]=te.TRACKER_QUERY,new DataView(x.buffer).setUint32(1,0),new DataView(x.buffer).setUint16(5,50);const w=new Promise(T=>{m.onData((E,P)=>{E===te.TRACKER_RESPONSE&&T(P)})});m.send(x,te.TRACKER_QUERY);const v=await Promise.race([w,new Promise((T,E)=>setTimeout(()=>E(new Error("Tracker query timeout")),8e3))]);if(v.length>=6){const T=new DataView(v.buffer,v.byteOffset).getUint16(4);let E=6;for(let P=0;P<T&&E<v.length&&!(E+36>v.length);P++){const I=v.subarray(E,E+32),B=new DataView(v.buffer,v.byteOffset+E+32).getUint16(0),V=new TextDecoder().decode(v.subarray(E+34,E+34+B)),K=new DataView(v.buffer,v.byteOffset+E+34+B).getUint16(0),Z=v.subarray(E+36+B,E+36+B+K),Ae=Wn(I),ue=l(Z);ue&&y.push({roomId:Ae,envId:ue.envId,name:ue.name,description:ue.description,capacity:ue.capacity,tags:ue.tags,entryRelay:V}),E+=36+B+K}}m.destroy();const C=De.indexOf(m);C>=0&&De.splice(C,1)}catch(m){h=m.message}if(y.length===0)try{y=await f(),y.length>0}catch{}return y.length===0&&h&&(o.value=h),n.value=y,s.value=!1,y}async function p(y){rn||await i(),o.value=null;try{const h=G,m=[...Me],x=await r(m),w=m[m.length-1].url,v=h.randombytes_buf(20);if(x.send(new Uint8Array(v),te.ESTABLISH_RENDEZVOUS),!await Promise.race([new Promise(W=>{x.onData((J,ye)=>{J===te.RENDEZVOUS_ESTABLISHED&&W(ye[0]===1)})}),new Promise((W,J)=>setTimeout(()=>J(new Error("Rendezvous establish timeout")),1e4))]))throw x.destroy(),new Error("Failed to establish rendezvous");const T=await r([...Me].reverse()),E=new TextEncoder().encode(w),P=Mi(y),I=new Uint8Array(55+E.length);I[0]=te.TRACKER_INTRODUCE,I.set(P,1),I.set(v,33),new DataView(I.buffer).setUint16(53,E.length),I.set(E,55),T.send(I,te.TRACKER_INTRODUCE);const B=new Xo,V=await B.initAsClient(x),K=await Promise.race([new Promise(W=>{x.onData((J,ye)=>{J===te.RENDEZVOUS_JOIN&&W(ye.subarray(1))})}),new Promise((W,J)=>setTimeout(()=>J(new Error("Host join timeout (30s)")),3e4))]);x.send(V,te.DATA),await B.completeAsClient(K),T.destroy();const Z=De.indexOf(T);Z>=0&&De.splice(Z,1);const Ae=await Promise.race([new Promise(W=>{x.onData((J,ye)=>{if(J===te.DATA){const Je=B.decrypt(ye);if(Je)try{const Jt=JSON.parse(new TextDecoder().decode(Je));Jt.envId&&W(Jt.envId)}catch{}}})}),new Promise((W,J)=>setTimeout(()=>J(new Error("Room info timeout")),1e4))]),ue={onData:null,onClose:null,send:W=>{const J=B.encrypt(W);x.send(J,te.DATA)},close:()=>{B.destroy(),x.destroy();const W=De.indexOf(x);W>=0&&De.splice(W,1),ue.onClose?.()}};return x.onData((W,J)=>{if(W===te.DATA){const ye=B.decrypt(J);ye&&ue.onData?.(ye)}}),{connection:ue,envId:Ae}}catch(h){return o.value=h.message,null}}function S(){wt&&clearInterval(wt),wt=null;for(const y of De)y.destroy();De.length=0,Ms=null,Ds=null,t.value=!1,s.value=!1}function k(y){if(!G)throw new Error("Not initialized");return Wn(Zo(y))}function A(y,h){if(!G||!ze)throw new Error("Not initialized");const m=G,x=new TextEncoder().encode(y),w=m.randombytes_buf(j),v=m.crypto_aead_xchacha20poly1305_ietf_encrypt(x,null,null,w,ze),C=new Uint8Array(w.length+v.length);return C.set(w),C.set(v,w.length),`${h}.${m.to_base64(C,m.base64_variants.URLSAFE_NO_PADDING)}`}function _(y){if(!G||!ze)return null;const h=G;let m="",x="";if(y.startsWith("sfr:"))x=y.slice(4);else{const w=y.indexOf(".");if(w<1)return null;m=y.substring(0,w),x=y.substring(w+1)}try{const w=h.from_base64(x,h.base64_variants.URLSAFE_NO_PADDING);if(w.length<j+Yt)return null;const v=w.subarray(0,j),C=w.subarray(j),T=h.crypto_aead_xchacha20poly1305_ietf_decrypt(null,C,null,v,ze);if(!T||T.length===0)return null;const E=new TextDecoder().decode(T);return{roomKey:m,envId:E}}catch{return null}}async function b(){try{return await $fetch("/api/room3d/tunnel-info")}catch{return null}}return{isReady:vt(e),isPublishing:vt(t),isDiscovering:vt(s),publicRooms:vt(n),connectionError:vt(o),init:i,publishRoom:d,discoverRooms:u,connectToRoom:p,destroyAll:S,deriveRoomId:k,generateInviteToken:A,parseInviteToken:_,fetchTunnelInfo:b}}const Di="sf_room3d_favorites",Ni="sf_room3d_custom_names",nt=z([]),Ft=z({});let Jo=!1;function Ul(){if(!(Jo||typeof window>"u")){Jo=!0;try{const e=localStorage.getItem(Di);e&&(nt.value=JSON.parse(e))}catch{}try{const e=localStorage.getItem(Ni);e&&(Ft.value=JSON.parse(e))}catch{}}}function Go(){typeof window>"u"||localStorage.setItem(Di,JSON.stringify(nt.value))}function Ol(){typeof window>"u"||localStorage.setItem(Ni,JSON.stringify(Ft.value))}function Vl(){Ul();function e(r){nt.value.some(a=>a.roomId===r.roomId)||(nt.value.push({roomId:r.roomId,name:r.name,addedAt:Date.now()}),Go())}function t(r){nt.value=nt.value.filter(a=>a.roomId!==r),Go()}function n(r){return nt.value.some(a=>a.roomId===r)}function s(r){n(r.roomId)?t(r.roomId):e(r)}function o(r,a){a.trim()?Ft.value[r]=a.trim():delete Ft.value[r],Ol()}function i(r){return Ft.value[r.roomId]||r.name}return{favorites:vt(nt),customNames:vt(Ft),addFavorite:e,removeFavorite:t,isFavorite:n,toggleFavorite:s,setCustomName:o,getDisplayName:i}}const zl={class:"w-full max-w-4xl mx-auto"},$l={class:"flex items-center gap-2 mb-3"},Fl={class:"relative flex-1"},Hl=["disabled"],jl={class:"max-h-[30vh] sm:max-h-[35vh] overflow-y-auto pr-0.5 pub-scroll"},Kl={key:0,class:"flex flex-col items-center py-8"},Wl={key:1,class:"text-center py-6"},Yl={class:"text-red-400/70 text-base mb-2"},ql={key:2,class:"text-center py-8"},Zl={class:"text-white/40 text-base"},Xl={key:3,class:"space-y-2"},Jl=["onClick"],Gl={class:"flex-1 min-w-0"},Ql={class:"flex items-center gap-2"},ec={class:"text-base font-bold text-white/80 group-hover:text-emerald-300 transition-colors truncate"},tc={key:0,class:"text-base text-white/35 truncate mt-0.5"},nc={class:"flex items-center gap-1 text-white/30 text-base flex-shrink-0"},sc=["onClick"],oc={key:0,class:"bg-black/50 border border-white/[0.12] border-t-0 border-amber-500/30 rounded-b-xl px-4 py-3 flex items-center gap-2"},ic=["onKeydown"],rc=["onClick"],ac=so({__name:"Room3dPublicBrowser",props:{authenticated:{type:Boolean}},emits:["join-public-room"],setup(e,{emit:t}){const n=t,s=Ll(),o=Vl(),i=z(""),r=z([]),a=z(!1),l=z(null),d=z(null),c=z(""),f=z(null),{getDisplayName:u,isFavorite:p,toggleFavorite:S}=o;function k(m){return p(m)}function A(m){S(m)}const _=ot(()=>{if(!i.value.trim())return r.value;const m=i.value.toLowerCase();return r.value.filter(x=>x.name.toLowerCase().includes(m)||x.description?.toLowerCase().includes(m)||x.tags?.some(w=>w.toLowerCase().includes(m)))});function b(m){if(m.passwordProtected){try{const x=JSON.parse(localStorage.getItem("sf_room3d_room_passwords")||"{}");if(x[m.envId]){n("join-public-room",{...m,password:x[m.envId]});return}}catch{}if(d.value===m.roomId)return;d.value=m.roomId,c.value="",rr(()=>{const x=f.value?.[0];x&&x.focus()});return}n("join-public-room",m)}function y(m){c.value&&(d.value=null,n("join-public-room",{...m,password:c.value}))}async function h(){a.value=!0,l.value=null,d.value=null;try{await s.init();const m=await s.discoverRooms();r.value=m,m.length===0&&s.connectionError.value&&(l.value=s.connectionError.value)}catch(m){l.value=m?.message||"Connection failed"}finally{a.value=!1}}return Us(()=>{h()}),(m,x)=>(L(),O("div",zl,[g("div",$l,[g("div",Fl,[H(D(_r),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),Ot(g("input",{"onUpdate:modelValue":x[0]||(x[0]=w=>St(i)?i.value=w:null),type:"text",placeholder:"Search rooms...",class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors"},null,512),[[an,D(i)]])]),g("button",{onClick:h,disabled:D(a),class:"p-2 rounded-xl bg-black/60 border border-white/20 hover:bg-emerald-500/10 hover:border-emerald-500/30 transition-all disabled:opacity-30",title:"Refresh"},[H(D(li),{class:Te(["w-5 h-5 text-white/50",{"animate-spin":D(a)}])},null,8,["class"])],8,Hl)]),g("div",jl,[D(a)&&!D(r).length?(L(),O("div",Kl,[...x[3]||(x[3]=[g("div",{class:"w-8 h-8 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin mb-3"},null,-1),g("p",{class:"text-white/40 text-base"},"Discovering rooms...",-1)])])):D(l)?(L(),O("div",Wl,[g("p",Yl,ke(D(l)),1),g("button",{onClick:h,class:"text-base text-emerald-400/60 hover:text-emerald-400 transition-colors"},"Try again")])):!D(_).length&&!D(a)?(L(),O("div",ql,[H(D(oo),{class:"w-10 h-10 text-white/[0.08] mx-auto mb-2"}),g("p",Zl,ke(D(i)?"No rooms match your search":"No public rooms yet"),1)])):(L(),O("div",Xl,[(L(!0),O(Vt,null,zt(D(_),w=>(L(),O("div",{key:w.roomId,class:"space-y-0"},[g("button",{onClick:v=>b(w),class:Te(["group w-full text-left flex items-center gap-3 bg-black/50 border border-white/[0.12] px-4 py-3 transition-all",[D(d)===w.roomId?"rounded-t-xl border-b-0 border-amber-500/30 bg-amber-500/[0.04]":"rounded-xl hover:border-emerald-500/30 hover:bg-emerald-500/[0.06]"]])},[g("div",Gl,[g("div",Ql,[g("h4",ec,ke(D(u)(w)),1),w.passwordProtected?(L(),He(D(pn),{key:0,class:"w-4 h-4 text-amber-400/60 flex-shrink-0"})):X("",!0),(L(!0),O(Vt,null,zt(w.tags?.slice(0,2),v=>(L(),O("span",{key:v,class:"hidden sm:inline px-1.5 py-0.5 rounded bg-white/[0.06] text-white/35 text-base leading-tight flex-shrink-0"},ke(v),1))),128))]),w.description?(L(),O("p",tc,ke(w.description),1)):X("",!0)]),g("div",nc,[H(D(yr),{class:"w-4 h-4"}),g("span",null,ke(w.capacity),1)]),g("div",{onClick:xt(v=>A(w),["stop"]),class:"p-1 cursor-pointer flex-shrink-0"},[k(w.roomId)?(L(),He(D(Pr),{key:0,class:"w-4 h-4 text-amber-400"})):(L(),He(D($r),{key:1,class:"w-4 h-4 text-white/15 group-hover:text-white/30 transition-colors"}))],8,sc)],10,Jl),D(d)===w.roomId?(L(),O("div",oc,[H(D(pn),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),Ot(g("input",{ref_for:!0,ref_key:"passwordInputRef",ref:f,"onUpdate:modelValue":x[1]||(x[1]=v=>St(c)?c.value=v:null),type:"password",placeholder:"Enter room password",maxlength:"32",onKeydown:[Os(v=>y(w),["enter"]),x[2]||(x[2]=Os(v=>d.value=null,["escape"]))],class:"flex-1 bg-black/60 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,ic),[[an,D(c)]]),g("button",{onClick:v=>y(w),class:"px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-300 text-base font-medium hover:bg-amber-500/30 transition-colors"}," Join ",8,rc)])):X("",!0)]))),128))]))])]))}}),lc=Object.assign(io(ac,[["__scopeId","data-v-d44a5b4d"]]),{__name:"Room3dPublicBrowser"}),Oe=z();let fe=null,Pe=null,se=null,Xs=0,Js=0;const Ns=new U,Gs=z(!1);let mn=0;const Ve=z([]),hn=z(""),Qs="sf_room3d_user_name",fo=z("");function cc(){const e=fo.value.trim();e?localStorage.setItem(Qs,e):localStorage.removeItem(Qs)}function uc(){fo.value=localStorage.getItem(Qs)||""}const fc=z(),Li=z(0);function dc(e){const t=e.target;if(!t)return;const n=t.scrollWidth/Zs.length;Li.value=Math.round(t.scrollLeft/n)}const pc=z({}),yc=z(""),mc=ot(()=>window.location.origin);let ct=null,_e=[],At=0,it=0;const ge=z(0),eo=2.8;let ns=null;const un=new Set;async function hc(){if(!Oe.value||se)return;const e="ontouchstart"in window||navigator.maxTouchPoints>0;fe=new Cr,Pe=new Er(34,Oe.value.clientWidth/Oe.value.clientHeight,.1,50),Pe.position.set(0,1.25,4.8),Pe.lookAt(0,.6,0),se=new Rr({antialias:!e,alpha:!0}),se.setPixelRatio(Math.min(window.devicePixelRatio,e?1.5:2)),se.setSize(Oe.value.clientWidth,Oe.value.clientHeight),se.setClearColor(0,0),se.toneMapping=e?Ir:Br,se.toneMappingExposure=1.6,e||(se.shadowMap.enabled=!0,se.shadowMap.type=Mr),Oe.value.appendChild(se.domElement),fe.fog=new Dr(394767,.06);const t=new xs(16772829,3.5);t.position.set(2,5,5),e||(t.castShadow=!0,t.shadow.mapSize.set(1024,1024),t.shadow.camera.near=.5,t.shadow.camera.far=15,t.shadow.bias=-.002),fe.add(t);const n=new xs(6724044,.8);n.position.set(-4,2,3),fe.add(n);const s=new xs(1096065,2);if(s.position.set(0,3,-5),fe.add(s),!e){const o=new Nr(16777215,4,12,Math.PI/8,.6,1);o.position.set(0,5,3),o.target.position.set(0,0,eo),fe.add(o),fe.add(o.target)}fe.add(new Lr(3359829,e?1.2:.6)),ct=new xi,fe.add(ct),window.addEventListener("resize",Ui);try{await se.compileAsync(fe,Pe)}catch{}Js=performance.now(),zi()}function Ui(){if(!Oe.value||!se||!Pe)return;const e=Oe.value.clientWidth,t=Oe.value.clientHeight;Pe.aspect=e/t,Pe.updateProjectionMatrix(),se.setSize(e,t)}async function bc(){if(!fe||!ct||Ve.value.length===0)return;Gs.value=!0;const e=++mn,t=Ve.value,n=t.length,s=Math.PI*2/n;if(!ns)try{const r=new vi,a=await new Promise((l,d)=>r.load("/models/characters/animations/Idle.glb",l,void 0,d));a.animations?.length&&(ns=a.animations.find(l=>!l.name.includes("T-Pose"))||a.animations[a.animations.length-1])}catch{}if(e!==mn)return;_e=[],un.clear();for(let r=0;r<n;r++){const a=r*s,l=new xi;l.position.set(Math.sin(a)*eo,0,Math.cos(a)*eo),ct.add(l),_e.push({wrapper:l,model:null,mixer:null,file:t[r],loaded:!1})}const o=t.indexOf(hn.value);o>=0&&(ge.value=o,At=it=-o*s);const i=[ge.value];n>1&&i.push(((ge.value+1)%n+n)%n),n>2&&i.push(((ge.value-1)%n+n)%n),await Promise.all(i.map(r=>Oi(r,e))),Vi(),Gs.value=!1}async function Oi(e,t){const n=t??mn;if(e<0||e>=_e.length)return;const s=_e[e];if(!(!s||s.loaded||un.has(e))){un.add(e);try{const o=new vi,i=await new Promise((u,p)=>{o.load(`/models/characters/${encodeURIComponent(s.file)}`,u,void 0,p)});if(n!==mn){i.scene.traverse(u=>{u.geometry&&u.geometry.dispose()});return}const r=i.scene,a=new Se().setFromObject(r),l=a.max.y-a.min.y;l>0&&r.scale.setScalar(1.4/l);const d=new Se().setFromObject(r);r.position.y=-d.min.y,r.position.x=-(d.min.x+d.max.x)/2,r.position.z=-(d.min.z+d.max.z)/2,s.wrapper.add(r),s.model=r;const c=i.animations||[];let f=c.find(u=>/idle/i.test(u.name)&&!u.name.includes("T-Pose"));if(!f&&c.length>0&&(f=c.find(u=>!u.name.includes("T-Pose"))||c[0]),!f&&ns&&(f=ns),f&&(s.mixer=new Ur(r),s.mixer.clipAction(f).play()),s.loaded=!0,se&&fe&&Pe)try{await se.compileAsync(fe,Pe)}catch{}}catch{}finally{un.delete(e)}}}function gc(e,t){e.model&&e.model.traverse(n=>{if(n.isMesh&&n.material){const s=Array.isArray(n.material)?n.material:[n.material];for(const o of s)o.transparent=!0,o.opacity=t}})}function Vi(){if(!_e.length)return;const e=_e.length;for(let t=0;t<e;t++){const n=((t-ge.value)%e+e)%e,s=n>e/2?e-n:n,o=s===0?1.05:1;_e[t].wrapper.scale.setScalar(o),_e[t].wrapper.visible=s<=2,gc(_e[t],s<=1?1:.25)}}function zi(){if(!se||!fe||!Pe)return;Xs=requestAnimationFrame(zi);const e=performance.now(),t=Math.min((e-Js)/1e3,.1);Js=e;for(const n of _e)n.mixer&&n.mixer.update(t);if(ct){const n=it-At;Math.abs(n)>.001?At+=n*Math.min(1,t*4):At=it,ct.rotation.y=At;const s=Pe.position;for(const o of _e){o.wrapper.getWorldPosition(Ns);const i=s.x-Ns.x,r=s.z-Ns.z,a=Math.atan2(i,r);o.wrapper.rotation.y=a-ct.rotation.y}}se.render(fe,Pe)}function po(e){const t=Ve.value.length;if(t<2)return;const n=ge.value,s=Math.PI*2/t;for(ge.value=(e%t+t)%t,it=-ge.value*s;it-At>Math.PI;)it-=Math.PI*2;for(;it-At<-Math.PI;)it+=Math.PI*2;hn.value=Ve.value[ge.value],Vi();const o=ge.value>n||n===t-1&&ge.value===0?1:-1,i=((ge.value+o)%t+t)%t;Oi(i)}function $i(){po(ge.value-1)}function Fi(){po(ge.value+1)}let Qo=0;function wc(e){if(e.preventDefault(),Ve.value.length<2)return;const t=Date.now();t-Qo<200||(Qo=t,e.deltaY>0?Fi():e.deltaY<0&&$i())}function xc(){window.removeEventListener("resize",Ui),cancelAnimationFrame(Xs),Xs=0,mn++,un.clear();for(const e of _e)e.mixer&&e.mixer.stopAllAction(),sl(e.wrapper);_e=[],fe&&(fe.traverse(e=>{if(e.geometry&&e.geometry.dispose(),e.material){const t=Array.isArray(e.material)?e.material:[e.material];for(const n of t)n.dispose()}}),fe=null),ct=null,se&&(se.domElement.remove(),se.dispose(),se=null),Pe=null}async function vc(){try{const e=await $fetch("/api/room3d/characters");if(e?.length){const t=[...e];for(let n=t.length-1;n>0;n--){const s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}Ve.value=t}!Ve.value.includes(hn.value)&&Ve.value.length>0&&(hn.value=Ve.value[0])}catch{}}function Sc(){return{lobbyCanvas:Oe,lobbyCharLoading:Gs,availableCharacters:Ve,selectedCharacter:hn,displayName:fo,saveDisplayName:cc,loadDisplayName:uc,roomScrollContainer:fc,activeRoomIdx:Li,onRoomScroll:dc,editingCode:pc,copiedCode:yc,currentDomain:mc,carouselSelectedIdx:ge,initLobbyScene:hc,disposeLobbyScene:xc,initCarouselPositions:bc,lobbyRotateToIndex:po,lobbyPrevChar:$i,lobbyNextChar:Fi,onLobbyWheel:wc,loadAvailableCharacters:vc,charDisplayName:nl}}const Ac={key:1,class:"absolute top-4 right-4 z-30"},Tc={class:"px-3 py-1.5 rounded-full bg-black/70 backdrop-blur-sm border border-white/15 text-base text-gray-300 flex items-center gap-2"},kc={key:0,class:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none"},_c={class:"absolute top-0 left-0 right-0 z-20 text-center pt-5 pointer-events-none"},Pc={class:"inline-block"},Cc={key:0,class:"mt-2 inline-block bg-yellow-500/10 border border-yellow-500/30 rounded-full px-3 py-0.5"},Ec={key:0,class:"mt-2 flex items-center justify-center gap-2 pointer-events-auto"},Rc={class:"relative inline-flex items-center cursor-pointer"},Ic={class:"absolute bottom-0 left-0 right-0 z-20 lobby-bottom-fade pointer-events-none"},Bc={key:0,class:"pointer-events-auto max-w-xs mx-auto px-4 pb-6 text-center"},Mc={key:0,class:"flex items-center justify-center gap-1.5 mb-4"},Dc=["disabled"],Nc={key:1,class:"mt-3 flex items-center gap-2"},Lc={class:"relative flex-1"},Uc=["disabled"],Oc={key:1,class:"max-w-6xl mx-auto px-0 pb-3 sm:px-6 sm:pb-6"},Vc={class:"text-center mb-3 sm:mb-4"},zc={key:0,class:"hidden sm:flex items-center justify-center gap-1.5 mb-2"},$c={class:"flex justify-center"},Fc={class:"flex items-center justify-center gap-3 sm:gap-4 mb-2 sm:mb-3 pointer-events-auto"},Hc={class:"flex items-center bg-black/60 rounded-xl p-0.5 border border-white/15"},jc={key:0,class:"flex items-center justify-center mb-3 pointer-events-auto"},Kc={key:1,class:"pointer-events-auto relative"},Wc={class:"lobby-room-card group relative overflow-hidden rounded-2xl transition-all duration-300 hover:scale-[1.03]"},Yc=["onClick"],qc={class:"relative h-28 sm:h-56 overflow-hidden"},Zc=["src","alt"],Xc={key:1,class:"w-full h-full bg-gradient-to-br from-gray-800/80 to-gray-900/80 flex items-center justify-center"},Jc={key:2,class:"absolute top-2 right-2 bg-amber-500/20 border border-amber-500/30 rounded-full px-2 py-0.5"},Gc={class:"absolute bottom-3 left-3 right-3"},Qc={class:"text-white font-bold text-lg sm:text-xl drop-shadow-lg group-hover:text-emerald-300 transition-colors leading-tight"},eu={key:0,class:"text-white/50 text-base drop-shadow-lg truncate mt-0.5"},tu={class:"flex items-center justify-between"},nu={class:"flex items-center gap-1.5 cursor-pointer"},su={class:"relative inline-flex items-center"},ou=["checked","onChange"],iu={class:"flex items-center gap-1.5 cursor-pointer"},ru={class:"relative inline-flex items-center"},au=["checked","onChange"],lu={class:"flex items-center gap-2"},cu=["onClick"],uu=["onClick"],fu=["onClick"],du=["value","placeholder","onBlur"],pu=["value","onBlur"],yu={class:"flex items-center gap-2"},mu=["value","onBlur"],hu={key:2,class:"flex items-center justify-center gap-1.5 mt-3 pointer-events-auto"},bu=["onClick"],gu={key:3,class:"pointer-events-auto"},wu=so({__name:"Room3dLobby",props:{environments:{},availableCharacters:{},selectedCharacter:{},carouselSelectedIdx:{},lobbyCharLoading:{type:Boolean},displayName:{},isDev:{type:Boolean},editMode:{type:Boolean},authenticated:{type:Boolean},roomSettings:{},inviteTokens:{},copiedToken:{},activeRoomIdx:{},guestMode:{type:Boolean},guestReady:{type:Boolean},guestOnlineCount:{},guestConnected:{type:Boolean},hideTokenPaste:{type:Boolean}},emits:["select-environment","prev-char","next-char","lobby-wheel","update-room-settings","copy-link","update:displayName","update:editMode","save-display-name","room-scroll","enter-room","join-public-room","join-by-token"],setup(e,{emit:t}){const n={isPublic:!0,inviteOnly:!1,publicName:"",publicDescription:"",password:""},s={isPublic:!1,inviteOnly:!0,publicName:"",publicDescription:"",password:""},o=e,i=t,{sidebarOpen:r}=mr(),a=z(!1),l=z("");function d(){const N=l.value.trim();N.startsWith("sfr:")&&(i("join-by-token",N),l.value="")}const c=z(null),f=z(null);function u(N){f.value=null,c.value=c.value===N?null:N}function p(N){c.value=null,f.value=f.value===N?null:N}function S(N,R){const Y=o.roomSettings[N];return Y&&R in Y?Y[R]:(N==="big_room"?n:s)[R]}function k(N,R){const Y=R.target.value;i("update-room-settings",N,{publicName:Y})}function A(N,R){const Y=R.target.value;i("update-room-settings",N,{publicDescription:Y})}function _(N,R){const Y=R.target.value;i("update-room-settings",N,{password:Y})}const b=ot(()=>o.authenticated?o.environments:o.environments.filter(N=>!N.hidden)),y=ot({get:()=>o.displayName,set:N=>i("update:displayName",N)}),h=ot({get:()=>o.editMode,set:N=>i("update:editMode",N)}),m=z("rooms"),x=z(),w=z(),v=z(),C=z(0),T=z(3),E=ot(()=>Math.max(1,Math.ceil(b.value.length/T.value))),P=ot(()=>{const N=b.value.length,R=T.value;if(C.value>=E.value-1&&N>R)return b.value.slice(N-R);const Y=C.value*R;return b.value.slice(Y,Y+R)});function I(){C.value>0&&C.value--}function B(){C.value<E.value-1&&C.value++}function V(){const N=window.innerWidth;if(N<640){T.value=2;return}const R=404,Y=Math.min(N-48,1152);T.value=Math.max(1,Math.floor(Y/R))}Us(()=>{V(),window.addEventListener("resize",V)}),vo(()=>{window.removeEventListener("resize",V)});const K=Sc();So(x,N=>{N&&(K.lobbyCanvas.value=N)}),So(w,N=>{N&&(K.roomScrollContainer.value=N)});let Z=null,Ae=null;Us(()=>{const N=v.value;if(!N)return;N.width=480,N.height=270;const R=N.getContext("2d");if(!R)return;Z=document.createElement("video"),Z.muted=!0,Z.loop=!0,Z.playsInline=!0,Z.preload="auto",Z.setAttribute("muted",""),Z.setAttribute("playsinline",""),Z.src="/video/loby-background.mp4";const Y=Z;Y.addEventListener("pause",()=>{Y.readyState>=2&&setTimeout(()=>Y.play().catch(()=>{}),50)}),Y.play().catch(()=>{const mt=()=>{Y.play().catch(()=>{})};document.addEventListener("click",mt,{once:!0}),document.addEventListener("touchstart",mt,{once:!0})}),Ae=ln(()=>{Y.readyState>=2&&!Y.paused&&R.drawImage(Y,0,0,480,270),Y.paused&&Y.readyState>=2&&Y.play().catch(()=>{})},42)}),vo(()=>{Ae&&(clearInterval(Ae),Ae=null),Z&&(Z.pause(),Z.removeAttribute("src"),Z.load(),Z=null)});let ue=0,W=0;function J(N){ue=N.touches[0].clientX,W=N.touches[0].clientY}function ye(N){const R=N.changedTouches[0].clientX-ue,Y=N.changedTouches[0].clientY-W;Math.abs(R)>50&&Math.abs(R)>Math.abs(Y)*1.5&&(R>0?i("prev-char"):i("next-char"))}function Je(){i("save-display-name")}function Jt(N){i("room-scroll",N)}return(N,R)=>{const Y=nr,mt=Pl,gs=lc;return L(),O("div",{class:"absolute inset-0 z-30 lobby-bg overflow-hidden",onTouchstartPassive:J,onTouchend:ye},[e.guestMode?X("",!0):(L(),O("button",{key:0,onClick:R[0]||(R[0]=M=>r.value=!0),class:"absolute top-3 left-3 z-30 p-2 text-white/40 hover:text-white/70 transition-colors"},[H(D(hr),{class:"w-6 h-6"})])),R[36]||(R[36]=ar('<div class="lobby-particle lobby-p1" data-v-f35415a5></div><div class="lobby-particle lobby-p2" data-v-f35415a5></div><div class="lobby-particle lobby-p3" data-v-f35415a5></div><div class="lobby-particle lobby-p4" data-v-f35415a5></div><div class="lobby-particle lobby-p5" data-v-f35415a5></div><div class="lobby-particle lobby-p6" data-v-f35415a5></div><div class="lobby-particle lobby-p7" data-v-f35415a5></div><div class="lobby-particle lobby-p8" data-v-f35415a5></div>',8)),g("canvas",{ref_key:"videoBgCanvas",ref:v,class:"absolute inset-0 w-full h-full object-cover pointer-events-none",style:{filter:"blur(4px)",opacity:"0.35"}},null,512),g("div",{ref_key:"lobbyCanvasEl",ref:x,class:"absolute inset-0 z-[1]",onWheel:R[1]||(R[1]=xt(M=>N.$emit("lobby-wheel",M),["prevent"]))},null,544),R[37]||(R[37]=g("div",{class:"absolute inset-0 pointer-events-none lobby-vignette z-[2]"},null,-1)),e.guestMode?(L(),O("div",Ac,[g("div",Tc,[g("div",{class:Te(["w-2 h-2 rounded-full",e.guestConnected?"bg-emerald-400 animate-pulse":"bg-gray-600"])},null,2),g("span",null,ke(e.guestOnlineCount??0)+" online",1)])])):X("",!0),H(Nt,{"enter-active-class":"transition-opacity duration-300","leave-active-class":"transition-opacity duration-300","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:et(()=>[e.lobbyCharLoading?(L(),O("div",kc,[...R[19]||(R[19]=[g("div",{class:"w-14 h-14 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin"},null,-1)])])):X("",!0)]),_:1}),g("div",_c,[g("div",Pc,[R[21]||(R[21]=g("img",{src:"/images/SCHEDULE-4-REAL.svg",alt:"Schedule 4 Real",class:"mx-auto h-16 sm:h-24 select-none lobby-title-glow",draggable:"false"},null,-1)),!e.authenticated&&!e.guestMode?(L(),O("div",Cc,[...R[20]||(R[20]=[g("span",{class:"text-yellow-400/70 text-base font-medium"},"Guest Mode",-1)])])):X("",!0),R[22]||(R[22]=g("div",{class:"mx-auto mt-2 h-px w-56 bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent"},null,-1))]),H(Y,null,{default:et(()=>[e.isDev&&e.authenticated?(L(),O("div",Ec,[g("label",Rc,[Ot(g("input",{type:"checkbox","onUpdate:modelValue":R[2]||(R[2]=M=>St(h)?h.value=M:null),class:"sr-only peer"},null,512),[[cr,D(h)]]),R[23]||(R[23]=g("div",{class:"w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-amber-500 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all"},null,-1))]),R[24]||(R[24]=g("span",{class:"text-amber-400 text-base font-medium"},"Asset Editing Mode",-1))])):X("",!0)]),_:1})]),e.availableCharacters.length>1?(L(),O("button",{key:2,onClick:R[3]||(R[3]=M=>N.$emit("prev-char")),class:"absolute left-2 sm:left-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[H(D(ko),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):X("",!0),e.availableCharacters.length>1?(L(),O("button",{key:3,onClick:R[4]||(R[4]=M=>N.$emit("next-char")),class:"absolute right-2 sm:right-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group"},[H(D(Ao),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"})])):X("",!0),g("div",Ic,[e.guestMode?(L(),O("div",Bc,[e.availableCharacters.length>1?(L(),O("div",Mc,[(L(!0),O(Vt,null,zt(e.availableCharacters,(M,ie)=>(L(),O("div",{key:ie,class:Te(["h-1.5 rounded-full transition-all duration-300",ie===e.carouselSelectedIdx?"bg-emerald-400 w-4":"bg-white/15 w-1.5"])},null,2))),128))])):X("",!0),Ot(g("input",{"onUpdate:modelValue":R[5]||(R[5]=M=>St(y)?y.value=M:null),type:"text",placeholder:"Enter your name",maxlength:"20",onBlur:R[6]||(R[6]=M=>Je()),class:"w-full bg-black/60 border border-white/20 rounded-xl px-4 py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors mb-3"},null,544),[[an,D(y)]]),g("button",{onClick:R[7]||(R[7]=M=>N.$emit("enter-room")),disabled:!e.guestReady||e.lobbyCharLoading,class:"w-full py-3 rounded-xl font-bold text-base text-white transition-all bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25"}," Enter Room ",8,Dc),e.hideTokenPaste?X("",!0):(L(),O("div",Nc,[g("div",Lc,[H(D(Si),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"}),Ot(g("input",{"onUpdate:modelValue":R[8]||(R[8]=M=>St(l)?l.value=M:null),type:"text",placeholder:"Paste invite token",onKeyup:Os(d,["enter"]),class:"w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors font-mono"},null,544),[[an,D(l)]])]),g("button",{onClick:d,disabled:!D(l).startsWith("sfr:"),class:"px-3 py-2 rounded-xl bg-emerald-500/25 border border-emerald-500/30 text-emerald-400 text-base font-bold hover:bg-emerald-500/35 transition-all disabled:opacity-20 disabled:cursor-not-allowed flex-shrink-0"}," Join ",8,Uc)]))])):(L(),O("div",Oc,[g("div",Vc,[e.availableCharacters.length>1?(L(),O("div",zc,[(L(!0),O(Vt,null,zt(e.availableCharacters,(M,ie)=>(L(),O("div",{key:ie,class:Te(["w-1.5 h-1.5 rounded-full transition-all duration-300",ie===e.carouselSelectedIdx?"bg-emerald-400 w-4 rounded-full":"bg-white/15"])},null,2))),128))])):X("",!0),g("div",$c,[Ot(g("input",{"onUpdate:modelValue":R[9]||(R[9]=M=>St(y)?y.value=M:null),type:"text",placeholder:"Your name",maxlength:"20",onBlur:R[10]||(R[10]=M=>Je()),class:"pointer-events-auto w-48 sm:w-56 bg-black/60 border border-white/20 rounded-xl px-4 py-2 sm:py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,544),[[an,D(y)]])])]),g("div",Fc,[R[26]||(R[26]=g("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-r from-transparent to-white/10"},null,-1)),g("div",Hc,[g("button",{onClick:R[11]||(R[11]=M=>m.value="rooms"),class:Te(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all",D(m)==="rooms"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])}," My Rooms ",2),g("button",{onClick:R[12]||(R[12]=M=>m.value="public"),class:Te(["px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all flex items-center gap-1.5",D(m)==="public"?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50"])},[H(D(oo),{class:"w-3.5 h-3.5"}),R[25]||(R[25]=ae(" Public ",-1))],2)]),R[27]||(R[27]=g("div",{class:"hidden sm:block h-px w-12 bg-gradient-to-l from-transparent to-white/10"},null,-1))]),D(m)==="rooms"?(L(),O("div",jc,[g("button",{onClick:R[13]||(R[13]=M=>a.value=!0),class:"flex items-center gap-1.5 px-3 py-1 rounded-full bg-black/40 border border-white/10 text-white/40 hover:text-emerald-400 hover:border-emerald-500/30 hover:bg-emerald-500/10 transition-all text-base",title:"How privacy works"},[H(D(Or),{class:"w-4 h-4"}),R[28]||(R[28]=g("span",null,"Privacy info",-1))])])):X("",!0),H(mt,{modelValue:D(a),"onUpdate:modelValue":R[14]||(R[14]=M=>St(a)?a.value=M:null)},null,8,["modelValue"]),D(m)==="rooms"?(L(),O("div",Kc,[H(Nt,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:et(()=>[D(C)>0?(L(),O("button",{key:0,onClick:I,class:"hidden sm:flex absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[H(D(ko),{class:"w-4 h-4 text-white/60"})])):X("",!0)]),_:1}),g("div",{ref_key:"roomScrollEl",ref:w,onScroll:Jt,class:"flex gap-3 sm:gap-5 overflow-x-auto snap-x snap-mandatory scrollbar-hide sm:overflow-visible sm:justify-center px-2 sm:px-0 items-start"},[H(lr,{name:"room-card",tag:"div",class:"contents"},{default:et(()=>[(L(!0),O(Vt,null,zt(D(P),M=>(L(),O("div",{key:M.id,class:"flex flex-col items-stretch w-[45vw] sm:w-96 snap-center flex-shrink-0"},[g("div",Wc,[g("button",{onClick:ie=>N.$emit("select-environment",M,D(y).trim()||void 0),class:"w-full text-left"},[g("div",qc,[M.image?(L(),O("img",{key:0,src:M.image,alt:M.name,class:"w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"},null,8,Zc)):(L(),O("div",Xc,[(L(),He(ur(M.icon),{class:"w-12 h-12 text-white/15"}))])),R[30]||(R[30]=g("div",{class:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-black/30"},null,-1)),M.hidden&&e.authenticated?(L(),O("div",Jc,[...R[29]||(R[29]=[g("span",{class:"text-amber-400 text-base font-medium"},"Hidden",-1)])])):X("",!0),g("div",Gc,[g("h3",Qc,ke(S(M.id,"publicName")||M.name),1),S(M.id,"publicDescription")?(L(),O("p",eu,ke(S(M.id,"publicDescription")),1)):X("",!0)]),R[31]||(R[31]=g("div",{class:"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"},[g("div",{class:"w-14 h-14 rounded-full bg-emerald-500/20 backdrop-blur-sm flex items-center justify-center border border-emerald-400/30"},[g("svg",{class:"w-6 h-6 text-emerald-300 ml-0.5",fill:"currentColor",viewBox:"0 0 24 24"},[g("path",{d:"M8 5v14l11-7z"})])])],-1))])],8,Yc),e.authenticated?(L(),O("div",{key:0,class:"bg-black/80 border-t border-white/[0.08] px-3 py-1.5 space-y-1.5",onClick:R[15]||(R[15]=xt(()=>{},["stop"]))},[g("div",tu,[g("label",nu,[g("div",su,[g("input",{type:"checkbox",checked:S(M.id,"isPublic"),onChange:ie=>N.$emit("update-room-settings",M.id,{isPublic:!S(M.id,"isPublic")}),class:"sr-only peer"},null,40,ou),R[32]||(R[32]=g("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),g("span",{class:Te(["text-base",S(M.id,"isPublic")?"text-emerald-400/80":"text-white/35"])},ke(S(M.id,"isPublic")?"Public visible":"Not public"),3)]),g("label",iu,[g("div",ru,[g("input",{type:"checkbox",checked:!S(M.id,"inviteOnly"),onChange:ie=>N.$emit("update-room-settings",M.id,{inviteOnly:!S(M.id,"inviteOnly")}),class:"sr-only peer"},null,40,au),R[33]||(R[33]=g("div",{class:"w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-3 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all"},null,-1))]),g("span",{class:Te(["text-base",S(M.id,"inviteOnly")?"text-white/35":"text-sky-400/80"])},ke(S(M.id,"inviteOnly")?"Hidden on lobby":"Visible on lobby"),3)])]),g("div",lu,[g("button",{onClick:ie=>p(M.id),class:Te(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",[S(M.id,"password")?"text-amber-400 bg-amber-500/10":"text-white/30 hover:text-white/50",D(f)===M.id?"ring-1 ring-amber-500/40":""]])},[S(M.id,"password")?(L(),He(D(pn),{key:0,class:"w-3.5 h-3.5"})):(L(),He(D(br),{key:1,class:"w-3.5 h-3.5"})),g("span",null,ke(S(M.id,"password")?"Password set":"No password"),1)],10,cu),g("button",{onClick:ie=>u(M.id),class:Te(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",D(c)===M.id?"text-emerald-400 bg-emerald-500/10 ring-1 ring-emerald-500/40":"text-white/30 hover:text-white/50"])},[H(D(Vr),{class:"w-3.5 h-3.5"}),R[34]||(R[34]=g("span",null,"Edit info",-1))],10,uu),R[35]||(R[35]=g("div",{class:"flex-1"},null,-1)),e.inviteTokens[M.id]?(L(),O("button",{key:0,onClick:xt(ie=>N.$emit("copy-link",M.id),["prevent"]),class:Te(["flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all",e.copiedToken===M.id?"text-emerald-400 bg-emerald-500/10":"text-white/30 hover:text-white/50"])},[e.copiedToken!==M.id?(L(),He(D(Fr),{key:0,class:"w-3.5 h-3.5"})):(L(),He(D(zr),{key:1,class:"w-3.5 h-3.5"})),g("span",null,ke(e.copiedToken===M.id?"Copied!":"Copy link"),1)],10,fu)):X("",!0)])])):X("",!0)]),H(Nt,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:et(()=>[D(c)===M.id?(L(),O("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-white/[0.12] rounded-xl px-3 py-2 space-y-1.5",onClick:R[16]||(R[16]=xt(()=>{},["stop"]))},[g("input",{type:"text",value:S(M.id,"publicName"),maxlength:"60",placeholder:M.name,onBlur:ie=>k(M.id,ie),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,du),g("input",{type:"text",value:S(M.id,"publicDescription"),maxlength:"200",placeholder:"Short description...",onBlur:ie=>A(M.id,ie),class:"w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors"},null,40,pu)])):X("",!0)]),_:2},1024),H(Nt,{"enter-active-class":"transition-all duration-200 ease-out","enter-from-class":"opacity-0 -translate-y-1","leave-active-class":"transition-all duration-150 ease-in","leave-to-class":"opacity-0 -translate-y-1"},{default:et(()=>[D(f)===M.id?(L(),O("div",{key:0,class:"mt-1.5 bg-black/70 backdrop-blur-sm border border-amber-500/20 rounded-xl px-3 py-2",onClick:R[17]||(R[17]=xt(()=>{},["stop"]))},[g("div",yu,[H(D(pn),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"}),g("input",{type:"text",value:S(M.id,"password"),maxlength:"32",placeholder:"Room password (leave empty to remove)",onBlur:ie=>_(M.id,ie),class:"flex-1 bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors"},null,40,mu)])])):X("",!0)]),_:2},1024)]))),128))]),_:1})],544),H(Nt,{"enter-active-class":"transition-opacity duration-200","leave-active-class":"transition-opacity duration-200","enter-from-class":"opacity-0","leave-to-class":"opacity-0"},{default:et(()=>[D(C)<D(E)-1?(L(),O("button",{key:0,onClick:B,class:"hidden sm:flex absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all"},[H(D(Ao),{class:"w-4 h-4 text-white/60"})])):X("",!0)]),_:1})])):X("",!0),D(m)==="rooms"&&D(E)>1?(L(),O("div",hu,[(L(!0),O(Vt,null,zt(D(E),M=>(L(),O("button",{key:M,onClick:ie=>C.value=M-1,class:Te(["h-1.5 rounded-full transition-all duration-300 cursor-pointer",M-1===D(C)?"bg-emerald-400 w-5":"bg-white/15 w-1.5 hover:bg-white/30"])},null,10,bu))),128))])):X("",!0),D(m)==="public"?(L(),O("div",gu,[H(gs,{authenticated:e.authenticated,onJoinPublicRoom:R[18]||(R[18]=M=>N.$emit("join-public-room",M))},null,8,["authenticated"])])):X("",!0)]))])],32)}}}),vd=Object.assign(io(wu,[["__scopeId","data-v-f35415a5"]]),{__name:"Room3dLobby"});let $=null,Wt=null,ss=0,pt=null,Hi,ji,to,bn=!1;const xu=15e3;let Ls=0;const vu=50;let $n={x:0,y:0,z:0},ei=0,ti="";const ni=.01,si=.02;let os=null,is=null,rs=null,Ht=null,as=null,ls=null,cs=null,no=null;const gn=[],xn=z(!1),us=z(!1),yo=z(""),Ie=z(new Map),Su=ot(()=>Ie.value.size+(xn.value?1:0));function Sd(){return{connected:xn,wsConnected:us,localPeerId:yo,playerCount:Su,remotePlayers:Ie,connect:Ou,joinRoom:Vu,leaveRoom:mo,sendLocalState:$u,sendRoomStateChanged:Uu,onPlayerMoved:Tu,onRoomStateChanged:ku,onPlayersInit:Au,sendObjectDelta:Pu,onObjectDelta:_u,sendVoiceSignal:Cu,sendVoiceState:Eu,sendVoiceRelay:Ru,onVoiceSignal:Iu,onVoiceState:Bu,getRoomId:()=>pt,onPlayerLeft:Mu,sendTVChanged:Lu,onTVChanged:Du,onServerError:Nu,dispose:Fu}}function Au(e){rs=e}function Tu(e){os=e}function ku(e){is=e}let fs=null;function _u(e){fs=e}function Pu(e){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify(e))}catch{}}function Cu(e,t,n){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify({type:t,target:e,...n}))}catch{}}function Eu(e){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify({type:"voice:state",...e}))}catch{}}function Ru(e,t){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify({type:"voice:relay",audio:e,sr:t}))}catch{}}function Iu(e){if(Ht=e,e&&gn.length>0){const t=gn.splice(0);(async()=>{for(const n of t)try{await e(n.from,n.type,n.data)}catch{}})()}}function Bu(e){as=e}function Mu(e){ls=e}function Du(e){cs=e}function Nu(e){no=e}function Lu(e,t){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify({type:"tv:changed",tvId:e,channelUrl:t}))}catch{}}function Uu(){if(!(!$||$.readyState!==WebSocket.OPEN))try{$.send(JSON.stringify({type:"room:state-changed"}))}catch{}}let Yn=null;function Ou(){bn=!1,!($&&($.readyState===WebSocket.OPEN||$.readyState===WebSocket.CONNECTING))&&ho()}function Vu(e,t,n,s,o){pt&&mo(),pt=e,Hi=t,ji=s,to=o,Yn=n||null,$&&$.readyState===WebSocket.OPEN?Ki():(!$||$.readyState===WebSocket.CLOSED)&&ho()}function mo(){if(pt&&$&&$.readyState===WebSocket.OPEN)try{$.send(JSON.stringify({type:"leave"}))}catch{}pt=null,Ie.value=new Map,xn.value=!1,yo.value=""}const zu=3e4;function $u(e,t,n){if(!$||$.readyState!==WebSocket.OPEN)return;const s=Date.now();if(s-Ls<vu)return;const o=s-Ls>zu;if(!(Ie.value.size===0&&!o)){if(!o){const i=e.x-$n.x,r=e.y-$n.y,a=e.z-$n.z,l=i*i+r*r+a*a,d=Math.abs(t-ei),c=d>si&&d<Math.PI*2-si;if(l<ni*ni&&!c&&n===ti)return}Ls=s,$n={...e},ei=t,ti=n;try{$.send(JSON.stringify({type:"move",position:e,rotationY:t,animation:n}))}catch{}}}function Fu(){bn=!0,mo(),Hu(),os=null,is=null,rs=null,fs=null,Ht=null,as=null,ls=null,cs=null,gn.length=0}function Ki(){if(!$||$.readyState!==WebSocket.OPEN||!pt)return;const e={type:"join",roomId:pt,displayName:Hi,characterModel:ji,position:Yn};to&&(e.password=to),$.send(JSON.stringify(e)),Yn&&$.send(JSON.stringify({type:"move",position:Yn,rotationY:0,animation:"idle"}))}function ho(){if($){const n=$;n.onclose=null,n.onmessage=null,n.onerror=null,n.onopen=null;try{n.close()}catch{}$=null}const t=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_room3d-ws`;try{$=new WebSocket(t)}catch{oi();return}$.onopen=()=>{ss=0,us.value=!0,pt&&Ki()},$.onmessage=n=>{let s;try{s=JSON.parse(typeof n.data=="string"?n.data:"")}catch{return}ju(s)},$.onclose=n=>{us.value=!1,xn.value=!1,bn||oi()},$.onerror=n=>{}}function Hu(){if(Wt&&(clearTimeout(Wt),Wt=null),ss=0,$){const e=$;e.onclose=null,e.onmessage=null,e.onerror=null,e.onopen=null;try{e.close()}catch{}$=null}us.value=!1}function oi(){if(Wt||bn)return;const e=Math.min(1e3*Math.pow(2,ss),xu);ss++,Wt=setTimeout(()=>{Wt=null,bn||ho()},e)}function ju(e){switch(e.type){case"init":{yo.value=e.peerId,xn.value=!0;const t=new Map;for(const n of e.players||[])t.set(n.peerId,{peerId:n.peerId,displayName:n.displayName,characterModel:n.characterModel||"",color:n.color,position:n.position||{x:0,y:0,z:0},rotationY:n.rotationY||0,animation:n.animation||"idle",timestamp:Date.now()});Ie.value=t,rs&&t.size>0&&rs([...t.values()]);break}case"player:joined":{const t=e.player;if(!t)break;const n=new Map(Ie.value);n.set(t.peerId,{peerId:t.peerId,displayName:t.displayName,characterModel:t.characterModel||"",color:t.color,position:t.position||{x:0,y:0,z:0},rotationY:t.rotationY||0,animation:t.animation||"idle",timestamp:Date.now()}),Ie.value=n;break}case"player:moved":{os&&os(e.peerId,e.position,e.rotationY,e.animation,e.seq??0);const t=Ie.value.get(e.peerId);if(t)t.position=e.position,t.rotationY=e.rotationY,t.animation=e.animation,t.timestamp=Date.now();else{const n=new Map(Ie.value);n.set(e.peerId,{peerId:e.peerId,displayName:e.peerId.slice(0,6),characterModel:"",color:"#60a5fa",position:e.position,rotationY:e.rotationY,animation:e.animation||"idle",timestamp:e.timestamp}),Ie.value=n}break}case"player:left":{ls&&ls(e.peerId);const t=new Map(Ie.value);t.delete(e.peerId),Ie.value=t;break}case"room:state-changed":{is&&is();break}case"object:placed":case"object:deleted":case"object:moved":{fs&&fs(e);break}case"voice:offer":case"voice:answer":case"voice:ice":{Ht?Ht(e.from,e.type,e):gn.length<50&&gn.push({from:e.from,type:e.type,data:e});break}case"voice:relay":{Ht&&Ht(e.from,e.type,e);break}case"tv:changed":{cs&&cs(e.peerId,e.tvId,e.channelUrl??null);break}case"voice:state":{as&&as(e.peerId,{muted:e.muted,speaking:e.speaking});break}case"error":{no&&no(e.code,e.message);break}}}const Ku=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun.cloudflare.com:3478"}];let F=null,oe=null,fn=null,je=null,ds=null;const Q=new Map,We=new Map;let q=null,Wi=1,Yi=20,qn=null;const Wu=5e3,Yu=1e4;let bo=!1;const qu=2,Zu=3e3;let Ue=!1,Xu=null,vn=!1,Ke=null,dn=null,qt=!1;const Zt=new Map,st=new Map,Ce=new Map,qi="room3d-voice-settings",ii={mode:"vad",muted:!1,volume:80,spatialAudio:!0,autoJoin:!0};function Ju(){try{const e=localStorage.getItem(qi);if(e)return{...ii,...JSON.parse(e)}}catch{}return{...ii}}function Sn(){try{localStorage.setItem(qi,JSON.stringify({mode:Ze.value,muted:Ee.value,volume:_t.value,spatialAudio:hs.value,autoJoin:go.value}))}catch{}}const An=Ju(),yt=z(!1),Ze=z(An.mode),Ee=z(An.muted),Xe=z(!1),kt=z(!1),_t=z(An.volume),hs=z(An.spatialAudio),go=z(An.autoJoin),wo=z(!1),bs=fr(new Map),Gu=8,Qu=30,ef=400;let Zn=null,jt=0,Kt=0,Tt=!1,Xn=null,lt=null;function Xt(e){const t=oe?.getAudioTracks()[0];t&&(t.enabled=e)}function tf(e,t){if(!F)return null;const n=Q.get(t);if(!n)return null;if(n.source)return n;if(e.getAudioTracks().length===0)return null;const o=F.createMediaStreamSource(e),i=F.createGain();i.gain.value=_t.value/100;const r=F.createPanner();r.panningModel="HRTF",r.distanceModel="inverse",r.refDistance=Wi,r.maxDistance=Yi,r.rolloffFactor=1.5,r.coneInnerAngle=360,r.coneOuterAngle=360,r.coneOuterGain=1;const a=F.createAnalyser();return a.fftSize=256,a.smoothingTimeConstant=.5,o.connect(i),i.connect(r),r.connect(a),a.connect(F.destination),n.source=o,n.gain=i,n.panner=r,n.analyser=a,n.stream=e,n}function Zi(e){const t=new RTCPeerConnection({iceServers:Ku});return t.onicecandidate=n=>{n.candidate&&q&&q.sendVoiceSignal(e,"voice:ice",{candidate:n.candidate})},t.ontrack=n=>{const s=n.streams[0]||new MediaStream([n.track]);F&&F.state==="suspended"&&F.resume().catch(()=>{});const o=Q.get(e);if(o&&!o.audioEl)try{const r=new Audio;r.srcObject=s,r.autoplay=!0,r.volume=_t.value/100,r.play().then(()=>{}).catch(a=>{}),o.audioEl=r}catch{}Q.get(e)?.audioEl||tf(s,e)},t.onconnectionstatechange=()=>{if(t.connectionState==="connected"&&Ue){let s=!0;for(const[,o]of Q)if(o.pc.connectionState!=="connected"){s=!1;break}s&&Pf()}},t.oniceconnectionstatechange=()=>{},t.onsignalingstatechange=()=>{},t}let Xi=1;function nf(e,t=1){q=e,Xi=t}async function sf(){if(oe)return!0;if(!navigator.mediaDevices?.getUserMedia)return!1;try{return oe=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1}),!0}catch{return!1}}async function of(e,t){e&&(q=e);const n=t??Xi;if(Wi=1*n,Yi=20*n,!yt.value&&q)try{if(!oe){if(!navigator.mediaDevices?.getUserMedia)return;oe=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})}const s=oe.getAudioTracks()[0];if((!s||s.readyState!=="live")&&(oe=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1})),F=new AudioContext,F.state==="suspended")try{await F.resume()}catch{}if(!qt)try{await F.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await F.audioWorklet.addModule("/workers/audio-playback.worklet.js"),qt=!0}catch{}const o=oe.getAudioTracks()[0];fn=o.clone();const i=new MediaStream([fn]);je=F.createAnalyser(),je.fftSize=512,je.smoothingTimeConstant=.5,ds=new Uint8Array(je.frequencyBinCount),F.createMediaStreamSource(i).connect(je),o.enabled=Ze.value==="vad"&&!Ee.value,q.onVoiceSignal(lf),q.onVoiceState(cf),Zn=ln(pf,100),Xn=ln(mf,100),qn=ln(uf,Wu),yt.value=!0}catch{tr()}}async function Ji(e){if(!yt.value||!oe||!q||Q.has(e))return;const n=(q.localPeerId?.value||"")<e,s=Zi(e);for(const i of oe.getAudioTracks())s.addTrack(i,oe);const o={pc:s,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:n};if(Q.set(e,o),n)try{const i=await s.createOffer();await s.setLocalDescription(i),q.sendVoiceSignal(e,"voice:offer",{sdp:s.localDescription}),o.offerSentAt=Date.now()}catch{Q.delete(e),s.close()}setTimeout(()=>{const i=Q.get(e);i&&i.pc.connectionState!=="connected"&&!Ue&&Gi()},Zu)}async function ri(e){const t=We.get(e);if(!t||t.length===0)return;We.delete(e);const n=Q.get(e);if(n)for(const s of t)try{await n.pc.addIceCandidate(new RTCIceCandidate(s))}catch{}}function rf(e,t,n){if(t===n)return e;const s=t/n,o=Math.round(e.length/s),i=new Int16Array(o);for(let r=0;r<o;r++){const a=r*s,l=Math.floor(a),d=Math.min(l+1,e.length-1),c=a-l;i[r]=Math.round(e[l]*(1-c)+e[d]*c)}return i}function af(e,t){if(F&&(F.state==="suspended"&&F.resume().catch(()=>{}),Ue||(Ue=!0,vn=!0,Qi()),!(!t.audio||typeof t.audio!="string")))try{const n=atob(t.audio),s=new Uint8Array(n.length);for(let l=0;l<n.length;l++)s[l]=n.charCodeAt(l);let o=new Int16Array(s.buffer,s.byteOffset,s.byteLength>>1);const i=t.sr||48e3,r=F.sampleRate;i!==r&&(o=rf(o,i,r)),Zt.has(e),Zt.set(e,Date.now()),Ce.has(e)||Cf(e);const a=Ce.get(e);if(!a)return;a.workletNode.port.postMessage(o.buffer,[o.buffer])}catch{}}async function lf(e,t,n){if(!(!oe||!q))if(t==="voice:offer"){let s=Q.get(e);if(s&&s.pc.signalingState==="have-local-offer"){if((q.localPeerId?.value||"")>e)return;try{await s.pc.setLocalDescription({type:"rollback"})}catch{}}if(!s){const o=Zi(e);for(const i of oe.getAudioTracks())o.addTrack(i,oe);s={pc:o,source:null,gain:null,panner:null,analyser:null,stream:null,audioEl:null,speaking:!1,offerSentAt:0,isOfferer:!1},Q.set(e,s)}try{await s.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await ri(e);const o=await s.pc.createAnswer();await s.pc.setLocalDescription(o),q.sendVoiceSignal(e,"voice:answer",{sdp:s.pc.localDescription})}catch{}}else if(t==="voice:answer"){const s=Q.get(e);if(!s||s.pc.signalingState!=="have-local-offer")return;try{await s.pc.setRemoteDescription(new RTCSessionDescription(n.sdp)),await ri(e)}catch{}}else if(t==="voice:ice"){const s=Q.get(e);if(!s){let o=We.get(e);o||(o=[],We.set(e,o)),o.push(n.candidate);return}if(n.candidate)if(s.pc.remoteDescription)try{await s.pc.addIceCandidate(new RTCIceCandidate(n.candidate))}catch{}else{let o=We.get(e);o||(o=[],We.set(e,o)),o.push(n.candidate)}}else t==="voice:relay"&&af(e,n)}function cf(e,t){bs.set(e,{...t}),lt&&lt(e,t.speaking)}function ps(e){const t=Q.get(e);if(t){try{t.source?.disconnect()}catch{}try{t.gain?.disconnect()}catch{}try{t.panner?.disconnect()}catch{}try{t.analyser?.disconnect()}catch{}t.audioEl&&(t.audioEl.pause(),t.audioEl.srcObject=null,t.audioEl=null),t.pc.close(),Q.delete(e)}xo(e),bs.delete(e),We.delete(e)}function uf(){if(!yt.value||!q)return;const e=Date.now();for(const[t,n]of Q){const s=n.pc.connectionState,o=n.pc.signalingState;if(s==="connected"){st.delete(t);continue}if(s==="failed"||s==="closed"){ps(t),st.set(t,(st.get(t)||0)+1);continue}if(n.isOfferer&&n.offerSentAt>0&&o==="have-local-offer"&&e-n.offerSentAt>Yu){ps(t),st.set(t,(st.get(t)||0)+1);continue}}if(!Ue){for(const[,t]of st)if(t>=qu){Gi();break}}for(const t of q.remotePlayers.value.keys())Q.has(t)||Ji(t)}function ff(e,t){if(!F||F.state==="closed"||!hs.value)return;const n=F.listener;if(e){const s=e.position;n.positionX?(n.positionX.value=s.x,n.positionY.value=s.y,n.positionZ.value=s.z):n.setPosition(s.x,s.y,s.z);const o={x:0,y:0,z:-1},i={x:0,y:1,z:0},r=e.quaternion,a=o.x,l=o.y,d=o.z,c=r.x,f=r.y,u=r.z,p=r.w,S=p*a+f*d-u*l,k=p*l+u*a-c*d,A=p*d+c*l-f*a,_=-c*a-f*l-u*d;o.x=S*p+_*-c+k*-u-A*-f,o.y=k*p+_*-f+A*-c-S*-u,o.z=A*p+_*-u+S*-f-k*-c;const b=i.x,y=i.y,h=i.z,m=p*b+f*h-u*y,x=p*y+u*b-c*h,w=p*h+c*y-f*b,v=-c*b-f*y-u*h;i.x=m*p+v*-c+x*-u-w*-f,i.y=x*p+v*-f+w*-c-m*-u,i.z=w*p+v*-u+m*-f-x*-c,n.forwardX?(n.forwardX.value=o.x,n.forwardY.value=o.y,n.forwardZ.value=o.z,n.upX.value=i.x,n.upY.value=i.y,n.upZ.value=i.z):n.setOrientation(o.x,o.y,o.z,i.x,i.y,i.z)}for(const[s,o]of Q){if(!o.panner)continue;const i=t.getPlayerPosition3D(s);i&&(o.panner.positionX?(o.panner.positionX.value=i.x,o.panner.positionY.value=i.y,o.panner.positionZ.value=i.z):o.panner.setPosition(i.x,i.y,i.z))}}function df(e){!yt.value||Ee.value||(kt.value=e,Ze.value==="ptt"&&(Xe.value=e,Xt(e),q?.sendVoiceState({muted:!1,speaking:e})))}function pf(){if(Ze.value!=="vad"||!je||!ds||Ee.value||q&&q.remotePlayers.value.size===0){Tt&&ai();return}const e=ds;je.getByteFrequencyData(e);let t=0;for(let o=0;o<e.length;o++)t+=e[o];const n=t/e.length,s=Date.now();n>Gu?(Kt=0,jt||(jt=s),!Tt&&s-jt>=Qu&&yf()):(jt=0,Tt&&(Kt||(Kt=s),s-Kt>=ef&&ai()))}function yf(){Tt=!0,Xe.value=!0,q?.sendVoiceState({muted:!1,speaking:!0})}function ai(){Tt=!1,!bo&&(Xe.value=!1,q?.sendVoiceState({muted:Ee.value,speaking:!1}))}function mf(){if(Q.size===0&&Ce.size===0)return;const e=12;for(const[t,n]of Q){if(!n.analyser)continue;const s=new Uint8Array(n.analyser.frequencyBinCount);n.analyser.getByteFrequencyData(s);let o=0;for(let a=0;a<s.length;a++)o+=s[a];const r=o/s.length>e;r!==n.speaking&&(n.speaking=r,lt&&lt(t,r))}if(Ce.size>0){const t=Date.now();for(const[n]of Ce){const s=Zt.get(n)||0,o=t-s<300;lt&&lt(n,o)}}}function hf(e){Ze.value=e,e==="ptt"?(kt.value||(Xe.value=!1,Xt(!1),q?.sendVoiceState({muted:Ee.value,speaking:!1})),Tt=!1,jt=0,Kt=0):(kt.value=!1,Ee.value||Xt(!0)),Sn()}function bf(){Ee.value=!Ee.value,Ee.value?(Xe.value=!1,kt.value=!1,Xt(!1),q?.sendVoiceState({muted:!0,speaking:!1})):Ze.value==="vad"&&Xt(!0),Sn()}function gf(e){_t.value=Math.max(0,Math.min(100,e));const t=_t.value/100;for(const n of Q.values())n.gain&&(n.gain.gain.value=t),n.audioEl&&(n.audioEl.volume=t);for(const n of Ce.values())n.gain.gain.value=t*2.5;Sn()}function wf(e){if(hs.value=e,!e)for(const t of Q.values())t.panner&&(t.panner.positionX?(t.panner.positionX.value=0,t.panner.positionY.value=0,t.panner.positionZ.value=0):t.panner.setPosition(0,0,0));Sn()}function xf(e){go.value=e,Sn()}function vf(){wo.value=!0}function Sf(){wo.value=!1}function Af(e){lt=e}function Tf(){return[...Q.keys()]}function kf(){const e=[];for(const[n,s]of Q)e.push({id:n.slice(0,6),conn:s.pc.connectionState,ice:s.pc.iceConnectionState,sig:s.pc.signalingState,hasRemoteDesc:!!s.pc.remoteDescription,hasTrack:!!s.stream,trackEnabled:s.stream?.getAudioTracks()[0]?.enabled??!1});const t=oe?.getAudioTracks()[0];return{audioCtx:F?.state||"none",relayMode:Ue,voiceWs:Xu?.readyState===WebSocket.OPEN?"open":"closed",relayPeers:Ce.size,voiceEnabled:yt.value,localStream:!!oe,localTrackState:t?.readyState||"none",localTrackEnabled:t?.enabled??!1,localMuted:Ee.value,localSpeaking:Xe.value,voiceMode:Ze.value,mp:!!q,mpConnected:q?.connected?.value??!1,localPeerId:(q?.localPeerId?.value||"").slice(0,6),iceBuf:We.size,peers:e}}function _f(){bo=!0,Xt(!0),Xe.value=!0}function Gi(){Ue||(Ue=!0,vn=!0,F&&F.state==="suspended"&&F.resume().catch(()=>{}),Qi())}function Pf(){if(Ue){Ue=!1,vn=!1,er();for(const e of[...Ce.keys()])xo(e);Zt.clear(),st.clear()}}async function Qi(){if(!(Ke||!F||!oe)){if(!qt)try{await F.audioWorklet.addModule("/workers/audio-capture.worklet.js"),await F.audioWorklet.addModule("/workers/audio-playback.worklet.js"),qt=!0}catch{return}dn=F.createMediaStreamSource(oe),Ke=new AudioWorkletNode(F,"audio-capture-processor"),Ke.port.onmessage=e=>{if(!Ee.value&&!(Ze.value==="ptt"&&!kt.value)&&vn&&q){const t=new Int16Array(e.data),n=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);let s="";for(let i=0;i<n.length;i++)s+=String.fromCharCode(n[i]);const o=btoa(s);q.sendVoiceRelay(o,F?.sampleRate||48e3)}},dn.connect(Ke),Ke.connect(F.destination)}}function er(){if(Ke){Ke.port.postMessage({type:"mute",value:!0});try{Ke.disconnect()}catch{}Ke=null}if(dn){try{dn.disconnect()}catch{}dn=null}}function Cf(e){if(!(!F||Ce.has(e)||!qt))try{const t=new AudioWorkletNode(F,"audio-playback-processor"),n=F.createGain();n.gain.value=_t.value/100*2.5,t.connect(n),n.connect(F.destination),Ce.set(e,{workletNode:t,gain:n})}catch{}}function xo(e){const t=Ce.get(e);if(t){try{t.workletNode.port.postMessage({type:"reset"})}catch{}try{t.workletNode.disconnect()}catch{}try{t.gain.disconnect()}catch{}Ce.delete(e),Zt.delete(e)}}function tr(){Zn&&(clearInterval(Zn),Zn=null),Xn&&(clearInterval(Xn),Xn=null),qn&&(clearInterval(qn),qn=null);for(const e of[...Q.keys()])ps(e);if(oe){for(const e of oe.getTracks())e.stop();oe=null}fn&&(fn.stop(),fn=null);try{je?.disconnect()}catch{}je=null,ds=null,er();for(const e of[...Ce.keys()])xo(e);Zt.clear(),st.clear(),Ue=!1,vn=!1,F&&F.state!=="closed"&&F.close().catch(()=>{}),F=null,qt=!1,q&&(q.onVoiceSignal(null),q.onVoiceState(null)),q=null,yt.value=!1,Xe.value=!1,kt.value=!1,Tt=!1,jt=0,Kt=0,bo=!1,bs.clear(),We.clear(),lt=null}function Ad(){return{voiceEnabled:yt,voiceMode:Ze,localMuted:Ee,localSpeaking:Xe,pttActive:kt,masterVolume:_t,spatialEnabled:hs,autoJoinVoice:go,showVoiceSettings:wo,peerVoiceStates:bs,requestMicrophone:sf,setMultiplayerRef:nf,initVoice:of,disposeVoice:tr,connectToPeer:Ji,disconnectPeer:ps,updateSpatialPositions:ff,setVoiceMode:hf,setPTT:df,toggleMute:bf,setMasterVolume:gf,setSpatialAudio:wf,setAutoJoin:xf,openVoiceSettings:vf,closeVoiceSettings:Sf,onPeerSpeakingChanged:Af,getConnectedPeerIds:Tf,getVoiceDebugInfo:kf,forceEnableTransmit:_f}}export{qf as $,yd as A,rl as B,ud as C,yn as D,tl as E,rd as F,Qa as G,xd as H,il as I,Gf as J,td as K,Jf as L,Ga as M,ed as N,Qf as O,fd as P,Vl as Q,Hf as R,Sc as S,cd as T,Sd as U,Ad as V,Ll as W,Bi as X,Xf as Y,Yf as Z,vd as _,jf as a,Zf as a0,sd as a1,Si as a2,Kf as b,Za as c,Fr as d,nd as e,Zs as f,Wf as g,nl as h,Ko as i,id as j,pd as k,gd as l,md as m,dd as n,wd as o,Wo as p,cl as q,el as r,ad as s,Ja as t,Xa as u,sl as v,od as w,bd as x,hd as y,ld as z};
