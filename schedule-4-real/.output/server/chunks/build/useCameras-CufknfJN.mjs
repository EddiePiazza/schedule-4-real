import{ref as e,defineComponent as t,computed as n,watch as a,mergeProps as o,unref as l,isRef as r,useSSRContext as s}from"vue";import{ssrRenderAttrs as c,ssrInterpolate as i}from"vue/server-renderer";import{u}from"./useAuthGate-BgxmmIEE.mjs";function D(t){const n=r(t)?t:e(t),o=e(null),l=e("idle"),s=e(""),c=e(null),{getAuthHeaders:i}=u();let d=null,m=null,h=null,f=null,y=!1;async function C(){if(n.value){if(l.value="connecting",s.value="",y)return void v();try{d=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),d.addTransceiver("video",{direction:"recvonly"}),d.addTransceiver("audio",{direction:"recvonly"}),d.ontrack=e=>{o.value&&e.streams[0]&&(o.value.srcObject=e.streams[0])};let e=!1;d.onconnectionstatechange=()=>{"connected"===(null==d?void 0:d.connectionState)&&(e=!0,c.value="webrtc",h&&(clearTimeout(h),h=null)),("failed"===(null==d?void 0:d.connectionState)||"disconnected"===(null==d?void 0:d.connectionState))&&(e?(l.value="error",s.value="Connection lost",m||(m=setTimeout(()=>{m=null,g()},5e3))):(y=!0,p(),v()))},h=setTimeout(()=>{h=null,d&&"connected"!==d.connectionState&&(y=!0,p(),v())},5e3);const t=await d.createOffer();await d.setLocalDescription(t);const a={"Content-Type":"application/sdp",...i()},r=await fetch(`/api/cameras/webrtc?src=${encodeURIComponent(n.value)}`,{method:"POST",headers:a,body:t.sdp});if(!r.ok)throw new Error(`Server error: ${r.status}`);const u=await r.text();await d.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:u}))}catch{h&&(clearTimeout(h),h=null),y=!0,p(),v()}}}function v(){if(!n.value||!o.value)return;l.value="connecting",c.value="mse";const e=o.value;e.srcObject=null,f=new AbortController,e.src=`/api/cameras/stream/${encodeURIComponent(n.value)}`,e.play().catch(()=>{})}function p(){if(h&&(clearTimeout(h),h=null),d){try{d.close()}catch{}d=null}o.value&&(o.value.srcObject=null)}function b(){m&&(clearTimeout(m),m=null),p(),f&&(f.abort(),f=null),o.value&&(o.value.srcObject=null,o.value.src=""),c.value=null,l.value="idle"}function g(){b(),C()}return a(n,()=>{n.value?g():b()}),{videoEl:o,status:l,errorMessage:s,streamMode:c,connect:C,disconnect:b,reconnect:g,onVideoPlaying:function(){l.value="playing"}}}const d=t({__name:"CameraStream",__ssrInlineRender:!0,props:{cameraId:{},cameraName:{}},setup(t){const r=t,{videoEl:s,status:u,errorMessage:d}=D(n(()=>r.cameraId)),m=e(null);return a(m,e=>{s.value=e},{immediate:!0}),(e,n,a,r)=>{n(`<div${c(o({class:"relative bg-black rounded-lg overflow-hidden aspect-video group"},r))}>`),"connecting"===l(u)?n('<div class="absolute inset-0 flex items-center justify-center z-10"><div class="flex items-center gap-2 text-white/60"><svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><span class="text-base">Connecting...</span></div></div>'):n("\x3c!----\x3e"),"error"===l(u)?n(`<div class="absolute inset-0 flex flex-col items-center justify-center gap-3 z-10"><span class="text-red-400 text-base">${i(l(d))}</span><button class="px-4 py-1.5 bg-white/10 hover:bg-white/20 text-white text-base rounded-lg transition-colors"> Retry </button></div>`):n("\x3c!----\x3e"),n(`<video autoplay muted playsinline class="w-full h-full object-contain"></video><div class="absolute top-2 left-2 bg-black/60 text-white text-base px-2 py-0.5 rounded backdrop-blur-sm">${i(t.cameraName)}</div><button class="absolute top-2 right-2 bg-black/60 text-white/70 hover:text-white p-1.5 rounded opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm" title="Fullscreen"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg></button></div>`)}}}),m=d.setup;d.setup=(e,t)=>{const n=s();return(n.modules||(n.modules=new Set)).add("components/system/CameraStream.vue"),m?m(e,t):void 0};const h=Object.assign(d,{__name:"SystemCameraStream"});function H(){return{cameras:e([]),loading:e(!1),go2rtcRunning:e(!1),fetchCameras:async()=>{},addCamera:async e=>null,updateCamera:async(e,t)=>!1,deleteCamera:async e=>!1,testCamera:async e=>({success:!1,message:""})}}e([]),e(!1),e(!1);export{H,h as U};
