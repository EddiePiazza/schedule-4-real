import{_ as t,c as n}from"./server.mjs";import{ref as i,computed as r,readonly as o,defineComponent as c,watch as p,mergeProps as u,unref as b,isRef as h,createVNode as m,resolveDynamicComponent as x,useSSRContext as f,reactive as w}from"vue";import{ssrRenderAttrs as y,ssrRenderComponent as g,ssrRenderStyle as _,ssrRenderClass as R,ssrInterpolate as A,ssrRenderAttr as P,ssrRenderList as T,ssrIncludeBooleanAttr as C,ssrRenderVNode as I,ssrRenderTeleport as S}from"vue/server-renderer";import{Bars3Icon as D,MicrophoneIcon as j,QuestionMarkCircleIcon as M,ChevronLeftIcon as O,ChevronRightIcon as $,KeyIcon as U,GlobeAltIcon as L,Cog6ToothIcon as N,DocumentDuplicateIcon as K,CheckIcon as B,LockClosedIcon as z,LockOpenIcon as V,PencilSquareIcon as F,XMarkIcon as W,ShieldCheckIcon as H,EyeSlashIcon as Y,CodeBracketIcon as q,ArrowPathIcon as J,AdjustmentsHorizontalIcon as G,LinkIcon as X,ServerStackIcon as Q,DocumentTextIcon as Z,SignalIcon as ee,MagnifyingGlassIcon as ae,StarIcon as te}from"@heroicons/vue/24/solid";import{s as se}from"./_plugin-vue_export-helper-DlAUqK2U.mjs";import{StarIcon as ne}from"@heroicons/vue/24/outline";import*as ie from"three";import{GLTFLoader as re}from"three/addons/loaders/GLTFLoader.js";import{y as oe,b as le,U as de}from"./useImmersiveMode-CbESTZqa.mjs";var ce=Object.defineProperty,__publicField=(t,n,i)=>((t,n,i)=>n in t?ce(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i)(t,"symbol"!=typeof n?n+"":n,i);const pt=()=>{},ve=c({__name:"Room3dPrivacyInfo",__ssrInlineRender:!0,props:{modelValue:{type:Boolean}},emits:["update:modelValue"],setup(t,{emit:n}){const r=i("simple");return(n,i,o,c)=>{S(i,n=>{t.modelValue?(n('<div class="fixed inset-0 z-[200] flex items-center justify-center p-4" data-v-854eaa7a><div class="absolute inset-0 bg-black/80 backdrop-blur-sm" data-v-854eaa7a></div><div class="relative w-full max-w-3xl max-h-[85vh] flex flex-col rounded-2xl border border-white/10 bg-gray-950/95 shadow-2xl overflow-hidden" data-v-854eaa7a><button class="absolute top-4 right-4 z-10 p-1.5 rounded-lg text-white/40 hover:text-white/80 hover:bg-white/10 transition-all" data-v-854eaa7a>'),n(g(b(W),{class:"w-5 h-5"},null,o)),n('</button><div class="p-6 pb-4 border-b border-white/[0.06]" data-v-854eaa7a><div class="flex items-center gap-3" data-v-854eaa7a><div class="w-10 h-10 rounded-xl bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center" data-v-854eaa7a>'),n(g(b(H),{class:"w-5 h-5 text-emerald-400"},null,o)),n(`</div><div data-v-854eaa7a><h2 class="text-xl font-bold text-white" data-v-854eaa7a>Anonymous &amp; Private Rooms</h2><p class="text-base text-white/40" data-v-854eaa7a>How your privacy is protected</p></div></div><div class="flex gap-2 mt-4" data-v-854eaa7a><button class="${R(["px-4 py-2 text-base font-medium rounded-lg transition-all flex items-center gap-2","simple"===b(r)?"bg-emerald-500/20 text-emerald-400 border border-emerald-500/30":"text-white/40 hover:text-white/60 hover:bg-white/5"])}" data-v-854eaa7a>`),n(g(b(Y),{class:"w-4 h-4"},null,o)),n(` Simple </button><button class="${R(["px-4 py-2 text-base font-medium rounded-lg transition-all flex items-center gap-2","experts"===b(r)?"bg-amber-500/20 text-amber-400 border border-amber-500/30":"text-white/40 hover:text-white/60 hover:bg-white/5"])}" data-v-854eaa7a>`),n(g(b(q),{class:"w-4 h-4"},null,o)),n(' Experts </button></div></div><div class="flex-1 overflow-y-auto custom-scrollbar" data-v-854eaa7a>'),"simple"===b(r)?(n('<div class="p-6 space-y-6" data-v-854eaa7a><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(z),{class:"w-5 h-5 text-emerald-400"},null,o)),n(' What does &quot;Anonymous &amp; Private&quot; mean? </h3><p class="text-base text-white/60 leading-relaxed" data-v-854eaa7a> When you share your 3D room with someone, <strong class="text-white/80" data-v-854eaa7a>nobody can find out who you are</strong> or <strong class="text-white/80" data-v-854eaa7a>where your computer is</strong>. Not us, not the servers in between, not anyone listening on the network. Your room is like a secret meeting point that only the people you invite can reach. </p></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(J),{class:"w-5 h-5 text-sky-400"},null,o)),n(' How does it work? </h3><p class="text-base text-white/60 leading-relaxed mb-4" data-v-854eaa7a> Imagine you want to send a letter to a friend, but you don&#39;t want anyone to know who sent it or who received it. Instead of mailing it directly, you put the letter inside <strong class="text-white/80" data-v-854eaa7a>two sealed envelopes</strong>: </p><div class="bg-black/30 rounded-xl border border-white/[0.06] p-5 space-y-4" data-v-854eaa7a><div class="flex items-start gap-3" data-v-854eaa7a><div class="w-8 h-8 rounded-full bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center shrink-0 mt-0.5" data-v-854eaa7a><span class="text-emerald-400 font-bold text-base" data-v-854eaa7a>1</span></div><div data-v-854eaa7a><p class="text-base text-white/80 font-medium" data-v-854eaa7a>You seal the letter in an inner envelope</p><p class="text-base text-white/50 mt-1" data-v-854eaa7a>Only your friend has the key to open it. The relay servers can never read it.</p></div></div><div class="flex items-start gap-3" data-v-854eaa7a><div class="w-8 h-8 rounded-full bg-sky-500/20 border border-sky-500/30 flex items-center justify-center shrink-0 mt-0.5" data-v-854eaa7a><span class="text-sky-400 font-bold text-base" data-v-854eaa7a>2</span></div><div data-v-854eaa7a><p class="text-base text-white/80 font-medium" data-v-854eaa7a>You put that inside an outer envelope addressed to &quot;Relay A&quot;</p><p class="text-base text-white/50 mt-1" data-v-854eaa7a>Relay A opens its envelope and finds instructions: &quot;send this to Relay B&quot;. But Relay A can&#39;t open the inner envelope â€” it doesn&#39;t have the key.</p></div></div><div class="flex items-start gap-3" data-v-854eaa7a><div class="w-8 h-8 rounded-full bg-purple-500/20 border border-purple-500/30 flex items-center justify-center shrink-0 mt-0.5" data-v-854eaa7a><span class="text-purple-400 font-bold text-base" data-v-854eaa7a>3</span></div><div data-v-854eaa7a><p class="text-base text-white/80 font-medium" data-v-854eaa7a>Relay B passes it to your friend</p><p class="text-base text-white/50 mt-1" data-v-854eaa7a>Relay B knows the letter came from Relay A, but has no idea who originally sent it. Your friend opens the inner envelope and reads the letter.</p></div></div><div class="border-t border-white/[0.06] pt-4 mt-2" data-v-854eaa7a><div class="flex items-center justify-center gap-2 flex-wrap" data-v-854eaa7a><div class="px-3 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-center" data-v-854eaa7a><div class="text-lg" data-v-854eaa7a>ðŸ‘¤</div><div class="text-base font-medium text-emerald-400" data-v-854eaa7a>You</div></div><div class="text-white/20 text-base" data-v-854eaa7a>â†’ ðŸ”’ â†’</div><div class="px-3 py-2 bg-sky-500/10 border border-sky-500/20 rounded-lg text-center" data-v-854eaa7a><div class="text-lg" data-v-854eaa7a>ðŸ“¬</div><div class="text-base font-medium text-sky-400" data-v-854eaa7a>Relay A</div><div class="text-base text-white/30" data-v-854eaa7a>sees: you</div></div><div class="text-white/20 text-base" data-v-854eaa7a>â†’ ðŸ”’ â†’</div><div class="px-3 py-2 bg-purple-500/10 border border-purple-500/20 rounded-lg text-center" data-v-854eaa7a><div class="text-lg" data-v-854eaa7a>ðŸ“¬</div><div class="text-base font-medium text-purple-400" data-v-854eaa7a>Relay B</div><div class="text-base text-white/30" data-v-854eaa7a>sees: friend</div></div><div class="text-white/20 text-base" data-v-854eaa7a>â†’ ðŸ”’ â†’</div><div class="px-3 py-2 bg-amber-500/10 border border-amber-500/20 rounded-lg text-center" data-v-854eaa7a><div class="text-lg" data-v-854eaa7a>ðŸ‘¤</div><div class="text-base font-medium text-amber-400" data-v-854eaa7a>Friend</div></div></div><p class="text-base text-white/30 text-center mt-3" data-v-854eaa7a> No single relay knows both who sent it AND who received it </p></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(Y),{class:"w-5 h-5 text-emerald-400"},null,o)),n(' What the servers CANNOT see </h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-3" data-v-854eaa7a><div class="bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3" data-v-854eaa7a><span class="text-emerald-400 text-lg shrink-0" data-v-854eaa7a>âœ—</span><div data-v-854eaa7a><p class="text-base font-medium text-white/80" data-v-854eaa7a>Your IP address</p><p class="text-base text-white/40 mt-0.5" data-v-854eaa7a>The relay that talks to your friend doesn&#39;t know who you are</p></div></div><div class="bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3" data-v-854eaa7a><span class="text-emerald-400 text-lg shrink-0" data-v-854eaa7a>âœ—</span><div data-v-854eaa7a><p class="text-base font-medium text-white/80" data-v-854eaa7a>Your room content</p><p class="text-base text-white/40 mt-0.5" data-v-854eaa7a>3D objects, chat, voice â€” all encrypted end-to-end</p></div></div><div class="bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3" data-v-854eaa7a><span class="text-emerald-400 text-lg shrink-0" data-v-854eaa7a>âœ—</span><div data-v-854eaa7a><p class="text-base font-medium text-white/80" data-v-854eaa7a>Your room name or description</p><p class="text-base text-white/40 mt-0.5" data-v-854eaa7a>Even public room listings are encrypted blobs</p></div></div><div class="bg-emerald-500/5 border border-emerald-500/15 rounded-xl p-4 flex items-start gap-3" data-v-854eaa7a><span class="text-emerald-400 text-lg shrink-0" data-v-854eaa7a>âœ—</span><div data-v-854eaa7a><p class="text-base font-medium text-white/80" data-v-854eaa7a>Who is talking to whom</p><p class="text-base text-white/40 mt-0.5" data-v-854eaa7a>With 2 relays, neither one knows both sides</p></div></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(G),{class:"w-5 h-5 text-purple-400"},null,o)),n(' Two ways to share your room </h3><div class="space-y-3" data-v-854eaa7a><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4" data-v-854eaa7a><div class="flex items-center gap-2 mb-2" data-v-854eaa7a>'),n(g(b(U),{class:"w-4 h-4 text-emerald-400"},null,o)),n('<span class="text-base font-bold text-emerald-400" data-v-854eaa7a>Invite Only (default)</span></div><p class="text-base text-white/50 leading-relaxed" data-v-854eaa7a> Your room is completely invisible. You create a special link and send it to people you trust. The link looks like a random code â€” it doesn&#39;t contain your name, IP address, or any clue about your computer. Even if someone finds the link, they can&#39;t figure out where your server is. </p></div><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4" data-v-854eaa7a><div class="flex items-center gap-2 mb-2" data-v-854eaa7a>'),n(g(b(L),{class:"w-4 h-4 text-sky-400"},null,o)),n('<span class="text-base font-bold text-sky-400" data-v-854eaa7a>Public</span></div><p class="text-base text-white/50 leading-relaxed" data-v-854eaa7a> Your room appears in a public list so anyone can browse and join. But the directory is &quot;blind&quot; â€” it stores your room name as an encrypted blob that only visitors&#39; apps can decrypt. The servers that host the list have no idea what rooms they&#39;re listing. </p></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(X),{class:"w-5 h-5 text-teal-400"},null,o)),n(' About invite links </h3><p class="text-base text-white/60 leading-relaxed" data-v-854eaa7a> When you create an invite link, the URL points to a <strong class="text-white/80" data-v-854eaa7a>relay server</strong>, not your computer. The link contains an encrypted token that the relay passes along but <strong class="text-white/80" data-v-854eaa7a>cannot read</strong>. Think of it like giving someone a sealed envelope with a relay&#39;s address on it â€” the relay delivers the envelope but can&#39;t open it to see what&#39;s inside. </p></section><section class="bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-5" data-v-854eaa7a><div class="flex items-start gap-3" data-v-854eaa7a>'),n(g(b(H),{class:"w-6 h-6 text-emerald-400 shrink-0 mt-0.5"},null,o)),n('<div data-v-854eaa7a><p class="text-base font-bold text-emerald-400 mb-2" data-v-854eaa7a>The bottom line</p><p class="text-base text-white/60 leading-relaxed" data-v-854eaa7a> Your room connection bounces through 2 random servers. Each server only sees the server before and after it â€” never the full picture. All your data (3D objects, chat, voice, movements) is encrypted so that only you and your visitors can read it. No accounts, no phone numbers, no emails â€” just share a link and connect anonymously. </p></div></div></section></div>')):n("\x3c!----\x3e"),"experts"===b(r)?(n('<div class="p-6 space-y-6" data-v-854eaa7a><div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 flex items-start gap-3" data-v-854eaa7a>'),n(g(b(q),{class:"w-5 h-5 text-amber-400 shrink-0 mt-0.5"},null,o)),n('<div data-v-854eaa7a><p class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Fully auditable â€” all source files referenced below</p><p class="text-base text-white/50" data-v-854eaa7a> The entire relay and client communication stack is open source. Every claim in this document can be verified by reading the referenced source files. No trust required â€” verify it yourself. </p></div></div><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(J),{class:"w-5 h-5 text-sky-400"},null,o)),n(' Protocol Overview </h3><p class="text-base text-white/60 leading-relaxed mb-3" data-v-854eaa7a> The system implements a custom <strong class="text-white/80" data-v-854eaa7a>onion routing protocol</strong> with 2-hop circuits, inspired by Tor&#39;s design but purpose-built for real-time WebSocket communication. Connections are established via <strong class="text-white/80" data-v-854eaa7a>telescoping circuit extension</strong>: the client performs a key exchange with each relay sequentially, building a layered encryption tunnel. </p><div class="bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base" data-v-854eaa7a><div class="space-y-2 text-white/50" data-v-854eaa7a><div class="flex items-center gap-2" data-v-854eaa7a><span class="text-emerald-400 font-bold w-14 shrink-0 text-right" data-v-854eaa7a>Client</span><span class="text-white/20" data-v-854eaa7a>â”€â”€</span><span class="bg-emerald-500/15 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/20" data-v-854eaa7a>KX + encrypt(encrypt(data, K_B), K_A)</span><span class="text-white/20" data-v-854eaa7a>â”€â”€â–¶</span><span class="text-sky-400" data-v-854eaa7a>Relay A</span></div><div class="flex items-center gap-2 pl-20" data-v-854eaa7a><span class="text-white/20" data-v-854eaa7a>â”€â”€</span><span class="bg-sky-500/15 text-sky-400 px-2 py-0.5 rounded border border-sky-500/20" data-v-854eaa7a>decrypt(K_A) â†’ forward encrypt(data, K_B)</span><span class="text-white/20" data-v-854eaa7a>â”€â”€â–¶</span><span class="text-purple-400" data-v-854eaa7a>Relay B</span></div><div class="flex items-center gap-2 pl-40" data-v-854eaa7a><span class="text-white/20" data-v-854eaa7a>â”€â”€</span><span class="bg-purple-500/15 text-purple-400 px-2 py-0.5 rounded border border-purple-500/20" data-v-854eaa7a>decrypt(K_B) â†’ plaintext</span><span class="text-white/20" data-v-854eaa7a>â”€â”€â–¶</span><span class="text-amber-400 font-bold" data-v-854eaa7a>Peer</span></div><div class="pt-2 border-t border-white/[0.06] text-white/30" data-v-854eaa7a> K_A, K_B = independent XChaCha20-Poly1305 session keys per hop </div></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(z),{class:"w-5 h-5 text-amber-400"},null,o)),n(' Cryptographic Primitives </h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-3" data-v-854eaa7a><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Key Exchange</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>X25519 (Curve25519 Diffie-Hellman)</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>crypto.cjs â†’ clientSessionKeys() / serverSessionKeys()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Symmetric Cipher</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>XChaCha20-Poly1305 AEAD (256-bit key, 192-bit nonce)</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>crypto.cjs â†’ encrypt() / decrypt()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Authentication</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>Poly1305 MAC with per-circuit AAD (circuit ID as associated data)</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>relay.cjs â†’ sendToCircuit() aad = circuitId</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Hash Function</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>BLAKE2b (used for metadata key derivation)</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>useOnionClient.ts â†’ crypto_generichash()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Gossip Signing</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>Ed25519 digital signatures on peer announcements</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>gossip.cjs â†’ signAnnouncement() / verifyAnnouncement()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-amber-400 mb-1" data-v-854eaa7a>Library</div><div class="text-base text-white/50 mb-2" data-v-854eaa7a>libsodium (NaCl) â€” server: sodium-native, client: libsodium-wrappers-sumo</div><div class="text-base text-white/30 font-mono" data-v-854eaa7a>Audited, battle-tested, no custom crypto</div></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(Q),{class:"w-5 h-5 text-purple-400"},null,o)),n(' Circuit Lifecycle </h3><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-3" data-v-854eaa7a><div class="flex items-start gap-3" data-v-854eaa7a><span class="text-emerald-400 font-bold text-base w-5 shrink-0" data-v-854eaa7a>1.</span><div data-v-854eaa7a><p class="text-base text-white/70 font-medium" data-v-854eaa7a>Handshake with Relay A</p><p class="text-base text-white/40" data-v-854eaa7a>Client generates ephemeral X25519 keypair, sends public key + random circuit ID. Relay A derives shared keys via crypto_kx_server_session_keys(). Client derives same keys via crypto_kx_client_session_keys().</p><p class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>relay.cjs:137 â†’ handleHandshake()</p></div></div><div class="flex items-start gap-3" data-v-854eaa7a><span class="text-sky-400 font-bold text-base w-5 shrink-0" data-v-854eaa7a>2.</span><div data-v-854eaa7a><p class="text-base text-white/70 font-medium" data-v-854eaa7a>Circuit extension to Relay B</p><p class="text-base text-white/40" data-v-854eaa7a>Client sends a RELAY message (0x10) through the encrypted tunnel to Relay A, containing Relay B&#39;s URL + a new handshake for Relay B. Relay A opens a WebSocket to Relay B and forwards the handshake â€” it cannot read Relay B&#39;s session keys.</p><p class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>relay.cjs:290 â†’ forwardToHop()</p></div></div><div class="flex items-start gap-3" data-v-854eaa7a><span class="text-purple-400 font-bold text-base w-5 shrink-0" data-v-854eaa7a>3.</span><div data-v-854eaa7a><p class="text-base text-white/70 font-medium" data-v-854eaa7a>Two-layer encryption established</p><p class="text-base text-white/40" data-v-854eaa7a>Client now has independent session keys with both relays. Every packet is double-encrypted: first with Relay B&#39;s key, then with Relay A&#39;s key. Each relay peels exactly one layer and forwards the rest.</p><p class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>useOnionClient.ts â†’ OnionCircuit.build()</p></div></div><div class="flex items-start gap-3" data-v-854eaa7a><span class="text-amber-400 font-bold text-base w-5 shrink-0" data-v-854eaa7a>4.</span><div data-v-854eaa7a><p class="text-base text-white/70 font-medium" data-v-854eaa7a>Rendezvous point</p><p class="text-base text-white/40" data-v-854eaa7a>Room host establishes a rendezvous on Relay B with a random 20-byte cookie. Visitor joins the rendezvous with the same cookie. Relay B pairs the two circuits â€” it never sees the content (still E2E encrypted between peers).</p><p class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>rendezvous.cjs â†’ establishRendezvous() / joinRendezvous()</p></div></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(Z),{class:"w-5 h-5 text-sky-400"},null,o)),n(' Wire Format </h3><div class="bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base text-white/50 space-y-2" data-v-854eaa7a><p class="text-white/70" data-v-854eaa7a>Packet on the wire (encrypted):</p><p data-v-854eaa7a>| nonce (24B) | circuit_id (4B) | ciphertext (MAC 16B + payload) |</p><p class="text-white/70 mt-3" data-v-854eaa7a>Decrypted inner message:</p><p data-v-854eaa7a>| msg_type (1B) | next_hop_len (1B) | [next_hop] | payload_len (2B) | payload |</p><p class="text-white/70 mt-3" data-v-854eaa7a>Message types (relay.cjs MSG enum):</p><p data-v-854eaa7a>0x01 HANDSHAKE_INIT Â  0x02 HANDSHAKE_REPLY</p><p data-v-854eaa7a>0x10 RELAY (extend) Â Â  0x20 DATA (E2E payload)</p><p data-v-854eaa7a>0x30 ESTABLISH_RENDEZVOUS Â  0x33 RENDEZVOUS_JOIN</p><p data-v-854eaa7a>0x40-0x45 TRACKER_* Â  0xF0 CIRCUIT_DESTROY</p><p data-v-854eaa7a>0xFF CHAFF (noise, dropped on receipt)</p></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(ee),{class:"w-5 h-5 text-rose-400"},null,o)),n(' Traffic Analysis Resistance </h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-3" data-v-854eaa7a><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-rose-400 mb-1" data-v-854eaa7a>Fixed Packet Size</div><div class="text-base text-white/50" data-v-854eaa7a>All packets padded to 1024 bytes (configurable). No payload size leakage.</div><div class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>crypto.cjs â†’ padPacket()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-rose-400 mb-1" data-v-854eaa7a>Chaff Traffic</div><div class="text-base text-white/50" data-v-854eaa7a>Random noise packets (0xFF) between relay peers. Hides when real data flows.</div><div class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>chaff.cjs â†’ startChaff()</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-rose-400 mb-1" data-v-854eaa7a>Timing Jitter</div><div class="text-base text-white/50" data-v-854eaa7a>Configurable random delay (maxJitter) on message forwarding to resist timing correlation.</div><div class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>relay.cjs:133 â†’ setTimeout(processMessage, jitter)</div></div><div class="bg-black/30 rounded-lg border border-white/[0.06] p-3" data-v-854eaa7a><div class="text-base font-bold text-rose-400 mb-1" data-v-854eaa7a>Key Rotation</div><div class="text-base text-white/50" data-v-854eaa7a>Relay keypairs rotate every 60 min. Previous keypair accepted for 2 min grace period, then zeroed.</div><div class="text-base text-white/30 font-mono mt-1" data-v-854eaa7a>relay.cjs:352 â†’ rotateKeys()</div></div></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(Q),{class:"w-5 h-5 text-emerald-400"},null,o)),n(' Blind Tracker Design </h3><p class="text-base text-white/60 leading-relaxed mb-3" data-v-854eaa7a> The room tracker (for public room discovery) is designed so that it <strong class="text-white/80" data-v-854eaa7a>cannot read any room metadata</strong>. Room listings are encrypted client-side with a symmetric key derived from a well-known seed using BLAKE2b. All clients derive the same key, so they can decrypt listings â€” but the tracker itself only stores opaque base64 blobs. </p><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-2 text-base" data-v-854eaa7a><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-emerald-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>Encrypted metadata:</strong> Room name, description, envId â€” all encrypted with XChaCha20-Poly1305 before reaching the tracker</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-emerald-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>No IP addresses stored:</strong> Rooms identified by relay WebSocket URL only (e.g. wss://relay.example.com/relay)</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-emerald-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>In-memory only:</strong> Room listings stored in JavaScript Maps, never persisted to disk. TTL-based expiry.</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-emerald-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>Registration through circuits:</strong> Room registration (TRACKER_REGISTER 0x40) travels through the onion circuit, so the tracker never sees the registrant&#39;s IP</span></div><p class="text-white/30 font-mono pt-2 border-t border-white/[0.06]" data-v-854eaa7a> tracker.cjs â†’ processRegister() | useOnionClient.ts â†’ publishRoom() </p></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(L),{class:"w-5 h-5 text-blue-400"},null,o)),n(' Gossip Protocol &amp; Peer Discovery </h3><p class="text-base text-white/60 leading-relaxed mb-3" data-v-854eaa7a> Relays discover each other via a gossip protocol. Each relay generates an Ed25519 identity keypair on first boot and announces itself to known peers. Announcements include the relay&#39;s URL, public keys, tracker status, and a timestamp â€” all signed with the relay&#39;s Ed25519 key. </p><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4 space-y-2 text-base" data-v-854eaa7a><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-blue-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>Ed25519 signatures:</strong> Every announcement is signed â€” relays reject announcements with invalid signatures or timestamps in the future</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-blue-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>Propagation:</strong> When a relay receives a new peer, it gossips the announcement to all other known peers (flood fill with deduplication)</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-blue-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>TTL expiry:</strong> Peers that don&#39;t re-announce within the TTL window are pruned. No permanent storage of peer data.</span></div><div class="flex items-start gap-2" data-v-854eaa7a><span class="text-blue-400 shrink-0" data-v-854eaa7a>âœ“</span><span class="text-white/50" data-v-854eaa7a><strong class="text-white/70" data-v-854eaa7a>Client peer directory:</strong> Clients fetch /peers from known relays, probe latency, and cache results in localStorage. Relays sorted by latency for optimal circuit building.</span></div><p class="text-white/30 font-mono pt-2 border-t border-white/[0.06]" data-v-854eaa7a> gossip.cjs â†’ announceToAll() / handleAnnouncement() | useOnionClient.ts â†’ refreshPeerDirectory() </p></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(X),{class:"w-5 h-5 text-teal-400"},null,o)),n(' Invite Link Token Format </h3><div class="bg-black/40 rounded-xl border border-white/[0.06] p-4 font-mono text-base text-white/50 space-y-2" data-v-854eaa7a><p class="text-white/70" data-v-854eaa7a>Token structure:</p><p data-v-854eaa7a>ROOMKEY.BASE64(xchacha20_encrypt(envId, metadataKey))</p><p class="text-white/70 mt-3" data-v-854eaa7a>Where:</p><p data-v-854eaa7a>metadataKey = BLAKE2b(32, &quot;spiderfarmer-room-metadata-v1&quot;)</p><p data-v-854eaa7a>ROOMKEY = 32-byte random key stored in data/room3d/tunnel-key.json</p><p class="text-white/70 mt-3" data-v-854eaa7a>The URL points to a relay domain:</p><p data-v-854eaa7a>https://relay.example.com/join/ROOMKEY.TOKEN</p><p class="text-white/30 mt-3 border-t border-white/[0.06] pt-2" data-v-854eaa7a>The relay resolves the room key to a connected tunnel host, creates a session cookie, and proxies the visitor&#39;s connection. The relay never sees the decrypted envId.</p></div></section><section data-v-854eaa7a><h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2" data-v-854eaa7a>'),n(g(b(q),{class:"w-5 h-5 text-amber-400"},null,o)),n(' Source File Reference </h3><div class="bg-black/30 rounded-xl border border-white/[0.06] p-4" data-v-854eaa7a><div class="grid grid-cols-1 gap-2 text-base" data-v-854eaa7a><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/relay.cjs</span><span class="text-white/50" data-v-854eaa7a>Circuit management, packet handling, handshake, message routing, rendezvous forwarding</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/crypto.cjs</span><span class="text-white/50" data-v-854eaa7a>X25519 key exchange, XChaCha20-Poly1305 encrypt/decrypt, packet padding, random bytes</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/circuits.cjs</span><span class="text-white/50" data-v-854eaa7a>Circuit registry (Map), collision detection, circuit TTL, destroy logic</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/rendezvous.cjs</span><span class="text-white/50" data-v-854eaa7a>Rendezvous point management â€” cookie-based circuit pairing for E2E data relay</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/tracker.cjs</span><span class="text-white/50" data-v-854eaa7a>Blind tracker â€” stores encrypted room blobs, TTL expiry, TRACKER_* message handling</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/gossip.cjs</span><span class="text-white/50" data-v-854eaa7a>Peer discovery â€” Ed25519-signed announcements, flood propagation, peer pruning</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/chaff.cjs</span><span class="text-white/50" data-v-854eaa7a>Chaff traffic generator â€” random noise packets between relay peers</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/rate-limit.cjs</span><span class="text-white/50" data-v-854eaa7a>Per-IP rate limiting for all HTTP and WebSocket endpoints</span></div><div class="flex items-start gap-3 py-1.5 border-b border-white/[0.04]" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>relay/index.cjs</span><span class="text-white/50" data-v-854eaa7a>HTTP server, CORS, WebSocket upgrade, join page, tunnel proxy, tracker integration</span></div><div class="flex items-start gap-3 py-1.5" data-v-854eaa7a><span class="text-amber-400 font-mono w-56 shrink-0" data-v-854eaa7a>useOnionClient.ts</span><span class="text-white/50" data-v-854eaa7a>Client composable â€” circuit building, room publishing, peer discovery, E2E crypto, rendezvous</span></div></div><p class="text-base text-white/30 mt-3 pt-2 border-t border-white/[0.06]" data-v-854eaa7a> All files located under <span class="font-mono" data-v-854eaa7a>src/services/relay/</span> (server) and <span class="font-mono" data-v-854eaa7a>app/composables/room3d/</span> (client) </p></div></section><section class="bg-black/30 rounded-xl border border-white/[0.06] p-4" data-v-854eaa7a><h3 class="text-base font-bold text-white/60 uppercase tracking-wider mb-3" data-v-854eaa7a>Technical Summary</h3><div class="grid grid-cols-2 gap-x-6 gap-y-2 text-base" data-v-854eaa7a><div class="text-white/40" data-v-854eaa7a>Protocol</div><div class="text-white/70" data-v-854eaa7a>Onion routing, 2-hop circuits (telescoping extension)</div><div class="text-white/40" data-v-854eaa7a>Key Exchange</div><div class="text-white/70" data-v-854eaa7a>X25519 (Curve25519 DH)</div><div class="text-white/40" data-v-854eaa7a>Symmetric Cipher</div><div class="text-white/70" data-v-854eaa7a>XChaCha20-Poly1305 AEAD (256-bit key, 192-bit nonce)</div><div class="text-white/40" data-v-854eaa7a>MAC / Authentication</div><div class="text-white/70" data-v-854eaa7a>Poly1305 with circuit ID as AAD</div><div class="text-white/40" data-v-854eaa7a>Hash Function</div><div class="text-white/70" data-v-854eaa7a>BLAKE2b (key derivation, metadata)</div><div class="text-white/40" data-v-854eaa7a>Gossip Signatures</div><div class="text-white/70" data-v-854eaa7a>Ed25519 (peer announcements)</div><div class="text-white/40" data-v-854eaa7a>Packet Size</div><div class="text-white/70" data-v-854eaa7a>Fixed 1024 bytes (padded)</div><div class="text-white/40" data-v-854eaa7a>Key Rotation</div><div class="text-white/70" data-v-854eaa7a>Every 60 minutes (2-min grace period)</div><div class="text-white/40" data-v-854eaa7a>Logging</div><div class="text-white/70" data-v-854eaa7a>Zero â€” no connection, traffic, or metadata logs</div><div class="text-white/40" data-v-854eaa7a>Tracker Storage</div><div class="text-white/70" data-v-854eaa7a>In-memory Maps only (JavaScript), TTL-based expiry</div><div class="text-white/40" data-v-854eaa7a>Library</div><div class="text-white/70" data-v-854eaa7a>libsodium (sodium-native server, libsodium-wrappers-sumo client)</div><div class="text-white/40" data-v-854eaa7a>Peer Discovery</div><div class="text-white/70" data-v-854eaa7a>Gossip protocol with Ed25519-signed announcements, flood propagation</div></div></section></div>')):n("\x3c!----\x3e"),n("</div></div></div>")):n("\x3c!----\x3e")},"body",!1,o)}}}),pe=ve.setup;ve.setup=(t,n)=>{const i=f();return(i.modules||(i.modules=new Set)).add("components/room3d/Room3dPrivacyInfo.vue"),pe?pe(t,n):void 0};const ue=Object.assign(se(ve,[["__scopeId","data-v-854eaa7a"]]),{__name:"Room3dPrivacyInfo"}),be=24,he=16,me=32,xe=16,fe=32,ye=48,ge=49,ke=51,_e=64,Re=65,Pe=66,Te=67,Ce=68,Ee=69;let De=null,je=null;async function Ie(){return De||(je||(je=import("libsodium-wrappers").then(async t=>{const n=t.default||t;return await n.ready,De=n,n})),je)}function ra(t,n,i){const r=De,o=r.randombytes_buf(be),c=new Uint8Array(4);new DataView(c.buffer).setUint32(0,i);const p=r.crypto_aead_xchacha20poly1305_ietf_encrypt(t,c,null,o,n),u=new Uint8Array(o.length+p.length);return u.set(o),u.set(p,o.length),u}function la(t,n,i){const r=De;if(t.length<40)return null;const o=t.subarray(0,be),c=t.subarray(be),p=new Uint8Array(4);new DataView(p.buffer).setUint32(0,i);try{return r.crypto_aead_xchacha20poly1305_ietf_decrypt(null,c,p,o,n)}catch{return null}}function ft(t,n,i){const r=n?(new TextEncoder).encode(n):new Uint8Array(0),o=new Uint8Array(2+r.length+2+i.length);return o[0]=t,o[1]=r.length,o.set(r,2),new DataView(o.buffer).setUint16(2+r.length,i.length),o.set(i,4+r.length),o}function Me(t){return Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join("")}function xt(t){const n=De,i=De.randombytes_buf(32),r=(new TextEncoder).encode(t),o=new Uint8Array(r.length+i.length);return o.set(r),o.set(i,r.length),n.crypto_generichash(32,o)}class Ae{constructor(){__publicField(this,"hops",[]),__publicField(this,"ws",null),__publicField(this,"circuitId",0),__publicField(this,"messageQueue",[]),__publicField(this,"dataCallback",null),__publicField(this,"_destroyed",!1)}async build(t){const n=(await Ie()).randombytes_buf(4);this.circuitId=new DataView(n.buffer).getUint32(0);const i=t[0];this.ws=new WebSocket(i.url),this.ws.binaryType="arraybuffer",await new Promise((t,n)=>{this.ws.onopen=()=>t(),this.ws.onerror=()=>n(new Error(`Failed to connect to relay ${i.url}`))}),this.ws.onclose=()=>{this._destroyed};const r=await this._handshakeWithRelay();this.hops.push({url:i.url,sessionRx:r.rx,sessionTx:r.tx,publicKey:r.serverPk}),this.ws.onmessage=t=>{const n=new Uint8Array(t.data);this._handleIncoming(n)};for(let n=1;n<t.length;n++){const i=t[n],r=await this._extendCircuit(i);this.hops.push({url:i.url,sessionRx:r.rx,sessionTx:r.tx,publicKey:r.serverPk})}}send(t,n,i=null){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let r=ft(n,i,t);for(let t=this.hops.length-1;t>=0;t--){const n=this.hops[t];t===this.hops.length-1||(r=ft(xe,this.hops[t+1].url,r));const i=ra(r,n.sessionTx,this.circuitId),o=i.subarray(0,be),c=i.subarray(be);r=new Uint8Array(28+c.length),r.set(o,0),new DataView(r.buffer).setUint32(be,this.circuitId),r.set(c,28)}this.ws.send(r)}onData(t){this.dataCallback=t}destroy(){this._destroyed=!0,this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.ws=null);for(const t of this.hops)t.sessionRx.fill(0),t.sessionTx.fill(0);this.hops=[],this.messageQueue=[]}_handleIncoming(t){let n=t;for(const t of this.hops){const i=la(n,t.sessionRx,this.circuitId);if(!i)return;n=i}const i=function(t){if(t.length<4)return null;const n=t[0],i=t[1],r=i>0?(new TextDecoder).decode(t.subarray(2,2+i)):null,o=new DataView(t.buffer,t.byteOffset).getUint16(2+i);return{type:n,nextHop:r,payload:t.subarray(4+i,4+i+o)}}(n);if(i){if(this.messageQueue.length>0)return void this.messageQueue.shift().resolve({type:i.type,payload:i.payload});this.dataCallback&&this.dataCallback(i.type,i.payload)}}_waitForMessage(t=1e4){return new Promise((n,i)=>{const r=setTimeout(()=>{const t=this.messageQueue.findIndex(t=>t.resolve===n);t>=0&&this.messageQueue.splice(t,1),i(new Error("Timeout waiting for relay response"))},t);this.messageQueue.push({resolve:t=>{clearTimeout(r),n(t)}})})}async _handshakeWithRelay(){var t;const n=De,i=n.crypto_kx_keypair(),r=new Uint8Array(60),o=n.randombytes_buf(be);r.set(o,0),new DataView(r.buffer).setUint32(be,this.circuitId),r.set(i.publicKey,28),this.ws.send(function(t,n){if(t.length>=n)return t.subarray(0,n);const i=new Uint8Array(n);i.set(t);const r=De.randombytes_buf(n-t.length);return i.set(r,t.length),i}(r,512));const c=await new Promise((t,n)=>{const i=setTimeout(()=>{this.ws.onmessage=null,n(new Error("Handshake timeout"))},1e4);this.ws.onmessage=n=>{clearTimeout(i),t(new Uint8Array(n.data))}}),p=new Uint8Array([83,70,80,75]);let u,b,h;if(c.length>=4&&c[0]===p[0]&&c[1]===p[1]&&c[2]===p[2]&&c[3]===p[3])u=c.subarray(4,36),b=c.subarray(36,60),h=c.subarray(64);else{const i=0===this.hops.length?null==(t=this.ws)?void 0:t.url:"";if(!i)throw new Error("Cannot determine relay URL for PK fetch");const r=i.replace(/^wss:/,"https:").replace(/^ws:/,"http:")+"/pk",o=await fetch(r);if(!o.ok)throw new Error(`Failed to fetch relay PK from ${r}`);const p=await o.json();u=n.from_hex(p.publicKey),b=c.subarray(0,be),h=c.subarray(28)}const m=n.crypto_kx_client_session_keys(i.publicKey,i.privateKey,u),x=h.subarray(0,49),f=new Uint8Array(4);new DataView(f.buffer).setUint32(0,this.circuitId);try{n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,x,f,b,m.sharedRx)}catch{throw new Error("Handshake verification failed â€” relay rejected or key mismatch")}return{rx:m.sharedRx,tx:m.sharedTx,serverPk:new Uint8Array(u)}}async _extendCircuit(t){const n=De,i=n.crypto_kx_keypair(),r=new Uint8Array(60),o=n.randombytes_buf(be);r.set(o,0),new DataView(r.buffer).setUint32(be,this.circuitId),r.set(i.publicKey,28),this.send(r,xe,t.url);const c=(await this._waitForMessage()).payload,p=new Uint8Array([83,70,80,75]),u=c.length>=4&&c[0]===p[0]&&c[1]===p[1]&&c[2]===p[2]&&c[3]===p[3]?4:0;if(c.length<u+me+be+4+he+1)throw new Error("Extend handshake reply too short");const b=c.subarray(u,u+me),h=n.crypto_kx_client_session_keys(i.publicKey,i.privateKey,b);return{rx:h.sharedRx,tx:h.sharedTx,serverPk:new Uint8Array(b)}}}class yt{constructor(){__publicField(this,"rx",new Uint8Array(0)),__publicField(this,"tx",new Uint8Array(0)),__publicField(this,"nonceCounter",0)}async initAsClient(t){const n=(await Ie()).crypto_kx_keypair();return this._keypair=n,n.publicKey}async completeAsClient(t){const n=De,i=this._keypair,r=n.crypto_kx_client_session_keys(i.publicKey,i.privateKey,t);this.rx=r.sharedRx,this.tx=r.sharedTx}async initAsServer(t){const n=await Ie(),i=n.crypto_kx_keypair(),r=n.crypto_kx_server_session_keys(i.publicKey,i.privateKey,t);return this.rx=r.sharedRx,this.tx=r.sharedTx,i.publicKey}encrypt(t){const n=De,i=n.randombytes_buf(be),r=n.crypto_aead_xchacha20poly1305_ietf_encrypt(t,null,null,i,this.tx),o=new Uint8Array(i.length+r.length);return o.set(i),o.set(r,i.length),o}decrypt(t){const n=De;if(t.length<40)return null;const i=t.subarray(0,be),r=t.subarray(be);try{return n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,r,null,i,this.rx)}catch{return null}}destroy(){this.rx.fill(0),this.tx.fill(0)}}let Oe=[],$e=null,Ue={};const Le=["wss://schedule4real.com/rooms","wss://r2.imaset.com"];function Dt(t){if(!t||"string"!=typeof t||!t.startsWith("wss://")&&!t.startsWith("ws://")||t.length>256)return!1;try{const n=new URL(t.replace(/^wss:/,"https:").replace(/^ws:/,"http:")).hostname;return!("localhost"===n||"127.0.0.1"===n||"::1"===n||"0.0.0.0"===n||/^10\./.test(n)||/^172\.(1[6-9]|2\d|3[01])\./.test(n)||/^192\.168\./.test(n)||/^169\.254\./.test(n))}catch{return!1}}function Se(t){const n=t.replace(/^wss:/,"https:").replace(/^ws:/,"http:");try{const t=new URL(n);return`${t.protocol}//${t.host}`}catch{return n}}async function Ne(){var t;const n=[...Le,...Oe.filter(t=>!Le.includes(t.url)).map(t=>t.url)];try{const{peers:i,relayRtts:r,meshRtts:o}=await async function(t){const n=t.map(t=>Se(t)),i=await $fetch("/api/room3d/onion-peers",{params:{relays:n.join(",")},timeout:1e4});return(null==i?void 0:i.peers)&&Array.isArray(i.peers)?{peers:i.peers.slice(0,200).filter(t=>t.url&&Dt(t.url)).map(t=>({url:t.url,pk:t.pk||"",tracker:!!t.tracker,failures:Math.min(t.failures||0,5),latency:1/0,lastSeen:t.lastSeen||0})),relayRtts:i.relayRtts||{},meshRtts:i.meshRtts||{}}:{peers:[],relayRtts:{},meshRtts:{}}}(n);!function(t){for(const n of t){if(!Dt(n.url))continue;const t=Oe.find(t=>t.url===n.url);if(t)n.pk&&!t.pk&&(t.pk=n.pk),n.tracker&&(t.tracker=!0),n.lastSeen>t.lastSeen&&(t.lastSeen=n.lastSeen);else{if(Oe.length>=200)continue;Oe.push({...n})}}}(i);for(const t of Oe){const n=Se(t.url);void 0!==r[n]&&(t.latency=r[n])}Ue={};for(const[n,i]of Object.entries(o)){const r=null==(t=Oe.find(t=>Se(t.url)===n))?void 0:t.url;r&&(Ue[r]=i)}Oe.sort((t,n)=>{if(t.failures!==n.failures)return t.failures-n.failures;const i=isFinite(t.latency)?0:1,r=isFinite(n.latency)?0:1;if(i!==r)return i-r;if(isFinite(t.latency)&&isFinite(n.latency)&&t.latency!==n.latency)return t.latency-n.latency;const o=Le.includes(t.url)?0:1,c=Le.includes(n.url)?0:1;return o!==c?o-c:n.lastSeen-t.lastSeen});Object.keys(r).length}catch{}}function we(){return Oe.filter(t=>t.failures<5).map(t=>({url:t.url,publicKey:new Uint8Array(me)}))}function wt(t){const n=Oe.find(n=>n.url===t);n&&n.failures++}let Ke=!1,Be=null;const ze=[];let Ve=null,Fe=null,We=null;function wa(){const t=i(!1),r=i(!1),c=i([]),p=i(!1),u=i(null);async function l(){if(Ke)t.value=!0;else try{await Ie();const i=n(),r=[i.public.onionRelayA||Le[0],i.public.onionRelayB||Le[1]].filter(Boolean),o=[];o.length&&(Oe=o);for(const t of r)Oe.find(n=>n.url===t)||Oe.push({url:t,pk:"",tracker:!0,failures:0,latency:1/0,lastSeen:0});Be=De.crypto_generichash(32,(new TextEncoder).encode("spiderfarmer-room-metadata-v1")),Ke=!0,t.value=!0,Ne().catch(()=>{}),$e||($e=void 0)}catch(t){u.value=t.message}}async function d(t){var n,i,r,o;if(t){const n=new Ae;return await n.build(t),ze.push(n),n}const c=we();if(!c.length)throw new Error("No usable relays available");if(c.length>=2){const t=[],p=Math.min(c.length,8);for(let u=0;u<p-1;u++)for(let b=u+1;b<p;b++){const p=c[u].url,h=c[b].url,m=Oe.find(t=>t.url===p),x=Oe.find(t=>t.url===h),f=null!=(n=null==m?void 0:m.latency)?n:1/0,w=null!=(i=null==x?void 0:x.latency)?i:1/0,y=null!=(o=null==(r=Ue[p])?void 0:r[h])?o:1/0;let g;if(isFinite(f)&&isFinite(w)){g=f+(isFinite(y)?y:f+w)+w}else g=isFinite(f)||isFinite(w)?(isFinite(f)?f:500)+(isFinite(w)?w:500):1e4+100*u+b;t.push({i:u,j:b,score:g})}t.sort((t,n)=>t.score-n.score);for(const{i:n,j:i}of t.slice(0,6))try{const t=new Ae;return await t.build([c[n],c[i]]),ze.push(t),t}catch{wt(c[n].url)}}for(const t of c)try{const n=new Ae;return await n.build([t]),ze.push(n),n}catch{wt(t.url)}await Ne();const p=we();if(p.length){const t=new Ae;return await t.build([p[0]]),ze.push(t),t}throw new Error("All relay circuits failed")}function k(t){if(!Be||t.length<40)return null;const n=De,i=t.subarray(0,be),r=t.subarray(be);try{const t=n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,r,null,i,Be),o=(new TextDecoder).decode(t);return JSON.parse(o)}catch{return null}}async function E(){const t=De,n=Oe.filter(t=>t.tracker&&t.failures<5).map(t=>Se(t.url)),i=new Map;if(!n.length)return[];try{const r=await $fetch("/api/room3d/onion-rooms",{params:{trackers:n.join(",")},timeout:1e4});if(null==r?void 0:r.rooms)for(const n of r.rooms)if(!i.has(n.id))try{const r=k(t.from_base64(n.metadata,t.base64_variants.ORIGINAL));r&&i.set(n.id,{roomId:n.id,envId:r.envId,name:r.name,description:r.description,capacity:r.capacity,tags:r.tags,entryRelay:n.relay})}catch{}}catch{}return[...i.values()]}return{isReady:o(t),isPublishing:o(r),isDiscovering:o(p),publicRooms:o(c),connectionError:o(u),init:l,publishRoom:async function(t){var n;Ke||await l(),r.value=!0,u.value=null;try{const i=xt(t.envId),o=function(t){if(!Be)throw new Error("Not initialized");const n=De,i=JSON.stringify(t),r=(new TextEncoder).encode(i),o=n.randombytes_buf(be),c=n.crypto_aead_xchacha20poly1305_ietf_encrypt(r,null,null,o,Be),p=new Uint8Array(o.length+c.length);return p.set(o),p.set(c,o.length),p}({envId:t.envId,name:t.name,description:t.description,capacity:t.capacity||8,tags:t.tags||[]}),c=await d(),p=(null==(n=we()[0])?void 0:n.url)||Le[0],u=(new TextEncoder).encode(p),b=t.private?1:0,h=new Uint8Array(36+u.length+o.length);h[0]=_e,h[1]=b,h.set(i,2),new DataView(h.buffer).setUint16(34,u.length),h.set(u,36),h.set(o,36+u.length),c.send(h,_e);const m=Me(i);We=void 0,Ve=c,c.onData((n,i)=>{n===Ee&&async function(t,n){const i=De;if(t.length<23)return;const r=t.subarray(0,20),o=new DataView(t.buffer,t.byteOffset+20).getUint16(0),c=(new TextDecoder).decode(t.subarray(22,22+o));let p=we().find(t=>t.url===c);p||(p={url:c,publicKey:new Uint8Array(me)});const u=we().filter(t=>t.url!==c),b=u.length>0?[u[0],p]:[p],h=await d(b),m=i.crypto_kx_keypair(),x=new Uint8Array(52);x.set(r),x.set(m.publicKey,20),h.send(x,ke);const f=await Promise.race([new Promise(t=>{h.onData((n,i)=>{n===fe&&i.length>=me&&t(i.subarray(0,me))})}),new Promise((t,n)=>setTimeout(()=>n(new Error("Visitor PK timeout")),15e3))]),w=i.crypto_kx_server_session_keys(m.publicKey,m.privateKey,f),y=new yt;y.rx=w.sharedRx,y.tx=w.sharedTx;const g=(new TextEncoder).encode(JSON.stringify({envId:n})),_=y.encrypt(g);h.send(_,fe),setTimeout(()=>{y.destroy(),h.destroy();const t=ze.indexOf(h);t>=0&&ze.splice(t,1)},3e3)}(i,t.envId).catch(t=>{})});const x={roomId:m,keepAlive:()=>{var t;if((null==(t=c.ws)?void 0:t.readyState)===WebSocket.OPEN){const t=new Uint8Array(33);t[0]=Te,t.set(i,1),c.send(t,Te)}},unpublish:()=>{We&&clearInterval(We),We=null,c.destroy(),Ve=null,Fe=null,r.value=!1}};return Fe=x,r.value=!1,x}catch(t){return u.value=t.message,r.value=!1,null}},discoverRooms:async function(){Ke||await l(),p.value=!0,u.value=null;let t=[];try{const n=async function(){const t=[],n=await d(),i=new Uint8Array(7);i[0]=Re,new DataView(i.buffer).setUint32(1,0),new DataView(i.buffer).setUint16(5,50);const r=new Promise(t=>{n.onData((n,i)=>{n===Pe&&t(i)})});n.send(i,Re);const o=await Promise.race([r,new Promise((t,n)=>setTimeout(()=>n(new Error("Tracker query timeout")),8e3))]);if(o.length>=6){const n=new DataView(o.buffer,o.byteOffset).getUint16(4);let i=6;for(let r=0;r<n&&i<o.length&&!(i+36>o.length);r++){const n=o.subarray(i,i+32),r=new DataView(o.buffer,o.byteOffset+i+32).getUint16(0),c=(new TextDecoder).decode(o.subarray(i+34,i+34+r)),p=new DataView(o.buffer,o.byteOffset+i+34+r).getUint16(0),u=o.subarray(i+36+r,i+36+r+p),b=Me(n),h=k(u);h&&t.push({roomId:b,envId:h.envId,name:h.name,description:h.description,capacity:h.capacity,tags:h.tags,entryRelay:c}),i+=36+r+p}}n.destroy();const c=ze.indexOf(n);return c>=0&&ze.splice(c,1),t}().then(t=>({source:"circuit",rooms:t})).catch(()=>({source:"circuit",rooms:[]})),i=E().then(t=>({source:"http",rooms:t})).catch(()=>({source:"http",rooms:[]})),r=(await Promise.all([n,i])).filter(t=>t.rooms.length>0);if(r.length>0){const n=r.find(t=>"circuit"===t.source);t=n?n.rooms:r[0].rooms}}catch(t){u.value=t.message}return c.value=t,p.value=!1,t},connectToRoom:async function(t){Ke||await l(),u.value=null;try{const n=De,i=await d(),r=i.hops[i.hops.length-1].url,o=n.randombytes_buf(20);if(i.send(new Uint8Array(o),ye),!await Promise.race([new Promise(t=>{i.onData((n,i)=>{n===ge&&t(1===i[0])})}),new Promise((t,n)=>setTimeout(()=>n(new Error("Rendezvous establish timeout")),1e4))]))throw i.destroy(),new Error("Failed to establish rendezvous");const c=await d(),p=(new TextEncoder).encode(r),u=function(t){const n=new Uint8Array(t.length/2);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(2*i,2*i+2),16);return n}(t),b=new Uint8Array(55+p.length);b[0]=Ce,b.set(u,1),b.set(o,33),new DataView(b.buffer).setUint16(53,p.length),b.set(p,55),c.send(b,Ce);const h=new yt,m=await h.initAsClient(i),x=await Promise.race([new Promise(t=>{i.onData((n,i)=>{n===ke&&t(i)})}),new Promise((t,n)=>setTimeout(()=>n(new Error("Host join timeout (30s)")),3e4))]);i.send(m,fe),await h.completeAsClient(x),c.destroy();const f=ze.indexOf(c);f>=0&&ze.splice(f,1);const w=await Promise.race([new Promise(t=>{i.onData((n,i)=>{if(n===fe){const n=h.decrypt(i);if(n)try{const i=JSON.parse((new TextDecoder).decode(n));i.envId&&t(i.envId)}catch{}}})}),new Promise((t,n)=>setTimeout(()=>n(new Error("Room info timeout")),1e4))]),y={onData:null,onClose:null,send:t=>{const n=h.encrypt(t);i.send(n,fe)},close:()=>{var t;h.destroy(),i.destroy();const n=ze.indexOf(i);n>=0&&ze.splice(n,1),null==(t=y.onClose)||t.call(y)}};return i.onData((t,n)=>{var i;if(t===fe){const t=h.decrypt(n);t&&(null==(i=y.onData)||i.call(y,t))}}),{connection:y,envId:w}}catch(t){return u.value=t.message,null}},destroyAll:function(){We&&clearInterval(We),We=null,$e&&clearInterval($e),$e=null;for(const t of ze)t.destroy();ze.length=0,Ve=null,Fe=null,r.value=!1,p.value=!1},deriveRoomId:function(t){if(!De)throw new Error("Not initialized");return Me(xt(t))},generateInviteToken:function(t,n){if(!De||!Be)throw new Error("Not initialized");const i=De,r=(new TextEncoder).encode(t),o=i.randombytes_buf(be),c=i.crypto_aead_xchacha20poly1305_ietf_encrypt(r,null,null,o,Be),p=new Uint8Array(o.length+c.length);return p.set(o),p.set(c,o.length),`${n}.${i.to_base64(p,i.base64_variants.URLSAFE_NO_PADDING)}`},parseInviteToken:function(t){if(!De||!Be)return null;const n=De;let i="",r="";if(t.startsWith("sfr:"))r=t.slice(4);else{const n=t.indexOf(".");if(n<1)return null;i=t.substring(0,n),r=t.substring(n+1)}try{const t=n.from_base64(r,n.base64_variants.URLSAFE_NO_PADDING);if(t.length<40)return null;const o=t.subarray(0,be),c=t.subarray(be),p=n.crypto_aead_xchacha20poly1305_ietf_decrypt(null,c,null,o,Be);if(!p||0===p.length)return null;return{roomKey:i,envId:(new TextDecoder).decode(p)}}catch{return null}},fetchTunnelInfo:async function(){try{return await $fetch("/api/room3d/tunnel-info")}catch{return null}}}}const He=i([]),Ye=i({});function ga(){function e(t){He.value.some(n=>n.roomId===t.roomId)||He.value.push({roomId:t.roomId,name:t.name,addedAt:Date.now()})}function a(t){He.value=He.value.filter(n=>n.roomId!==t)}function s(t){return He.value.some(n=>n.roomId===t)}return{favorites:o(He),customNames:o(Ye),addFavorite:e,removeFavorite:a,isFavorite:s,toggleFavorite:function(t){s(t.roomId)?a(t.roomId):e(t)},setCustomName:function(t,n){n.trim()?Ye.value[t]=n.trim():delete Ye.value[t]},getDisplayName:function(t){return Ye.value[t.roomId]||t.name}}}const qe=c({__name:"Room3dPublicBrowser",__ssrInlineRender:!0,props:{authenticated:{type:Boolean}},emits:["join-public-room"],setup(t,{emit:n}){wa();const o=ga(),c=i(""),p=i([]),h=i(!1),m=i(null),x=i(null),f=i("");i(null);const{getDisplayName:w,isFavorite:_}=o;const I=r(()=>{let t=p.value;if(c.value.trim()){const n=c.value.toLowerCase();t=t.filter(t=>{var i,r;return t.name.toLowerCase().includes(n)||(null==(i=t.description)?void 0:i.toLowerCase().includes(n))||(null==(r=t.tags)?void 0:r.some(t=>t.toLowerCase().includes(n)))})}return[...t].sort((t,n)=>{const i=_(t.roomId)?1:0,r=_(n.roomId)?1:0;return i!==r?r-i:t.name.localeCompare(n.name)})});return(t,n,i,r)=>{n(`<div${y(u({class:"w-full max-w-4xl mx-auto"},r))} data-v-be232ca8><div class="flex items-center gap-2 mb-3" data-v-be232ca8><div class="relative flex-1" data-v-be232ca8>`),n(g(b(ae),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"},null,i)),n(`<input${P("value",b(c))} type="text" placeholder="Search rooms..." class="w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors" data-v-be232ca8></div><button${C(b(h))?" disabled":""} class="p-2 rounded-xl bg-black/60 border border-white/20 hover:bg-emerald-500/10 hover:border-emerald-500/30 transition-all disabled:opacity-30" title="Refresh" data-v-be232ca8>`),n(g(b(J),{class:["w-5 h-5 text-white/50",{"animate-spin":b(h)}]},null,i)),n('</button></div><div class="max-h-[30vh] sm:max-h-[35vh] overflow-y-auto pr-0.5 pub-scroll" data-v-be232ca8>'),b(h)&&!b(p).length?n('<div class="flex flex-col items-center py-8" data-v-be232ca8><div class="w-8 h-8 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin mb-3" data-v-be232ca8></div><p class="text-white/40 text-base" data-v-be232ca8>Discovering rooms...</p></div>'):b(m)?n(`<div class="text-center py-6" data-v-be232ca8><p class="text-red-400/70 text-base mb-2" data-v-be232ca8>${A(b(m))}</p><button class="text-base text-emerald-400/60 hover:text-emerald-400 transition-colors" data-v-be232ca8>Try again</button></div>`):b(I).length||b(h)?(n('<div class="space-y-2" data-v-be232ca8>\x3c!--[--\x3e'),T(b(I),t=>{var r;n(`<div class="space-y-0" data-v-be232ca8><button class="${R([[b(x)===t.roomId?"rounded-t-xl border-b-0 border-amber-500/30 bg-amber-500/[0.04]":"rounded-xl hover:border-emerald-500/30 hover:bg-emerald-500/[0.06]"],"group w-full text-left flex items-center gap-3 bg-black/50 border border-white/[0.12] px-4 py-3 transition-all"])}" data-v-be232ca8><div class="flex-1 min-w-0" data-v-be232ca8><div class="flex items-center gap-2" data-v-be232ca8><h4 class="text-base font-bold text-white/80 group-hover:text-emerald-300 transition-colors truncate" data-v-be232ca8>${A(b(w)(t))}</h4>`),t.passwordProtected?n(g(b(z),{class:"w-4 h-4 text-amber-400/60 flex-shrink-0"},null,i)):n("\x3c!----\x3e"),n("\x3c!--[--\x3e"),T(null==(r=t.tags)?void 0:r.slice(0,2),t=>{n(`<span class="hidden sm:inline px-1.5 py-0.5 rounded bg-white/[0.06] text-white/35 text-base leading-tight flex-shrink-0" data-v-be232ca8>${A(t)}</span>`)}),n("\x3c!--]--\x3e</div>"),t.description?n(`<p class="text-base text-white/35 truncate mt-0.5" data-v-be232ca8>${A(t.description)}</p>`):n("\x3c!----\x3e"),n('</div><div class="p-1 cursor-pointer flex-shrink-0" data-v-be232ca8>'),function(t){return _(t)}(t.roomId)?n(g(b(te),{class:"w-4 h-4 text-amber-400"},null,i)):n(g(b(ne),{class:"w-4 h-4 text-white/15 group-hover:text-white/30 transition-colors"},null,i)),n("</div></button>"),b(x)===t.roomId?(n('<div class="bg-black/50 border border-white/[0.12] border-t-0 border-amber-500/30 rounded-b-xl px-4 py-3 flex items-center gap-2" data-v-be232ca8>'),n(g(b(z),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"},null,i)),n(`<input${P("value",b(f))} type="password" placeholder="Enter room password" maxlength="32" class="flex-1 bg-black/60 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors" data-v-be232ca8><button class="px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-300 text-base font-medium hover:bg-amber-500/30 transition-colors" data-v-be232ca8> Join </button></div>`)):n("\x3c!----\x3e"),n("</div>")}),n("\x3c!--]--\x3e</div>")):(n('<div class="text-center py-8" data-v-be232ca8>'),n(g(b(L),{class:"w-10 h-10 text-white/[0.08] mx-auto mb-2"},null,i)),n(`<p class="text-white/40 text-base" data-v-be232ca8>${A(b(c)?"No rooms match your search":"No public rooms yet")}</p></div>`)),n("</div></div>")}}}),Je=qe.setup;qe.setup=(t,n)=>{const i=f();return(i.modules||(i.modules=new Set)).add("components/room3d/Room3dPublicBrowser.vue"),Je?Je(t,n):void 0};const Ge=Object.assign(se(qe,[["__scopeId","data-v-be232ca8"]]),{__name:"Room3dPublicBrowser"}),Xe=i();let Qe=null,Ze=null,ea=null,aa=0,ta=0;const sa=new ie.Vector3,na=i(!1);let ia=0;const oa=i([]),da=i(""),ca="sf_room3d_user_name",va=i("");function Ra(){const t=va.value.trim();t?localStorage.setItem(ca,t):localStorage.removeItem(ca)}function Ea(){va.value=localStorage.getItem(ca)||""}const pa=i(),ua=i(0);function Ta(t){const n=t.target;if(!n)return;const i=n.scrollWidth/de.length;ua.value=Math.round(n.scrollLeft/i)}const ba=i({}),ha=i(""),ma=r(()=>"");let xa=null,fa=[],ya=0,ka=0;const _a=i(0);let Aa=null;const Ca=new Set;async function Pa(){if(!Xe.value||ea)return;const t="ontouchstart"in void 0||(void 0).maxTouchPoints>0;Qe=new ie.Scene,Ze=new ie.PerspectiveCamera(34,Xe.value.clientWidth/Xe.value.clientHeight,.1,50),Ze.position.set(0,1.25,4.8),Ze.lookAt(0,.6,0),ea=new ie.WebGLRenderer({antialias:!t,alpha:!0}),ea.setPixelRatio(Math.min((void 0).devicePixelRatio,t?1.5:2)),ea.setSize(Xe.value.clientWidth,Xe.value.clientHeight),ea.setClearColor(0,0),ea.toneMapping=t?ie.AgXToneMapping:ie.ACESFilmicToneMapping,ea.toneMappingExposure=1.6,t||(ea.shadowMap.enabled=!0,ea.shadowMap.type=ie.PCFSoftShadowMap),Xe.value.appendChild(ea.domElement),Qe.fog=new ie.FogExp2(394767,.06);const n=new ie.DirectionalLight(16772829,3.5);n.position.set(2,5,5),t||(n.castShadow=!0,n.shadow.mapSize.set(1024,1024),n.shadow.camera.near=.5,n.shadow.camera.far=15,n.shadow.bias=-.002),Qe.add(n);const i=new ie.DirectionalLight(6724044,.8);i.position.set(-4,2,3),Qe.add(i);const r=new ie.DirectionalLight(1096065,2);if(r.position.set(0,3,-5),Qe.add(r),!t){const t=new ie.SpotLight(16777215,4,12,Math.PI/8,.6,1);t.position.set(0,5,3),t.target.position.set(0,0,2.8),Qe.add(t),Qe.add(t.target)}Qe.add(new ie.AmbientLight(3359829,t?1.2:.6)),xa=new ie.Group,Qe.add(xa),(void 0).addEventListener("resize",Lt);try{await ea.compileAsync(Qe,Ze)}catch{}ta=performance.now(),Ot()}function Lt(){if(!Xe.value||!ea||!Ze)return;const t=Xe.value.clientWidth,n=Xe.value.clientHeight;Ze.aspect=t/n,Ze.updateProjectionMatrix(),ea.setSize(t,n)}async function Da(){var t;if(!Qe||!xa||0===oa.value.length)return;na.value=!0;const n=++ia,i=oa.value,r=i.length,o=2*Math.PI/r;if(!Aa)try{const n=new re,i=await new Promise((t,i)=>n.load("/data/appdata/models/characters/animations/Idle.glb",t,void 0,i));(null==(t=i.animations)?void 0:t.length)&&(Aa=i.animations.find(t=>!t.name.includes("T-Pose"))||i.animations[i.animations.length-1])}catch{}if(n!==ia)return;fa=[],Ca.clear();for(let t=0;t<r;t++){const n=t*o,r=new ie.Group;r.position.set(2.8*Math.sin(n),0,2.8*Math.cos(n)),xa.add(r),fa.push({wrapper:r,model:null,mixer:null,file:i[t],loaded:!1})}const c=i.indexOf(da.value);c>=0&&(_a.value=c,ya=ka=-c*o);const p=[_a.value];if(r>1&&p.push(((_a.value+1)%r+r)%r),r>2&&p.push(((_a.value-1)%r+r)%r),await Promise.all(p.map(t=>Mt(t,n))),n===ia&&ea&&Qe&&Ze){try{await ea.compileAsync(Qe,Ze)}catch{}for(const t of p){const n=fa[t];(null==n?void 0:n.model)&&(n.model.visible=!0)}const t=new Map;Qe.traverse(n=>{n.frustumCulled&&(t.set(n,!0),n.frustumCulled=!1)}),ea.render(Qe,Ze);for(const[n]of t)n.frustumCulled=!0;ea.info.reset()}else for(const t of p){const n=fa[t];(null==n?void 0:n.model)&&(n.model.visible=!0)}Nt(),na.value=!1}async function Mt(t,n){const i=null!=n?n:ia;if(t<0||t>=fa.length)return;const r=fa[t];if(r&&!r.loaded&&!Ca.has(t)){Ca.add(t);try{const t=new re,n=await new Promise((n,i)=>{t.load(`/data/appdata/models/characters/${encodeURIComponent(r.file)}`,n,void 0,i)});if(i!==ia)return void n.scene.traverse(t=>{t.geometry&&t.geometry.dispose()});const o=n.scene,c=(new ie.Box3).setFromObject(o),p=c.max.y-c.min.y;if(p>0){const t=1.4/p;o.scale.setScalar(t),o.position.y=-c.min.y*t,o.position.x=-(c.min.x+c.max.x)/2*t,o.position.z=-(c.min.z+c.max.z)/2*t}o.visible=!1,r.wrapper.add(o),r.model=o;const u=n.animations||[];let b=u.find(t=>/idle/i.test(t.name)&&!t.name.includes("T-Pose"));!b&&u.length>0&&(b=u.find(t=>!t.name.includes("T-Pose"))||u[0]),!b&&Aa&&(b=Aa),b&&(r.mixer=new ie.AnimationMixer(o),r.mixer.clipAction(b).play()),r.loaded=!0}catch{}finally{Ca.delete(t)}}}function Ua(t,n){t.model&&t.model.traverse(t=>{if(t.isMesh&&t.material){const i=Array.isArray(t.material)?t.material:[t.material];for(const t of i)t.transparent=!0,t.opacity=n}})}function Nt(){if(!fa.length)return;const t=fa.length;for(let n=0;n<t;n++){const i=((n-_a.value)%t+t)%t,r=i>t/2?t-i:i,o=0===r?1.05:1;fa[n].wrapper.scale.setScalar(o),fa[n].wrapper.visible=r<=2,Ua(fa[n],r<=1?1:.25)}}let Ia=0;function Ot(){if(!ea||!Qe||!Ze)return;aa=requestAnimationFrame(Ot);const t=performance.now(),n=t,i=Math.min((n-ta)/1e3,.1);ta=n;for(const t of fa)t.mixer&&t.mixer.update(i);if(xa){const t=ka-ya;Math.abs(t)>.001?ya+=t*Math.min(1,4*i):ya=ka,xa.rotation.y=ya;const n=Ze.position;for(const t of fa){t.wrapper.getWorldPosition(sa);const i=n.x-sa.x,r=n.z-sa.z,o=Math.atan2(i,r);t.wrapper.rotation.y=o-xa.rotation.y}}performance.now(),ea.render(Qe,Ze);const r=performance.now();r-t>50&&r-Ia>2e3&&(Ia=r,ea.info)}function et(t){const n=oa.value.length;if(n<2)return;const i=_a.value,r=2*Math.PI/n;for(_a.value=(t%n+n)%n,ka=-_a.value*r;ka-ya>Math.PI;)ka-=2*Math.PI;for(;ka-ya<-Math.PI;)ka+=2*Math.PI;da.value=oa.value[_a.value],Nt();const o=_a.value>i||i===n-1&&0===_a.value?1:-1,c=((_a.value+o)%n+n)%n;Mt(c).then(()=>{const t=fa[c];(null==t?void 0:t.model)&&!t.model.visible&&(ea&&Qe&&Ze?ea.compileAsync(Qe,Ze).then(()=>{t.model&&(t.model.visible=!0),ea&&Qe&&Ze&&(ea.render(Qe,Ze),ea.info.reset())}).catch(()=>{t.model&&(t.model.visible=!0)}):t.model&&(t.model.visible=!0))})}function jt(){et(_a.value-1)}function Kt(){et(_a.value+1)}let Sa=0;function La(t){if(t.preventDefault(),oa.value.length<2)return;const n=Date.now();n-Sa<200||(Sa=n,t.deltaY>0?Kt():t.deltaY<0&&jt())}function Ma(){(void 0).removeEventListener("resize",Lt),cancelAnimationFrame(aa),aa=0,ia++,Ca.clear();for(const t of fa)t.mixer&&t.mixer.stopAllAction(),le(t.wrapper);fa=[],Qe&&(Qe.traverse(t=>{if(t.geometry&&t.geometry.dispose(),t.material){const n=Array.isArray(t.material)?t.material:[t.material];for(const t of n)t.dispose()}}),Qe=null),xa=null,ea&&(ea.domElement.remove(),ea.dispose(),ea=null),Ze=null}async function Na(){try{const t=await $fetch("/api/room3d/characters");if(null==t?void 0:t.length){const n=[...t];for(let t=n.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[n[t],n[i]]=[n[i],n[t]]}oa.value=n}!oa.value.includes(da.value)&&oa.value.length>0&&(da.value=oa.value[0])}catch{}}function Oa(){return{lobbyCanvas:Xe,lobbyCharLoading:na,availableCharacters:oa,selectedCharacter:da,displayName:va,saveDisplayName:Ra,loadDisplayName:Ea,roomScrollContainer:pa,activeRoomIdx:ua,onRoomScroll:Ta,editingCode:ba,copiedCode:ha,currentDomain:ma,carouselSelectedIdx:_a,initLobbyScene:Pa,disposeLobbyScene:Ma,initCarouselPositions:Da,lobbyRotateToIndex:et,lobbyPrevChar:jt,lobbyNextChar:Kt,onLobbyWheel:La,loadAvailableCharacters:Na,charDisplayName:oe}}const ja={mode:"vad",muted:!1,volume:80,spatialAudio:!0,autoJoin:!0};const $a=function(){try{const t=localStorage.getItem("room3d-voice-settings");if(t)return{...ja,...JSON.parse(t)}}catch{}return{...ja}}();function Ba(){return{voiceEnabled:i(!1),voiceMode:i("ptt"),localMuted:i(!1),localSpeaking:i(!1),pttActive:i(!1),masterVolume:i(80),spatialEnabled:i(!0),autoJoinVoice:i(!0),showVoiceSettings:i(!1),peerVoiceStates:new Map,micPermissionState:i("unknown"),checkMicPermission:async()=>{},requestMicrophone:async()=>!1,setMultiplayerRef:()=>{},initVoice:async()=>{},disposeVoice:()=>{},connectToPeer:async()=>{},disconnectPeer:()=>{},updateSpatialPositions:()=>{},setVoiceMode:t=>{},setPTT:t=>{},toggleMute:()=>{},setMasterVolume:t=>{},setSpatialAudio:t=>{},setAutoJoin:t=>{},openVoiceSettings:()=>{},closeVoiceSettings:()=>{},onPeerSpeakingChanged:t=>{},getConnectedPeerIds:()=>[],getVoiceDebugInfo:()=>({}),forceEnableTransmit:()=>{}}}i(!1),i($a.mode),i($a.muted),i(!1),i(!1),i($a.volume),i($a.spatialAudio),i($a.autoJoin),i(!1),i("unknown"),w(new Map);const Ka=c({__name:"Room3dLobby",__ssrInlineRender:!0,props:{environments:{},availableCharacters:{},selectedCharacter:{},carouselSelectedIdx:{},lobbyCharLoading:{type:Boolean},displayName:{},isDev:{type:Boolean},editMode:{type:Boolean},authenticated:{type:Boolean},roomSettings:{},inviteTokens:{},copiedToken:{},activeRoomIdx:{},guestMode:{type:Boolean},guestReady:{type:Boolean},guestOnlineCount:{},guestConnected:{type:Boolean},hideTokenPaste:{type:Boolean}},emits:["select-environment","prev-char","next-char","lobby-wheel","update-room-settings","copy-link","update:displayName","update:editMode","save-display-name","room-scroll","enter-room","join-public-room","join-by-token"],setup(n,{emit:o}){const c={isPublic:!0,inviteOnly:!1,publicName:"",publicDescription:"",password:""},f={isPublic:!1,inviteOnly:!0,publicName:"",publicDescription:"",password:""},w=n,H=o,Y=Ba().micPermissionState,q=i(!1),J=i(!1),G=i(""),X=i(null),Q=i(null),Z=i(null);function v(t,n){const i=w.roomSettings[t];return i&&n in i?i[n]:("big_room"===t?c:f)[n]}const ee=r(()=>w.authenticated?w.environments:w.environments.filter(t=>!t.hidden)),ae=r({get:()=>w.displayName,set:t=>H("update:displayName",t)});r({get:()=>w.editMode,set:t=>H("update:editMode",t)});const te=i("rooms"),se=i(),ne=i();i();const ie=i(0),re=i(3),oe=r(()=>1===re.value),le=r(()=>oe.value?ee.value.length:Math.max(1,Math.ceil(ee.value.length/re.value))),de=r(()=>{const t=ee.value.length,n=re.value;if(oe.value)return ee.value;if(ie.value>=le.value-1&&t>n)return ee.value.slice(t-n);const i=ie.value*n;return ee.value.slice(i,i+n)}),ce=Oa();return p(se,t=>{t&&(ce.lobbyCanvas.value=t)}),p(ne,t=>{t&&(ce.roomScrollContainer.value=t)}),(i,r,o,c)=>{var p;const f=t,w=ue,H=Ge;r(`<div${y(u({class:"absolute inset-0 z-30 lobby-bg overflow-hidden"},c))} data-v-03547be6>`),n.guestMode?r("\x3c!----\x3e"):(r('<button class="absolute top-3 left-3 z-30 p-2 text-white/40 hover:text-white/70 transition-colors" data-v-03547be6>'),r(g(b(D),{class:"w-6 h-6"},null,o)),r("</button>")),r(`<div class="lobby-particle lobby-p1" data-v-03547be6></div><div class="lobby-particle lobby-p2" data-v-03547be6></div><div class="lobby-particle lobby-p3" data-v-03547be6></div><div class="lobby-particle lobby-p4" data-v-03547be6></div><div class="lobby-particle lobby-p5" data-v-03547be6></div><div class="lobby-particle lobby-p6" data-v-03547be6></div><div class="lobby-particle lobby-p7" data-v-03547be6></div><div class="lobby-particle lobby-p8" data-v-03547be6></div><canvas class="absolute inset-0 w-full h-full object-cover pointer-events-none" style="${_({filter:"blur(4px)",opacity:"0.35"})}" data-v-03547be6></canvas><div class="absolute inset-0 z-[1]" data-v-03547be6></div><div class="absolute inset-0 pointer-events-none lobby-vignette z-[2]" data-v-03547be6></div>`),n.guestMode?r(`<div class="absolute top-4 right-4 z-30" data-v-03547be6><div class="px-3 py-1.5 rounded-full bg-black/70 backdrop-blur-sm border border-white/15 text-base text-gray-300 flex items-center gap-2" data-v-03547be6><div class="${R([n.guestConnected?"bg-emerald-400 animate-pulse":"bg-gray-600","w-2 h-2 rounded-full"])}" data-v-03547be6></div><span data-v-03547be6>${A(null!=(p=n.guestOnlineCount)?p:0)} online</span></div></div>`):r("\x3c!----\x3e"),n.lobbyCharLoading?r('<div class="absolute inset-0 z-10 flex items-center justify-center pointer-events-none" data-v-03547be6><div class="w-14 h-14 border-2 border-white/5 border-t-emerald-400 rounded-full animate-spin" data-v-03547be6></div></div>'):r("\x3c!----\x3e"),r(`<div class="absolute top-0 left-0 right-0 z-20 text-center pt-5 pointer-events-none" data-v-03547be6><div class="inline-block" data-v-03547be6><img${P("src","/data/appdata/images/SCHEDULE-4-REAL.svg")} alt="Schedule 4 Real" class="mx-auto h-16 sm:h-24 select-none lobby-title-glow" draggable="false" data-v-03547be6><div class="mx-auto mt-2 h-px w-56 bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent" data-v-03547be6></div><div class="mt-2 flex items-center justify-center gap-2 flex-wrap" data-v-03547be6>`),n.authenticated||n.guestMode?r("\x3c!----\x3e"):r('<div class="inline-block bg-yellow-500/10 border border-yellow-500/30 rounded-full px-3 py-0.5" data-v-03547be6><span class="text-yellow-400/70 text-base font-medium" data-v-03547be6>Guest Mode</span></div>'),"denied"===b(Y)||"error"===b(Y)||"unavailable"===b(Y)?(r('<button class="pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-red-500/10 border-red-500/30 text-red-400 hover:bg-red-500/20 relative" data-v-03547be6>'),r(g(b(j),{class:"w-3.5 h-3.5"},null,o)),r("<span data-v-03547be6>Enable Mic</span>"),b(q)?r('<div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-64 bg-black/90 border border-red-500/30 rounded-lg p-3 text-left z-50 shadow-xl" data-v-03547be6><p class="text-red-300 text-base font-medium mb-1" data-v-03547be6>Mic blocked by browser</p><p class="text-white/50 text-base leading-snug" data-v-03547be6>Click the lock icon in the address bar, find Microphone, set to Allow, then reload.</p></div>'):r("\x3c!----\x3e"),r("</button>")):"prompt"===b(Y)?(r('<button class="pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full border text-base font-medium transition-all bg-amber-500/10 border-amber-500/30 text-amber-400 hover:bg-amber-500/20" data-v-03547be6>'),r(g(b(j),{class:"w-3.5 h-3.5"},null,o)),r("<span data-v-03547be6>Enable Mic</span></button>")):r("\x3c!----\x3e"),n.authenticated&&!n.guestMode?(r('<button class="pointer-events-auto inline-flex items-center gap-1.5 px-3 py-0.5 rounded-full bg-black/40 border border-white/10 text-white/40 hover:text-emerald-400 hover:border-emerald-500/30 hover:bg-emerald-500/10 transition-all text-base font-medium" title="How privacy works" data-v-03547be6>'),r(g(b(M),{class:"w-3.5 h-3.5"},null,o)),r("<span data-v-03547be6>Privacy info</span></button>")):r("\x3c!----\x3e"),r("</div></div>"),r(g(f,null,{},o)),r("</div>"),n.availableCharacters.length>1?(r('<button class="absolute left-2 sm:left-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group" data-v-03547be6>'),r(g(b(O),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"},null,o)),r("</button>")):r("\x3c!----\x3e"),n.availableCharacters.length>1?(r('<button class="absolute right-2 sm:right-6 top-[45%] -translate-y-1/2 z-20 lobby-nav-btn group" data-v-03547be6>'),r(g(b($),{class:"w-5 h-5 text-white/40 group-hover:text-emerald-300 transition-colors duration-200"},null,o)),r("</button>")):r("\x3c!----\x3e"),r('<div class="absolute bottom-0 left-0 right-0 z-20 lobby-bottom-fade pointer-events-none" data-v-03547be6>'),n.guestMode?(r('<div class="pointer-events-auto max-w-xs mx-auto px-4 pb-6 text-center" data-v-03547be6>'),n.availableCharacters.length>1?(r('<div class="flex items-center justify-center gap-1.5 mb-4" data-v-03547be6>\x3c!--[--\x3e'),T(n.availableCharacters,(t,i)=>{r(`<div class="${R([i===n.carouselSelectedIdx?"bg-emerald-400 w-4":"bg-white/15 w-1.5","h-1.5 rounded-full transition-all duration-300"])}" data-v-03547be6></div>`)}),r("\x3c!--]--\x3e</div>")):r("\x3c!----\x3e"),r(`<input${P("value",b(ae))} type="text" placeholder="Enter your name" maxlength="20" class="w-full bg-black/60 border border-white/20 rounded-xl px-4 py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors mb-3" data-v-03547be6><button${C(!n.guestReady||n.lobbyCharLoading)?" disabled":""} class="w-full py-3 rounded-xl font-bold text-base text-white transition-all bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25" data-v-03547be6> Enter Room </button>`),n.hideTokenPaste?r("\x3c!----\x3e"):(r('<div class="mt-3 flex items-center gap-2" data-v-03547be6><div class="relative flex-1" data-v-03547be6>'),r(g(b(U),{class:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/25"},null,o)),r(`<input${P("value",b(G))} type="text" placeholder="Paste invite token" class="w-full bg-black/60 border border-white/20 rounded-xl pl-9 pr-3 py-2 text-white text-base placeholder-white/30 focus:border-emerald-500/40 focus:outline-none transition-colors font-mono" data-v-03547be6></div><button${C(!b(G).startsWith("sfr:"))?" disabled":""} class="px-3 py-2 rounded-xl bg-emerald-500/25 border border-emerald-500/30 text-emerald-400 text-base font-bold hover:bg-emerald-500/35 transition-all disabled:opacity-20 disabled:cursor-not-allowed flex-shrink-0" data-v-03547be6> Join </button></div>`)),r("</div>")):(r('<div class="max-w-6xl mx-auto px-0 pb-3 sm:px-6 sm:pb-6" data-v-03547be6><div class="text-center mb-3 sm:mb-4" data-v-03547be6>'),n.availableCharacters.length>1?(r('<div class="hidden sm:flex items-center justify-center gap-1.5 mb-2" data-v-03547be6>\x3c!--[--\x3e'),T(n.availableCharacters,(t,i)=>{r(`<div class="${R([i===n.carouselSelectedIdx?"bg-emerald-400 w-4 rounded-full":"bg-white/15","w-1.5 h-1.5 rounded-full transition-all duration-300"])}" data-v-03547be6></div>`)}),r("\x3c!--]--\x3e</div>")):r("\x3c!----\x3e"),r(`<div class="flex justify-center" data-v-03547be6><input${P("value",b(ae))} type="text" placeholder="Your name" maxlength="20" class="pointer-events-auto w-48 sm:w-56 bg-black/60 border border-white/20 rounded-xl px-4 py-2 sm:py-2.5 text-white text-center text-base placeholder-white/30 focus:border-emerald-500/50 focus:outline-none transition-colors" data-v-03547be6></div></div><div class="flex items-center justify-center gap-3 sm:gap-4 mb-2 sm:mb-3 pointer-events-auto" data-v-03547be6><div class="hidden sm:block h-px w-12 bg-gradient-to-r from-transparent to-white/10" data-v-03547be6></div><div class="flex items-center bg-black/60 rounded-xl p-0.5 border border-white/15" data-v-03547be6><button class="${R(["rooms"===b(te)?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50","px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all"])}" data-v-03547be6> My Rooms </button><button class="${R(["public"===b(te)?"bg-white/[0.12] text-white/70":"text-white/30 hover:text-white/50","px-3 sm:px-4 py-1 sm:py-1.5 rounded-lg text-base font-bold tracking-wider uppercase transition-all flex items-center gap-1.5"])}" data-v-03547be6>`),r(g(b(L),{class:"w-3.5 h-3.5"},null,o)),r(' Public </button></div><div class="hidden sm:block h-px w-12 bg-gradient-to-l from-transparent to-white/10" data-v-03547be6></div></div>'),r(g(w,{modelValue:b(J),"onUpdate:modelValue":t=>h(J)?J.value=t:null},null,o)),"rooms"===b(te)?(r('<div class="pointer-events-auto relative" data-v-03547be6>'),b(ie)>0?(r('<button class="hidden sm:flex absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all" data-v-03547be6>'),r(g(b(O),{class:"w-4 h-4 text-white/60"},null,o)),r("</button>")):r("\x3c!----\x3e"),r(`<div class="flex gap-3 sm:gap-5 overflow-x-auto snap-x snap-mandatory scrollbar-hide sm:overflow-visible sm:justify-center sm:px-0 items-start" style="${_(b(oe)?"padding-left: 7.5vw; padding-right: 7.5vw;":"")}" data-v-03547be6><div${y({name:"room-card",class:"contents"})} data-v-03547be6>`),T(b(de),t=>{r('<div class="flex flex-col items-stretch w-[85vw] sm:w-96 snap-center flex-shrink-0" data-v-03547be6><div class="lobby-room-card group relative overflow-hidden rounded-2xl transition-all duration-300 hover:scale-[1.03]" data-v-03547be6><button class="w-full text-left" data-v-03547be6><div class="relative h-44 sm:h-56 overflow-hidden" data-v-03547be6>'),t.image?r(`<img${P("src",t.image)}${P("alt",t.name)} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" data-v-03547be6>`):(r('<div class="w-full h-full bg-gradient-to-br from-gray-800/80 to-gray-900/80 flex items-center justify-center" data-v-03547be6>'),I(r,m(x(t.icon),{class:"w-12 h-12 text-white/15"},null),o),r("</div>")),r('<div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-black/30" data-v-03547be6></div>'),t.hidden&&n.authenticated?r('<div class="absolute top-2 right-2 bg-amber-500/20 border border-amber-500/30 rounded-full px-2 py-0.5" data-v-03547be6><span class="text-amber-400 text-base font-medium" data-v-03547be6>Hidden</span></div>'):r("\x3c!----\x3e"),r(`<div class="absolute bottom-3 left-3 right-3" data-v-03547be6><h3 class="text-white font-bold text-lg sm:text-xl drop-shadow-lg group-hover:text-emerald-300 transition-colors leading-tight" data-v-03547be6>${A(v(t.id,"publicName")||t.name)}</h3>`),v(t.id,"publicDescription")?r(`<p class="text-white/50 text-base drop-shadow-lg truncate mt-0.5" data-v-03547be6>${A(v(t.id,"publicDescription"))}</p>`):r("\x3c!----\x3e"),r('</div><div class="hidden sm:flex absolute inset-0 items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300" data-v-03547be6><div class="w-14 h-14 rounded-full bg-emerald-500/20 backdrop-blur-sm flex items-center justify-center border border-emerald-400/30" data-v-03547be6><svg class="w-6 h-6 text-emerald-300 ml-0.5" fill="currentColor" viewBox="0 0 24 24" data-v-03547be6><path d="M8 5v14l11-7z" data-v-03547be6></path></svg></div></div></div></button>'),n.authenticated?(r('<div class="sm:hidden absolute top-2 left-2 flex items-center gap-1.5 z-10" data-v-03547be6><button class="flex items-center gap-1 px-2 py-1 rounded-lg bg-black/60 backdrop-blur-sm border border-white/15 text-white/60 active:bg-white/15 transition-all text-base font-bold" data-v-03547be6>'),r(g(b(N),{class:"w-3.5 h-3.5"},null,o)),r("<span data-v-03547be6>Options</span></button>"),n.inviteTokens[t.id]?(r(`<button class="${R([n.copiedToken===t.id?"bg-emerald-500/30 border-emerald-500/40 text-emerald-300":"bg-black/60 border-white/15 text-white/60 active:bg-white/15","flex items-center gap-1 px-2 py-1 rounded-lg backdrop-blur-sm border transition-all text-base font-bold"])}" data-v-03547be6>`),n.copiedToken!==t.id?r(g(b(K),{class:"w-3.5 h-3.5"},null,o)):r(g(b(B),{class:"w-3.5 h-3.5"},null,o)),r(`<span data-v-03547be6>${A(n.copiedToken===t.id?"Copied!":"Link")}</span></button>`)):r("\x3c!----\x3e"),r("</div>")):r("\x3c!----\x3e"),n.authenticated?(r(`<div class="hidden sm:block bg-black/80 border-t border-white/[0.08] px-3 py-1.5" data-v-03547be6><div class="space-y-1.5" data-v-03547be6><div class="flex items-center justify-between" data-v-03547be6><label class="flex items-center gap-1.5 cursor-pointer" data-v-03547be6><div class="relative inline-flex items-center" data-v-03547be6><input type="checkbox"${C(v(t.id,"isPublic"))?" checked":""} class="sr-only peer" data-v-03547be6><div class="w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-3 after:content-[&#39;&#39;] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all" data-v-03547be6></div></div><span class="${R([v(t.id,"isPublic")?"text-emerald-400/80":"text-white/35","text-base"])}" data-v-03547be6>${A(v(t.id,"isPublic")?"Public visible":"Not public")}</span></label><label class="flex items-center gap-1.5 cursor-pointer" data-v-03547be6><div class="relative inline-flex items-center" data-v-03547be6><input type="checkbox"${C(!v(t.id,"inviteOnly"))?" checked":""} class="sr-only peer" data-v-03547be6><div class="w-7 h-4 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-3 after:content-[&#39;&#39;] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all" data-v-03547be6></div></div><span class="${R([v(t.id,"inviteOnly")?"text-white/35":"text-sky-400/80","text-base"])}" data-v-03547be6>${A(v(t.id,"inviteOnly")?"Hidden on lobby":"Visible on lobby")}</span></label></div><div class="flex items-center gap-2" data-v-03547be6><button class="${R([[v(t.id,"password")?"text-amber-400 bg-amber-500/10":"text-white/30 hover:text-white/50",b(Q)===t.id?"ring-1 ring-amber-500/40":""],"flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all"])}" data-v-03547be6>`),v(t.id,"password")?r(g(b(z),{class:"w-3.5 h-3.5"},null,o)):r(g(b(V),{class:"w-3.5 h-3.5"},null,o)),r(`<span data-v-03547be6>${A(v(t.id,"password")?"Password set":"No password")}</span></button><button class="${R([b(X)===t.id?"text-emerald-400 bg-emerald-500/10 ring-1 ring-emerald-500/40":"text-white/30 hover:text-white/50","flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all"])}" data-v-03547be6>`),r(g(b(F),{class:"w-3.5 h-3.5"},null,o)),r('<span data-v-03547be6>Edit info</span></button><div class="flex-1" data-v-03547be6></div>'),n.inviteTokens[t.id]?(r(`<button class="${R([n.copiedToken===t.id?"text-emerald-400 bg-emerald-500/10":"text-white/30 hover:text-white/50","flex items-center gap-1 px-2 py-0.5 rounded-lg text-base transition-all"])}" data-v-03547be6>`),n.copiedToken!==t.id?r(g(b(K),{class:"w-3.5 h-3.5"},null,o)):r(g(b(B),{class:"w-3.5 h-3.5"},null,o)),r(`<span data-v-03547be6>${A(n.copiedToken===t.id?"Copied!":"Copy link")}</span></button>`)):r("\x3c!----\x3e"),r("</div></div></div>")):r("\x3c!----\x3e"),r("</div>"),b(X)===t.id?r(`<div class="mt-1.5 bg-black/70 backdrop-blur-sm border border-white/[0.12] rounded-xl px-3 py-2 space-y-1.5" data-v-03547be6><input type="text"${P("value",v(t.id,"publicName"))} maxlength="60"${P("placeholder",t.name)} class="w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors" data-v-03547be6><input type="text"${P("value",v(t.id,"publicDescription"))} maxlength="200" placeholder="Short description..." class="w-full bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors" data-v-03547be6></div>`):r("\x3c!----\x3e"),b(Q)===t.id?(r('<div class="mt-1.5 bg-black/70 backdrop-blur-sm border border-amber-500/20 rounded-xl px-3 py-2" data-v-03547be6><div class="flex items-center gap-2" data-v-03547be6>'),r(g(b(z),{class:"w-4 h-4 text-amber-400/50 flex-shrink-0"},null,o)),r(`<input type="text"${P("value",v(t.id,"password"))} maxlength="32" placeholder="Room password (leave empty to remove)" class="flex-1 bg-black/50 border border-white/15 rounded-lg px-2.5 py-1.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors" data-v-03547be6></div></div>`)):r("\x3c!----\x3e"),r("</div>")}),r("</div></div>"),b(ie)<b(le)-1?(r('<button class="hidden sm:flex absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-9 h-9 items-center justify-center rounded-full bg-black/70 backdrop-blur-sm border border-white/15 hover:bg-emerald-500/15 hover:border-emerald-500/30 transition-all" data-v-03547be6>'),r(g(b($),{class:"w-4 h-4 text-white/60"},null,o)),r("</button>")):r("\x3c!----\x3e"),r("</div>")):r("\x3c!----\x3e"),"rooms"===b(te)&&b(le)>1?(r('<div class="flex items-center justify-center gap-1.5 mt-3 pointer-events-auto" data-v-03547be6>\x3c!--[--\x3e'),T(b(le),t=>{r(`<button class="${R([t-1===b(ie)?"bg-emerald-400 w-5":"bg-white/15 w-1.5 hover:bg-white/30","h-1.5 rounded-full transition-all duration-300 cursor-pointer"])}" data-v-03547be6></button>`)}),r("\x3c!--]--\x3e</div>")):r("\x3c!----\x3e"),"public"===b(te)?(r('<div class="pointer-events-auto" data-v-03547be6>'),r(g(H,{authenticated:n.authenticated,onJoinPublicRoom:t=>i.$emit("join-public-room",t)},null,o)),r("</div>")):r("\x3c!----\x3e"),r("</div>")),r("</div>"),S(r,t=>{var i;b(Z)?(t('<div class="fixed inset-0 z-[100] flex items-end justify-center bg-black/70 backdrop-blur-sm" data-v-03547be6>'),b(Z)?(t('<div class="w-full max-w-md bg-gray-900/95 backdrop-blur-xl border-t border-white/15 rounded-t-3xl px-5 py-5 pb-8 space-y-5" data-v-03547be6><div class="flex items-center justify-between" data-v-03547be6><h3 class="text-white font-bold text-lg" data-v-03547be6>Room Options</h3><button class="p-2 -mr-2 text-white/40 active:text-white/70" data-v-03547be6>'),t(g(b(W),{class:"w-5 h-5"},null,o)),t(`</button></div><div class="space-y-4" data-v-03547be6><label class="flex items-center justify-between cursor-pointer" data-v-03547be6><span class="${R([v(b(Z),"isPublic")?"text-emerald-400":"text-white/50","text-base font-medium"])}" data-v-03547be6> Public visible </span><div class="relative inline-flex items-center" data-v-03547be6><input type="checkbox"${C(v(b(Z),"isPublic"))?" checked":""} class="sr-only peer" data-v-03547be6><div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-4 after:content-[&#39;&#39;] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all" data-v-03547be6></div></div></label><label class="flex items-center justify-between cursor-pointer" data-v-03547be6><span class="${R([v(b(Z),"inviteOnly")?"text-white/50":"text-sky-400","text-base font-medium"])}" data-v-03547be6> Visible on lobby </span><div class="relative inline-flex items-center" data-v-03547be6><input type="checkbox"${C(!v(b(Z),"inviteOnly"))?" checked":""} class="sr-only peer" data-v-03547be6><div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:bg-sky-500 peer-checked:after:translate-x-4 after:content-[&#39;&#39;] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:rounded-full after:h-[18px] after:w-[18px] after:transition-all" data-v-03547be6></div></div></label></div><div class="space-y-2" data-v-03547be6><div class="flex items-center gap-2" data-v-03547be6>`),t(g(b(z),{class:["w-4 h-4",v(b(Z),"password")?"text-amber-400":"text-white/30"]},null,o)),t(`<span class="${R([v(b(Z),"password")?"text-amber-400":"text-white/40","text-base font-medium"])}" data-v-03547be6>Password</span></div><input type="text"${P("value",v(b(Z),"password"))} maxlength="32" placeholder="Room password (leave empty to remove)" class="w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-amber-500/50 focus:outline-none transition-colors" data-v-03547be6></div><div class="space-y-2" data-v-03547be6><div class="flex items-center gap-2" data-v-03547be6>`),t(g(b(F),{class:"w-4 h-4 text-white/40"},null,o)),t(`<span class="text-base font-medium text-white/40" data-v-03547be6>Public info</span></div><input type="text"${P("value",v(b(Z),"publicName"))} maxlength="60"${P("placeholder",(null==(i=n.environments.find(t=>t.id===b(Z)))?void 0:i.name)||"Room name")} class="w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors" data-v-03547be6><input type="text"${P("value",v(b(Z),"publicDescription"))} maxlength="200" placeholder="Short description..." class="w-full bg-black/50 border border-white/15 rounded-xl px-3 py-2.5 text-white text-base placeholder-white/25 focus:border-emerald-500/50 focus:outline-none transition-colors" data-v-03547be6></div></div>`)):t("\x3c!----\x3e"),t("</div>")):t("\x3c!----\x3e")},"body",!1,o),r("</div>")}}}),za=Ka.setup;Ka.setup=(t,n)=>{const i=f();return(i.modules||(i.modules=new Set)).add("components/room3d/Room3dLobby.vue"),za?za(t,n):void 0};const Va=Object.assign(se(Ka,[["__scopeId","data-v-03547be6"]]),{__name:"Room3dLobby"}),Fa=i(!1);i(!1),i("");const Wa=i(new Map);function Za(){return{connected:i(!1),wsConnected:i(!1),localPeerId:i(""),playerCount:r(()=>0),remotePlayers:i(new Map),connect:()=>{},joinRoom:()=>{},leaveRoom:()=>{},sendLocalState:()=>{},sendRoomStateChanged:()=>{},onPlayerMoved:t=>{},onRoomStateChanged:t=>{},onPlayersInit:t=>{},sendObjectDelta:t=>{},onObjectDelta:t=>{},sendVoiceSignal:(t,n,i)=>{},sendVoiceState:t=>{},sendVoiceRelay:(t,n)=>{},onVoiceSignal:t=>{},onVoiceState:t=>{},getRoomId:()=>null,onPlayerLeft:t=>{},sendTVChanged:(t,n)=>{},onTVChanged:t=>{},onServerError:t=>{},dispose:()=>{}}}r(()=>Wa.value.size+(Fa.value?1:0));export{Ba as B,Oa as O,Va as Q,Za as Z,ga as g,pt as p,wa as w};
