import{defineStore as e}from"pinia";import{u as t}from"./useAuthGate-BgxmmIEE.mjs";const o=e("triggers",{state:()=>({flows:[],currentFlow:null,socketAiModes:{},blowerAiMode:!1,fanAiMode:!1,executionLogs:[],loading:!1,saving:!1,selectedNodeId:null}),getters:{enabledFlows:e=>e.flows.filter(e=>e.enabled),selectedNode:e=>e.currentFlow&&e.selectedNodeId&&e.currentFlow.flow.nodes.find(t=>t.id===e.selectedNodeId)||null,isSocketAiEnabled:e=>t=>!0===e.socketAiModes[t],isBlowerAiEnabled:e=>e.blowerAiMode,isFanAiEnabled:e=>e.fanAiMode},actions:{async fetchFlows(){this.loading=!0;try{const e=await $fetch("/api/automation/flows");this.flows=e}catch{}finally{this.loading=!1}},async loadFlow(e){this.loading=!0;try{const t=await $fetch(`/api/automation/flow/${e}`);this.currentFlow=t,this.selectedNodeId=null}catch(e){throw e}finally{this.loading=!1}},createNewFlow(){this.currentFlow={id:"",name:"New Trigger Flow",description:null,enabled:!1,flow:{nodes:[],connections:[]},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},this.selectedNodeId=null},async loadGlobalConfiguration(){this.loading=!0;try{const e=(await $fetch("/api/automation/flows")).find(e=>"global"===e.id);this.currentFlow=e||{id:"global",name:"Global Automation",description:"Main automation configuration",enabled:!1,flow:{nodes:[],connections:[]},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},this.selectedNodeId=null}catch{this.currentFlow={id:"global",name:"Global Automation",description:"Main automation configuration",enabled:!1,flow:{nodes:[],connections:[]},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()}}finally{this.loading=!1}},async saveCurrentFlow(){if(this.currentFlow){this.saving=!0;try{const{getAuthHeaders:e}=t(),o=e();if("global"===this.currentFlow.id){const e=await $fetch("/api/automation/flow/global",{method:"PUT",headers:o,body:{name:this.currentFlow.name,description:this.currentFlow.description,enabled:this.currentFlow.enabled,flow:this.currentFlow.flow}});this.currentFlow=e}else if(this.currentFlow.id){const e=await $fetch(`/api/automation/flow/${this.currentFlow.id}`,{method:"PUT",headers:o,body:{name:this.currentFlow.name,description:this.currentFlow.description,enabled:this.currentFlow.enabled,flow:this.currentFlow.flow}});this.currentFlow=e;const t=this.flows.findIndex(t=>t.id===e.id);t>=0&&(this.flows[t]=e)}else{const e=await $fetch("/api/automation/flows",{method:"POST",headers:o,body:{name:this.currentFlow.name,description:this.currentFlow.description,enabled:this.currentFlow.enabled,flow:this.currentFlow.flow}});this.currentFlow=e,this.flows.unshift(e)}}catch(e){throw e}finally{this.saving=!1}}},async deleteFlow(e){var o;try{const{getAuthHeaders:n}=t();await $fetch(`/api/automation/flow/${e}`,{method:"DELETE",headers:n()}),this.flows=this.flows.filter(t=>t.id!==e),(null==(o=this.currentFlow)?void 0:o.id)===e&&(this.currentFlow=null)}catch(e){throw e}},async toggleFlowEnabled(e){var o,n;const i=e||(null==(o=this.currentFlow)?void 0:o.id);if(!i)return;const a=this.flows.find(e=>e.id===i);if(a)try{const{getAuthHeaders:e}=t();await $fetch(`/api/automation/flow/${i}`,{method:"PUT",headers:e(),body:{enabled:!a.enabled}}),a.enabled=!a.enabled,(null==(n=this.currentFlow)?void 0:n.id)===i&&(this.currentFlow.enabled=a.enabled)}catch(e){throw e}},addNode(e,t){if(!this.currentFlow)return;const o=`${e}-${Date.now()}`,n={id:o,type:e,position:t,data:{config:{condition:{sensor:"temp",timeSlots:[{id:"default",period:"custom",startTime:"00:00",endTime:"00:00",weekmask:127,operator:">",value:25,hysteresis:2}]},action:{socket:"O5",action:"on",mandatoryOn:!1,mandatoryOff:!1},schedule:{scheduleType:"time_range",period:"custom",startTime:"08:00",endTime:"20:00",weekmask:127,intervalMinutes:30,durationSeconds:60,activeStartTime:"00:00",activeEndTime:"00:00",activePeriod:"custom",mandatoryOn:!1,mandatoryOff:!1},state:{socket:"O1",checkState:"on",timeRestricted:!1,period:"custom",startTime:"00:00",endTime:"00:00"},logic:{operator:"and",name:"",timeRestricted:!1,period:"custom",startTime:"08:00",endTime:"20:00",mandatoryOn:!1,mandatoryOff:!1},note:{text:"Note",color:"gray"},vpd_control:{mode:"plant_stage",manualTarget:{min:.8,max:1.2},phaseTargets:{germination:{min:.4,max:.7},seedling:{min:.6,max:.9},vegetative:{min:.8,max:1},flower:{min:1,max:1.3},flush:{min:1.15,max:1.35},drying:{min:-1,max:-1},curing:{min:-1,max:-1}},roles:[],escalationTimeoutSeconds:180,hysteresisPercent:60},blower_curve:{standbySpeed:0,curves:[{id:`curve-${Date.now()}`,sensor:"temp",enabled:!0,points:[{value:25,speed:30},{value:26,speed:60},{value:27,speed:100}],escalation:{enabled:!1,intervalSeconds:30,expectedImprovement:.5,speedIncrement:10}}]}}[e]}};return this.currentFlow.flow.nodes.push(n),this.selectedNodeId=o,n},updateNode(e,t){if(!this.currentFlow)return;const o=this.currentFlow.flow.nodes.findIndex(t=>t.id===e);if(o>=0){const e=this.currentFlow.flow.nodes[o];this.currentFlow.flow.nodes[o]={...e,...t}}},updateNodeConfig(e,t){if(!this.currentFlow)return;const o=this.currentFlow.flow.nodes.find(t=>t.id===e);o&&(o.data.config={...o.data.config,...t})},deleteNode(e){this.currentFlow&&(this.currentFlow.flow.nodes=this.currentFlow.flow.nodes.filter(t=>t.id!==e),this.currentFlow.flow.connections=this.currentFlow.flow.connections.filter(t=>t.source!==e&&t.target!==e),this.selectedNodeId===e&&(this.selectedNodeId=null))},addConnection(e){if(!this.currentFlow)return;const t=`conn-${Date.now()}`;this.currentFlow.flow.connections.push({id:t,...e})},deleteConnection(e){this.currentFlow&&(this.currentFlow.flow.connections=this.currentFlow.flow.connections.filter(t=>t.id!==e))},updateConnection(e,t){var o,n;if(!this.currentFlow)return;const i=this.currentFlow.flow.connections.find(t=>t.id===e);i&&(void 0!==t.sourceHandle&&(i.sourceHandle=null!=(o=t.sourceHandle)?o:void 0),void 0!==t.targetHandle&&(i.targetHandle=null!=(n=t.targetHandle)?n:void 0))},selectNode(e){this.selectedNodeId=e},async fetchSocketAiModes(){try{const e=await $fetch("/api/automation/socket-ai-mode");this.socketAiModes=e}catch{}},async setSocketAiMode(e,o){try{const{getAuthHeaders:n}=t();await $fetch("/api/automation/socket-ai-mode",{method:"POST",headers:n(),body:{socket:e,aiMode:o}}),this.socketAiModes[e]=o}catch(e){throw e}},async fetchBlowerAiMode(){try{const e=await $fetch("/api/automation/blower-ai-mode");this.blowerAiMode=e.aiMode}catch{}},async setBlowerAiMode(e){try{const{getAuthHeaders:o}=t();await $fetch("/api/automation/blower-ai-mode",{method:"POST",headers:o(),body:{aiMode:e}}),this.blowerAiMode=e}catch(e){throw e}},async fetchFanAiMode(){try{const e=await $fetch("/api/automation/fan-ai-mode");this.fanAiMode=e.aiMode}catch{}},async setFanAiMode(e){try{const{getAuthHeaders:o}=t();await $fetch("/api/automation/fan-ai-mode",{method:"POST",headers:o(),body:{aiMode:e}}),this.fanAiMode=e}catch(e){throw e}},async fetchExecutionLogs(e={}){try{const t=new URLSearchParams;e.range&&t.set("range",e.range),e.flowId&&t.set("flowId",e.flowId),e.socket&&t.set("socket",e.socket);const o=await $fetch(`/api/automation/logs?${t}`);this.executionLogs=o}catch{}}}});export{o as d};
