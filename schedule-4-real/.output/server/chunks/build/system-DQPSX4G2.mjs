import{defineStore as t}from"pinia";const e=t("system",{state:()=>({services:[],servicesLoading:!1,backups:[],backupsLoading:!1,backupCreating:!1,backupRestoring:!1,config:null,configLoading:!1,configSaving:!1,proxyConfig:null,proxyLoading:!1,proxySaving:!1,updateStatus:null,updateLoading:!1,updateApplying:!1,updateProgress:null,rawMessages:[],rawLive:!1,rawFilter:"all",pendingRequestIds:new Set}),actions:{async fetchServices(){this.servicesLoading=!0;try{const t=await $fetch("/api/system/services");this.services=t}catch{}finally{this.servicesLoading=!1}},async controlService(t,e){try{const{getAuthHeaders:a}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/service-control",{method:"POST",headers:a(),body:{name:t,action:e}}),await this.fetchServices()}catch(t){throw t}},async fetchBackups(){this.backupsLoading=!0;try{const t=await $fetch("/api/system/backups");this.backups=t}catch{}finally{this.backupsLoading=!1}},async createBackup(){this.backupCreating=!0;try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/backups",{method:"POST",headers:t()}),await this.fetchBackups()}catch(t){throw t}finally{this.backupCreating=!1}},async deleteBackup(t){try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/backup-delete",{method:"POST",headers:e(),body:{filename:t}}),await this.fetchBackups()}catch(t){throw t}},async restoreBackup(t){this.backupRestoring=!0;try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/backup-restore",{method:"POST",headers:e(),body:{filename:t}})}catch(t){throw t}finally{this.backupRestoring=!1}},async uploadBackup(t){try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders})),a=new FormData;a.append("file",t),await $fetch("/api/system/backup-upload",{method:"POST",headers:e(),body:a}),await this.fetchBackups()}catch(t){throw t}},async fetchConfig(){this.configLoading=!0;try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders})),e=await $fetch("/api/system/config",{headers:t()});this.config=e}catch{}finally{this.configLoading=!1}},async saveConfig(t){this.configSaving=!0;try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/config",{method:"POST",headers:e(),body:t}),await this.fetchConfig()}catch(t){throw t}finally{this.configSaving=!1}},async fetchProxyConfig(){this.proxyLoading=!0;try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders})),e=await $fetch("/api/system/proxy-config",{headers:t()});this.proxyConfig=e}catch{}finally{this.proxyLoading=!1}},async saveProxyConfig(t){this.proxySaving=!0;try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/proxy-config",{method:"POST",headers:e(),body:t}),await this.fetchProxyConfig()}catch(t){throw t}finally{this.proxySaving=!1}},async fetchUpdateStatus(){this.updateLoading=!0;try{const t=await $fetch("/api/system/updates");this.updateStatus=t,t.inProgress&&t.updateProgress&&!this.updateProgress&&(this.updateProgress=t.updateProgress)}catch{}finally{this.updateLoading=!1}},async checkForUpdates(){this.updateLoading=!0;try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders})),e=await $fetch("/api/system/updates",{method:"POST",headers:t(),body:{action:"check"}});return await this.fetchUpdateStatus(),e}catch(t){throw t}finally{this.updateLoading=!1}},async applyUpdates(t=[]){var e,a,s,i;this.updateApplying=!0,this.updateProgress={phase:"downloading",component:null,current:0,total:0,error:null,timestamp:Date.now()};try{const{getAuthHeaders:h}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));let r=null;try{r=await $fetch("/api/system/updates",{method:"POST",headers:h(),body:{action:"apply",components:t}})}catch(t){const i=!(null==t?void 0:t.statusCode);if(i&&"downloading"!==(null==(e=this.updateProgress)?void 0:e.phase))return;if(i&&"downloading"===(null==(a=this.updateProgress)?void 0:a.phase))return void(this.updateProgress={phase:"restarting",component:"web",current:0,total:0,error:null,timestamp:Date.now()});const h=(null==(s=null==t?void 0:t.data)?void 0:s.message)||(null==t?void 0:t.statusMessage)||(null==t?void 0:t.message)||"Request failed";throw new Error(h)}if(r&&!1===r.success){if(null==(i=r.error)?void 0:i.includes("already in progress"))return void await this.fetchUpdateStatus();throw new Error(r.error||"Update failed on server")}await this.fetchUpdateStatus()}catch(t){throw this.updateProgress=null,t}finally{this.updateApplying=!1}},async rollbackUpdate(t){this.updateApplying=!0;try{const{getAuthHeaders:e}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));try{await $fetch("/api/system/updates",{method:"POST",headers:e(),body:{action:"rollback",timestamp:t}})}catch{}}catch(t){throw t}finally{this.updateApplying=!1}},async toggleAutoUpdate(){try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders})),e=await $fetch("/api/system/updates",{method:"POST",headers:t(),body:{action:"toggle-auto"}});return await this.fetchUpdateStatus(),e}catch(t){throw t}},async dismissChangelog(){this.updateStatus&&(this.updateStatus.showChangelog=!1);try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/updates",{method:"POST",headers:t(),body:{action:"dismiss-changelog"}})}catch{}},async dismissAdvert(){this.updateStatus&&(this.updateStatus.advertDismissed=!0);try{const{getAuthHeaders:t}=await import("./useAuthGate-BgxmmIEE.mjs").then(t=>t.b).then(t=>({getAuthHeaders:t.useAuth().getAuthHeaders}));await $fetch("/api/system/updates",{method:"POST",headers:t(),body:{action:"dismiss-advert"}})}catch{}},addRawMessage(t){if("phoneApp"===this.rawFilter){if("phoneApp"!==t.deviceType)return}else if("phoneApp"===t.deviceType||"all"!==this.rawFilter&&t.deviceType!==this.rawFilter)return;this.rawMessages.push(t),this.rawMessages.length>500&&this.rawMessages.splice(0,this.rawMessages.length-500)},addPendingRequestIds(t){for(const e of t)this.pendingRequestIds.add(e);setTimeout(()=>{for(const e of t)this.pendingRequestIds.delete(e)},5e3)},clearRawMessages(){this.rawMessages=[]}}});export{e as n};
