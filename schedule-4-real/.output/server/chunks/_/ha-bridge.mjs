import{b as e}from"../nitro/nitro.mjs";import{writeFileSync as t,existsSync as n,readFileSync as o}from"fs";import{resolve as i}from"path";import{m as a,b as l,g as s,k as r,e as c,s as u,a as d,c as g,u as m}from"./mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const f=i(e(),"ha-config.json");function saveConfig(e){t(f,JSON.stringify(e,null,2))}let h=null,p=!1;const v=new Set,O={0:"Manual",1:"Time Slot",2:"Cycle",3:"Temperature",4:"Humidity",5:"CO2",7:"Temp Priority",8:"Humi Priority",12:"PPFD Auto",13:"Temp+Humi",14:"Drip"};function initHaBridge(e){h=e;(function(){try{if(n(f))return JSON.parse(o(f,"utf-8"))}catch{}return{enabled:!1}})().enabled&&startBridge()}function enableHaBridge(){saveConfig({enabled:!0}),startBridge()}function disableHaBridge(){saveConfig({enabled:!1}),function(){if(!p||!h)return;console.log("[HA Bridge] Stopping Home Assistant MQTT Discovery bridge");for(const e of v)removeDiscovery(e);v.clear(),h.publish("ggs/ha/status","offline",{retain:!0,qos:1}),h.unsubscribe("ggs/ha/+/+/set"),h.unsubscribe("ggs/ha/+/+/+/set"),a.off("sensor",onSensorEvent),a.off("outlet",onOutletEvent),a.off("light",onLightEvent),a.off("blower",onBlowerEvent),a.off("fan",onFanEvent),p=!1}()}function isHaBridgeEnabled(){return p}function startBridge(){!p&&h&&(p=!0,console.log("[HA Bridge] Starting Home Assistant MQTT Discovery bridge"),h.subscribe("ggs/ha/+/+/set",{qos:1}),h.subscribe("ggs/ha/+/+/+/set",{qos:1}),h.publish("ggs/ha/status","online",{retain:!0,qos:1}),a.on("sensor",onSensorEvent),a.on("outlet",onOutletEvent),a.on("light",onLightEvent),a.on("blower",onBlowerEvent),a.on("fan",onFanEvent),setTimeout(()=>function(){if(!p||!h)return;const e=r().macs||{};let t=0;for(const[n,o]of Object.entries(e)){if(!o)continue;const e=o.toLowerCase(),i=l(n),a={identifiers:[`ggs_${e}`],name:`Schedule 4 Real (${n.toUpperCase()})`,manufacturer:"Spider Farmer",model:n.toUpperCase()},r=`ggs_${e}`,c={availability_topic:"ggs/ha/status",payload_available:"online",payload_not_available:"offline"};if(n===s()||"lc"===n){const n=[{id:"temperature",name:"Temperature",unit:"°C",deviceClass:"temperature",icon:"mdi:thermometer"},{id:"humidity",name:"Humidity",unit:"%",deviceClass:"humidity",icon:"mdi:water-percent"},{id:"co2",name:"CO2",unit:"ppm",deviceClass:"carbon_dioxide",icon:"mdi:molecule-co2"},{id:"vpd",name:"VPD",unit:"kPa",deviceClass:null,icon:"mdi:gauge"}];for(const o of n){const n={unique_id:`${r}_${o.id}`,name:o.name,state_topic:`ggs/ha/${e}/${o.id}/state`,unit_of_measurement:o.unit,icon:o.icon,device:a,...c};o.deviceClass&&(n.device_class=o.deviceClass),h.publish(`homeassistant/sensor/${r}/${o.id}/config`,JSON.stringify(n),{retain:!0,qos:1}),t++}}if(i.hasOutlets)for(let n=1;n<=5;n++){const o=`outlet_${n}`,i={unique_id:`${r}_${o}`,name:`Outlet ${n}`,state_topic:`ggs/ha/${e}/${o}/state`,command_topic:`ggs/ha/${e}/${o}/set`,payload_on:"ON",payload_off:"OFF",icon:"mdi:power-socket-eu",device:a,...c};h.publish(`homeassistant/switch/${r}/${o}/config`,JSON.stringify(i),{retain:!0,qos:1}),t++}{const n={unique_id:`${r}_light_1`,name:"Light 1",state_topic:`ggs/ha/${e}/light_1/state`,command_topic:`ggs/ha/${e}/light_1/set`,schema:"json",brightness:!0,brightness_scale:100,icon:"mdi:lightbulb",device:a,...c};h.publish(`homeassistant/light/${r}/light_1/config`,JSON.stringify(n),{retain:!0,qos:1}),t++}if(i.hasLight2){const n={unique_id:`${r}_light_2`,name:"Light 2",state_topic:`ggs/ha/${e}/light_2/state`,command_topic:`ggs/ha/${e}/light_2/set`,schema:"json",brightness:!0,brightness_scale:100,icon:"mdi:lightbulb",device:a,...c};h.publish(`homeassistant/light/${r}/light_2/config`,JSON.stringify(n),{retain:!0,qos:1}),t++}if(i.hasFan){const n={unique_id:`${r}_blower`,name:"Blower",state_topic:`ggs/ha/${e}/blower/state`,state_value_template:"{{ value_json.state }}",command_topic:`ggs/ha/${e}/blower/set`,payload_on:"ON",payload_off:"OFF",percentage_state_topic:`ggs/ha/${e}/blower/state`,percentage_value_template:"{{ value_json.percentage | int }}",percentage_command_topic:`ggs/ha/${e}/blower/percentage/set`,percentage_command_template:"{{ [value | int, 25] | max }}",speed_range_min:1,speed_range_max:100,icon:"mdi:fan",device:a,...c};h.publish(`homeassistant/fan/${r}/blower/config`,JSON.stringify(n),{retain:!0,qos:1}),t++;const o={unique_id:`${r}_fan`,name:"Fan",state_topic:`ggs/ha/${e}/fan/state`,state_value_template:"{{ value_json.state }}",command_topic:`ggs/ha/${e}/fan/set`,payload_on:"ON",payload_off:"OFF",percentage_state_topic:`ggs/ha/${e}/fan/state`,percentage_value_template:"{{ value_json.percentage }}",percentage_command_topic:`ggs/ha/${e}/fan/percentage/set`,speed_range_min:1,speed_range_max:10,oscillation_state_topic:`ggs/ha/${e}/fan/state`,oscillation_value_template:"{{ value_json.oscillating }}",oscillation_command_topic:`ggs/ha/${e}/fan/oscillation/set`,payload_oscillation_on:"oscillate_on",payload_oscillation_off:"oscillate_off",icon:"mdi:fan",device:a,...c};h.publish(`homeassistant/fan/${r}/fan/config`,JSON.stringify(o),{retain:!0,qos:1}),t++}v.add(e)}console.log(`[HA Bridge] Published discovery for ${t} entities`)}(),3e3))}function removeDiscovery(e){if(!h)return;const t=`ggs_${e}`,n=[`homeassistant/sensor/${t}/temperature/config`,`homeassistant/sensor/${t}/humidity/config`,`homeassistant/sensor/${t}/co2/config`,`homeassistant/sensor/${t}/vpd/config`,`homeassistant/switch/${t}/outlet_1/config`,`homeassistant/switch/${t}/outlet_2/config`,`homeassistant/switch/${t}/outlet_3/config`,`homeassistant/switch/${t}/outlet_4/config`,`homeassistant/switch/${t}/outlet_5/config`,`homeassistant/light/${t}/light_1/config`,`homeassistant/light/${t}/light_2/config`,`homeassistant/fan/${t}/blower/config`,`homeassistant/fan/${t}/fan/config`];for(const e of n)h.publish(e,"",{retain:!0,qos:1})}function getFirstMac(){var e;const t=r(),n=s();return((null==(e=t.macs)?void 0:e[n])||"").toLowerCase()}function onSensorEvent(e){if(!p||!h)return;const t=getFirstMac();t&&(void 0!==e.temp&&h.publish(`ggs/ha/${t}/temperature/state`,String(e.temp),{qos:0}),void 0!==e.humi&&h.publish(`ggs/ha/${t}/humidity/state`,String(e.humi),{qos:0}),void 0!==e.co2&&h.publish(`ggs/ha/${t}/co2/state`,String(e.co2),{qos:0}),void 0!==e.vpd&&h.publish(`ggs/ha/${t}/vpd/state`,String(e.vpd),{qos:0}))}function onOutletEvent(e){var t,n;if(!p||!h)return;const o=getFirstMac();if(o)for(let i=1;i<=5;i++){const a=`O${i}`;if(e[a]){const l=e[a],s=1===(null!=(n=null!=(t=l.mOnOff)?t:l.on)?n:0);h.publish(`ggs/ha/${o}/outlet_${i}/state`,s?"ON":"OFF",{qos:0})}}}function onLightEvent(e){var t,n,o,i,a,l,s,r;if(!p||!h)return;const c=getFirstMac();if(c){if(e.light){const a=e.light,l=null!=(n=null!=(t=a.mOnOff)?t:a.on)?n:0,s=null!=(i=null!=(o=a.mLevel)?o:a.level)?i:0;h.publish(`ggs/ha/${c}/light_1/state`,JSON.stringify({state:1===l?"ON":"OFF",brightness:s}),{qos:0})}if(e.light2){const t=e.light2,n=null!=(l=null!=(a=t.mOnOff)?a:t.on)?l:0,o=null!=(r=null!=(s=t.mLevel)?s:t.level)?r:0;h.publish(`ggs/ha/${c}/light_2/state`,JSON.stringify({state:1===n?"ON":"OFF",brightness:o}),{qos:0})}}}function onBlowerEvent(e){p&&h&&function(e){var t,n,o,i;const a=getFirstMac();if(!a||!h)return;const l=1===(null!=(n=null!=(t=e.mOnOff)?t:e.on)?n:0),s=null!=(i=null!=(o=e.mLevel)?o:e.level)?i:0;h.publish(`ggs/ha/${a}/blower/state`,JSON.stringify({state:l?"ON":"OFF",percentage:l?s:0}),{qos:0})}(e)}function onFanEvent(e){var t,n,o,i,a;if(!p||!h)return;const l=getFirstMac();if(!l)return;publishFanState(1===(null!=(n=null!=(t=e.mOnOff)?t:e.on)?n:0),null!=(i=null!=(o=e.mLevel)?o:e.level)?i:0,null!=(a=e.shakeLevel)?a:0,l)}async function handleHaCommand(e,t){if(!p)return;const n=e.split("/");if(n.length<5)return;const o=n[2],i=n[3],a=6===n.length?n[4]:null;try{if(i.startsWith("outlet_"))await async function(e,t,n){var o,i,a,l,r;const f=parseInt(t.replace("outlet_",""));if(f<1||f>5)return;const p=`O${f}`,v=s(),_=c(v),b=null==(i=null==(o=null==_?void 0:_.data)?void 0:o.outlet)?void 0:i[p],$=null!=(a=null==b?void 0:b.modeType)?a:0;if(0!==$){const t=O[$]||`Mode ${$}`;return console.log(`[HA Bridge] Rejected ${p} command: device is in ${t} mode (only Manual allowed)`),void function(e,t,n){var o,i;if(!h)return;const a=1===(null!=(i=null!=(o=null==n?void 0:n.mOnOff)?o:null==n?void 0:n.on)?i:0);h.publish(`ggs/ha/${e}/outlet_${t}/state`,a?"ON":"OFF",{qos:0})}(e,f,b)}await async function(e){try{const{query:t}=await import("./db.mjs"),n=await t("SELECT ai_mode FROM socket_ai_mode WHERE socket = $1 LATEST ON timestamp PARTITION BY socket",[e]);return!!(Array.isArray(n)&&n.length>0)&&1===n[0].ai_mode}catch{return!1}}(p)&&console.log(`[HA Bridge] Warning: ${p} has trigger automation active — HA command will proceed but triggers may override`);const y="ON"===n.trim().toUpperCase()?1:0;let F={};try{const e=await u({method:"getConfigField",params:{keyPath:["outlet",p]}},v,3e3);F=(null==(l=null==e?void 0:e.data)?void 0:l[p])||{}}catch{}const w={...F,modeType:0,mOnOff:y};await d({method:"setConfigField",params:{keyPath:["outlet",p],[p]:w}},v);const N=g(v),S=(null==(r=null==N?void 0:N.data)?void 0:r.outlet)||{};m(v,{outlet:{...S,[p]:w}}),console.log(`[HA Bridge] ${p} → ${y?"ON":"OFF"} (from HA)`),h&&h.publish(`ggs/ha/${e}/outlet_${f}/state`,y?"ON":"OFF",{qos:0})}(o,i,t);else if(i.startsWith("light_"))await async function(e,t,n){var o,i,a,l,r,f,p,v,_;const b=parseInt(t.replace("light_","")),$=2===b,y=$?"light2":"light",F=$?["light2"]:["device","light"],w=s(),N=c(w),S=null==(o=null==N?void 0:N.data)?void 0:o[y],C=g(w),H=null==(i=null==C?void 0:C.data)?void 0:i[y],L=null!=(l=null!=(a=null==S?void 0:S.modeType)?a:null==H?void 0:H.modeType)?l:0;if(0!==L){const t=O[L]||`Mode ${L}`;return console.log(`[HA Bridge] Rejected ${y} command: device is in ${t} mode (only Manual allowed)`),void function(e,t,n){var o,i,a,l;if(!h)return;const s=null!=(i=null!=(o=null==n?void 0:n.mOnOff)?o:null==n?void 0:n.on)?i:0,r=null!=(l=null!=(a=null==n?void 0:n.mLevel)?a:null==n?void 0:n.level)?l:0;h.publish(`ggs/ha/${e}/light_${t}/state`,JSON.stringify({state:1===s?"ON":"OFF",brightness:r}),{qos:0})}(e,b,S)}let B;try{B=JSON.parse(n)}catch{B={state:n.trim().toUpperCase()}}const q="ON"===B.state?1:"OFF"===B.state?0:void 0,A=B.brightness;let T={};try{const e=await u({method:"getConfigField",params:{keyPath:F}},w,3e3);T=(null==(r=null==e?void 0:e.data)?void 0:r[y])||{}}catch{}const k=null!=(p=null!=(f=null!=q?q:T.mOnOff)?f:T.on)?p:0,E=null!=(_=null!=(v=null!=A?A:T.mLevel)?v:T.level)?_:0,M={...T,modeType:0,mOnOff:k,mLevel:E};"on"in T&&(M.on=k);"level"in T&&(M.level=E);await d({method:"setConfigField",params:{keyPath:F,[y]:M}},w),m(w,{[y]:M}),console.log(`[HA Bridge] ${y} → ${k?"ON":"OFF"} level=${E} (from HA)`),h&&h.publish(`ggs/ha/${e}/light_${b}/state`,JSON.stringify({state:1===k?"ON":"OFF",brightness:E}),{qos:0})}(o,i,t);else if("blower"===i)if("percentage"===a){const e=parseInt(t);0===e||isNaN(e)?await handleBlowerCommand(o,JSON.stringify({state:"OFF"})):await handleBlowerCommand(o,JSON.stringify({percentage:e}))}else await handleBlowerCommand(o,t);else if("fan"===i)if("percentage"===a){const e=parseInt(t);0===e||isNaN(e)?await handleFanCommand(o,JSON.stringify({state:"OFF"})):await handleFanCommand(o,JSON.stringify({percentage:e}))}else"oscillation"===a?await async function(e,t){var n,o,i,a,l,r,m,f;const h=s(),p=c(h),v=null==(n=null==p?void 0:p.data)?void 0:n.fan,_=null!=(o=null==v?void 0:v.modeType)?o:0;if(0!==_){const t=O[_]||`Mode ${_}`;return console.log(`[HA Bridge] Rejected fan oscillation: device is in ${t} mode (only Manual allowed)`),void republishFanState(e,v)}const b="oscillate_on"===t.trim().toLowerCase();let $={};try{const e=await u({method:"getConfigField",params:{keyPath:["device","fan"]}},h,3e3);$=(null==(i=null==e?void 0:e.data)?void 0:i.fan)||{}}catch{}if(0===Object.keys($).length){const e=g(h);$=(null==(a=null==e?void 0:e.data)?void 0:a.fan)||{}}const y=b?$.shakeLevel>0?$.shakeLevel:5:0,F={...$,modeType:0,shakeLevel:y};await d({method:"setConfigField",params:{keyPath:["device","fan"],fan:F}},h);const w=1===(null!=(r=null!=(l=$.mOnOff)?l:null==v?void 0:v.on)?r:0),N=null!=(f=null!=(m=$.mLevel)?m:null==v?void 0:v.level)?f:5;console.log(`[HA Bridge] fan oscillation → ${b?"ON":"OFF"} shake=${y} (from HA)`),publishFanState(w,N,y,e)}(o,t):await handleFanCommand(o,t)}catch(e){console.error(`[HA Bridge] Error handling command for ${i}:`,e.message)}}async function handleBlowerCommand(e,t){var n,o,i,a,l,r,g,f,p;const v=s(),_=c(v),b=(null==(n=null==_?void 0:_.data)?void 0:n.blower)||(null==(o=null==_?void 0:_.data)?void 0:o.fan),$=null!=(i=null==b?void 0:b.modeType)?i:0;if(0!==$){const t=O[$]||`Mode ${$}`;return console.log(`[HA Bridge] Rejected blower command: device is in ${t} mode (only Manual allowed)`),void function(e,t){var n,o,i,a;if(!h)return;const l=1===(null!=(o=null!=(n=null==t?void 0:t.mOnOff)?n:null==t?void 0:t.on)?o:0),s=null!=(a=null!=(i=null==t?void 0:t.mLevel)?i:null==t?void 0:t.level)?a:0;h.publish(`ggs/ha/${e}/blower/state`,JSON.stringify({state:l?"ON":"OFF",percentage:l?s:0}),{qos:0})}(e,b)}let y;await async function(){try{const{query:e}=await import("./db.mjs"),t=await e("SELECT ai_mode FROM blower_ai_mode LATEST ON timestamp PARTITION BY device");return!!(Array.isArray(t)&&t.length>0)&&1===t[0].ai_mode}catch{return!1}}()&&console.log("[HA Bridge] Warning: blower has trigger automation active — HA command will proceed but triggers may override");try{y=JSON.parse(t)}catch{y={state:t.trim().toUpperCase()}}const F="ON"===y.state?1:"OFF"===y.state?0:void 0,w=y.percentage;let N={};try{const e=await u({method:"getConfigField",params:{keyPath:["device","blower"]}},v,3e3);N=(null==(a=null==e?void 0:e.data)?void 0:a.blower)||{}}catch{}const S=null!=(l=null!=F?F:N.mOnOff)?l:0,C=null!=(r=null!=w?w:N.mLevel)?r:50,H=0===S?null!=(g=N.mLevel)?g:50:Math.max(25,Math.min(100,C)),L={...N,modeType:0,mOnOff:S,mLevel:H};await d({method:"setConfigField",params:{keyPath:["device","blower"],blower:L}},v),m(v,{blower:{on:1===L.mOnOff,level:L.mLevel,modeType:0,closeCO2:1===L.closeCO2,minSpeed:null!=(f=L.minSpeed)?f:0,maxSpeed:null!=(p=L.maxSpeed)?p:0}}),console.log(`[HA Bridge] blower → ${S?"ON":"OFF"} level=${H} (from HA)`),h&&h.publish(`ggs/ha/${e}/blower/state`,JSON.stringify({state:1===S?"ON":"OFF",percentage:1===S?H:0}),{qos:0})}async function handleFanCommand(e,t){var n,o,i,a,l,r,m,f,h,p,v;const _=s(),b=c(_),$=null==(n=null==b?void 0:b.data)?void 0:n.fan,y=null!=(o=null==$?void 0:$.modeType)?o:0;if(0!==y){const t=O[y]||`Mode ${y}`;return console.log(`[HA Bridge] Rejected fan command: device is in ${t} mode (only Manual allowed)`),void republishFanState(e,$)}let F;try{F=JSON.parse(t)}catch{F={state:t.trim().toUpperCase()}}const w="ON"===F.state?1:"OFF"===F.state?0:void 0,N=F.percentage;let S={};try{const e=await u({method:"getConfigField",params:{keyPath:["device","fan"]}},_,3e3);S=(null==(i=null==e?void 0:e.data)?void 0:i.fan)||{}}catch{}if(0===Object.keys(S).length){const e=g(_);S=(null==(a=null==e?void 0:e.data)?void 0:a.fan)||{}}const C=null!=(l=null!=w?w:S.mOnOff)?l:0,H=null!=(r=null!=N?N:S.mLevel)?r:5,L=0===C?null!=(m=S.mLevel)?m:5:Math.max(1,Math.min(10,H)),B=null!=(h=null!=(f=S.shakeLevel)?f:null==$?void 0:$.shakeLevel)?h:0,q=null!=(v=null!=(p=S.natural)?p:null==$?void 0:$.natural)?v:0,A={...S,modeType:0,mOnOff:C,mLevel:L,shakeLevel:B,natural:q};await d({method:"setConfigField",params:{keyPath:["device","fan"],fan:A}},_),console.log(`[HA Bridge] fan → ${C?"ON":"OFF"} level=${L} shake=${B} (from HA)`),publishFanState(1===C,L,B,e)}function publishFanState(e,t,n,o){h&&h.publish(`ggs/ha/${o}/fan/state`,JSON.stringify({state:e?"ON":"OFF",percentage:e?t:0,oscillating:n>0}),{qos:0})}function republishFanState(e,t){var n,o,i,a,l;if(!h)return;publishFanState(1===(null!=(o=null!=(n=null==t?void 0:t.mOnOff)?n:null==t?void 0:t.on)?o:0),null!=(a=null!=(i=null==t?void 0:t.mLevel)?i:null==t?void 0:t.level)?a:0,null!=(l=null==t?void 0:t.shakeLevel)?l:0,e)}export{disableHaBridge,enableHaBridge,handleHaCommand,initHaBridge,isHaBridgeEnabled,saveConfig};
