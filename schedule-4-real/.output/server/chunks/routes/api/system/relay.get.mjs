import{d as t,b as e}from"../../../nitro/nitro.mjs";import{existsSync as n,readFileSync as o}from"node:fs";import{resolve as r}from"node:path";import{execSync as s}from"node:child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"fs";import"path";import"fs/promises";import"node:url";let i=null,l=0;const p=t(async()=>{var t,p,a,c,u,m,d,f,h,y,b,g;const w=e(),S=r(w,"data","relay","relay-config.json"),k=r(w,"data","relay","relay-identity.json"),j={enabled:!1,trackerEnabled:!1,port:9443,publicUrl:"",detectedUrl:"",publicKey:"",signPublicKey:"",peers:0,circuits:0,rooms:0,tunnelHosts:0,tunnelSessions:0,status:"stopped"};if(n(S))try{const e=JSON.parse(o(S,"utf-8"));j.enabled=null!=(t=e.enabled)&&t,j.trackerEnabled=null!=(p=e.trackerEnabled)&&p,j.port=null!=(a=e.port)?a:9443,j.publicUrl=null!=(c=e.publicUrl)?c:""}catch{}if(n(k))try{JSON.parse(o(k,"utf-8")).kxSeed&&(j.hasIdentity=!0)}catch{}try{const t=s("pm2 jlist",{encoding:"utf-8",timeout:5e3}),e=JSON.parse(t).find(t=>"s4r-relay"===t.name||"spiderapp-relay"===t.name);e&&(j.status=(null==(u=e.pm2_env)?void 0:u.status)||"unknown")}catch{}if("online"===j.status){try{const t=j.port||9443,e=await fetch(`http://127.0.0.1:${t}/stats`).then(t=>t.json());j.circuits=null!=(m=e.circuits)?m:0,j.rooms=null!=(d=e.rooms)?d:0,j.tunnelHosts=null!=(f=e.tunnelHosts)?f:0,j.tunnelSessions=null!=(h=e.tunnelSessions)?h:0,j.peers=null!=(y=e.peers)?y:0}catch{}try{const t=j.port||9443,e=await fetch(`http://127.0.0.1:${t}/pk`).then(t=>t.json());j.publicKey=null!=(b=e.publicKey)?b:"",j.signPublicKey=null!=(g=e.signPublicKey)?g:""}catch{}}const K=await async function(){if(i&&Date.now()-l<6e5)return i;const t=["https://api.ipify.org","https://ifconfig.me/ip","https://icanhazip.com"];for(const e of t)try{const t=await fetch(e,{signal:AbortSignal.timeout(3e3)});if(t.ok){const e=(await t.text()).trim();if(/^\d{1,3}(\.\d{1,3}){3}$/.test(e))return i=e,l=Date.now(),e}}catch{}return""}();if(K){const t=j.port||9443;j.detectedUrl=`ws://${K}:${t}`}return j});export{p as default};
