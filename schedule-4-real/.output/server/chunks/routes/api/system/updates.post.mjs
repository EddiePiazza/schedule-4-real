import t from"node:process";globalThis._importMeta_=globalThis._importMeta_||{url:"file:///_entry.js",env:t.env};import{d as e,r,b as s,e as o,c as a}from"../../../nitro/nitro.mjs";import{readFileSync as c,writeFileSync as i}from"fs";import{resolve as n}from"path";import{createRequire as p}from"module";import{m}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const u=p(globalThis._importMeta_.url);function getUpdateChecker(){const t=n(s(),"src/services/update-checker.cjs");return delete u.cache[u.resolve(t)],u(t)}function broadcastProgress(t){m.emit("update-progress",t)}const l=e(async e=>{const p=await r(e),{action:m,components:u,timestamp:l}=p||{},d=n(s(),"versions.local.json");if("dismiss-advert"===m)try{const t=JSON.parse(c(d,"utf-8"));return t.advertDismissed=!0,i(d,JSON.stringify(t,null,2)+"\n"),{success:!0}}catch(t){return{success:!1,error:t.message}}if("dismiss-changelog"===m)try{const t=JSON.parse(c(d,"utf-8"));return t.changelogDismissedAt=(new Date).toISOString(),i(d,JSON.stringify(t,null,2)+"\n"),{success:!0}}catch(t){return{success:!1,error:t.message}}const h=t.env.APP_PASSWORD||"",g=o(e,"x-auth-token")||"";if(h&&g!==h)throw a({statusCode:401,message:"Unauthorized"});switch(m){case"check":try{const t=getUpdateChecker();return{success:!0,...await t.checkForUpdates()}}catch(t){return{success:!1,error:t.message}}case"apply":try{const t=getUpdateChecker();return await t.applyUpdates(u||[],broadcastProgress)}catch(t){return{success:!1,error:t.message}}case"rollback":if(!l)throw a({statusCode:400,message:"timestamp required for rollback"});try{const t=getUpdateChecker();return await t.rollback(l)}catch(t){return{success:!1,error:t.message}}case"toggle-auto":try{const t=JSON.parse(c(d,"utf-8"));return t.autoUpdate=!t.autoUpdate,i(d,JSON.stringify(t,null,2)+"\n"),{success:!0,autoUpdate:t.autoUpdate}}catch(t){return{success:!1,error:t.message}}default:throw a({statusCode:400,message:"Invalid action. Use: check, apply, rollback, toggle-auto"})}});export{l as default};
