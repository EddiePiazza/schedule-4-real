import{d as t,l as e,c as s,b as o}from"../../../nitro/nitro.mjs";import{mkdirSync as a,writeFileSync as r}from"fs";import{resolve as i}from"path";import{gunzipSync as n,gzipSync as p}from"zlib";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const m=t(async t=>{try{const m=await e(t);if(!m||0===m.length)throw s({statusCode:400,message:"No file uploaded"});const l=m[0];if(!l.data||!l.filename)throw s({statusCode:400,message:"Invalid file"});const d=l.filename,c=d.endsWith(".gz");let f,g;if(c)try{f=n(l.data)}catch{throw s({statusCode:400,message:"Invalid gzip file â€” could not decompress"})}else f=l.data;try{g=JSON.parse(f.toString("utf-8"))}catch{throw s({statusCode:400,message:"Invalid JSON content in backup file"})}if(!g.version||!g.tables||!Array.isArray(g.tables))throw s({statusCode:400,message:"Invalid backup format: missing version or tables"});const u=/(\d{4}-\d{2}-\d{2}T[\d-]{8})/,h=d.replace(/\.(json|gz)$/gi,"").replace(/\.json$/i,"");let b;if(h.match(u)){b=`${h.replace(/[^a-zA-Z0-9._-]/g,"_")}.json.gz`}else{const t=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);b=`${h.replace(/[^a-zA-Z0-9._-]/g,"_")}-${t}.json.gz`}const v=i(o(),"database/backups");a(v,{recursive:!0});const z=c?l.data:p(f,{level:6}),w=i(v,b);return r(w,z),{success:!0,filename:b,tables:g.tables.length,originalSize:f.length,compressedSize:z.length}}catch(t){if(t.statusCode)throw t;throw s({statusCode:500,message:"Failed to upload backup: "+t.message})}});export{m as default};
