import{d as e,r as t,c as s,b as r}from"../../../nitro/nitro.mjs";import{readFileSync as o,writeFileSync as n,mkdirSync as i}from"fs";import{resolve as a}from"path";import{execSync as T,exec as c}from"child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const d=["MQTT_HOST","MQTT_PORT","MQTT_LAN_PORT","QUESTDB_PG_PORT","QUESTDB_HTTP_PORT","QUESTDB_ILP_PORT","DATA_RETENTION_DAYS","API_PORT","WS_PORT","APP_PASSWORD","RELAY_PORT","APP_DOMAIN","RELAY_DOMAIN"],p=e(async e=>{const p=await t(e);if(!p||"object"!=typeof p)throw s({statusCode:400,message:"Invalid request body"});for(const e of Object.keys(p))if(!d.includes(e))throw s({statusCode:400,message:`Cannot modify key: ${e}`});try{const e=a(r(),".env"),t=o(e,"utf-8").split("\n"),s=new Set,d=t.map(e=>{const t=e.trim();if(!t||t.startsWith("#"))return e;const r=t.indexOf("=");if(-1===r)return e;const o=t.slice(0,r).trim();return o in p?(s.add(o),`${o}=${p[o]}`):e});for(const[e,t]of Object.entries(p))s.has(e)||d.push(`${e}=${t}`);n(e,d.join("\n"));for(const[e,t]of Object.entries(p))process.env[e]=t;"API_PORT"in p&&(process.env.NITRO_PORT=p.API_PORT);const _=new Set,u=Object.keys(p);for(const e of u)switch(e){case"API_PORT":case"WS_PORT":_.add("s4r-web");break;case"MQTT_HOST":case"MQTT_PORT":case"MQTT_LAN_PORT":_.add("s4r-web"),_.add("s4r-ingest"),_.add("s4r-supervisor");break;case"QUESTDB_PG_PORT":case"QUESTDB_HTTP_PORT":case"QUESTDB_ILP_PORT":_.add("s4r-web"),_.add("s4r-ingest"),_.add("s4r-retention");break;case"DATA_RETENTION_DAYS":_.add("s4r-retention");break;case"RELAY_PORT":_.add("s4r-relay")}if("QUESTDB_PG_PORT"in p||"QUESTDB_HTTP_PORT"in p||"QUESTDB_ILP_PORT"in p)try{const e=process.env.QUESTDB_PG_PORT||"8812",t=process.env.QUESTDB_HTTP_PORT||"9000",s=process.env.QUESTDB_ILP_PORT||"9009",o=process.env.QUESTDB_USER||"spider",n=process.env.QUESTDB_PASSWORD||"spider123",i=r(),a=function(){try{if(T('docker ps -a --format "{{.Names}}"',{encoding:"utf-8",timeout:3e3}).includes("s4r-questdb"))return"s4r-questdb"}catch{}return"s4r-questdb"}();T(`docker stop ${a} 2>/dev/null || true`,{timeout:15e3}),T(`docker rm ${a} 2>/dev/null || true`,{timeout:5e3}),T(`docker run -d --name s4r-questdb --restart=always -p ${e}:8812 -p ${t}:9000 -p ${s}:9009 -v "${i}/database/data:/var/lib/questdb" -e QDB_PG_USER="${o}" -e QDB_PG_PASSWORD="${n}" -e QDB_TELEMETRY_ENABLED=false questdb/questdb:latest`,{timeout:3e4});for(let e=0;e<15;e++){try{T("docker exec s4r-questdb curl -s http://localhost:9000/exec?query=SELECT+1",{timeout:3e3,stdio:"pipe"});break}catch{}T("sleep 1")}}catch{}if("MQTT_PORT"in p||"MQTT_LAN_PORT"in p){const e=process.env.MQTT_PORT||"1883",t=process.env.MQTT_LAN_PORT||"1884",s=r(),o=`# Mosquitto Local Broker - Schedule 4 Real\n# Auto-generated from .env ports\n\nlistener ${e} 127.0.0.1\nlistener ${t} 0.0.0.0\n\nlistener 9001 0.0.0.0\nprotocol websockets\n\nallow_anonymous true\n\nlog_type all\nlog_dest stdout\n\npersistence true\npersistence_location proxy/mosquitto_data/\n\nretain_available true\n`;i(a(s,"proxy/mosquitto_data"),{recursive:!0}),n(a(s,"proxy/mosquitto.conf"),o);try{T('pkill -f "mosquitto -c" 2>/dev/null || true',{timeout:5e3}),setTimeout(()=>{c(`mosquitto -c ${s}/proxy/mosquitto.conf -d`,()=>{})},1e3)}catch{}}return _.size>0&&setTimeout(()=>{const e=Array.from(_).join(" ");c(`pm2 restart ${e} --update-env`,()=>{})},500),{success:!0,updated:u,restarted:Array.from(_)}}catch(e){if(e.statusCode)throw e;throw s({statusCode:500,message:"Failed to save config: "+e.message})}});export{p as default};
