import{d as e,r as t,b as o,c as s}from"../../../nitro/nitro.mjs";import{existsSync as n,readFileSync as r,mkdirSync as a,writeFileSync as i}from"node:fs";import{resolve as c}from"node:path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"fs";import"path";import"fs/promises";import"node:url";function getConfig(e){const t=c(e,"data","system","cloudflare-config.json");if(!n(t))return{};try{return JSON.parse(r(t,"utf-8"))}catch{return{}}}function saveConfig(e,t){const o=c(e,"data","system");n(o)||a(o,{recursive:!0}),i(c(o,"cloudflare-config.json"),JSON.stringify(t,null,2))}async function cfFetch(e,t,o={}){var s;const n=await fetch(`https://api.cloudflare.com/client/v4${e}`,{...o,headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",...o.headers}}),r=await n.json();if(!r.success){const e=(null==(s=r.errors)?void 0:s.map(e=>e.message).join(", "))||"Cloudflare API error";throw new Error(e)}return r}async function getPublicIp(){const e=["https://api.ipify.org","https://ifconfig.me/ip","https://icanhazip.com"];for(const t of e)try{const e=await fetch(t,{signal:AbortSignal.timeout(5e3)});if(e.ok){const t=(await e.text()).trim();if(/^\d{1,3}(\.\d{1,3}){3}$/.test(t))return t}}catch{}throw new Error("Could not detect public IP")}const d=e(async e=>{var n,r;const a=await t(e),i=null==a?void 0:a.action,c=o();if(!i)throw s({statusCode:400,message:"Missing action"});switch(i){case"test-token":{const e=a.apiToken;if(!e)throw s({statusCode:400,message:"API token required"});try{await cfFetch("/user/tokens/verify",e);const t=(await cfFetch("/zones?per_page=50",e)).result.map(e=>({id:e.id,name:e.name,status:e.status})),o=getConfig(c);return o.apiToken=e,saveConfig(c,o),{success:!0,zones:t}}catch(e){throw s({statusCode:400,message:"Invalid token: "+e.message})}}case"select-zone":{const e=a.zoneId,t=a.zoneName;if(!e)throw s({statusCode:400,message:"Zone ID required"});const o=getConfig(c);return o.zoneId=e,o.zoneName=t||"",saveConfig(c,o),{success:!0}}case"set-records":{const e=a.domain,t=!1!==a.proxied;if(!e)throw s({statusCode:400,message:"Domain required"});const o=getConfig(c);if(!o.apiToken||!o.zoneId)throw s({statusCode:400,message:"Configure API token and zone first"});try{const s=await getPublicIp(),n=[],r=await async function(e,t,o){var s;const n=await cfFetch(`/zones/${t}/dns_records?type=${o.type}&name=${o.name}`,e);if((null==(s=n.result)?void 0:s.length)>0){const s=n.result[0].id;return{id:s,...(await cfFetch(`/zones/${t}/dns_records/${s}`,e,{method:"PUT",body:JSON.stringify(o)})).result}}{const s=await cfFetch(`/zones/${t}/dns_records`,e,{method:"POST",body:JSON.stringify(o)});return{id:s.result.id,...s.result}}}(o.apiToken,o.zoneId,{type:"A",name:e,content:s,proxied:t,ttl:1});return n.push({name:e,type:"A",content:s,proxied:t,id:r.id}),o.domain=e,o.proxyEnabled=t,o.records=n,o.lastIp=s,o.lastSync=Date.now(),saveConfig(c,o),{success:!0,ip:s,records:n}}catch(e){throw s({statusCode:500,message:"DNS update failed: "+e.message})}}case"toggle-proxy":{const e=!!a.proxied,t=getConfig(c);if(!t.apiToken||!t.zoneId||!(null==(n=t.records)?void 0:n.length))throw s({statusCode:400,message:"No records to update"});try{for(const o of t.records)o.id&&o.name===t.domain&&(await cfFetch(`/zones/${t.zoneId}/dns_records/${o.id}`,t.apiToken,{method:"PATCH",body:JSON.stringify({proxied:e})}),o.proxied=e);return t.proxyEnabled=e,saveConfig(c,t),{success:!0}}catch(e){throw s({statusCode:500,message:"Toggle proxy failed: "+e.message})}}case"sync":{const e=getConfig(c);if(!e.apiToken||!e.zoneId||!(null==(r=e.records)?void 0:r.length))throw s({statusCode:400,message:"Nothing to sync"});try{const t=await getPublicIp();if(t===e.lastIp)return{success:!0,message:"IP unchanged",ip:t};for(const o of e.records)o.id&&(await cfFetch(`/zones/${e.zoneId}/dns_records/${o.id}`,e.apiToken,{method:"PATCH",body:JSON.stringify({content:t})}),o.content=t);return e.lastIp=t,e.lastSync=Date.now(),saveConfig(c,e),{success:!0,message:"IP updated",ip:t}}catch(e){throw s({statusCode:500,message:"Sync failed: "+e.message})}}case"remove":{const e=getConfig(c);if(!e.apiToken||!e.zoneId)return saveConfig(c,{}),{success:!0};try{for(const t of e.records||[])if(t.id)try{await cfFetch(`/zones/${e.zoneId}/dns_records/${t.id}`,e.apiToken,{method:"DELETE"})}catch{}return saveConfig(c,{}),{success:!0,message:"Records deleted and config cleared"}}catch(e){throw s({statusCode:500,message:"Remove failed: "+e.message})}}default:throw s({statusCode:400,message:`Unknown action: ${i}`})}});export{d as default};
