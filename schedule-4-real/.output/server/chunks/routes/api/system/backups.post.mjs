import{d as t,b as e,c as o}from"../../../nitro/nitro.mjs";import{mkdirSync as r,createWriteStream as s,existsSync as n,readFileSync as a}from"fs";import{resolve as i}from"path";import{createGzip as p}from"zlib";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const c=t(async()=>{const t=`http://${process.env.QUESTDB_HOST||"127.0.0.1"}:${process.env.QUESTDB_HTTP_PORT||"9000"}`;try{const o=await fetch(`${t}/exec?query=${encodeURIComponent("SHOW TABLES")}`);if(!o.ok)throw new Error("Failed to query tables");const c=await o.json(),m=["sys.","telemetry","_query_trace"],f=c.dataset.map(t=>t[0]).filter(t=>!m.some(e=>t.startsWith(e))),l=i(e(),"database/backups");r(l,{recursive:!0});const d=`backup-${(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19)}.json.gz`,h=i(l,d),u=p({level:6}),w=s(h);u.pipe(w);const y=new Promise((t,e)=>{w.on("close",t),w.on("error",e),u.on("error",e)});u.write(`{"version":1,"created":"${(new Date).toISOString()}","tables":[`);let g=0,b=0;for(let e=0;e<f.length;e++){const o=f[e];try{const e=await fetch(`${t}/exec?query=${encodeURIComponent(`SHOW COLUMNS FROM '${o}'`)}`);if(!e.ok)continue;const r=(await e.json()).dataset.map(t=>({name:t[0],type:t[1]})),s=5e4;let n=0,a=[],i=0;for(;;){const e=await fetch(`${t}/exec?query=${encodeURIComponent(`SELECT * FROM '${o}' LIMIT ${n},${n+s}`)}`);if(!e.ok)break;const r=(await e.json()).dataset||[];if(0===r.length)break;if(a.push(...r),i+=r.length,n+=s,r.length<s)break}b>0&&u.write(","),u.write(JSON.stringify({name:o,schema:r,rowCount:i,data:a})),a=[],g+=i,b++}catch(t){console.error(`[Backup] Error exporting table ${o}:`,t)}}u.write("]");const $={},S=i(e(),"proxy/proxy-config.json");if(n(S))try{$["proxy/proxy-config.json"]=JSON.parse(a(S,"utf-8"))}catch{}return Object.keys($).length>0&&u.write(`,"configFiles":${JSON.stringify($)}`),u.write("}"),u.end(),await y,{success:!0,filename:d,tables:b,totalRows:g,sizeBytes:0}}catch(t){if(t.statusCode)throw t;throw o({statusCode:500,message:"Failed to create backup: "+t.message})}});export{c as default};
