import{d as t,r as s,c as e}from"../../../nitro/nitro.mjs";import{j as o,b as r,a as i}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const a=t(async t=>{const a=await s(t),{type:m,msgIds:p}=a;if(!m||!["status","settings","system"].includes(m))throw e({statusCode:400,message:'Invalid request type. Use "status", "settings", or "system".'});if(!p||!Array.isArray(p))throw e({statusCode:400,message:"msgIds array is required"});const n=await o(),f=[];for(const[t,s]of Object.entries(n.macs))s&&f.push({type:t,mac:s});if(0===f.length)throw e({statusCode:503,message:"No devices detected yet"});let c=0;async function fire(t,s){const e=p[c++];if(e)try{await i({...t,msgId:e},s)}catch{}}if("status"===m)await Promise.all(f.map(t=>fire({method:"getDevSta"},t.type)));else if("settings"===m){const t=[];for(const s of f){const e=r(s.type);if(e.configKeyPaths.length>0){const o=["device","target","alarm","system"];e.hasOutlets&&o.unshift("outlet");for(const e of o)t.push(fire({method:"getConfigField",params:{keyPath:[e]}},s.type))}else t.push(fire({method:"getDevSta"},s.type))}await Promise.all(t)}else"system"===m&&await Promise.all(f.map(t=>fire({method:"getSysSta"},t.type)));return{success:!0}});export{a as default};
