import{d as t,r as e,b as r,c as o}from"../../../nitro/nitro.mjs";import{existsSync as s,mkdirSync as a,readFileSync as i,writeFileSync as p}from"node:fs";import{resolve as n}from"node:path";import{execSync as l}from"node:child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"fs";import"path";import"fs/promises";import"node:url";const m=t(async t=>{var m;const c=await e(t),d=r(),u=n(d,"data","relay"),f=n(u,"relay-config.json");s(u)||a(u,{recursive:!0});const b={enabled:!0,trackerEnabled:!0,port:9443,publicUrl:"",keyRotationIntervalMs:36e5,sessionTtlMs:3e5,packetSize:512,chaffIntervalMs:100,maxCircuits:1e4,maxJitterMs:3,roomTtlMs:12e4,roomHeartbeatIntervalMs:6e4,maxRooms:5e4};let y={...b};if(s(f))try{const t=JSON.parse(i(f,"utf-8"));y={...b,...t}}catch{}if(void 0!==c.enabled&&(y.enabled=!!c.enabled),void 0!==c.trackerEnabled&&(y.trackerEnabled=!!c.trackerEnabled),void 0!==c.port&&(y.port=parseInt(c.port)||9443),void 0!==c.publicUrl&&(y.publicUrl=String(c.publicUrl).trim()),y.enabled&&!y.publicUrl)try{const t=["https://api.ipify.org","https://ifconfig.me/ip","https://icanhazip.com"];for(const e of t)try{const t=await fetch(e,{signal:AbortSignal.timeout(3e3)});if(t.ok){const e=(await t.text()).trim();if(/^\d{1,3}(\.\d{1,3}){3}$/.test(e)){y.publicUrl=`ws://${e}:${y.port||9443}`;break}}}catch{}}catch{}p(f,JSON.stringify(y,null,2));const h=n(d,"src","services","relay","index.cjs");if(!y.enabled){try{l("pm2 stop s4r-relay 2>/dev/null || pm2 stop spiderapp-relay 2>/dev/null || true",{timeout:1e4})}catch{}return{success:!0,message:"Relay stopped"}}try{const t=l("pm2 jlist",{encoding:"utf-8",timeout:5e3}),e=JSON.parse(t).find(t=>"s4r-relay"===t.name||"spiderapp-relay"===t.name),r=(null==e?void 0:e.name)||"s4r-relay";return e&&"online"===(null==(m=e.pm2_env)?void 0:m.status)?l(`pm2 restart ${r}`,{timeout:1e4,cwd:d}):l(e?`pm2 restart ${r}`:`pm2 start ${h} --name s4r-relay --cwd ${d}`,{timeout:1e4,cwd:d}),{success:!0,message:"Relay started"}}catch(t){throw o({statusCode:500,message:`Failed to start relay: ${t.message}`})}});export{m as default};
