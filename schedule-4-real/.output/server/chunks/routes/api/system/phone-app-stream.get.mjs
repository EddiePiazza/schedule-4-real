import{d as e,n as o}from"../../../nitro/nitro.mjs";import t from"mqtt";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";const r=e(async e=>{o(e,"Content-Type","text/event-stream"),o(e,"Cache-Control","no-cache"),o(e,"Connection","keep-alive"),o(e,"X-Accel-Buffering","no");const r=e.node.res,n=process.env.MQTT_HOST||"127.0.0.1",p=process.env.MQTT_PORT||"1883",i=t.connect(`mqtt://${n}:${p}`,{clientId:`phoneapp-stream-${Date.now()}`,clean:!0,reconnectPeriod:5e3,connectTimeout:1e4});i.on("connect",()=>{i.subscribe("ggs/+/+/down",{qos:0})}),i.on("message",(e,o)=>{var t,n;try{const p=e.split("/"),i=(null==(t=p[1])?void 0:t.toUpperCase())||"unknown",s=(null==(n=p[2])?void 0:n.toUpperCase())||"";let a;try{a=JSON.parse(o.toString())}catch{return}const c=a._originalTopic||`SF/GGS/${i}/API/DOWN/${s}`,m={timestamp:Date.now(),topic:c,deviceType:"phoneApp",mac:s,payload:a,meta:{direction:"SERVERâ†’CLIENT",originalDeviceType:i.toLowerCase()}};r.write(`data: ${JSON.stringify(m)}\n\n`)}catch(e){console.error("Error sending phone app SSE message:",e)}}),i.on("error",e=>{console.error("[PhoneAppStream] MQTT error:",e.message)}),e.node.req.on("close",()=>{i.end(!0)});const s=setInterval(()=>{try{r.write(": keepalive\n\n")}catch{clearInterval(s)}},3e4);return e.node.req.on("close",()=>{clearInterval(s)}),new Promise(()=>{})});export{r as default};
