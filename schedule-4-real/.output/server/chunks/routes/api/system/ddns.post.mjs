import{d as t,r as e,c as s}from"../../../nitro/nitro.mjs";import{unlinkSync as o,existsSync as i,writeFileSync as r}from"node:fs";import{execSync as n}from"node:child_process";import{arch as a}from"node:os";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";const m=t(async t=>{const m=await e(t),c=null==m?void 0:m.action;if(!c)throw s({statusCode:400,message:"Missing action"});const p="/usr/local/bin/noip-duc";switch(c){case"install":if(i(p))return{success:!0,message:"No-IP DUC already installed"};try{const t="arm64"===a()?"aarch64":"amd64",e="3.3.0";n(`cd /tmp && wget -q "${`https://dmej8g5cpdyqd.cloudfront.net/downloads/noip-duc_${e}.tar.gz`}" -O noip-duc.tar.gz && tar xzf noip-duc.tar.gz`,{timeout:3e4,stdio:"pipe"});const s=`/tmp/noip-duc_${e}/binaries/${`noip-duc-linux-${t}`}`,o=`/tmp/noip-duc_${e}/binaries/noip-duc-linux-amd64`,r=i(s)?s:o;return n(`cp "${r}" ${p} && chmod +x ${p}`,{timeout:5e3,stdio:"pipe"}),n("rm -rf /tmp/noip-duc*",{timeout:3e3,stdio:"pipe"}),{success:!0,message:"No-IP DUC installed"}}catch(t){throw s({statusCode:500,message:"Failed to install DUC: "+t.message})}case"configure":{const t=m.hostname,e=m.username,o=m.password;if(!t||!e||!o)throw s({statusCode:400,message:"hostname, username, and password are required"});if(!i(p))throw s({statusCode:400,message:"DUC is not installed. Install it first."});try{return r("/etc/systemd/system/noip-duc.service",`[Unit]\nDescription=No-IP Dynamic Update Client\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=simple\nExecStart=${p} -g ${t} --username "${e}" --password "${o}"\nRestart=on-failure\nRestartSec=30\n\n[Install]\nWantedBy=multi-user.target\n`),n("systemctl daemon-reload",{timeout:5e3}),n("systemctl enable noip-duc",{timeout:5e3}),n("systemctl restart noip-duc",{timeout:1e4}),{success:!0,message:`DUC configured for ${t}`}}catch(t){throw s({statusCode:500,message:"Failed to configure DUC: "+t.message})}}case"remove":try{try{n("systemctl stop noip-duc",{timeout:5e3,stdio:"pipe"})}catch{}try{n("systemctl disable noip-duc",{timeout:5e3,stdio:"pipe"})}catch{}try{o("/etc/systemd/system/noip-duc.service")}catch{}try{n("systemctl daemon-reload",{timeout:5e3,stdio:"pipe"})}catch{}try{o(p)}catch{}return{success:!0,message:"DUC removed"}}catch(t){throw s({statusCode:500,message:"Failed to remove DUC: "+t.message})}default:throw s({statusCode:400,message:`Unknown action: ${c}`})}});export{m as default};
