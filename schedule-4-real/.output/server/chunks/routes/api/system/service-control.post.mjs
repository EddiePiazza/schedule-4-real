import{d as t,r as s,c as e,b as r}from"../../../nitro/nitro.mjs";import{execSync as o,exec as p}from"child_process";import{readFileSync as i}from"fs";import{resolve as n}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const a=["s4r-web","s4r-ingest","s4r-retention","s4r-supervisor","s4r-mosquitto","s4r-proxy","s4r-cameras","s4r-relay","s4r-tunnel","spiderapp-web","spiderapp-ingest","spiderapp-retention","spiderapp-supervisor","spiderapp-mosquitto","spiderapp-proxy","spiderapp-cameras","spiderapp-relay","spiderapp-tunnel","questdb"];const m=t(async t=>{const m=await s(t),{name:c,action:d}=m;if(!c||!d)throw e({statusCode:400,message:"Missing name or action"});if(!a.includes(c))throw e({statusCode:400,message:`Unknown service: ${c}`});if(!["restart","stop"].includes(d))throw e({statusCode:400,message:`Unknown action: ${d}`});if("restart"===d)try{const t=n(r(),".env"),s=i(t,"utf-8");for(const t of s.split("\n")){const s=t.trim();if(!s||s.startsWith("#"))continue;const e=s.indexOf("=");if(-1===e)continue;const r=s.slice(0,e).trim(),o=s.slice(e+1).trim();process.env[r]=o}process.env.API_PORT&&(process.env.NITRO_PORT=process.env.API_PORT)}catch{}try{if("questdb"===c){const t=function(){try{const t=o('docker ps -a --format "{{.Names}}"',{encoding:"utf-8",timeout:3e3});if(t.includes("s4r-questdb"))return"s4r-questdb";if(t.includes("spiderapp-questdb"))return"spiderapp-questdb"}catch{}return"s4r-questdb"}();o("restart"===d?`docker restart ${t}`:`docker stop ${t}`,{timeout:3e4})}else if("spiderapp-mosquitto"===c||"spiderapp-proxy"===c||"s4r-mosquitto"===c||"s4r-proxy"===c)o("restart"===d?`pm2 restart ${c} --update-env`:`pm2 stop ${c}`,{timeout:1e4});else{if("spiderapp-web"===c||"s4r-web"===c){const t="restart"===d?" --update-env":"";return setTimeout(()=>{p(`pm2 ${d} ${c}${t}`,()=>{})},500),{success:!0,name:c,action:d}}o("restart"===d?`pm2 restart ${c} --update-env`:`pm2 stop ${c}`,{timeout:1e4})}return{success:!0,name:c,action:d}}catch(t){throw e({statusCode:500,message:`Failed to ${d} ${c}: ${t.message}`})}});export{m as default};
