import{d as t,b as e}from"../../../nitro/nitro.mjs";import{execSync as s}from"child_process";import{existsSync as p,readFileSync as o}from"fs";import{join as n}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const r=t(async t=>{var r,i,u,m,a,l,d,c,h,f,y;const v=[];try{const t=s("pm2 jlist",{encoding:"utf-8",timeout:5e3}),e=JSON.parse(t);for(const t of e)((null==(r=t.name)?void 0:r.startsWith("s4r-"))||(null==(i=t.name)?void 0:i.startsWith("spiderapp-")))&&v.push({name:t.name,status:(null==(u=t.pm2_env)?void 0:u.status)||"unknown",cpu:(null==(m=t.monit)?void 0:m.cpu)||0,memory:(null==(a=t.monit)?void 0:a.memory)||0,uptime:(null==(l=t.pm2_env)?void 0:l.pm_uptime)?Date.now()-t.pm2_env.pm_uptime:0,restarts:(null==(d=t.pm2_env)?void 0:d.restart_time)||0,pid:t.pid||null})}catch(t){console.error("[System] Failed to get PM2 list:",t.message)}try{let t=s('docker ps --filter name=s4r-questdb --format "{{.Status}}"',{encoding:"utf-8",timeout:3e3}).trim();t||(t=s('docker ps --filter name=spiderapp-questdb --format "{{.Status}}"',{encoding:"utf-8",timeout:3e3}).trim()),v.push({name:"questdb",status:t.includes("Up")?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}catch{v.push({name:"questdb",status:"unknown",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{const t="false"!==process.env.APPDATA_SYNC_ENABLED,s=n(e(),"data","appdata"),r=n(s,"appdata-index.json");let i=0;if(p(r)){const t=JSON.parse(o(r,"utf-8"));i=Object.keys(t.files||{}).length}const u="online"===(null==(c=v.find(t=>"s4r-supervisor"===t.name||"spiderapp-supervisor"===t.name))?void 0:c.status);v.push({name:"appdata-sync",status:t&&u?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:i,pid:null})}catch{v.push({name:"appdata-sync",status:"unknown",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{s("docker info",{timeout:3e3,stdio:"pipe"}),v.push({name:"docker-engine",status:"online",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}catch{v.push({name:"docker-engine",status:"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{const t=process.env.PROXY_PORT||"8883",e=s(`lsof -Pi :${t} -sTCP:ESTABLISHED 2>/dev/null | grep -v '127.0.0.1\\|localhost' | grep -c -e '->.*:8883'`,{encoding:"utf-8",timeout:3e3}).trim(),p=parseInt(e)||0;v.push({name:"cloud-bridge",status:p>0?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:p,pid:null})}catch{v.push({name:"cloud-bridge",status:"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{const t=process.env.WS_PORT||"3001",e=s(`lsof -Pi :${t} -sTCP:LISTEN -t 2>/dev/null`,{encoding:"utf-8",timeout:3e3}).trim();v.push({name:"websocket",status:e?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:e?parseInt(e.split("\n")[0]):null})}catch{const t=v.find(t=>"s4r-web"===t.name||"spiderapp-web"===t.name);v.push({name:"websocket",status:"online"===(null==t?void 0:t.status)?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{const t=await fetch("http://127.0.0.1:1985/status").catch(()=>null);if(null==t?void 0:t.ok){const e=await t.json();v.push({name:"go2rtc",status:e.running?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:e.pid||null})}else v.push({name:"go2rtc",status:"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}catch{v.push({name:"go2rtc",status:"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}try{const t=process.env.QUESTDB_HTTP_PORT||"9000",e=s(`curl -sf "http://127.0.0.1:${t}/exec?query=SELECT%20count()%20FROM%20automation_flows%20WHERE%20enabled%20%3D%20true"`,{encoding:"utf-8",timeout:3e3}),p=JSON.parse(e),o=(null==(f=null==(h=null==p?void 0:p.dataset)?void 0:h[0])?void 0:f[0])||0,n="online"===(null==(y=v.find(t=>"s4r-web"===t.name||"spiderapp-web"===t.name))?void 0:y.status);v.push({name:"automation",status:n&&o>0?"online":"stopped",cpu:0,memory:0,uptime:0,restarts:o,pid:null})}catch{v.push({name:"automation",status:"stopped",cpu:0,memory:0,uptime:0,restarts:0,pid:null})}return v});export{r as default};
