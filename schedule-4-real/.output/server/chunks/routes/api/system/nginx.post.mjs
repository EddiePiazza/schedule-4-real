import{d as e,r as t,c as r,b as n}from"../../../nitro/nitro.mjs";import{writeFileSync as s,readFileSync as o,existsSync as a}from"node:fs";import{resolve as i}from"node:path";import{execSync as p}from"node:child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"fs";import"path";import"fs/promises";import"node:url";const d=e(async e=>{var d,c,_,l;const u=await t(e),m=null==u?void 0:u.action;if(!m)throw r({statusCode:400,message:"Missing action"});switch(m){case"status":{const e=(()=>{try{return p("which nginx",{stdio:"pipe",timeout:3e3}),!0}catch{return!1}})(),t=(()=>{try{return"active"===p("systemctl is-active nginx",{encoding:"utf-8",stdio:"pipe",timeout:3e3}).trim()}catch{return!1}})(),r=a("/etc/nginx/sites-available/schedule4real"),n=(()=>{if(!r)return"";try{const e=o("/etc/nginx/sites-available/schedule4real","utf-8").match(/ssl_certificate\s+\/etc\/letsencrypt\/live\/([^/]+)\//);return(null==e?void 0:e[1])||""}catch{return""}})();return{installed:e,running:t,configExists:r,sslDomain:n}}case"install":try{return p("apt-get update -qq && apt-get install -y nginx",{timeout:6e4,stdio:"pipe"}),{success:!0,message:"Nginx installed"}}catch(e){throw r({statusCode:500,message:"Failed to install Nginx: "+((null==(d=e.stderr)?void 0:d.toString())||e.message)})}case"configure":{const e=u.domain,t=process.env.API_PORT||"3000",a=process.env.RELAY_PORT||"9443";if(!e)throw r({statusCode:400,message:"Domain is required"});const d=`# Schedule 4 Real — Auto-generated\n# ${e} → port ${t}, /relay → port ${a}\n\nserver {\n    listen 80;\n    server_name ${e};\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name ${e};\n\n    # SSL certificates will be added by certbot\n    # ssl_certificate /etc/letsencrypt/live/${e}/fullchain.pem;\n    # ssl_certificate_key /etc/letsencrypt/live/${e}/privkey.pem;\n\n    location ~ ^/(models|images|sound|fonts|defaults)/ {\n        proxy_pass http://127.0.0.1:${t};\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        expires off;\n        add_header Cache-Control "no-store, no-cache";\n    }\n\n    # Relay Node (WebSocket) — /relay\n    location /relay {\n        proxy_pass http://127.0.0.1:${a}/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_read_timeout 86400s;\n        proxy_send_timeout 86400s;\n    }\n\n    location /_ws {\n        proxy_pass http://127.0.0.1:${t};\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_read_timeout 86400s;\n        proxy_send_timeout 86400s;\n    }\n\n    location /_room3d-ws {\n        proxy_pass http://127.0.0.1:${t};\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_read_timeout 86400s;\n        proxy_send_timeout 86400s;\n    }\n\n    location /mqtt {\n        proxy_pass http://127.0.0.1:9001;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_read_timeout 86400s;\n        proxy_send_timeout 86400s;\n    }\n\n    location / {\n        proxy_pass http://127.0.0.1:${t};\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}`;try{s("/etc/nginx/sites-available/schedule4real",d);try{p("rm -f /etc/nginx/sites-enabled/default",{timeout:3e3})}catch{}try{p("rm -f /etc/nginx/sites-enabled/spiderfarmer",{timeout:3e3})}catch{}p("ln -sf /etc/nginx/sites-available/schedule4real /etc/nginx/sites-enabled/",{timeout:3e3}),p("nginx -t",{timeout:5e3,stdio:"pipe"}),p("systemctl reload nginx",{timeout:1e4});const t=i(n(),".env");let r=o(t,"utf-8");return r.includes("APP_DOMAIN=")?r=r.replace(/APP_DOMAIN=.*/,`APP_DOMAIN=${e}`):r+=`\nAPP_DOMAIN=${e}`,s(t,r),process.env.APP_DOMAIN=e,{success:!0,message:`Nginx configured for ${e}`}}catch(e){throw r({statusCode:500,message:"Nginx config failed: "+((null==(c=e.stderr)?void 0:c.toString())||e.message)})}}case"install-ssl":{const e=u.domain,t=u.email;if(!e)throw r({statusCode:400,message:"Domain required"});try{p("apt-get install -y certbot python3-certbot-nginx",{timeout:6e4,stdio:"pipe"});const r=t?`-m ${t}`:"--register-unsafely-without-email";return{success:!0,message:"SSL certificate installed",output:p(`certbot --nginx -d ${e} --non-interactive --agree-tos ${r}`,{timeout:12e4,encoding:"utf-8",stdio:"pipe"}).slice(-500)}}catch(e){throw r({statusCode:500,message:"SSL setup failed: "+((null==(l=null==(_=e.stderr)?void 0:_.toString())?void 0:l.slice(-500))||e.message)})}}default:throw r({statusCode:400,message:`Unknown action: ${m}`})}});export{d as default};
