import{d as t,r as o,c as e,b as r}from"../../../nitro/nitro.mjs";import{existsSync as i,readFileSync as s,writeFileSync as m}from"fs";import{resolve as p}from"path";import{execSync as n}from"child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const a={privateMode:!1,remoteEnabled:!1,remoteHost:"",remotePort:1884},d=t(async t=>{const d=await o(t);if(!d||"object"!=typeof d)throw e({statusCode:400,message:"Invalid request body"});try{const t=p(r(),"proxy/proxy-config.json");let o={...a};if(i(t))try{o={...a,...JSON.parse(s(t,"utf-8"))}}catch{}"privateMode"in d&&(o.privateMode=Boolean(d.privateMode)),"remoteEnabled"in d&&(o.remoteEnabled=Boolean(d.remoteEnabled)),"remoteHost"in d&&null!=d.remoteHost&&(o.remoteHost=String(d.remoteHost)),"remotePort"in d&&null!=d.remotePort&&(o.remotePort=Number(d.remotePort)||1884),m(t,JSON.stringify(o,null,2));try{const t=process.env.PROXY_PORT||"8883",o=n(`lsof -Pi :${t} -sTCP:LISTEN -t 2>/dev/null`,{encoding:"utf-8",timeout:3e3}).trim();o&&n(`kill -HUP ${o.split("\n")[0]}`,{timeout:3e3})}catch{}return{success:!0,config:o}}catch(t){if(t.statusCode)throw t;throw e({statusCode:500,message:"Failed to save proxy config: "+t.message})}});export{d as default};
