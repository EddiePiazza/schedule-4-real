import{d as t,r as e,c as o,b as r}from"../../../nitro/nitro.mjs";import{readFile as s,mkdir as i,writeFile as a}from"fs/promises";import{join as n}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"node:url";const m="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",p=/^[A-Z0-9]{4}$/;function generateCode(){let t="";for(let e=0;e<4;e++)t+=m[Math.floor(36*Math.random())];return t}const d=t(async t=>{const m=await e(t),d=String((null==m?void 0:m.envId)||"").replace(/[^a-zA-Z0-9._-]/g,"");if(!d)throw o({statusCode:400,message:"envId required"});const c=n(r(),"data","room3d"),f=n(c,"room-codes.json");let l={};try{l=JSON.parse(await s(f,"utf-8"))}catch{}let u=String(m.code||"").toUpperCase().trim();if(u){if(!p.test(u))throw o({statusCode:400,message:"Code must be 4 alphanumeric characters (A-Z, 0-9)"});for(const[t,e]of Object.entries(l))if(e===u&&t!==d)throw o({statusCode:409,message:"Code already in use by another room"})}else{const t=new Set(Object.values(l));let e=0;do{u=generateCode(),e++}while(t.has(u)&&e<100)}return l[d]=u,await i(c,{recursive:!0}),await a(f,JSON.stringify(l,null,2),"utf-8"),{ok:!0,envId:d,code:u}});export{d as default};
