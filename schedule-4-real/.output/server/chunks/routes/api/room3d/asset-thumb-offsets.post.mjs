import{d as t,r as o,c as e,b as s}from"../../../nitro/nitro.mjs";import{mkdir as a,readFile as f,writeFile as r}from"fs/promises";import{join as m}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"node:url";const i=t(async t=>{var i,n,p,l,d;const c=await o(t);if(!c||"string"!=typeof c.filename||!c.offset||"object"!=typeof c.offset)throw e({statusCode:400,message:"filename (string) and offset ({ x, y, z, zoom }) required"});const u=c.filename.replace(/[^a-zA-Z0-9._-]/g,"");if(!u.endsWith(".glb"))throw e({statusCode:400,message:"Invalid filename"});const h=!0===c.system,y=h?m(s(),"data","appdata","defaults"):m(s(),"data","room3d");await a(y,{recursive:!0});const b=m(y,"asset-thumb-offsets.json");let g={};const z=h?m(s(),"data","room3d"):m(s(),"data","appdata","defaults");for(const t of[b,m(z,"asset-thumb-offsets.json")])try{g=JSON.parse(await f(t,"utf-8"));break}catch{}const round=t=>Math.round(1e4*t)/1e4,w={x:round(null!=(i=c.offset.x)?i:0),y:round(null!=(n=c.offset.y)?n:0),z:round(null!=(p=c.offset.z)?p:0),zoom:round(null!=(l=c.offset.zoom)?l:1),light:round(null!=(d=c.offset.light)?d:1)};return null!=c.offset.camX&&(w.camX=round(c.offset.camX)),null!=c.offset.camY&&(w.camY=round(c.offset.camY)),null!=c.offset.camZ&&(w.camZ=round(c.offset.camZ)),g[u]=w,await r(b,JSON.stringify(g,null,2),"utf-8"),{ok:!0,offsets:g}});export{i as default};
