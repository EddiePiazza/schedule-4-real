import{d as t,r as o,c as e,b as i}from"../../../nitro/nitro.mjs";import{mkdir as s,readFile as r,writeFile as a}from"fs/promises";import{join as m}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"node:url";const n=t(async t=>{const n=await o(t);if(!n||"string"!=typeof n.id||!n.id.trim())throw e({statusCode:400,message:"id (string) required"});const p="system"===n.source?"system":"user",d=m(i(),"data","appdata","models","rooms"),c=m(i(),"data","room3d","models","rooms"),f="system"===p?d:c,l=m(f,"rooms.json");await s(f,{recursive:!0});let u=[],h=[];try{u=JSON.parse(await r(m(d,"rooms.json"),"utf-8"))}catch{}try{h=JSON.parse(await r(m(c,"rooms.json"),"utf-8"))}catch{}const y="system"===p?u:h,g=new Set([...u.map(t=>t.id),...h.map(t=>t.id)]);let b=n.id.replace(/[^a-zA-Z0-9._-]/g,"_");const w=!0===n.update;if(!w&&g.has(b)){let t=2;for(;g.has(`${b}_${t}`);)t++;b=`${b}_${t}`}const j={id:b,name:(n.name||b).slice(0,100),description:(n.description||"").slice(0,500),file:n.file||"",size:n.size||"",icon:n.icon||"CubeIcon"};if(n.image&&(j.image=n.image),"boolean"==typeof n.animated&&(j.animated=n.animated),"boolean"==typeof n.hidden&&(j.hidden=n.hidden),w){const t=y.findIndex(t=>t.id===b);t>=0?y[t]=j:y.push(j)}else y.push(j);return await a(l,JSON.stringify(y,null,2),"utf-8"),{ok:!0,room:j}});export{n as default};
