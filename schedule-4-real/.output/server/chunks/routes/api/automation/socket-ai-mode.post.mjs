import{d as t,r as o,c as e}from"../../../nitro/nitro.mjs";import{query as s}from"../../../_/db.mjs";import{g as i,b as r,s as a,a as m,c as p,u as d}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";import"mqtt";import"child_process";const c=t(async t=>{var c,n;const l=await o(t);if(!l.socket)throw e({statusCode:400,message:"Socket is required"});if(!["O1","O2","O3","O4","O5"].includes(l.socket))throw e({statusCode:400,message:"Invalid socket name. Must be O1-O5"});const u=i();if(!r(u).hasOutlets)throw e({statusCode:404,message:"This device type does not have outlets"});try{if(l.aiMode){const t=["outlet",l.socket];let o={};try{const e=await a({method:"getConfigField",params:{keyPath:t}},u,3e3);o=(null==(c=null==e?void 0:e.data)?void 0:c[l.socket])||{}}catch{}const e={...o,modeType:0,mOnOff:0};await m({method:"setConfigField",params:{keyPath:t,[l.socket]:e}},u);const s=p(u),i=(null==(n=null==s?void 0:s.data)?void 0:n.outlet)||{};d(u,{outlet:{...i,[l.socket]:e}})}return await s("\n      INSERT INTO socket_ai_mode (timestamp, socket, ai_mode, updated_by)\n      VALUES (now(), $1, $2, 'user')\n    ",[l.socket,l.aiMode?1:0]),{success:!0,socket:l.socket,aiMode:l.aiMode}}catch(t){throw console.error("Failed to set socket AI mode:",t),e({statusCode:500,message:"Failed to set socket AI mode"})}});export{c as default};
