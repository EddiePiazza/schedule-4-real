import{d as t,g as o,r as e,c as n}from"../../../../nitro/nitro.mjs";import{query as i}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const a=t(async t=>{const a=o(t,"id"),d=await e(t);if(!a)throw n({statusCode:400,message:"Flow ID is required"});try{const t=[],o=[];let e=1;if(void 0!==d.name&&(t.push("name = $"+e++),o.push(d.name)),void 0!==d.description&&(t.push("description = $"+e++),o.push(d.description)),void 0!==d.enabled&&(t.push("enabled = $"+e++),o.push(d.enabled?1:0)),void 0!==d.flow&&(t.push("flow_json = $"+e++),o.push(JSON.stringify(d.flow))),0===t.length)throw n({statusCode:400,message:"No fields to update"});t.push("updated_at = now()"),o.push(a);const s=await i("\n      SELECT id, name, description, enabled, flow_json, created_at\n      FROM automation_flows\n      WHERE id = $1\n      ORDER BY updated_at DESC\n      LIMIT 1\n    ",[a]);let r;if(0===s.length)r={id:a,name:d.name||"Global Automation",description:d.description||"Main automation configuration",enabled:void 0!==d.enabled&&d.enabled?1:0,flow_json:void 0!==d.flow?JSON.stringify(d.flow):'{"nodes":[],"connections":[]}',created_at:(new Date).toISOString()};else{const t=s[0];r={id:t.id,name:void 0!==d.name?d.name:t.name,description:void 0!==d.description?d.description:t.description,enabled:void 0!==d.enabled?d.enabled?1:0:t.enabled,flow_json:void 0!==d.flow?JSON.stringify(d.flow):t.flow_json,created_at:t.created_at}}return await i("\n      INSERT INTO automation_flows (id, name, description, enabled, flow_json, created_at, updated_at)\n      VALUES ($1, $2, $3, $4, $5, $6, now())\n    ",[r.id,r.name,r.description,r.enabled,r.flow_json,r.created_at]),{id:r.id,name:r.name,description:r.description,enabled:1===r.enabled,flow:r.flow_json?JSON.parse(r.flow_json):{nodes:[],connections:[]},createdAt:r.created_at,updatedAt:(new Date).toISOString()}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to update flow:",t),n({statusCode:500,message:"Failed to update flow"})}});export{a as default};
