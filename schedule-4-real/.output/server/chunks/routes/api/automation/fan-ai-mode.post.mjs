import{d as e,r as t,c as o}from"../../../nitro/nitro.mjs";import{query as m}from"../../../_/db.mjs";import{g as i,s as a,a as r,u as n}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";import"mqtt";import"child_process";const p=e(async e=>{var p,d,s,l,c,f,u;const h=await t(e),y=i();try{if(h.aiMode){const e=["device","fan"];let t={};try{const o=await a({method:"getConfigField",params:{keyPath:e}},y,3e3);t=(null==(p=null==o?void 0:o.data)?void 0:p.fan)||{}}catch{}const o={modeType:0,minSpeed:null!=(d=t.minSpeed)?d:0,maxSpeed:null!=(s=t.maxSpeed)?s:0,shakeLevel:null!=(l=t.shakeLevel)?l:0,natural:null!=(c=t.natural)?c:0,mOnOff:null!=(f=t.mOnOff)?f:0,mLevel:null!=(u=t.mLevel)?u:5};t.timePeriod&&(o.timePeriod=t.timePeriod),t.cycleTime&&(o.cycleTime=t.cycleTime),await r({method:"setConfigField",params:{keyPath:e,fan:o}},y),n(y,{fan:{on:1===o.mOnOff,level:o.mLevel,modeType:o.modeType,minSpeed:o.minSpeed,maxSpeed:o.maxSpeed,shakeLevel:o.shakeLevel,natural:o.natural,timePeriod:o.timePeriod,cycleTime:o.cycleTime}})}return await m("\n      INSERT INTO fan_ai_mode (timestamp, device, ai_mode, updated_by)\n      VALUES (now(), 'fan', $1, 'user')\n    ",[h.aiMode?1:0]),{success:!0,aiMode:h.aiMode}}catch(e){throw console.error("Failed to set fan AI mode:",e),o({statusCode:500,message:"Failed to set fan AI mode"})}});export{p as default};
