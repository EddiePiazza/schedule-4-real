import{d as t,a as o}from"../../../nitro/nitro.mjs";import{query as e}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const r=t(async t=>{const{limit:r="50"}=o(t),i=Math.min(parseInt(r)||50,200);try{let normalizeTs=function(t){return t instanceof Date?t.toISOString():"string"==typeof t?t.endsWith("Z")?t:t.replace(" ","T")+"Z":String(t)};const t=await e(`\n      SELECT timestamp, socket, is_on\n      FROM socket_events\n      ORDER BY timestamp DESC\n      LIMIT ${i}\n    `);let o=[];try{o=await e(`\n        SELECT timestamp, flow_name, socket, action, trigger_reason\n        FROM trigger_execution_log\n        ORDER BY timestamp DESC\n        LIMIT ${i}\n      `)}catch{}const r=[];for(const o of t)r.push({timestamp:normalizeTs(o.timestamp),socket:o.socket,action:1===o.is_on?"on":"off",source:"device"});for(const t of o)r.push({timestamp:normalizeTs(t.timestamp),socket:t.socket,action:t.action,source:"trigger",flowName:t.flow_name,reason:t.trigger_reason});return r.sort((t,o)=>new Date(o.timestamp).getTime()-new Date(t.timestamp).getTime()),r.slice(0,i)}catch(t){return console.error("Failed to fetch socket log:",t),[]}});export{r as default};
