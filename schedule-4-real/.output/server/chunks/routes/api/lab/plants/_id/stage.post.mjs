import{d as t,g as e,r as n,c as a}from"../../../../../nitro/nitro.mjs";import{query as r}from"../../../../../_/db.mjs";import{randomUUID as o}from"crypto";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=t(async t=>{var s,i;const _=e(t,"id"),d=await n(t);if(!_)throw a({statusCode:400,message:"Plant ID is required"});if(!d.stage)throw a({statusCode:400,message:"Stage is required"});const l=(new Date).toISOString(),g=(null==(s=d.transition_data)?void 0:s.transition_date)||l.split("T")[0],p=(null==(i=d.transition_data)?void 0:i.notes)||null;try{const t=await r(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE id = '${_}' AND is_deleted = 0\n      )\n      WHERE rn = 1\n      LIMIT 1\n    `);if(0===t.length)throw a({statusCode:404,message:"Plant not found"});const e=t[0];await r(`\n      INSERT INTO lab_plants (\n        timestamp, id, strain_id, seed_batch_id, zone_id, plant_code, pheno_label,\n        origin_type, parent_plant_id, project_goal, status, selection_status,\n        is_keeper, sex, date_started, current_week, current_day,\n        date_to_veg, date_to_flower, date_harvested,\n        container_size, grow_medium, nutrients_type, training_methods,\n        is_deleted\n      ) VALUES (\n        now(),\n        '${_}',\n        ${e.strain_id?`'${e.strain_id}'`:"NULL"},\n        ${e.seed_batch_id?`'${e.seed_batch_id}'`:"NULL"},\n        ${e.zone_id?`'${e.zone_id}'`:"NULL"},\n        '${e.plant_code}',\n        ${e.pheno_label?`'${e.pheno_label}'`:"NULL"},\n        '${e.origin_type}',\n        ${e.parent_plant_id?`'${e.parent_plant_id}'`:"NULL"},\n        '${e.project_goal||"keeper"}',\n        '${d.stage}',\n        '${e.selection_status||"active"}',\n        ${e.is_keeper?1:0},\n        '${e.sex||"unknown"}',\n        '${e.date_started}',\n        ${e.current_week||1},\n        ${e.current_day||1},\n        ${getStageDate("date_to_veg",e,d.stage,g)},\n        ${getStageDate("date_to_flower",e,d.stage,g)},\n        ${getStageDate("date_harvested",e,d.stage,g)},\n        ${e.container_size||"NULL"},\n        ${e.grow_medium?`'${e.grow_medium}'`:"NULL"},\n        ${e.nutrients_type?`'${e.nutrients_type}'`:"NULL"},\n        ${e.training_methods?`'${e.training_methods}'`:"NULL"},\n        0\n      )\n    `),await r(`\n      INSERT INTO lab_stage_log (\n        timestamp, id, plant_id, stage, started_at, notes\n      ) VALUES (\n        now(),\n        '${o()}',\n        '${_}',\n        '${d.stage}',\n        '${g}',\n        ${p?`'${p.replace(/'/g,"''")}'`:"NULL"}\n      )\n    `);let n=null;if(e.strain_id)try{const t=await r(`\n          SELECT name FROM (\n            SELECT name, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n            FROM lab_strains\n            WHERE id = '${e.strain_id}' AND is_deleted = 0\n          )\n          WHERE rn = 1\n          LIMIT 1\n        `);t.length>0&&(n=t[0].name)}catch{}return{...e,status:d.stage,strain_name:n,date_to_veg:getStageDateValue("date_to_veg",e,d.stage,g),date_to_flower:getStageDateValue("date_to_flower",e,d.stage,g),date_harvested:getStageDateValue("date_harvested",e,d.stage,g)}}catch(t){throw console.error("Failed to change plant stage:",t),a({statusCode:500,message:"Failed to change plant stage"})}});function getStageDate(t,e,n,a){const r=getStageDateValue(t,e,n,a);return r?`'${r}'`:"NULL"}function getStageDateValue(t,e,n,a){return"date_to_veg"===t?["early_veg","mid_veg","late_veg"].includes(n)&&!e.date_to_veg?a:e.date_to_veg||null:"date_to_flower"===t?["pre_flower","early_flower","mid_flower","late_flower","flush"].includes(n)&&!e.date_to_flower?a:e.date_to_flower||null:"date_harvested"===t?["harvest","drying","curing"].includes(n)&&!e.date_harvested?a:e.date_harvested||null:null}export{s as default};
