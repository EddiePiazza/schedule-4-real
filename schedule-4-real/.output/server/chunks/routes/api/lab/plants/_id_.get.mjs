import{d as t,g as a,c as n}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as r,query as i}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=t(async t=>{const s=a(t,"id");if(!s)throw n({statusCode:400,message:"Plant ID is required"});let e;try{e=r(s)}catch{throw n({statusCode:400,message:"Invalid plant ID format"})}try{const t=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE id = '${e}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n    `);if(!t.length)throw n({statusCode:404,message:"Plant not found"});const a=t[0];let r=null;if(a.strain_id){r=(await i(`\n        SELECT * FROM (\n          SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n          FROM lab_strains\n          WHERE id = '${a.strain_id}'\n        )\n        WHERE rn = 1 AND is_deleted = 0\n      `))[0]||null}const s=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_observations\n        WHERE plant_id = '${e}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n      ORDER BY observed_at DESC\n      LIMIT 20\n    `),o=await i(`\n      SELECT * FROM lab_stage_log\n      WHERE plant_id = '${e}'\n      ORDER BY timestamp ASC\n    `),l=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY plant_id ORDER BY timestamp DESC) as rn\n        FROM lab_plant_scores\n        WHERE plant_id = '${e}'\n      )\n      WHERE rn = 1\n    `),_=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY plant_id ORDER BY timestamp DESC) as rn\n        FROM lab_phenotype_traits\n        WHERE plant_id = '${e}'\n      )\n      WHERE rn = 1\n    `),p=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_media\n        WHERE plant_id = '${e}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n      ORDER BY timestamp DESC\n      LIMIT 50\n    `),E=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY plant_id ORDER BY timestamp DESC) as rn\n        FROM lab_harvest_data\n        WHERE plant_id = '${e}'\n      )\n      WHERE rn = 1\n    `);return{...{...a,training_methods:a.training_methods?JSON.parse(a.training_methods):[],strain:r?{...r,dominant_terpenes:r.dominant_terpenes?JSON.parse(r.dominant_terpenes):[]}:null},observations:s.map(t=>({...t,photos:t.photos?JSON.parse(t.photos):[],checklist_data:t.checklist_data?JSON.parse(t.checklist_data):null,training_applied:t.training_applied?JSON.parse(t.training_applied):[]})),stage_log:o.map(t=>({...t,transition_data:t.transition_data?JSON.parse(t.transition_data):null})),scores:l[0]||null,traits:_[0]?{..._[0],germination_traits:_[0].germination_traits?JSON.parse(_[0].germination_traits):null,seedling_traits:_[0].seedling_traits?JSON.parse(_[0].seedling_traits):null,leaf_traits:_[0].leaf_traits?JSON.parse(_[0].leaf_traits):null,stalk_traits:_[0].stalk_traits?JSON.parse(_[0].stalk_traits):null,aroma_traits:_[0].aroma_traits?JSON.parse(_[0].aroma_traits):null,growth_habit_traits:_[0].growth_habit_traits?JSON.parse(_[0].growth_habit_traits):null,flowering_traits:_[0].flowering_traits?JSON.parse(_[0].flowering_traits):null,flower_aroma_traits:_[0].flower_aroma_traits?JSON.parse(_[0].flower_aroma_traits):null,resistance_traits:_[0].resistance_traits?JSON.parse(_[0].resistance_traits):null}:null,media:p,harvest_data:E[0]?{...E[0],trichome_state:E[0].trichome_state?JSON.parse(E[0].trichome_state):null,cure_aroma_profile:E[0].cure_aroma_profile?JSON.parse(E[0].cure_aroma_profile):[],dry_conditions:E[0].dry_conditions?JSON.parse(E[0].dry_conditions):null}:null}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to fetch plant:",t),n({statusCode:500,message:"Failed to fetch plant details"})}});export{s as default};
