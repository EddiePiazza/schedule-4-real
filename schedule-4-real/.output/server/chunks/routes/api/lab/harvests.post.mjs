import{d as t,r as e,c as _}from"../../../nitro/nitro.mjs";import{sanitizeUUID as l,query as n,sanitizeString as r,sanitizeInt as a,sanitizeFloat as o}from"../../../_/db.mjs";import{randomUUID as i}from"crypto";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=t(async t=>{var s,u,m,d,p,g,c,y,h,L,f,w,$,N,U,b,E,O,R,S,v,C,T,x,I,k;const D=await e(t);if(!D.plant_id)throw _({statusCode:400,message:"plant_id is required"});let F;try{F=l(D.plant_id)}catch{throw _({statusCode:400,message:"Invalid plant_id format"})}const J=i(),A=(new Date).toISOString();try{if(!(await n(`\n      SELECT id FROM (\n        SELECT id, is_deleted, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE id = '${F}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n    `)).length)throw _({statusCode:404,message:"Plant not found"});const t=D.harvest_date||A.split("T")[0];return await n(`\n      INSERT INTO lab_harvest_data (\n        timestamp, id, plant_id, harvest_date,\n        days_from_germ, days_flowering, final_height_cm,\n        wet_weight_g, dry_weight_g, trim_weight_g,\n        premium_bud_g, medium_bud_g, smalls_g,\n        yield_per_plant_g, yield_per_watt, yield_per_m2,\n        wet_dry_ratio, trichome_state, main_colas, bag_appeal_score,\n        cure_start_date, cure_duration_days,\n        cure_aroma_intensity, cure_aroma_complexity, cure_aroma_appeal,\n        cure_aroma_profile, smoke_smoothness,\n        dry_conditions, photos, notes\n      ) VALUES (\n        now(),\n        '${J}',\n        '${F}',\n        '${r(t)}',\n        ${null!=D.days_from_germ?a(D.days_from_germ):"NULL"},\n        ${null!=D.days_flowering?a(D.days_flowering):"NULL"},\n        ${null!=D.final_height_cm?o(D.final_height_cm):"NULL"},\n        ${null!=D.wet_weight_g?o(D.wet_weight_g):"NULL"},\n        ${null!=D.dry_weight_g?o(D.dry_weight_g):"NULL"},\n        ${null!=D.trim_weight_g?o(D.trim_weight_g):"NULL"},\n        ${null!=D.premium_bud_g?o(D.premium_bud_g):"NULL"},\n        ${null!=D.medium_bud_g?o(D.medium_bud_g):"NULL"},\n        ${null!=D.smalls_g?o(D.smalls_g):"NULL"},\n        ${null!=D.yield_per_plant_g?o(D.yield_per_plant_g):"NULL"},\n        ${null!=D.yield_per_watt?o(D.yield_per_watt):"NULL"},\n        ${null!=D.yield_per_m2?o(D.yield_per_m2):"NULL"},\n        ${null!=D.wet_dry_ratio?o(D.wet_dry_ratio):"NULL"},\n        ${D.trichome_state?`'${r("string"==typeof D.trichome_state?D.trichome_state:JSON.stringify(D.trichome_state))}'`:"NULL"},\n        ${null!=D.main_colas?a(D.main_colas):"NULL"},\n        ${null!=D.bag_appeal_score?a(D.bag_appeal_score):"NULL"},\n        ${D.cure_start_date?`'${r(D.cure_start_date)}'`:"NULL"},\n        ${null!=D.cure_duration_days?a(D.cure_duration_days):"NULL"},\n        ${null!=D.cure_aroma_intensity?a(D.cure_aroma_intensity):"NULL"},\n        ${null!=D.cure_aroma_complexity?a(D.cure_aroma_complexity):"NULL"},\n        ${null!=D.cure_aroma_appeal?a(D.cure_aroma_appeal):"NULL"},\n        ${D.cure_aroma_profile?`'${r("string"==typeof D.cure_aroma_profile?D.cure_aroma_profile:JSON.stringify(D.cure_aroma_profile))}'`:"NULL"},\n        ${null!=D.smoke_smoothness?a(D.smoke_smoothness):"NULL"},\n        ${D.dry_conditions?`'${r("string"==typeof D.dry_conditions?D.dry_conditions:JSON.stringify(D.dry_conditions))}'`:"NULL"},\n        ${D.photos?`'${r("string"==typeof D.photos?D.photos:JSON.stringify(D.photos))}'`:"NULL"},\n        ${D.notes?`'${r(D.notes)}'`:"NULL"}\n      )\n    `),{id:J,plant_id:F,harvest_date:t,days_from_germ:null!=(s=D.days_from_germ)?s:null,days_flowering:null!=(u=D.days_flowering)?u:null,final_height_cm:null!=(m=D.final_height_cm)?m:null,wet_weight_g:null!=(d=D.wet_weight_g)?d:null,dry_weight_g:null!=(p=D.dry_weight_g)?p:null,trim_weight_g:null!=(g=D.trim_weight_g)?g:null,premium_bud_g:null!=(c=D.premium_bud_g)?c:null,medium_bud_g:null!=(y=D.medium_bud_g)?y:null,smalls_g:null!=(h=D.smalls_g)?h:null,yield_per_plant_g:null!=(L=D.yield_per_plant_g)?L:null,yield_per_watt:null!=(f=D.yield_per_watt)?f:null,yield_per_m2:null!=(w=D.yield_per_m2)?w:null,wet_dry_ratio:null!=($=D.wet_dry_ratio)?$:null,trichome_state:null!=(N=D.trichome_state)?N:null,main_colas:null!=(U=D.main_colas)?U:null,bag_appeal_score:null!=(b=D.bag_appeal_score)?b:null,cure_start_date:null!=(E=D.cure_start_date)?E:null,cure_duration_days:null!=(O=D.cure_duration_days)?O:null,cure_aroma_intensity:null!=(R=D.cure_aroma_intensity)?R:null,cure_aroma_complexity:null!=(S=D.cure_aroma_complexity)?S:null,cure_aroma_appeal:null!=(v=D.cure_aroma_appeal)?v:null,cure_aroma_profile:null!=(C=D.cure_aroma_profile)?C:null,smoke_smoothness:null!=(T=D.smoke_smoothness)?T:null,dry_conditions:null!=(x=D.dry_conditions)?x:null,photos:null!=(I=D.photos)?I:null,notes:null!=(k=D.notes)?k:null}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to create harvest:",t),_({statusCode:500,message:"Failed to create harvest"})}});export{s as default};
