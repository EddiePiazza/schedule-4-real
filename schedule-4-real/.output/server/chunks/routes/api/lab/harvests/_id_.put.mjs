import{d as _,g as e,r as t,c as r}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as a,query as i,sanitizeString as o,sanitizeInt as s,sanitizeFloat as m}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const d=_(async _=>{const d=e(_,"id"),n=await t(_);if(!d)throw r({statusCode:400,message:"Harvest ID is required"});let p;try{p=a(d)}catch{throw r({statusCode:400,message:"Invalid harvest ID format"})}try{if(!["harvest_date","days_from_germ","days_flowering","final_height_cm","wet_weight_g","dry_weight_g","trim_weight_g","premium_bud_g","medium_bud_g","smalls_g","yield_per_plant_g","yield_per_watt","yield_per_m2","wet_dry_ratio","trichome_state","main_colas","bag_appeal_score","cure_start_date","cure_duration_days","cure_aroma_intensity","cure_aroma_complexity","cure_aroma_appeal","cure_aroma_profile","smoke_smoothness","dry_conditions","photos","notes"].some(_=>void 0!==n[_]))throw r({statusCode:400,message:"No fields to update"});const _=await i(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_harvest_data\n        WHERE id = '${p}'\n      )\n      WHERE rn = 1\n    `);if(!_.length)throw r({statusCode:404,message:"Harvest not found"});const e=_[0],t={harvest_date:void 0!==n.harvest_date?n.harvest_date:e.harvest_date,days_from_germ:void 0!==n.days_from_germ?n.days_from_germ:e.days_from_germ,days_flowering:void 0!==n.days_flowering?n.days_flowering:e.days_flowering,final_height_cm:void 0!==n.final_height_cm?n.final_height_cm:e.final_height_cm,wet_weight_g:void 0!==n.wet_weight_g?n.wet_weight_g:e.wet_weight_g,dry_weight_g:void 0!==n.dry_weight_g?n.dry_weight_g:e.dry_weight_g,trim_weight_g:void 0!==n.trim_weight_g?n.trim_weight_g:e.trim_weight_g,premium_bud_g:void 0!==n.premium_bud_g?n.premium_bud_g:e.premium_bud_g,medium_bud_g:void 0!==n.medium_bud_g?n.medium_bud_g:e.medium_bud_g,smalls_g:void 0!==n.smalls_g?n.smalls_g:e.smalls_g,yield_per_plant_g:void 0!==n.yield_per_plant_g?n.yield_per_plant_g:e.yield_per_plant_g,yield_per_watt:void 0!==n.yield_per_watt?n.yield_per_watt:e.yield_per_watt,yield_per_m2:void 0!==n.yield_per_m2?n.yield_per_m2:e.yield_per_m2,wet_dry_ratio:void 0!==n.wet_dry_ratio?n.wet_dry_ratio:e.wet_dry_ratio,trichome_state:void 0!==n.trichome_state?n.trichome_state:e.trichome_state,main_colas:void 0!==n.main_colas?n.main_colas:e.main_colas,bag_appeal_score:void 0!==n.bag_appeal_score?n.bag_appeal_score:e.bag_appeal_score,cure_start_date:void 0!==n.cure_start_date?n.cure_start_date:e.cure_start_date,cure_duration_days:void 0!==n.cure_duration_days?n.cure_duration_days:e.cure_duration_days,cure_aroma_intensity:void 0!==n.cure_aroma_intensity?n.cure_aroma_intensity:e.cure_aroma_intensity,cure_aroma_complexity:void 0!==n.cure_aroma_complexity?n.cure_aroma_complexity:e.cure_aroma_complexity,cure_aroma_appeal:void 0!==n.cure_aroma_appeal?n.cure_aroma_appeal:e.cure_aroma_appeal,cure_aroma_profile:void 0!==n.cure_aroma_profile?n.cure_aroma_profile:e.cure_aroma_profile,smoke_smoothness:void 0!==n.smoke_smoothness?n.smoke_smoothness:e.smoke_smoothness,dry_conditions:void 0!==n.dry_conditions?n.dry_conditions:e.dry_conditions,photos:void 0!==n.photos?n.photos:e.photos,notes:void 0!==n.notes?n.notes:e.notes},fmtJsonStr=_=>{if(null==_)return"NULL";const e="string"==typeof _?_:JSON.stringify(_);return`'${o(e)}'`},fmtStr=_=>null==_?"NULL":`'${o(String(_))}'`,fmtInt=_=>null==_?"NULL":String(s(_)),fmtFloat=_=>null==_?"NULL":String(m(_));await i(`\n      INSERT INTO lab_harvest_data (\n        timestamp, id, plant_id, harvest_date,\n        days_from_germ, days_flowering, final_height_cm,\n        wet_weight_g, dry_weight_g, trim_weight_g,\n        premium_bud_g, medium_bud_g, smalls_g,\n        yield_per_plant_g, yield_per_watt, yield_per_m2,\n        wet_dry_ratio, trichome_state, main_colas, bag_appeal_score,\n        cure_start_date, cure_duration_days,\n        cure_aroma_intensity, cure_aroma_complexity, cure_aroma_appeal,\n        cure_aroma_profile, smoke_smoothness,\n        dry_conditions, photos, notes\n      ) VALUES (\n        now(),\n        '${p}',\n        '${e.plant_id}',\n        ${fmtStr(t.harvest_date)},\n        ${fmtInt(t.days_from_germ)},\n        ${fmtInt(t.days_flowering)},\n        ${fmtFloat(t.final_height_cm)},\n        ${fmtFloat(t.wet_weight_g)},\n        ${fmtFloat(t.dry_weight_g)},\n        ${fmtFloat(t.trim_weight_g)},\n        ${fmtFloat(t.premium_bud_g)},\n        ${fmtFloat(t.medium_bud_g)},\n        ${fmtFloat(t.smalls_g)},\n        ${fmtFloat(t.yield_per_plant_g)},\n        ${fmtFloat(t.yield_per_watt)},\n        ${fmtFloat(t.yield_per_m2)},\n        ${fmtFloat(t.wet_dry_ratio)},\n        ${fmtJsonStr(t.trichome_state)},\n        ${fmtInt(t.main_colas)},\n        ${fmtInt(t.bag_appeal_score)},\n        ${fmtStr(t.cure_start_date)},\n        ${fmtInt(t.cure_duration_days)},\n        ${fmtInt(t.cure_aroma_intensity)},\n        ${fmtInt(t.cure_aroma_complexity)},\n        ${fmtInt(t.cure_aroma_appeal)},\n        ${fmtJsonStr(t.cure_aroma_profile)},\n        ${fmtInt(t.smoke_smoothness)},\n        ${fmtJsonStr(t.dry_conditions)},\n        ${fmtJsonStr(t.photos)},\n        ${fmtStr(t.notes)}\n      )\n    `);const a=await i(`\n      SELECT * FROM lab_harvest_data\n      WHERE id = '${p}'\n      ORDER BY timestamp DESC\n      LIMIT 1\n    `);if(a.length){const _=a[0];return{id:_.id,plant_id:_.plant_id,harvest_date:_.harvest_date,days_from_germ:_.days_from_germ,days_flowering:_.days_flowering,final_height_cm:_.final_height_cm,wet_weight_g:_.wet_weight_g,dry_weight_g:_.dry_weight_g,trim_weight_g:_.trim_weight_g,premium_bud_g:_.premium_bud_g,medium_bud_g:_.medium_bud_g,smalls_g:_.smalls_g,yield_per_plant_g:_.yield_per_plant_g,yield_per_watt:_.yield_per_watt,yield_per_m2:_.yield_per_m2,wet_dry_ratio:_.wet_dry_ratio,trichome_state:_.trichome_state,main_colas:_.main_colas,bag_appeal_score:_.bag_appeal_score,cure_start_date:_.cure_start_date,cure_duration_days:_.cure_duration_days,cure_aroma_intensity:_.cure_aroma_intensity,cure_aroma_complexity:_.cure_aroma_complexity,cure_aroma_appeal:_.cure_aroma_appeal,cure_aroma_profile:_.cure_aroma_profile,smoke_smoothness:_.smoke_smoothness,dry_conditions:_.dry_conditions,photos:_.photos,notes:_.notes,timestamp:_.timestamp}}return{id:p,...t}}catch(_){if(_.statusCode)throw _;throw console.error("Failed to update harvest:",_),r({statusCode:500,message:"Failed to update harvest"})}});export{d as default};
