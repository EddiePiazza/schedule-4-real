import{d as e,g as t,c as n}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as i,query as s}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const r=e(async e=>{var r,o,a,d,l,p,m,c;const _=t(e,"id");if(!_)throw n({statusCode:400,message:"Strain ID is required"});let u;try{u=i(_)}catch{throw n({statusCode:400,message:"Invalid strain ID format"})}try{const e=await s(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_strains\n        WHERE id = '${u}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n    `);if(!e.length)throw n({statusCode:404,message:"Strain not found"});const t=e[0],i=await s(`\n      SELECT count() as cnt FROM (\n        SELECT id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE strain_id = '${u}'\n      )\n      WHERE rn = 1 AND is_deleted = 0\n    `);if((null==(r=i[0])?void 0:r.cnt)>0)throw n({statusCode:400,message:`Cannot delete strain: ${i[0].cnt} plant(s) are using this strain`});const E=await s(`\n      SELECT count() as cnt FROM (\n        SELECT id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_breeding_projects\n        WHERE (female_strain_id = '${u}' OR male_strain_id = '${u}')\n      )\n      WHERE rn = 1 AND (is_deleted = 0 OR is_deleted IS NULL)\n    `);if((null==(o=E[0])?void 0:o.cnt)>0)throw n({statusCode:400,message:`Cannot delete strain: ${E[0].cnt} breeding project(s) reference this strain`});return await s(`\n      INSERT INTO lab_strains (\n        timestamp, id, name, generation, lineage, breeder, seed_type,\n        indica_ratio, expected_flowering_days, expected_thc, expected_cbd,\n        dominant_terpenes, grow_difficulty, description, breeder_notes,\n        acquisition_date, acquisition_source, total_seeds, seeds_remaining,\n        is_clone_only, is_deleted\n      ) VALUES (\n        now(),\n        '${u}',\n        '${t.name}',\n        ${t.generation?`'${t.generation}'`:"NULL"},\n        ${t.lineage?`'${t.lineage}'`:"NULL"},\n        ${t.breeder?`'${t.breeder}'`:"NULL"},\n        '${t.seed_type||"feminized"}',\n        ${null!=(a=t.indica_ratio)?a:50},\n        ${null!=(d=t.expected_flowering_days)?d:"NULL"},\n        ${null!=(l=t.expected_thc)?l:"NULL"},\n        ${null!=(p=t.expected_cbd)?p:"NULL"},\n        ${t.dominant_terpenes?`'${t.dominant_terpenes}'`:"NULL"},\n        '${t.grow_difficulty||"moderate"}',\n        ${t.description?`'${t.description}'`:"NULL"},\n        ${t.breeder_notes?`'${t.breeder_notes}'`:"NULL"},\n        ${t.acquisition_date?`'${t.acquisition_date}'`:"NULL"},\n        ${t.acquisition_source?`'${t.acquisition_source}'`:"NULL"},\n        ${null!=(m=t.total_seeds)?m:"NULL"},\n        ${null!=(c=t.seeds_remaining)?c:"NULL"},\n        ${t.is_clone_only?1:0},\n        1\n      )\n    `),{success:!0,id:_}}catch(e){if(e.statusCode)throw e;throw console.error("Failed to delete strain:",e),n({statusCode:500,message:"Failed to delete strain"})}});export{r as default};
