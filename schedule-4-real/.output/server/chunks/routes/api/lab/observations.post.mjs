import{d as e,r as t,c as n}from"../../../nitro/nitro.mjs";import{query as a}from"../../../_/db.mjs";import{randomUUID as i}from"crypto";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=e(async e=>{var s,_,o,r,l,d,p,m,c,u,g,L,h,$,v,f,E;const N=await t(e);if(!N.plant_id)throw n({statusCode:400,message:"plant_id is required"});const b=i(),w=(new Date).toISOString();try{let e=null;try{const t=await a("\n        SELECT temp, humi, vpd, co2 FROM sensors_environment\n        ORDER BY timestamp DESC\n        LIMIT 1\n      ");if(t.length>0){e=i();const n=t[0],u=(await a("\n          SELECT\n            avg(temp) as temp_avg,\n            min(temp) as temp_min,\n            max(temp) as temp_max,\n            avg(humi) as humi_avg,\n            avg(vpd) as vpd_avg\n          FROM sensors_environment\n          WHERE timestamp > dateadd('h', -24, now())\n        "))[0]||{};await a(`\n          INSERT INTO lab_env_snapshots (\n            timestamp, id, observation_id, plant_id, zone_id,\n            temp_current, temp_avg_24h, temp_min_24h, temp_max_24h,\n            humi_current, humi_avg_24h, vpd_current, vpd_avg_24h, co2_current\n          ) VALUES (\n            now(), '${e}', '${b}', '${N.plant_id}', NULL,\n            ${null!=(s=n.temp)?s:"NULL"}, ${null!=(_=u.temp_avg)?_:"NULL"}, ${null!=(o=u.temp_min)?o:"NULL"}, ${null!=(r=u.temp_max)?r:"NULL"},\n            ${null!=(l=n.humi)?l:"NULL"}, ${null!=(d=u.humi_avg)?d:"NULL"}, ${null!=(p=n.vpd)?p:"NULL"}, ${null!=(m=u.vpd_avg)?m:"NULL"}, ${null!=(c=n.co2)?c:"NULL"}\n          )\n        `)}}catch(e){}if(await a(`\n      INSERT INTO lab_observations (\n        timestamp, id, plant_id, observed_at, week_number, day_number, stage, obs_type,\n        height_cm, health_score, vigor_score, pest_issues, pest_details,\n        disease_issues, disease_details, deficiency_issues, deficiency_details,\n        watering_notes, feeding_notes, training_applied, general_notes,\n        photos, checklist_data, env_snapshot_id, is_deleted\n      ) VALUES (\n        now(),\n        '${b}',\n        '${N.plant_id}',\n        '${N.observed_at||w.split("T")[0]}',\n        ${null!=(u=N.week_number)?u:"NULL"},\n        ${null!=(g=N.day_number)?g:"NULL"},\n        ${N.stage?`'${N.stage}'`:"NULL"},\n        '${N.obs_type||"general"}',\n        ${null!=(L=N.height_cm)?L:"NULL"},\n        ${null!=(h=N.health_score)?h:"NULL"},\n        ${null!=($=N.vigor_score)?$:"NULL"},\n        ${N.pest_issues?1:0},\n        ${N.pest_details?`'${N.pest_details.replace(/'/g,"''")}'`:"NULL"},\n        ${N.disease_issues?1:0},\n        ${N.disease_details?`'${N.disease_details.replace(/'/g,"''")}'`:"NULL"},\n        ${N.deficiency_issues?1:0},\n        ${N.deficiency_details?`'${N.deficiency_details.replace(/'/g,"''")}'`:"NULL"},\n        ${N.watering_notes?`'${N.watering_notes.replace(/'/g,"''")}'`:"NULL"},\n        ${N.feeding_notes?`'${N.feeding_notes.replace(/'/g,"''")}'`:"NULL"},\n        ${N.training_applied?`'${JSON.stringify(N.training_applied)}'`:"NULL"},\n        ${N.general_notes?`'${N.general_notes.replace(/'/g,"''")}'`:"NULL"},\n        ${N.photos?`'${JSON.stringify(N.photos)}'`:"NULL"},\n        ${N.checklist_data?`'${JSON.stringify(N.checklist_data)}'`:"NULL"},\n        ${e?`'${e}'`:"NULL"},\n        0\n      )\n    `),N.week_number||N.day_number){const e=await a(`\n        SELECT * FROM (\n          SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n          FROM lab_plants\n          WHERE id = '${N.plant_id}' AND is_deleted = 0\n        )\n        WHERE rn = 1\n      `);if(e.length>0){e[0];await a(`\n          INSERT INTO lab_plants (\n            timestamp, id, strain_id, seed_batch_id, zone_id, plant_code, pheno_label,\n            origin_type, parent_plant_id, project_goal, status, selection_status,\n            cull_reason, cull_date, is_keeper, keeper_notes, sex, sex_confirmed_date,\n            date_started, date_to_veg, date_to_flower, date_harvested,\n            current_week, current_day, total_veg_days, total_flower_days,\n            container_size, grow_medium, nutrients_type, training_methods,\n            final_height_cm, final_score, hof_category, hof_notes, breeding_project_id, is_deleted\n          )\n          SELECT now(), id, strain_id, seed_batch_id, zone_id, plant_code, pheno_label,\n            origin_type, parent_plant_id, project_goal, status, selection_status,\n            cull_reason, cull_date, is_keeper, keeper_notes, sex, sex_confirmed_date,\n            date_started, date_to_veg, date_to_flower, date_harvested,\n            ${null!=(v=N.week_number)?v:"current_week"}, ${null!=(f=N.day_number)?f:"current_day"}, total_veg_days, total_flower_days,\n            container_size, grow_medium, nutrients_type, training_methods,\n            ${null!=(E=N.height_cm)?E:"final_height_cm"}, final_score, hof_category, hof_notes, breeding_project_id, is_deleted\n          FROM lab_plants\n          WHERE id = '${N.plant_id}'\n          LATEST ON timestamp PARTITION BY id\n        `)}}const t=await a(`\n      SELECT * FROM lab_observations\n      WHERE id = '${b}'\n      ORDER BY timestamp DESC\n      LIMIT 1\n    `);let n=null;if(e){n=(await a(`\n        SELECT * FROM lab_env_snapshots WHERE id = '${e}' LIMIT 1\n      `))[0]||null}return{...t[0],env_snapshot:n}}catch(e){throw console.error("Failed to create observation:",e),n({statusCode:500,message:"Failed to create observation"})}});export{s as default};
