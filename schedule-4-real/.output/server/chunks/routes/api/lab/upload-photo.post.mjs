import{d as t,l as e,c as a,b as o}from"../../../nitro/nitro.mjs";import{randomBytes as i}from"crypto";import{mkdir as r,writeFile as s}from"fs/promises";import{join as p}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"node:url";const m=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,n=t(async t=>{var n,d;const l=await e(t);if(!l)throw a({statusCode:400,message:"No form data received"});let f=null,g="",u="";for(const t of l)"file"===t.name&&t.data?f={filename:t.filename,data:t.data,type:t.type}:"plant_id"===t.name?g=t.data.toString():"plant_code"===t.name&&(u=t.data.toString());if(!f)throw a({statusCode:400,message:"No file uploaded"});if(!g||!u)throw a({statusCode:400,message:"plant_id and plant_code are required"});if(!m.test(g))throw a({statusCode:400,message:"Invalid plant_id format"});if(f.data.length>10485760)throw a({statusCode:400,message:"File too large. Maximum size is 10MB."});if(f.type&&!["image/jpeg","image/png","image/webp","image/gif"].includes(f.type))throw a({statusCode:400,message:"Invalid file type. Only JPEG, PNG, WebP, and GIF are allowed."});const c=(null==(d=null==(n=f.filename)?void 0:n.split(".").pop())?void 0:d.toLowerCase())||"jpg",h=["jpg","jpeg","png","webp","gif"].includes(c)?c:"jpg",w=`${u}_${(new Date).toISOString().split("T")[0].replace(/-/g,"")}_${i(4).toString("hex")}.${h}`,v=p(o(),"data","uploads",g);try{await r(v,{recursive:!0}),await s(p(v,w),f.data);return{success:!0,path:`/lab/uploads/${g}/${w}`,filename:w}}catch(t){throw console.error("Failed to save photo:",t),a({statusCode:500,message:"Failed to save photo"})}});export{n as default};
