import{d as e,a as o,c as r}from"../../../nitro/nitro.mjs";import{sanitizeUUID as t,query as s}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const n=e(async e=>{var n,a;const i=o(e),c=i.plant_id,l=Math.min(Math.max(parseInt(String(i.limit||"50"),10)||50,1),500);try{let e="";if(c)try{e=`WHERE plant_id = '${t(c)}'`}catch{throw r({statusCode:400,message:"Invalid plant_id format"})}return(await s(`\n      SELECT sc.*,\n             p.plant_code,\n             p.strain_id,\n             s.name as strain_name\n      FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plant_scores\n        ${e}\n      ) sc\n      LEFT JOIN (\n        SELECT id, plant_code, strain_id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n      ) p ON sc.plant_id = p.id AND p.rn = 1\n      LEFT JOIN (\n        SELECT id, name, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_strains\n      ) s ON p.strain_id = s.id AND s.rn = 1\n      WHERE sc.rn = 1\n      ORDER BY sc.timestamp DESC\n      LIMIT ${l}\n    `)).map(e=>({id:e.id,plant_id:e.plant_id,plantCode:e.plant_code||"Unknown",strain:e.strain_name||"Unknown",scoredAt:e.scored_at,scoringStage:e.scoring_stage,scoringProfileId:e.scoring_profile_id,scorerNotes:e.scorer_notes,germScore:e.germ_score,seedlingVigorScore:e.seedling_vigor_score,vegVigorScore:e.veg_vigor_score,flowerVigorScore:e.flower_vigor_score,stalkStructureScore:e.stalk_structure_score,branchingScore:e.branching_score,nodeSpacingScore:e.node_spacing_score,overallStructureScore:e.overall_structure_score,pestResistanceScore:e.pest_resistance_score,diseaseResistanceScore:e.disease_resistance_score,stressToleranceScore:e.stress_tolerance_score,hermieResistanceScore:e.hermie_resistance_score,budDensityScore:e.bud_density_score,resinProductionScore:e.resin_production_score,calyxLeafRatioScore:e.calyx_leaf_ratio_score,yieldScore:e.yield_score,aromaIntensityScore:e.aroma_intensity_score,aromaComplexityScore:e.aroma_complexity_score,aromaAppealScore:e.aroma_appeal_score,cloneEaseScore:e.clone_ease_score,consistencyScore:e.consistency_score,cloneVigorScore:e.clone_vigor_score,vigorHealthTotal:e.vigor_health_total,structureTotal:e.structure_total,resistanceTotal:e.resistance_total,flowerProductionTotal:e.flower_production_total,aromaTotal:e.aroma_total,cloneStabilityTotal:e.clone_stability_total,finalScore:e.final_score,timestamp:e.timestamp}))}catch(e){if(e.statusCode)throw e;return(null==(n=e.message)?void 0:n.includes("does not exist"))||(null==(a=e.message)?void 0:a.includes("table not found"))||console.error("Failed to fetch scores:",e),[]}});export{n as default};
