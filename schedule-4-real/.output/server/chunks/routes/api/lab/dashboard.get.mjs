import{d as t}from"../../../nitro/nitro.mjs";import{query as n}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const e=t(async()=>{var t,e,i,r;try{const a=await n("\n      SELECT status, count() as cnt FROM (\n        SELECT status, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE is_deleted = 0\n      )\n      WHERE rn = 1 AND status NOT IN ('archived', 'culled')\n      GROUP BY status\n    "),s=a.reduce((t,n)=>t+parseInt(n.cnt),0),o=["pre_flower","early_flower","mid_flower","late_flower","flush"],E=a.filter(t=>o.includes(t.status)).reduce((t,n)=>t+parseInt(n.cnt),0),p=(null==(t=(await n("\n      SELECT count() as cnt FROM (\n        SELECT is_keeper, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE is_deleted = 0\n      )\n      WHERE rn = 1 AND is_keeper = 1\n    "))[0])?void 0:t.cnt)||0,l=await n("\n      SELECT id, plant_code, pheno_label, strain_id, status, final_score, selection_status FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE is_deleted = 0 AND final_score IS NOT NULL\n      )\n      WHERE rn = 1\n      ORDER BY final_score DESC\n      LIMIT 5\n    "),R=[...new Set(l.map(t=>t.strain_id).filter(Boolean))];let d={};if(R.length>0){const t=await n(`\n        SELECT * FROM (\n          SELECT id, name, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n          FROM lab_strains\n          WHERE id IN ('${R.join("','")}')\n        )\n        WHERE rn = 1\n      `);d=Object.fromEntries(t.map(t=>[t.id,t.name]))}const m=(null==(e=(await n("\n      SELECT count() as cnt FROM lab_notifications\n      WHERE acknowledged = 0\n    "))[0])?void 0:e.cnt)||0,c=await n("\n      SELECT * FROM lab_notifications\n      WHERE resolved = 0 AND level IN ('urgent', 'important')\n      ORDER BY timestamp DESC\n      LIMIT 10\n    "),_=(null==(i=(await n("\n      SELECT count() as cnt FROM (\n        SELECT id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_strains\n        WHERE is_deleted = 0\n      )\n      WHERE rn = 1\n    "))[0])?void 0:i.cnt)||0,u=await n("\n      SELECT count() as cnt FROM lab_observations\n      WHERE timestamp > dateadd('d', -7, now()) AND is_deleted = 0\n    ");return{active_plants:s,flowering_count:E,keepers_count:p,strain_count:_,unread_notifications:m,recent_observations:(null==(r=u[0])?void 0:r.cnt)||0,status_distribution:Object.fromEntries(a.map(t=>[t.status,parseInt(t.cnt)])),top_performers:l.map(t=>({...t,strain_name:d[t.strain_id]||null})),urgent_alerts:c}}catch(t){return console.error("Failed to fetch dashboard stats:",t),{active_plants:0,flowering_count:0,keepers_count:0,strain_count:0,unread_notifications:0,recent_observations:0,status_distribution:{},top_performers:[],urgent_alerts:[]}}});export{e as default};
