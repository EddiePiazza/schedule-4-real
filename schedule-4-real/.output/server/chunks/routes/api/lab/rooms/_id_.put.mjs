import{d as t,g as i,r as o,c as n}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as s,query as r,sanitizeInt as e,sanitizeString as d}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const a=t(async t=>{var a,m,p,_,l;const c=i(t,"id"),f=await o(t);if(!c)throw n({statusCode:400,message:"Room ID is required"});let g;try{g=s(c)}catch{throw n({statusCode:400,message:"Invalid room ID format"})}try{const t=await r(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_grow_rooms\n        WHERE id = '${g}'\n      )\n      WHERE rn = 1 AND (is_deleted = 0 OR is_deleted IS NULL)\n    `);if(!t.length)throw n({statusCode:404,message:"Room not found"});const i=t[0],o=1e3*Date.now(),s=null!=(a=f.name)?a:i.name,c=void 0!==f.description?f.description:i.description,y=null!=(m=f.room_type)?m:i.room_type,u=void 0!==f.dimensions_cm?JSON.stringify(f.dimensions_cm):i.dimensions_cm,v=null!=(p=f.cover_color)?p:i.cover_color,N=void 0!==f.icon?f.icon:i.icon,O=void 0!==f.layout_data?JSON.stringify(f.layout_data):i.layout_data,$=void 0!==f.device_macs?JSON.stringify(f.device_macs):i.device_macs,S=void 0!==f.light_ids?JSON.stringify(f.light_ids):i.light_ids,h=void 0!==f.outlet_ids?JSON.stringify(f.outlet_ids):i.outlet_ids,L=void 0!==f.sensor_ids?JSON.stringify(f.sensor_ids):i.sensor_ids,J=void 0!==f.active_plant_ids?JSON.stringify(f.active_plant_ids):i.active_plant_ids,E=void 0!==f.environment_profile?JSON.stringify(f.environment_profile):i.environment_profile,R=null!=(_=f.status)?_:i.status,w=void 0!==f.sort_order?e(f.sort_order):null!=(l=i.sort_order)?l:0;return await r(`\n      INSERT INTO lab_grow_rooms (\n        timestamp, id, name, description, room_type, dimensions_cm,\n        cover_color, icon, layout_data, device_macs, light_ids,\n        outlet_ids, sensor_ids, active_plant_ids, environment_profile,\n        status, sort_order, is_deleted\n      ) VALUES (\n        ${o},\n        '${g}',\n        '${d(s)}',\n        ${c?`'${d(c)}'`:"NULL"},\n        '${d(y||"tent")}',\n        ${u?`'${d("string"==typeof u?u:JSON.stringify(u))}'`:"NULL"},\n        ${v?`'${d(v)}'`:"NULL"},\n        ${N?`'${d(N)}'`:"NULL"},\n        ${O?`'${d("string"==typeof O?O:JSON.stringify(O))}'`:"NULL"},\n        '${d("string"==typeof $?$:JSON.stringify($||[]))}',\n        '${d("string"==typeof S?S:JSON.stringify(S||[]))}',\n        '${d("string"==typeof h?h:JSON.stringify(h||[]))}',\n        '${d("string"==typeof L?L:JSON.stringify(L||[]))}',\n        '${d("string"==typeof J?J:JSON.stringify(J||[]))}',\n        ${E?`'${d("string"==typeof E?E:JSON.stringify(E))}'`:"NULL"},\n        '${d(R||"active")}',\n        ${w},\n        0\n      )\n    `),{success:!0,id:g}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to update room:",t),n({statusCode:500,message:"Failed to update room"})}});export{a as default};
