import{d as n,r as e,c as t}from"../../../nitro/nitro.mjs";import{sanitizeUUID as s,query as r,sanitizeInt as o,sanitizeString as i,sanitizeFloat as a}from"../../../_/db.mjs";import{v4 as _}from"uuid";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const l=n(async n=>{var l,c,p,m,u,g,$,f;const E=await e(n);if(!E.plant_id)throw t({statusCode:400,message:"plant_id is required"});let h;try{h=s(E.plant_id)}catch{throw t({statusCode:400,message:"Invalid plant_id format"})}const y=await r(`\n    SELECT id, plant_code, status FROM (\n      SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n      FROM lab_plants\n      WHERE id = '${h}'\n    )\n    WHERE rn = 1 AND is_deleted = 0\n  `);if(!y.length)throw t({statusCode:404,message:"Plant not found"});const R=y[0];try{const n=_(),e=1e3*Date.now(),t=(new Date).toISOString();let s={};if(E.details)try{s="string"==typeof E.details?JSON.parse(E.details):E.details}catch{s={}}const d=n=>{var e;return o(String(null!=(e=s[n])?e:5))};await r(`\n      INSERT INTO lab_plant_scores (\n        timestamp,\n        id,\n        plant_id,\n        scored_at,\n        scoring_stage,\n        scoring_profile_id,\n        scorer_notes,\n        germ_score,\n        seedling_vigor_score,\n        veg_vigor_score,\n        flower_vigor_score,\n        stalk_structure_score,\n        branching_score,\n        node_spacing_score,\n        overall_structure_score,\n        pest_resistance_score,\n        disease_resistance_score,\n        stress_tolerance_score,\n        hermie_resistance_score,\n        bud_density_score,\n        resin_production_score,\n        calyx_leaf_ratio_score,\n        yield_score,\n        aroma_intensity_score,\n        aroma_complexity_score,\n        aroma_appeal_score,\n        clone_ease_score,\n        consistency_score,\n        clone_vigor_score,\n        vigor_health_total,\n        structure_total,\n        resistance_total,\n        flower_production_total,\n        aroma_total,\n        clone_stability_total,\n        final_score\n      ) VALUES (\n        ${e},\n        '${n}',\n        '${h}',\n        '${t}',\n        '${i(R.status||"unknown")}',\n        '${i(E.profile||"standard")}',\n        '${i(E.notes||"")}',\n        ${d("vigor")},\n        ${d("recuperation")},\n        ${d("growth_speed")},\n        ${d("rooting_speed")},\n        ${d("stem_strength")},\n        ${d("branching")},\n        ${d("node_spacing")},\n        ${d("trainability")},\n        ${d("pest_resistance")},\n        ${d("mold_resistance")},\n        ${d("stress_tolerance")},\n        ${d("canopy_uniformity")},\n        ${d("bud_density")},\n        ${d("resin_production")},\n        ${d("trichome_coverage")},\n        ${d("yield_estimate")},\n        ${d("smell_intensity")},\n        ${d("smell_complexity")},\n        ${d("smell_appeal")},\n        ${d("clone_success_rate")},\n        ${d("rooting_time")},\n        ${d("clone_vigor")},\n        ${a(String(null!=(l=E.vigor_score)?l:5))},\n        ${a(String(null!=(c=E.structure_score)?c:5))},\n        ${a(String(null!=(p=E.resistance_score)?p:5))},\n        ${a(String(null!=(m=E.production_score)?m:5))},\n        ${a(String(null!=(u=E.aroma_score)?u:5))},\n        ${a(String(null!=(g=E.clonability_score)?g:5))},\n        ${a(String(null!=($=E.final_score)?$:5))}\n      )\n    `);const y=1e3*Date.now();return await r(`\n      INSERT INTO lab_plants (\n        timestamp, id, plant_code, strain_id, origin_type, date_started,\n        status, sex, selection_status, is_keeper, pheno_label, keeper_notes,\n        grow_medium, container_size, training_methods,\n        final_score, is_deleted\n      )\n      SELECT\n        ${y} as timestamp,\n        id,\n        plant_code,\n        strain_id,\n        origin_type,\n        date_started,\n        status,\n        sex,\n        selection_status,\n        is_keeper,\n        pheno_label,\n        keeper_notes,\n        grow_medium,\n        container_size,\n        training_methods,\n        ${a(String(null!=(f=E.final_score)?f:5))} as final_score,\n        is_deleted\n      FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n        WHERE id = '${h}'\n      )\n      WHERE rn = 1\n    `),{success:!0,id:n,plant_id:h,final_score:E.final_score}}catch(n){throw console.error("Failed to create score:",n),t({statusCode:500,message:"Failed to save score"})}});export{l as default};
