import{d as t,r as e,c as o}from"../../../nitro/nitro.mjs";import{sanitizeUUID as i,query as n,sanitizeString as a}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const r=t(async t=>{const r=await e(t);if(!r.action||!r.id)throw o({statusCode:400,message:"action and id are required"});const s=["acknowledge","resolve"];if(!s.includes(r.action))throw o({statusCode:400,message:`Invalid action. Must be one of: ${s.join(", ")}`});let d;try{d=i(r.id)}catch{throw o({statusCode:400,message:"Invalid notification ID format"})}const l=(new Date).toISOString();try{if("acknowledge"===r.action)await n(`\n        INSERT INTO lab_notifications (\n          timestamp, id, plant_id, source, level, notification_type, trigger_name,\n          stage, title, message, action_label, action_route, read_at, acknowledged,\n          resolved, resolved_action, resolved_at\n        )\n        SELECT\n          now(), id, plant_id, source, level, notification_type, trigger_name,\n          stage, title, message, action_label, action_route, '${l}', 1,\n          resolved, resolved_action, resolved_at\n        FROM lab_notifications\n        WHERE id = '${d}'\n        LATEST ON timestamp PARTITION BY id\n      `);else if("resolve"===r.action){const t=r.resolved_action?`'${a(r.resolved_action)}'`:"NULL";await n(`\n        INSERT INTO lab_notifications (\n          timestamp, id, plant_id, source, level, notification_type, trigger_name,\n          stage, title, message, action_label, action_route, read_at, acknowledged,\n          resolved, resolved_action, resolved_at\n        )\n        SELECT\n          now(), id, plant_id, source, level, notification_type, trigger_name,\n          stage, title, message, action_label, action_route, read_at, 1,\n          1, ${t}, '${l}'\n        FROM lab_notifications\n        WHERE id = '${d}'\n        LATEST ON timestamp PARTITION BY id\n      `)}return{success:!0}}catch(t){throw console.error("Failed to update notification:",t),o({statusCode:500,message:"Failed to update notification"})}});export{r as default};
