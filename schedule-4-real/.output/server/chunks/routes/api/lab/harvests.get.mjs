import{d as t,a as e}from"../../../nitro/nitro.mjs";import{sanitizeInt as n,query as i}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const r=t(async t=>{var r,a;const o=e(t),s=Math.min(n(o.limit||"50"),200);try{return(await i(`\n      SELECT h.*,\n             p.plant_code,\n             p.strain_id,\n             s.name as strain_name\n      FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_harvest_data\n      ) h\n      LEFT JOIN (\n        SELECT id, plant_code, strain_id, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n      ) p ON h.plant_id = p.id AND p.rn = 1\n      LEFT JOIN (\n        SELECT id, name, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_strains\n      ) s ON p.strain_id = s.id AND s.rn = 1\n      WHERE h.rn = 1\n      ORDER BY h.harvest_date DESC\n      LIMIT ${s}\n    `)).map(t=>({id:t.id,plant_id:t.plant_id,plantCode:t.plant_code||"Unknown",strain:t.strain_name||"Unknown",harvestDate:t.harvest_date,flowerDays:t.days_flowering||0,dryWeight:t.dry_weight_g||0,wetWeight:t.wet_weight_g||0,wetDryRatio:t.wet_dry_ratio||0,yieldPerPlant:t.yield_per_plant_g||t.dry_weight_g||0,premiumBud:t.premium_bud_g||0,mediumBud:t.medium_bud_g||0,smalls:t.smalls_g||0,trichomeState:t.trichome_state,bagAppeal:t.bag_appeal_score,notes:t.notes,timestamp:t.timestamp}))}catch(t){return(null==(r=t.message)?void 0:r.includes("does not exist"))||(null==(a=t.message)?void 0:a.includes("table not found"))||console.error("Failed to fetch harvests:",t),[]}});export{r as default};
