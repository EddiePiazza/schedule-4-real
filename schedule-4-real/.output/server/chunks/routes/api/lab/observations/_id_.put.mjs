import{d as e,g as s,r as t,c as i}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as n,query as o,sanitizeString as a}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const r=e(async e=>{var r,_,d,p,l,g,h,c,m;const u=s(e,"id"),f=await t(e);if(!u)throw i({statusCode:400,message:"Observation ID is required"});let L;try{L=n(u)}catch{throw i({statusCode:400,message:"Invalid observation ID format"})}try{if(!["health_score","vigor_score","height_cm","pest_issues","disease_issues","deficiency_issues","general_notes","watering_notes","feeding_notes","training_applied","photos"].some(e=>void 0!==f[e]))throw i({statusCode:400,message:"No fields to update"});const e=await o(`\n      SELECT * FROM lab_observations\n      WHERE id = '${L}' AND is_deleted = 0\n      ORDER BY timestamp DESC\n      LIMIT 1\n    `);if(!e.length)throw i({statusCode:404,message:"Observation not found"});const s=e[0],t={...s,health_score:null!=(r=f.health_score)?r:s.health_score,vigor_score:null!=(_=f.vigor_score)?_:s.vigor_score,height_cm:void 0!==f.height_cm?f.height_cm:s.height_cm,pest_issues:void 0!==f.pest_issues?f.pest_issues?1:0:s.pest_issues,disease_issues:void 0!==f.disease_issues?f.disease_issues?1:0:s.disease_issues,deficiency_issues:void 0!==f.deficiency_issues?f.deficiency_issues?1:0:s.deficiency_issues,general_notes:void 0!==f.general_notes?f.general_notes:s.general_notes,watering_notes:void 0!==f.watering_notes?f.watering_notes:s.watering_notes,feeding_notes:void 0!==f.feeding_notes?f.feeding_notes:s.feeding_notes,training_applied:void 0!==f.training_applied?f.training_applied:s.training_applied?JSON.parse(s.training_applied):[],photos:void 0!==f.photos?f.photos:s.photos?JSON.parse(s.photos):[]};await o(`\n      INSERT INTO lab_observations (\n        timestamp, id, plant_id, observed_at, week_number, day_number, stage, obs_type,\n        height_cm, health_score, vigor_score, pest_issues, pest_details,\n        disease_issues, disease_details, deficiency_issues, deficiency_details,\n        watering_notes, feeding_notes, training_applied, general_notes,\n        photos, checklist_data, env_snapshot_id, is_deleted\n      ) VALUES (\n        now(),\n        '${L}',\n        '${s.plant_id}',\n        '${s.observed_at}',\n        ${null!=(d=s.week_number)?d:"NULL"},\n        ${null!=(p=s.day_number)?p:"NULL"},\n        ${s.stage?`'${s.stage}'`:"NULL"},\n        '${s.obs_type||"general"}',\n        ${null!=(l=t.height_cm)?l:"NULL"},\n        ${null!=(g=t.health_score)?g:"NULL"},\n        ${null!=(h=t.vigor_score)?h:"NULL"},\n        ${t.pest_issues?1:0},\n        ${s.pest_details?`'${s.pest_details}'`:"NULL"},\n        ${t.disease_issues?1:0},\n        ${s.disease_details?`'${s.disease_details}'`:"NULL"},\n        ${t.deficiency_issues?1:0},\n        ${s.deficiency_details?`'${s.deficiency_details}'`:"NULL"},\n        ${t.watering_notes?`'${a(t.watering_notes)}'`:"NULL"},\n        ${t.feeding_notes?`'${a(t.feeding_notes)}'`:"NULL"},\n        ${(null==(c=t.training_applied)?void 0:c.length)?`'${a(JSON.stringify(t.training_applied))}'`:"NULL"},\n        ${t.general_notes?`'${a(t.general_notes)}'`:"NULL"},\n        ${(null==(m=t.photos)?void 0:m.length)?`'${a(JSON.stringify(t.photos))}'`:"NULL"},\n        ${s.checklist_data?`'${s.checklist_data}'`:"NULL"},\n        ${s.env_snapshot_id?`'${s.env_snapshot_id}'`:"NULL"},\n        0\n      )\n    `);const n=await o(`\n      SELECT * FROM lab_observations\n      WHERE id = '${L}'\n      ORDER BY timestamp DESC\n      LIMIT 1\n    `);return{...n[0],photos:n[0].photos?JSON.parse(n[0].photos):[],training_applied:n[0].training_applied?JSON.parse(n[0].training_applied):[]}}catch(e){if(e.statusCode)throw e;throw console.error("Failed to update observation:",e),i({statusCode:500,message:"Failed to update observation"})}});export{r as default};
