import{d as t,g as i,r as o,c as e}from"../../../../nitro/nitro.mjs";import{sanitizeUUID as a,query as n,sanitizeString as r,sanitizeFloat as s}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const l=t(async t=>{var l,_,d;const c=i(t,"id"),p=await o(t);if(!c)throw e({statusCode:400,message:"Pollen record ID is required"});let m;try{m=a(c)}catch{throw e({statusCode:400,message:"Invalid pollen record ID format"})}try{const t=await n(`\n      SELECT * FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_pollen_storage\n        WHERE id = '${m}'\n      )\n      WHERE rn = 1\n    `);if(!t.length)throw e({statusCode:404,message:"Pollen record not found"});const i=t[0];if("depleted"===i.status)throw e({statusCode:404,message:"Pollen record not found"});const o={strain_id:void 0!==p.strain_id?r(p.strain_id):i.strain_id,male_plant_id:void 0!==p.male_plant_id?r(p.male_plant_id):i.male_plant_id,batch_code:void 0!==p.batch_code?r(p.batch_code):i.batch_code,collection_date:void 0!==p.collection_date?r(p.collection_date):i.collection_date,quantity_grams:void 0!==p.quantity_grams?s(String(p.quantity_grams)):i.quantity_grams,viability_at_collection:void 0!==p.viability_at_collection?s(String(p.viability_at_collection)):i.viability_at_collection,last_viability_test:void 0!==p.last_viability_test?r(p.last_viability_test):i.last_viability_test,current_viability:void 0!==p.current_viability?s(String(p.current_viability)):i.current_viability,storage_method:void 0!==p.storage_method?r(p.storage_method):i.storage_method,storage_location:void 0!==p.storage_location?r(p.storage_location):i.storage_location,desiccant_type:void 0!==p.desiccant_type?r(p.desiccant_type):i.desiccant_type,container_type:void 0!==p.container_type?r(p.container_type):i.container_type,status:void 0!==p.status?r(p.status):i.status,notes:void 0!==p.notes?r(p.notes):i.notes},a=1e3*Date.now();return await n(`\n      INSERT INTO lab_pollen_storage (\n        timestamp, id, male_plant_id, strain_id, batch_code,\n        collection_date, quantity_grams, viability_at_collection,\n        last_viability_test, current_viability,\n        storage_method, storage_location, desiccant_type, container_type,\n        status, notes\n      ) VALUES (\n        ${a},\n        '${m}',\n        '${o.male_plant_id||""}',\n        '${o.strain_id||""}',\n        '${o.batch_code||""}',\n        '${o.collection_date||""}',\n        ${null!=(l=o.quantity_grams)?l:0},\n        ${null!=(_=o.viability_at_collection)?_:100},\n        '${o.last_viability_test||""}',\n        ${null!=(d=o.current_viability)?d:100},\n        '${o.storage_method||"refrigerated"}',\n        '${o.storage_location||""}',\n        '${o.desiccant_type||""}',\n        '${o.container_type||""}',\n        '${o.status||"available"}',\n        '${o.notes||""}'\n      )\n    `),{id:m,...o}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to update pollen record:",t),e({statusCode:500,message:"Failed to update pollen record"})}});export{l as default};
