import{d as t,a as s,c as e}from"../../../nitro/nitro.mjs";import{sanitizeInt as i,sanitizeUUID as o,query as n}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const a=t(async t=>{const a=s(t),r=a.plant_id,p=Math.min(i(a.limit||"50"),500);try{let t="";if(r)try{t=`WHERE plant_id = '${o(r)}'`}catch{throw e({statusCode:400,message:"Invalid plant ID format"})}const s=await n(`\n      SELECT\n        obs.id, obs.plant_id, obs.observed_at, obs.week_number, obs.day_number,\n        obs.stage, obs.obs_type, obs.height_cm, obs.health_score, obs.vigor_score,\n        obs.pest_issues, obs.pest_details, obs.disease_issues, obs.disease_details,\n        obs.deficiency_issues, obs.deficiency_details, obs.watering_notes, obs.feeding_notes,\n        obs.training_applied, obs.general_notes, obs.photos, obs.checklist_data,\n        obs.env_snapshot_id, obs.timestamp, obs.is_deleted,\n        p.plant_code,\n        p.strain_id,\n        p.status as plant_status\n      FROM (\n        SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_observations\n        ${t}\n      ) obs\n      LEFT JOIN (\n        SELECT id, plant_code, strain_id, status, is_deleted as plant_is_deleted,\n          ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n        FROM lab_plants\n      ) p ON obs.plant_id = p.id AND p.rn = 1\n      WHERE obs.rn = 1 AND obs.is_deleted = 0 AND (p.plant_is_deleted IS NULL OR p.plant_is_deleted = 0)\n      ORDER BY obs.observed_at DESC, obs.timestamp DESC\n      LIMIT ${p}\n    `),i=[...new Set(s.filter(t=>t.strain_id).map(t=>t.strain_id))];let a={};if(i.length>0){const t=await n(`\n        SELECT id, name FROM (\n          SELECT id, name, is_deleted, ROW_NUMBER() OVER (PARTITION BY id ORDER BY timestamp DESC) as rn\n          FROM lab_strains\n          WHERE id IN ('${i.join("','")}')\n        )\n        WHERE rn = 1 AND is_deleted = 0\n      `);a=t.reduce((t,s)=>(t[s.id]=s.name,t),{})}return s.map(t=>({...t,photos:t.photos?JSON.parse(t.photos):[],checklist_data:t.checklist_data?JSON.parse(t.checklist_data):null,training_applied:t.training_applied?JSON.parse(t.training_applied):[],strain_name:t.strain_id?a[t.strain_id]:null}))}catch(t){throw console.error("Failed to fetch observations:",t),e({statusCode:500,message:"Failed to fetch observations"})}});export{a as default};
