import{d as t,a as e,c as o}from"../../../nitro/nitro.mjs";import{query as n}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=t(async t=>{var s,i,a,m,r,l,c,h,p;const{range:d="24h"}=e(t),u=function(t){return{"4h":4,"6h":6,"12h":12,"24h":24,"48h":48,"7d":168,"30d":720,"60d":1440,"90d":2160}[t]||24}(d);try{const t=await n("\n      SELECT socket, watts, cost_per_kwh\n      FROM (\n        SELECT socket, watts, cost_per_kwh,\n               ROW_NUMBER() OVER (PARTITION BY socket ORDER BY timestamp DESC) as rn\n        FROM socket_wattage\n      )\n      WHERE rn = 1\n    "),e=new Map;for(const o of t)e.set(o.socket,{watts:o.watts,costPerKwh:o.cost_per_kwh});const o=new Date(Date.now()-60*u*60*1e3),p=new Date,w=await n(`\n      SELECT socket, is_on, timestamp\n      FROM (\n        SELECT socket, is_on, timestamp,\n               ROW_NUMBER() OVER (PARTITION BY socket ORDER BY timestamp DESC) as rn\n        FROM socket_events\n        WHERE timestamp < '${o.toISOString()}'\n          AND socket IN ('O1', 'O2', 'O3', 'O4', 'O5')\n      )\n      WHERE rn = 1\n    `),E=new Map;for(const t of w)E.set(t.socket,t.is_on);const O=await n(`\n      SELECT timestamp, socket, is_on\n      FROM socket_events\n      WHERE timestamp > dateadd('h', -${u}, now())\n        AND socket IN ('O1', 'O2', 'O3', 'O4', 'O5')\n      ORDER BY socket ASC, timestamp ASC\n    `),T=["O1","O2","O3","O4","O5"].map(t=>{let n=1===E.get(t),s=n?o.getTime():0,i=0,a=n?1:0;const m=O.filter(e=>e.socket===t);for(const t of m){const e=new Date(t.timestamp.endsWith("Z")?t.timestamp:t.timestamp.replace(" ","T")+"Z").getTime();t.is_on!==a&&(a=t.is_on,1===t.is_on?(s=e,n=!0):n&&(i+=e-s,n=!1))}n&&s>0&&(i+=p.getTime()-s);const r=i/36e5,l=e.get(t),c=(null==l?void 0:l.watts)||0,h=c*r/1e3,d=h*((null==l?void 0:l.costPerKwh)||0);return{socket:t,type:"socket",onTimeMinutes:Math.round(i/6e4),watts:c,kWh:Math.round(1e3*h)/1e3,cost:Math.round(100*d)/100}}),M=["light","light2"],g=[];for(const t of M){const i=e.get(t);if(!i||0===i.watts){g.push({socket:t,type:"light",onTimeMinutes:0,watts:0,avgLevel:0,kWh:0,cost:0});continue}const a=await n(`\n        SELECT is_on, level\n        FROM light_states\n        WHERE light_id = '${t}'\n          AND timestamp < '${o.toISOString()}'\n          AND is_on IS NOT NULL\n        ORDER BY timestamp DESC\n        LIMIT 1\n      `);let m=a.length>0&&1===a[0].is_on,r=a.length>0&&a[0].level||0;const l=await n(`\n        SELECT timestamp, is_on, level\n        FROM light_states\n        WHERE light_id = '${t}'\n          AND timestamp > dateadd('h', -${u}, now())\n          AND is_on IS NOT NULL\n        ORDER BY timestamp ASC\n      `);let c=0,h=0,d=o.getTime(),w=0,E=0;for(const t of l){const e=1===t.is_on,o=null!=(s=t.level)?s:r;if(e===m&&o===r)continue;const n=new Date(t.timestamp.endsWith("Z")?t.timestamp:t.timestamp.replace(" ","T")+"Z").getTime(),a=n-d;if(m&&r>0&&a>0){const t=a/36e5;c+=i.watts*(r/100)*t,h+=a,w+=r*a,E+=a}m=e,r=o,d=n}const O=p.getTime()-d;if(m&&r>0&&O>0){const t=O/36e5;c+=i.watts*(r/100)*t,h+=O,w+=r*O,E+=O}const T=c/1e3,M=E>0?Math.round(w/E):0;g.push({socket:t,type:"light",onTimeMinutes:Math.round(h/6e4),watts:i.watts,avgLevel:M,kWh:Math.round(1e3*T)/1e3,cost:Math.round(T*i.costPerKwh*100)/100})}let k=!1;const R=60*u*60*1e3,f=await n("\n      SELECT min(timestamp) as oldest FROM socket_events\n      WHERE socket IN ('O1', 'O2', 'O3', 'O4', 'O5')\n    "),_=await n("\n      SELECT min(timestamp) as oldest FROM light_states\n      WHERE is_on IS NOT NULL\n    ");let v=o.getTime();const W=(null==(i=f[0])?void 0:i.oldest)?new Date((null==(m=(a=f[0].oldest).endsWith)?void 0:m.call(a,"Z"))?f[0].oldest:f[0].oldest.replace(" ","T")+"Z").getTime():null,S=(null==(r=_[0])?void 0:r.oldest)?new Date((null==(c=(l=_[0].oldest).endsWith)?void 0:c.call(l,"Z"))?_[0].oldest:_[0].oldest.replace(" ","T")+"Z").getTime():null,D=Math.min(W||1/0,S||1/0);D!==1/0&&D>o.getTime()&&(v=D);const L=p.getTime()-v;if(L<.9*R&&L>432e5){k=!0;const t=R/L;for(const e of T)e.onTimeMinutes=Math.round(e.onTimeMinutes*t),e.kWh=Math.round(e.kWh*t*1e3)/1e3,e.cost=Math.round(e.cost*t*100)/100;for(const e of g)e.onTimeMinutes=Math.round(e.onTimeMinutes*t),e.kWh=Math.round(e.kWh*t*1e3)/1e3,e.cost=Math.round(e.cost*t*100)/100}const N=62,C=e.get("blower"),I=(null==C?void 0:C.watts)||N,A=(null==C?void 0:C.costPerKwh)||0,b=await n(`\n      SELECT is_on, level\n      FROM blower_states\n      WHERE timestamp < '${o.toISOString()}'\n        AND is_on IS NOT NULL\n      ORDER BY timestamp DESC\n      LIMIT 1\n    `);let F=b.length>0&&1===b[0].is_on,B=b.length>0&&b[0].level||0;const H=await n(`\n      SELECT timestamp, is_on, level\n      FROM blower_states\n      WHERE timestamp > dateadd('h', -${u}, now())\n        AND is_on IS NOT NULL\n      ORDER BY timestamp ASC\n    `);let Z=0,y=0,Y=o.getTime(),$=0,U=0;for(const t of H){const e=1===t.is_on,o=null!=(h=t.level)?h:B;if(e===F&&o===B)continue;const n=new Date(t.timestamp.endsWith("Z")?t.timestamp:t.timestamp.replace(" ","T")+"Z").getTime(),s=n-Y;if(F&&B>0&&s>0){Z+=I*(B/100)*(s/36e5),y+=s,$+=B*s,U+=s}F=e,B=o,Y=n}const P=p.getTime()-Y;if(F&&B>0&&P>0){Z+=I*(B/100)*(P/36e5),y+=P,$+=B*P,U+=P}const K=Z/1e3,x=U>0?Math.round($/U):0,j={socket:"blower",type:"blower",onTimeMinutes:Math.round(y/6e4),watts:I,avgLevel:x,kWh:Math.round(1e3*K)/1e3,cost:Math.round(K*A*100)/100};if(k){const t=R/L;j.onTimeMinutes=Math.round(j.onTimeMinutes*t),j.kWh=Math.round(j.kWh*t*1e3)/1e3,j.cost=Math.round(j.cost*t*100)/100}const V=[...T,...g,j];return{range:d,extrapolated:k,sockets:T,lights:g,blower:j,totals:{kWh:Math.round(1e3*V.reduce((t,e)=>t+e.kWh,0))/1e3,cost:Math.round(100*V.reduce((t,e)=>t+e.cost,0))/100}}}catch(t){if(null==(p=t.message)?void 0:p.includes("does not exist"))return{range:d,sockets:[],lights:[],blower:{socket:"blower",type:"blower",onTimeMinutes:0,watts:62,avgLevel:0,kWh:0,cost:0},totals:{kWh:0,cost:0}};throw console.error("Failed to fetch power stats:",t),o({statusCode:500,message:"Failed to fetch power stats"})}});export{s as default};
