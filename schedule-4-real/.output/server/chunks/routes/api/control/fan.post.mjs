import{d as e,r as t,c as l}from"../../../nitro/nitro.mjs";import{g as o,s as i,a as m}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const n=e(async e=>{var n,r,a,s,p,d,u,c,f,y,v,h,T,k,S,w,L,P,g,b,x,D,O;const C=await t(e),{on:F,level:j,modeType:q,minSpeed:A,maxSpeed:_,shakeLevel:z,natural:B,timePeriod:E,cycleTime:G}=C;if(void 0!==j&&0!==j&&(j<1||j>10))throw l({statusCode:400,message:"Level must be between 1 and 10"});try{const e=o();let t={};try{const l=await i({method:"getConfigField",params:{keyPath:["device","fan"]}},e,3e3);t=(null==(n=null==l?void 0:l.data)?void 0:n.fan)||{}}catch{}const l={modeType:null!=(r=null!=q?q:t.modeType)?r:0,minSpeed:null!=(a=null!=A?A:t.minSpeed)?a:0,maxSpeed:null!=(s=null!=_?_:t.maxSpeed)?s:0,shakeLevel:null!=(p=null!=z?z:t.shakeLevel)?p:0,natural:null!=(d=null!=B?B:t.natural)?d:0,mOnOff:void 0!==F?F?1:0:null!=(u=t.mOnOff)?u:0,mLevel:null!=(c=null!=j?j:t.mLevel)?c:5};return E&&Array.isArray(E)&&E.length>0?l.timePeriod=E:t.timePeriod&&(l.timePeriod=t.timePeriod),G&&"object"==typeof G?l.cycleTime={weekmask:null!=(v=null!=(y=G.weekmask)?y:null==(f=t.cycleTime)?void 0:f.weekmask)?v:127,startTime:null!=(k=null!=(T=G.startTime)?T:null==(h=t.cycleTime)?void 0:h.startTime)?k:0,openDur:null!=(L=null!=(w=G.openDur)?w:null==(S=t.cycleTime)?void 0:S.openDur)?L:3600,closeDur:null!=(b=null!=(g=G.closeDur)?g:null==(P=t.cycleTime)?void 0:P.closeDur)?b:1800,times:null!=(O=null!=(D=G.times)?D:null==(x=t.cycleTime)?void 0:x.times)?O:3}:t.cycleTime&&(l.cycleTime=t.cycleTime),await m({method:"setConfigField",params:{keyPath:["device","fan"],fan:l}},e),{success:!0,fan:{on:1===l.mOnOff,level:l.mLevel,modeType:l.modeType,minSpeed:l.minSpeed,maxSpeed:l.maxSpeed,shakeLevel:l.shakeLevel,natural:l.natural,timePeriod:l.timePeriod,cycleTime:l.cycleTime}}}catch(e){throw console.error("Failed to set fan:",e),l({statusCode:500,message:"Failed to set fan"})}});export{n as default};
