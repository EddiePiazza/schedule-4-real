import{d as e,r as o,c as l}from"../../../nitro/nitro.mjs";import{g as t,s as i,a as m,u as r}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const n=e(async e=>{var n,s,d,c,p,a,u,y,T,v,f,S,O,w,h,b,P,g,C,x,k,D;const L=await o(e);console.log("[Blower POST] Received body:",JSON.stringify(L));const{on:F,level:j,modeType:B,closeCO2:q,minSpeed:A,maxSpeed:J,timePeriod:N,cycleTime:_}=L;if(console.log("[Blower POST] Extracted values:",{on:F,level:j,modeType:B,closeCO2:q,minSpeed:A,maxSpeed:J,timePeriod:N,cycleTime:_}),void 0!==j&&0!==j&&(j<25||j>100))throw l({statusCode:400,message:"Level must be between 25 and 100"});try{const e=t();let o={};try{const l=await i({method:"getConfigField",params:{keyPath:["device","blower"]}},e,3e3);o=(null==(n=null==l?void 0:l.data)?void 0:n.blower)||{}}catch{}const l={modeType:null!=(s=null!=B?B:o.modeType)?s:0,minSpeed:null!=(d=null!=A?A:o.minSpeed)?d:0,maxSpeed:null!=(c=null!=J?J:o.maxSpeed)?c:0,closeCO2:void 0!==q?q?1:0:null!=(p=o.closeCO2)?p:0,mOnOff:void 0!==F?F?1:0:null!=(a=o.mOnOff)?a:0,mLevel:null!=(u=null!=j?j:o.mLevel)?u:50};N&&Array.isArray(N)&&N.length>0?l.timePeriod=N:o.timePeriod&&(l.timePeriod=o.timePeriod),_&&"object"==typeof _?l.cycleTime={weekmask:null!=(v=null!=(T=_.weekmask)?T:null==(y=o.cycleTime)?void 0:y.weekmask)?v:127,startTime:null!=(O=null!=(S=_.startTime)?S:null==(f=o.cycleTime)?void 0:f.startTime)?O:0,openDur:null!=(b=null!=(h=_.openDur)?h:null==(w=o.cycleTime)?void 0:w.openDur)?b:3600,closeDur:null!=(C=null!=(g=_.closeDur)?g:null==(P=o.cycleTime)?void 0:P.closeDur)?C:1800,times:null!=(D=null!=(k=_.times)?k:null==(x=o.cycleTime)?void 0:x.times)?D:3}:o.cycleTime&&(l.cycleTime=o.cycleTime);const L={method:"setConfigField",params:{keyPath:["device","blower"],blower:l}};return console.log("[Blower POST] Sending command:",JSON.stringify(L)),await m(L,e),r(e,{blower:{on:1===l.mOnOff,level:l.mLevel,modeType:l.modeType,closeCO2:1===l.closeCO2,minSpeed:l.minSpeed,maxSpeed:l.maxSpeed,timePeriod:l.timePeriod,cycleTime:l.cycleTime}}),{success:!0,blower:{on:1===l.mOnOff,level:l.mLevel,modeType:l.modeType,closeCO2:1===l.closeCO2,minSpeed:l.minSpeed,maxSpeed:l.maxSpeed,timePeriod:l.timePeriod,cycleTime:l.cycleTime}}}catch(e){throw console.error("Failed to set blower:",e),l({statusCode:500,message:"Failed to set blower"})}});export{n as default};
