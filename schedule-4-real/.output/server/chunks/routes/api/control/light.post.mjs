import{d as t,r as e,c as i}from"../../../nitro/nitro.mjs";import{g as o,e as l,s as n,a as r,u as s}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const a=t(async t=>{var a,d,m,p,h,f,g,c,u,v;const y=await e(t),{light:P,modeType:O,mOnOff:b,mLevel:L}=y;if(!P)throw i({statusCode:400,message:"Light ID is required"});try{const t=o(),e="light2"===P,i=e?["light2"]:["device","light"],y=e?"light2":"light";if(void 0!==L){const i=l(t),o=null==(a=null==i?void 0:i.data)?void 0:a.plan;if(1===(null==o?void 0:o.isPlanRun)&&(null==o?void 0:o.stageId)){const i=e?"light2":"light1";try{const e=await n({method:"getConfigField",params:{keyPath:["plan"]}},t,5e3),l=null==(d=null==e?void 0:e.data)?void 0:d.plan;if((null==l?void 0:l.stage)&&Array.isArray(l.stage)){const e=l.stage.findIndex(t=>t.stageId===o.stageId);if(e>=0){const o=l.stage[e][i];if(o){if(Array.isArray(o.timePeriod)&&o.timePeriod.length>0){const t=o.timePeriod.findIndex(t=>t.enabled),e=t>=0?t:0;o.timePeriod[e].brightness=L}o.mLevel=L}return await r({method:"setConfigField",params:{keyPath:["plan"],plan:l}},t),s(t,{plan:l}),{success:!0,light:P,modeType:null!=(p=null!=(m=null==o?void 0:o.modeType)?m:O)?p:1,mOnOff:1,mLevel:L}}}}catch(t){console.log("[Light] Plan brightness update failed, falling back to device config")}}}let w={};try{const e=await n({method:"getConfigField",params:{keyPath:i}},t,3e3);w=(null==(h=null==e?void 0:e.data)?void 0:h[y])||{}}catch{}const I=null!=(g=null!=(f=null!=b?b:w.mOnOff)?f:w.on)?g:0,T=null!=(u=null!=(c=null!=L?L:w.mLevel)?c:w.level)?u:0,A={...w,modeType:null!=(v=null!=O?O:w.modeType)?v:0,mOnOff:I,mLevel:T};if("on"in w&&(A.on=I),"level"in w&&(A.level=T),void 0!==L&&Array.isArray(A.timePeriod)&&A.timePeriod.length>0){const t=A.timePeriod.findIndex(t=>t.enabled),e=t>=0?t:0;A.timePeriod[e]&&(A.timePeriod[e].brightness=T)}const C={method:"setConfigField",params:{keyPath:i,[y]:A}};return await r(C,t),s(t,{[y]:A}),{success:!0,light:P,modeType:A.modeType,mOnOff:I,mLevel:T}}catch(t){throw console.error("Failed to set light:",t),i({statusCode:500,message:"Failed to set light"})}});export{a as default};
