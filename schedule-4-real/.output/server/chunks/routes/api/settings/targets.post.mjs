import{d as t,r as e,c as o}from"../../../nitro/nitro.mjs";import{g as r,j as a,a as i,u as n}from"../../../_/mqtt.mjs";import{query as d}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";import"pg";function timeToSeconds(t){if(!t&&0!==t)return 0;if("number"==typeof t)return t;const[e=0,o=0]=t.split(":").map(Number);return 3600*e+60*o}function secondsToTime(t){if(null==t)return"00:00";const e=Math.floor(t/3600),o=Math.floor(t%3600/60);return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}const s=t(async t=>{const s=await e(t),{dayTime:m,temp:u,humi:p,co2:l}=s;try{const t={dayTime:{startTime:timeToSeconds(null==m?void 0:m.startTime),endTime:timeToSeconds(null==m?void 0:m.endTime)},temp:{targetDay:Math.round((null==u?void 0:u.targetDay)||0),targetNight:Math.round((null==u?void 0:u.targetNight)||0),deadband:Math.round((null==u?void 0:u.deadband)||1)},humi:{targetDay:Math.round((null==p?void 0:p.targetDay)||0),targetNight:Math.round((null==p?void 0:p.targetNight)||0),deadband:Math.round((null==p?void 0:p.deadband)||1)},co2:{targetDay:Math.round((null==l?void 0:l.targetDay)||0),targetNight:Math.round((null==l?void 0:l.targetNight)||0),deadband:Math.round((null==l?void 0:l.deadband)||10)}},e=r();if(!(await a()).macs[e])throw o({statusCode:503,message:"Device not detected yet"});const s={method:"setConfigField",params:{keyPath:["target"],target:t}};await i(s,e),n(e,{target:t});try{const t="number"==typeof(null==m?void 0:m.startTime)?secondsToTime(m.startTime):(null==m?void 0:m.startTime)||"06:00",e="number"==typeof(null==m?void 0:m.endTime)?secondsToTime(m.endTime):(null==m?void 0:m.endTime)||"00:00";await d("\n        INSERT INTO day_night_schedule (timestamp, day_start, day_end, source)\n        VALUES (now(), $1, $2, 'user')\n      ",[t,e])}catch(t){console.error("Failed to persist day/night schedule:",t)}return{success:!0}}catch(t){if(t.statusCode)throw t;throw console.error("Failed to save targets:",t),o({statusCode:500,message:"Failed to save settings to device"})}});export{s as default};
