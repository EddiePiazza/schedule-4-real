import{d as t,r as e,c as o}from"../../../nitro/nitro.mjs";import{g as i,b as d,s as a,a as s,c as r,u as m}from"../../../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const n=t(async t=>{var n,l,p,c,u,f,v,h,y,g,w;const T=await e(t),{socket:k,...A}=T;if(!k)throw o({statusCode:400,message:"Socket ID is required"});const b=i();if(!d(b).hasOutlets)throw o({statusCode:404,message:"This device type does not have outlets"});try{const t=["outlet",k];let e={};try{const o=await a({method:"getConfigField",params:{keyPath:t}},b,5e3);e=(null==(n=null==o?void 0:o.data)?void 0:n[k])||{}}catch{}const o={...e,modeType:null!=(p=null!=(l=A.modeType)?l:e.modeType)?p:0,mOnOff:null!=(u=null!=(c=A.mOnOff)?c:e.mOnOff)?u:0};void 0!==A.tempAdd&&(o.tempAdd=A.tempAdd),void 0!==A.humiAdd&&(o.humiAdd=A.humiAdd),void 0!==A.co2Add&&(o.co2Add=A.co2Add),void 0!==A.timePeriod&&(o.timePeriod=A.timePeriod),void 0!==A.cycleTime&&(o.cycleTime=A.cycleTime),void 0!==A.wateringEnv&&(o.wateringEnv=A.wateringEnv),void 0!==A.bind&&(o.bind=A.bind);const i={method:"setConfigField",params:{keyPath:t,[k]:o}};await s(i,b);let d=o;try{const e=await a({method:"getConfigField",params:{keyPath:t}},b,5e3),i=null==(f=null==e?void 0:e.data)?void 0:f[k];if(i&&(d=i,i.modeType!==o.modeType)){await new Promise(t=>setTimeout(t,1e3));const e=await a({method:"getConfigField",params:{keyPath:t}},b,5e3),i=null==(v=null==e?void 0:e.data)?void 0:v[k];if(i&&(d=i,i.modeType!==o.modeType))throw new Error("Save verification failed: modeType mismatch")}}catch(t){if(null==(h=t.message)?void 0:h.includes("verification failed"))throw t}const g=r(b),w=(null==(y=null==g?void 0:g.data)?void 0:y.outlet)||{};return m(b,{outlet:{...w,[k]:d}}),{success:!0,socket:k,...d}}catch(t){throw console.error("Failed to update socket config:",t),o({statusCode:(null==(g=t.message)?void 0:g.includes("verification"))?409:500,message:(null==(w=t.message)?void 0:w.includes("verification"))?"Settings saved but verification failed - device may not have applied changes":"Failed to update socket configuration"})}});export{n as default};
