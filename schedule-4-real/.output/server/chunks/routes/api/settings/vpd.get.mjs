import{d as e}from"../../../nitro/nitro.mjs";import{query as t}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const o=e(async()=>{var e,o,n,r,i;try{const i=await t("\n      SELECT flow_json\n      FROM automation_flows\n      WHERE id = 'global' AND enabled = 1\n      ORDER BY updated_at DESC\n      LIMIT 1\n    ");if(0===i.length)return{enabled:!1};const a=null==(e=JSON.parse(i[0].flow_json||'{"nodes":[]}').nodes)?void 0:e.find(e=>"vpd_control"===e.type);if(!a)return{enabled:!1};const l=a.data.config;let s=null;if("plant_stage"===l.mode||"grow_phase"===l.mode)try{const e={germinating:"germination",seedling:"seedling",early_veg:"vegetative",mid_veg:"vegetative",late_veg:"vegetative",pre_flower:"flower",early_flower:"flower",mid_flower:"flower",late_flower:"flower",flush:"flush",harvest:"flush",drying:"drying",curing:"curing"},o=await t("\n          SELECT status\n          FROM lab_plants\n          WHERE status NOT IN ('culled', 'archived')\n          ORDER BY timestamp DESC\n          LIMIT 1\n        ");if(o.length>0){s=e[o[0].status]||null}}catch{}let m=0,p=0;if("manual"===l.mode)m=(null==(o=l.manualTarget)?void 0:o.min)||.8,p=(null==(n=l.manualTarget)?void 0:n.max)||1.2;else if(s&&(null==(r=l.phaseTargets)?void 0:r[s])){const e=l.phaseTargets[s];e.min>0&&e.max>0&&(m=e.min,p=e.max)}return{enabled:!0,mode:l.mode,targetMin:m,targetMax:p,phase:s,roles:l.roles||[],escalationTimeout:l.escalationTimeoutSeconds||180}}catch(e){return(null==(i=e.message)?void 0:i.includes("does not exist"))||console.error("Failed to fetch VPD config:",e),{enabled:!1}}});export{o as default};
