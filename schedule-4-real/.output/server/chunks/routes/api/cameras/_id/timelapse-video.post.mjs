import{d as t,g as e,c as o,r,b as s}from"../../../../nitro/nitro.mjs";import{existsSync as a,readdirSync as i,mkdirSync as p}from"fs";import{join as m,resolve as n}from"path";import{execFile as d}from"child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const f=n(s(),"data","webcam"),l=n(s(),"data","webcam-videos"),c=new Set,h=t(async t=>{const s=e(t,"id");if(!s||s.includes("..")||s.includes("/"))throw o({statusCode:400,message:"Invalid camera id"});const n=await r(t)||{},h=n.date,u=parseInt(n.fps,10),g=Number.isInteger(u)&&u>=1&&u<=60?u:10;if(!h||!/^\d{4}-\d{2}-\d{2}$/.test(h))throw o({statusCode:400,message:"Invalid date format (YYYY-MM-DD)"});const w=m(f,s,"timelapse",h);if(!a(w))throw o({statusCode:404,message:"No photos found for this date"});const v=i(w).filter(t=>t.endsWith(".jpg")).sort();if(v.length<2)throw o({statusCode:400,message:`Need at least 2 photos (found ${v.length})`});a(l)||p(l,{recursive:!0});const y=`${s}_${h}_${g}fps.mp4`,b=m(l,y),$=`${s}_${h}`;if(c.has($))throw o({statusCode:409,message:"Video generation already in progress for this day"});c.add($);try{return await new Promise((t,e)=>{const o=["-y","-framerate",String(g),"-pattern_type","glob","-i",m(w,"*.jpg"),"-c:v","libx264","-preset","fast","-crf","23","-pix_fmt","yuv420p","-movflags","+faststart",b];d("ffmpeg",o,{timeout:12e4},(o,r,s)=>{o?(console.error("[Camera] ffmpeg error:",s),e(new Error("Video generation failed"))):t()})}),{success:!0,video:{filename:y,date:h,fps:g,photoCount:v.length,url:`/api/cameras/timelapse-videos/${y}`}}}finally{c.delete($)}});export{h as default};
