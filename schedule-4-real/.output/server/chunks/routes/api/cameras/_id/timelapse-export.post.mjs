import{d as t,g as o,c as e,b as r}from"../../../../nitro/nitro.mjs";import{existsSync as s,readdirSync as i,writeFileSync as m,unlinkSync as a,statSync as p}from"fs";import{join as n,resolve as c}from"path";import{execFile as d}from"child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";const f=c(r(),"data","webcam-videos"),l=t(async t=>{const r=o(t,"id");if(!r||r.includes("..")||r.includes("/"))throw e({statusCode:400,message:"Invalid camera id"});if(!s(f))throw e({statusCode:404,message:"No videos found"});const c=i(f).filter(t=>t.startsWith(`${r}_`)&&t.endsWith(".mp4")&&!t.includes("_full_")).sort();if(0===c.length)throw e({statusCode:404,message:"No daily videos to export"});const l=n(f,`${r}_concat_list.txt`),u=c.map(t=>`file '${n(f,t)}'`).join("\n");m(l,u);const h=`${r}_full_timelapse.mp4`,y=n(f,h);await new Promise((t,o)=>{d("ffmpeg",["-y","-f","concat","-safe","0","-i",l,"-c","copy","-movflags","+faststart",y],{timeout:3e5},(e,r,s)=>{try{a(l)}catch{}if(e){try{a(y)}catch{}console.error("[Camera] Export concat error:",s),o(new Error("Export failed"))}else t()})});return{success:!0,export:{filename:h,url:`/api/cameras/timelapse-videos/${h}`,size:p(y).size,daysIncluded:c.length}}});export{l as default};
