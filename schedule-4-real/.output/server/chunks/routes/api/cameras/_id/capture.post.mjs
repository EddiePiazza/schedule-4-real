import{d as t,g as e,c as r,r as o,b as a}from"../../../../nitro/nitro.mjs";import{existsSync as s,mkdirSync as n,writeFileSync as i,statSync as p}from"fs";import{join as m,resolve as c}from"path";import{l as u,a as d}from"../../../../_/cameras.mjs";import{c as f}from"../../../../_/camera-fetch.mjs";import{execFile as g}from"child_process";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs/promises";import"node:url";import"../../../../_/db.mjs";import"pg";function buildOverlayText(t,e){const r=[];if(t.custom_text&&r.push(t.custom_text),t.show_day_counter&&t.day_counter_start){const o=new Date(t.day_counter_start+"T00:00:00"),a=e.getTime()-o.getTime(),s=Math.max(1,Math.floor(a/864e5)+1),n=t.day_counter_label||"Day";r.push(`${n} ${s}`)}if(t.show_date&&r.push(function(t,e){const r=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");switch(e){case"DD/MM/YYYY":return`${a}/${o}/${r}`;case"MM/DD/YYYY":return`${o}/${a}/${r}`;default:return`${r}-${o}-${a}`}}(e,t.date_format)),t.show_time){const t=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");r.push(`${t}:${o}:${a}`)}return r.join(" | ")}const l=c(a(),"data","webcam"),h=t(async t=>{const a=e(t,"id");if(!a||a.includes("..")||a.includes("/"))throw r({statusCode:400,message:"Invalid camera id"});const c="timelapse"===(await o(t)||{}).type?"timelapse":"manual",h=(await u()).find(t=>t.id===a);if(!h)throw r({statusCode:404,message:"Camera not found"});const S="manual"===c?["/photoaf.jpg","/photo.jpg"]:["/photo.jpg"];let $=null;for(const t of S){const e=await f(h.host,h.port,t,{timeoutMs:15e3,expectImage:!0});if(e.ok&&e.contentType.includes("image")){$=e.body;break}}if(!$||$.length<1e3)throw r({statusCode:502,message:"Cannot capture photo from camera"});const y=new Date,w=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}`,_=`${String(y.getHours()).padStart(2,"0")}-${String(y.getMinutes()).padStart(2,"0")}-${String(y.getSeconds()).padStart(2,"0")}`,F=m(l,a,c,w);s(F)||n(F,{recursive:!0});const b=`${_}.jpg`,v=m(F,b);i(v,$);const D=await d(a);D.enabled&&await function(t,e,r){const o=buildOverlayText(e,r||new Date);if(!o)return Promise.resolve(!1);const{gravity:a,offset:s}=function(t){switch(t){case"top-left":return{gravity:"NorthWest",offset:"+20+20"};case"top-right":return{gravity:"NorthEast",offset:"+20+20"};case"bottom-right":return{gravity:"SouthEast",offset:"+20+20"};default:return{gravity:"SouthWest",offset:"+20+20"}}}(e.position),n=function(t){switch(t){case"yellow":return"#FFDD00";case"green":return"#00FF88";case"cyan":return"#00DDFF";case"red":return"#FF4444";default:return"#FFFFFF"}}(e.text_color),i=Math.max(18,Math.min(72,e.font_size||36)),p=[t,"-gravity",a,"-font","DejaVu-Sans-Bold","-pointsize",String(i),"-fill","rgba(0,0,0,0.9)","-stroke","rgba(0,0,0,0.9)","-strokewidth","3","-annotate",s,o,"-stroke","none","-fill",n,"-annotate",s,o,t];return new Promise(t=>{g("convert",p,{timeout:1e4},e=>{e?(console.error("[Overlay] ImageMagick error:",e.message),t(!1)):t(!0)})})}(v,D,y);const M=s(v)?p(v).size:$.length,j=`${a}/${c}/${w}/${b}`;return{success:!0,photo:{path:j,filename:b,date:w,time:_.replace(/-/g,":"),size:M,type:c,url:`/api/cameras/photos/${j}`}}});export{h as default};
