import{d as t,a as m}from"../../../nitro/nitro.mjs";import{query as e}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";function normalizeTimestamp(t){return t instanceof Date?t.toISOString():"string"==typeof t?t.endsWith("Z")?t:t.replace(" ","T")+"Z":String(t)}const o=t(async t=>{const{range:o="24h",start:r,end:i}=m(t);let n,p;if(r&&i){const t=new Date(r),m=new Date(i);n=`timestamp >= '${t.toISOString()}' AND timestamp <= '${m.toISOString()}'`,p=function(t,m){const e=(m-t)/36e5;return e<=1?"":e<=4?"1m":e<=6?"90s":e<=12?"3m":e<=24?"5m":e<=48?"10m":e<=168?"30m":e<=720?"2h":e<=1440?"4h":"6h"}(t.getTime(),m.getTime())}else{const t=function(t){return{"1h":1,"4h":4,"6h":6,"12h":12,"24h":24,"48h":48,"7d":168,"30d":720,"60d":1440,"90d":2160}[t]||24}(o);n=`timestamp > dateadd('h', -${t}, now())`,p=function(t){var m;return null!=(m={"1h":"","4h":"1m","6h":"90s","12h":"3m","24h":"5m","48h":"10m","7d":"30m","30d":"2h","60d":"4h","90d":"6h"}[t])?m:"5m"}(o)}try{const t=p?`SELECT timestamp, avg(temp) as temp, avg(humi) as humi, avg(co2) as co2, avg(vpd) as vpd\n         FROM sensors_environment WHERE ${n}\n         SAMPLE BY ${p} ALIGN TO CALENDAR ORDER BY timestamp ASC`:`SELECT timestamp, temp, humi, co2, vpd\n         FROM sensors_environment WHERE ${n}\n         ORDER BY timestamp ASC`;return(await e(t)).map(t=>({temp:t.temp,humi:t.humi,co2:t.co2,vpd:t.vpd,timestamp:normalizeTimestamp(t.timestamp)}))}catch(t){console.error("Failed to fetch sensor history:",t);try{return(await e(`\n        SELECT temp, humi, co2, vpd, timestamp\n        FROM sensors_environment\n        WHERE ${n}\n        ORDER BY timestamp ASC\n      `)).map(t=>({temp:t.temp,humi:t.humi,co2:t.co2,vpd:t.vpd,timestamp:normalizeTimestamp(t.timestamp)}))}catch(t){return console.error("Fallback query also failed:",t),[]}}});export{o as default};
