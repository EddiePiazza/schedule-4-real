import{d as t,a as i}from"../../../../nitro/nitro.mjs";import{query as o}from"../../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";function normalizeTimestamp(t){return t instanceof Date?t.toISOString():"string"==typeof t?t.endsWith("Z")?t:t.replace(" ","T")+"Z":String(t)}const e=t(async t=>{const{range:e="24h",start:s,end:m,sensorId:r}=i(t);let n,p;if(s&&m){const t=new Date(s),i=new Date(m);n=`timestamp >= '${t.toISOString()}' AND timestamp <= '${i.toISOString()}'`,p=function(t,i){const o=(i-t)/36e5;return o<=1?"":o<=4?"1m":o<=6?"90s":o<=12?"3m":o<=24?"5m":o<=48?"10m":o<=168?"30m":o<=720?"2h":o<=1440?"4h":"6h"}(t.getTime(),i.getTime())}else{const t=function(t){return{"1h":1,"4h":4,"6h":6,"12h":12,"24h":24,"48h":48,"7d":168,"30d":720,"60d":1440,"90d":2160}[t]||24}(e);n=`timestamp > dateadd('h', -${t}, now())`,p=function(t){var i;return null!=(i={"1h":"","4h":"1m","6h":"90s","12h":"3m","24h":"5m","48h":"10m","7d":"30m","30d":"2h","60d":"4h","90d":"6h"}[t])?i:"5m"}(e)}n+=r&&"string"==typeof r?` AND sensor_id = '${r}'`:" AND sensor_id != 'avg'";try{const t=p?`SELECT timestamp, avg(temp_soil) as temp_soil, avg(humi_soil) as humi_soil, avg(ec_soil) as ec_soil\n         FROM sensors_soil WHERE ${n}\n         SAMPLE BY ${p} ALIGN TO CALENDAR ORDER BY timestamp ASC`:`SELECT timestamp, temp_soil, humi_soil, ec_soil\n         FROM sensors_soil WHERE ${n}\n         ORDER BY timestamp ASC`;return(await o(t)).map(t=>({temp_soil:t.temp_soil,humi_soil:t.humi_soil,ec_soil:t.ec_soil,timestamp:normalizeTimestamp(t.timestamp)}))}catch(t){console.error("Failed to fetch soil history:",t);try{return(await o(`\n        SELECT temp_soil, humi_soil, ec_soil, timestamp\n        FROM sensors_soil\n        WHERE ${n}\n        ORDER BY timestamp ASC\n      `)).map(t=>({temp_soil:t.temp_soil,humi_soil:t.humi_soil,ec_soil:t.ec_soil,timestamp:normalizeTimestamp(t.timestamp)}))}catch(t){return console.error("Fallback query also failed:",t),[]}}});export{e as default};
