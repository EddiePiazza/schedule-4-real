import{d as t,a as e,c as o}from"../../../nitro/nitro.mjs";import{query as r}from"../../../_/db.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"pg";const s=t(async t=>{var s;const{range:i,start:n,end:m}=e(t);try{let t,e=[];if(n&&m)t="\n        SELECT timestamp, is_on, level\n        FROM fan_states\n        WHERE timestamp >= $1 AND timestamp <= $2\n        ORDER BY timestamp ASC\n      ",e=[n,m];else{const e=function(t){return{"1h":1,"4h":4,"6h":6,"12h":12,"24h":24,"48h":48,"7d":168,"30d":720,"60d":1440,"90d":2160}[t]||24}(i||"4h");t=`\n        SELECT timestamp, is_on, level\n        FROM fan_states\n        WHERE timestamp > dateadd('h', -${e}, now())\n        ORDER BY timestamp ASC\n      `}const o=(await r(t,e)).map(t=>{let e=t.timestamp;return"string"!=typeof e||e.includes("T")||(e=e.replace(" ","T")+"Z"),{timestamp:e,value:1===t.is_on&&t.level||0}});if(o.length>0){const t=o[o.length-1].value;o.push({timestamp:(new Date).toISOString(),value:t})}return o}catch(t){if(null==(s=t.message)?void 0:s.includes("does not exist"))return[];throw console.error("Failed to fetch fan history:",t),o({statusCode:500,message:"Failed to fetch fan history"})}});export{s as default};
