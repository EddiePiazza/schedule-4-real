import{o as e,b as o}from"../nitro/nitro.mjs";import{readFileSync as t}from"node:fs";import{join as r}from"node:path";import{randomBytes as n}from"node:crypto";import"node:http";import"node:https";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"fs";import"path";import"fs/promises";import"node:url";const a=["#22d3ee","#a78bfa","#f472b6","#34d399","#fbbf24","#fb923c","#60a5fa","#e879f9"],s=new Map,i=new Map;function getRandomColor(e){const o=new Set([...e.values()].map(e=>e.color));for(const e of a)if(!o.has(e))return e;return a[Math.floor(Math.random()*a.length)]}function leaveRoom(e){const o=i.get(e);if(!o)return null;i.delete(e);const t=s.get(o);return t&&(t.delete(e),0===t.size&&s.delete(o)),o}function updatePlayer(e,o,t,r){const n=i.get(e);if(!n)return null;const a=s.get(n),d=null==a?void 0:a.get(e);return d?(d.position=o,d.rotationY=t,d.animation=r,d.lastUpdate=Date.now(),n):null}const d=new Map,c=new Map,l=new Map,p=e({open(e){},message(e,a){let p;try{p=JSON.parse("string"==typeof a?a:a.text())}catch{return void e.send(JSON.stringify({type:"error",message:"Invalid JSON"}))}switch(p.type){case"join":!function(e,a){d.has(e)&&handleLeave(e);const p=a.roomId;if(!p||"string"!=typeof p)return void e.send(JSON.stringify({type:"error",message:"roomId required"}));const m=function(e){var n,a;try{const s=r(o(),"data","room3d","room-settings.json"),i=JSON.parse(t(s,"utf-8"));return(null==(a=null==(n=null==i?void 0:i.rooms)?void 0:n[e])?void 0:a.password)||""}catch{return""}}(p);if(m){if(("string"==typeof a.password?a.password:"")!==m)return void e.send(JSON.stringify({type:"error",code:"PASSWORD_REQUIRED",message:"Room requires a password"}))}const f=n(4).toString("hex"),u="string"==typeof a.displayName&&a.displayName.trim()?a.displayName.trim().slice(0,20):"Guest_"+f.slice(0,4),y="string"==typeof a.characterModel&&a.characterModel.trim()?a.characterModel.trim():"",g=function(e,o,t,r=""){let n=s.get(o);if(n||(n=new Map,s.set(o,n)),n.size>=8)return{success:!1,error:"Room full (max 8 players)"};const a={peerId:e,displayName:t,roomId:o,characterModel:r,position:{x:0,y:0,z:0},rotationY:0,animation:"idle",color:getRandomColor(n),lastUpdate:Date.now()};return n.set(e,a),i.set(e,o),{success:!0,player:a,existingPlayers:[...n.values()].filter(o=>o.peerId!==e)}}(f,p,u,y);if(!g.success)return void e.send(JSON.stringify({type:"error",message:g.error}));a.position&&g.success&&updatePlayer(f,a.position,a.rotationY||0,"idle");d.set(e,{peerId:f,roomId:p,seq:0}),c.set(f,e),l.has(p)||l.set(p,new Set);l.get(p).add(e),e.send(JSON.stringify({type:"init",peerId:f,players:g.existingPlayers.map(serializePlayer)})),broadcastToRoom(p,e,{type:"player:joined",player:serializePlayer(g.player)}),console.log(`[Room3D-WS] ${u} (${f}) joined room ${p}`)}(e,p);break;case"move":!function(e,o){const t=d.get(e);if(!t)return;const{position:r,rotationY:n,animation:a}=o;if(!r||"number"!=typeof n||!a)return;const s=updatePlayer(t.peerId,r,n,a);if(!s)return;t.seq++,broadcastToRoom(s,e,{type:"player:moved",peerId:t.peerId,position:r,rotationY:n,animation:a,seq:t.seq})}(e,p);break;case"leave":handleLeave(e);break;case"room:state-changed":!function(e){const o=d.get(e);if(!o)return;broadcastToRoom(o.roomId,e,{type:"room:state-changed"})}(e);break;case"object:placed":case"object:deleted":case"object:moved":!function(e,o){const t=d.get(e);if(!t)return;broadcastToRoom(t.roomId,e,o)}(e,p);break;case"tv:changed":!function(e,o){var t;const r=d.get(e);if(!r)return;if(!o.tvId||"string"!=typeof o.tvId)return;broadcastToRoom(r.roomId,e,{type:"tv:changed",peerId:r.peerId,tvId:o.tvId,channelUrl:null!=(t=o.channelUrl)?t:null})}(e,p);break;case"voice:offer":case"voice:answer":case"voice:ice":!function(e,o){const t=d.get(e);if(!t)return;const r=o.target;if(!r||"string"!=typeof r)return;const n=c.get(r);if(!n)return;try{n.send(JSON.stringify({type:o.type,from:t.peerId,sdp:o.sdp,candidate:o.candidate}))}catch{}}(e,p);break;case"voice:state":!function(e,o){const t=d.get(e);if(!t)return;broadcastToRoom(t.roomId,e,{type:"voice:state",peerId:t.peerId,muted:!!o.muted,speaking:!!o.speaking})}(e,p);break;case"voice:relay":!function(e,o){var t;const r=d.get(e);if(!r)return;if(!m.has(r.peerId)){m.add(r.peerId);const e=l.get(r.roomId);console.log(`[Room3D-WS] Voice relay from ${r.peerId.slice(0,6)} in room ${r.roomId} â€” broadcasting to ${(null!=(t=null==e?void 0:e.size)?t:1)-1} peer(s)`)}broadcastToRoom(r.roomId,e,{type:"voice:relay",from:r.peerId,audio:o.audio,sr:o.sr})}(e,p);break;default:e.send(JSON.stringify({type:"error",message:"Unknown message type"}))}},close(e){handleLeave(e)},error(e,o){handleLeave(e),console.error("[Room3D-WS] Error:",o.message)}});function handleLeave(e){const o=d.get(e);if(!o)return;const t=l.get(o.roomId);t&&(t.delete(e),0===t.size&&l.delete(o.roomId));const r=leaveRoom(o.peerId);d.delete(e),c.delete(o.peerId),r&&(broadcastToRoom(r,e,{type:"player:left",peerId:o.peerId}),console.log(`[Room3D-WS] ${o.peerId} left room ${r}`))}const m=new Set;function broadcastToRoom(e,o,t){const r=l.get(e);if(!r)return;const n=JSON.stringify(t);for(const e of r)if(e!==o)try{e.send(n)}catch(e){console.warn("[Room3D-WS] Send failed:",e.message)}}function serializePlayer(e){return{peerId:e.peerId,displayName:e.displayName,characterModel:e.characterModel,position:e.position,rotationY:e.rotationY,animation:e.animation,color:e.color}}setInterval(()=>{var e;const o=function(){const e=Date.now(),o=[];for(const[t,r]of i){const n=s.get(r),a=null==n?void 0:n.get(t);(!a||e-a.lastUpdate>12e4)&&o.push(t)}return o}();for(const t of o){const o=c.get(t);if(o){handleLeave(o);try{null==(e=o.close)||e.call(o)}catch{}}else{const e=leaveRoom(t);e&&broadcastToRoom(e,null,{type:"player:left",peerId:t}),console.log(`[Room3D-WS] Removed stale player ${t} (no peer ref)`)}}},3e4);export{p as default};
