import{d as t,p as o,c as a,b as e,n as s,q as i,j as p,i as n}from"../../nitro/nitro.mjs";import{createReadStream as m}from"fs";import{stat as r}from"fs/promises";import{normalize as d,resolve as f,join as c,extname as g}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:url";const l=["appdata/models","appdata/images","appdata/sound","appdata/video","appdata/fonts","appdata/defaults","appdata/display-images","room3d/display-images","room3d/fonts","room3d/models","cache/models","uploads"],u={".glb":"model/gltf-binary",".gltf":"model/gltf+json",".bin":"application/octet-stream",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".webp":"image/webp",".gif":"image/gif",".svg":"image/svg+xml",".ico":"image/x-icon",".avif":"image/avif",".exr":"application/octet-stream",".hdr":"application/octet-stream",".ktx2":"image/ktx2",".mp3":"audio/mpeg",".ogg":"audio/ogg",".wav":"audio/wav",".m4a":"audio/mp4",".woff2":"font/woff2",".woff":"font/woff",".ttf":"font/ttf",".otf":"font/otf",".eot":"application/vnd.ms-fontobject",".json":"application/json",".pdf":"application/pdf",".mp4":"video/mp4",".webm":"video/webm"},h=t(async t=>{const h=decodeURIComponent(o(t).pathname),b="/data/";if(!h.startsWith(b))throw a({statusCode:400,statusMessage:"Invalid path"});const w=h.slice(6);if(!w||w.includes("..")||w.includes("\\"))throw a({statusCode:400,statusMessage:"Invalid path"});const C=d(w).replace(/\\/g,"/");if(!l.some(t=>C.startsWith(t+"/")||C===t))throw a({statusCode:403,statusMessage:"Access denied"});const v=e(),y=f(c(v,"data",C)),j=f(c(v,"data"));if(!y.startsWith(j+"/"))throw a({statusCode:403,statusMessage:"Access denied"});let x;try{x=await r(y)}catch{throw a({statusCode:404,statusMessage:"Not found"})}if(!x.isFile())throw a({statusCode:404,statusMessage:"Not found"});const M=g(y).toLowerCase(),I=u[M]||"application/octet-stream",R=x.size;s(t,"Content-Type",I),s(t,"Cache-Control","public, max-age=31536000, immutable"),s(t,"Accept-Ranges","bytes");const $=i(t,"range");if($){const o=$.match(/bytes=(\d*)-(\d*)/);if(o){const a=o[1]?parseInt(o[1],10):0,e=o[2]?parseInt(o[2],10):R-1;return a>=R||e>=R||a>e?(p(t,416),s(t,"Content-Range",`bytes */${R}`),""):(p(t,206),s(t,"Content-Range",`bytes ${a}-${e}/${R}`),s(t,"Content-Length",e-a+1),n(t,m(y,{start:a,end:e})))}}return s(t,"Content-Length",R),n(t,m(y))});export{h as default};
