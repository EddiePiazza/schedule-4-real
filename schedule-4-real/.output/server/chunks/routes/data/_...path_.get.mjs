import{d as t,g as o,c as a,b as e,n as s,p as i,j as p,i as n}from"../../nitro/nitro.mjs";import{createReadStream as m}from"fs";import{stat as r}from"fs/promises";import{normalize as d,resolve as f,join as g,extname as c}from"path";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:url";const l=["appdata/models","appdata/images","appdata/sound","appdata/video","appdata/fonts","appdata/defaults","appdata/display-images","room3d/display-images","room3d/fonts","room3d/models","cache/models","uploads"],u={".glb":"model/gltf-binary",".gltf":"model/gltf+json",".bin":"application/octet-stream",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".webp":"image/webp",".gif":"image/gif",".svg":"image/svg+xml",".ico":"image/x-icon",".avif":"image/avif",".exr":"application/octet-stream",".hdr":"application/octet-stream",".ktx2":"image/ktx2",".mp3":"audio/mpeg",".ogg":"audio/ogg",".wav":"audio/wav",".m4a":"audio/mp4",".woff2":"font/woff2",".woff":"font/woff",".ttf":"font/ttf",".otf":"font/otf",".eot":"application/vnd.ms-fontobject",".json":"application/json",".pdf":"application/pdf",".mp4":"video/mp4",".webm":"video/webm"},h=t(async t=>{const h=o(t,"path")||"",b=decodeURIComponent(h);if(!b||b.includes("..")||b.includes("\\"))throw a({statusCode:400,statusMessage:"Invalid path"});const w=d(b).replace(/\\/g,"/");if(!l.some(t=>w.startsWith(t+"/")||w===t))throw a({statusCode:403,statusMessage:"Access denied"});const C=e(),v=f(g(C,"data",w)),y=f(g(C,"data"));if(!v.startsWith(y+"/"))throw a({statusCode:403,statusMessage:"Access denied"});let j;try{j=await r(v)}catch{throw a({statusCode:404,statusMessage:"Not found"})}if(!j.isFile())throw a({statusCode:404,statusMessage:"Not found"});const x=c(v).toLowerCase(),M=u[x]||"application/octet-stream",I=j.size;s(t,"Content-Type",M),s(t,"Cache-Control","public, max-age=31536000, immutable"),s(t,"Accept-Ranges","bytes");const R=i(t,"range");if(R){const o=R.match(/bytes=(\d*)-(\d*)/);if(o){const a=o[1]?parseInt(o[1],10):0,e=o[2]?parseInt(o[2],10):I-1;return a>=I||e>=I||a>e?(p(t,416),s(t,"Content-Range",`bytes */${I}`),""):(p(t,206),s(t,"Content-Range",`bytes ${a}-${e}/${I}`),s(t,"Content-Length",e-a+1),n(t,m(v,{start:a,end:e})))}}return s(t,"Content-Length",I),n(t,m(v))});export{h as default};
