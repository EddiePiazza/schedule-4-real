import{o as e}from"../nitro/nitro.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";const t=new Map,o=new Map,r=e({open(e){},message(e,r){let n,i=null;if("string"!=typeof r){const e=r.rawData;Buffer.isBuffer(e)?i=e:(e instanceof Uint8Array||e instanceof ArrayBuffer)&&(i=Buffer.from(e))}if(i&&i.length>0)!function(e,r){const n=t.get(e);if(!n)return;const i=o.get(n.roomId);if(!i||i.size<=1)return;const s=Buffer.from(n.peerId,"utf-8"),p=Buffer.allocUnsafe(1+s.length+r.length);p[0]=s.length,s.copy(p,1),r.copy(p,1+s.length);for(const t of i)if(t!==e)try{t.send(p)}catch{}}(e,i);else{try{n=JSON.parse("string"==typeof r?r:r.text())}catch{return}switch(n.type){case"join":!function(e,r){t.has(e)&&handleVoiceLeave(e);const n=r.peerId,i=r.roomId;if(!n||"string"!=typeof n||!i||"string"!=typeof i)return;t.set(e,{peerId:n,roomId:i}),o.has(i)||o.set(i,new Set);o.get(i).add(e),e.send(JSON.stringify({type:"joined"}));const s=o.get(i),p=JSON.stringify({type:"peer-joined",peerId:n});for(const t of s)if(t!==e)try{t.send(p)}catch{}console.log(`[Voice-WS] ${n.slice(0,8)} joined voice in room ${i} (${s.size} peers)`)}(e,n);break;case"leave":handleVoiceLeave(e)}}},close(e){handleVoiceLeave(e)},error(e,t){handleVoiceLeave(e),console.error("[Voice-WS] Error:",t.message)}});function handleVoiceLeave(e){const r=t.get(e);if(!r)return;const n=o.get(r.roomId);if(n)if(n.delete(e),0===n.size)o.delete(r.roomId);else{const e=JSON.stringify({type:"peer-left",peerId:r.peerId});for(const t of n)try{t.send(e)}catch{}}t.delete(e),console.log(`[Voice-WS] ${r.peerId.slice(0,8)} left voice in room ${r.roomId}`)}export{r as default};
