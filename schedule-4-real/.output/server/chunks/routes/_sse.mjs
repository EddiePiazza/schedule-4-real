import{d as e,s as t}from"../nitro/nitro.mjs";import{p as o,m as n}from"../_/mqtt.mjs";import"node:http";import"node:https";import"node:crypto";import"stream";import"events";import"http";import"crypto";import"buffer";import"zlib";import"https";import"net";import"tls";import"url";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"fs";import"path";import"fs/promises";import"node:url";import"mqtt";import"child_process";const r=e(e=>{t(e,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive","X-Accel-Buffering":"no"}),o();const r=new ReadableStream({start(t){const o=new TextEncoder;function send(e){try{const n=JSON.stringify(e);t.enqueue(o.encode(`data: ${n}\n\n`))}catch{cleanup()}}function onSensor(e){send({type:"sensor",data:e})}function onOutlet(e){send({type:"outlet",data:e})}function onLight(e){send({type:"light",data:e})}function onSoil(e){send({type:"soil",data:e})}function onMqttRaw(e){send({type:"mqtt-raw",data:e})}function onDevice(e){send({type:"device",data:e})}function onBlower(e){send({type:"blower",data:e})}function onUpdateProgress(e){send({type:"update-progress",data:e})}function cleanup(){n.off("sensor",onSensor),n.off("outlet",onOutlet),n.off("light",onLight),n.off("soil",onSoil),n.off("mqtt-raw",onMqttRaw),n.off("device",onDevice),n.off("blower",onBlower),n.off("update-progress",onUpdateProgress)}n.on("sensor",onSensor),n.on("outlet",onOutlet),n.on("light",onLight),n.on("soil",onSoil),n.on("mqtt-raw",onMqttRaw),n.on("device",onDevice),n.on("blower",onBlower),n.on("update-progress",onUpdateProgress),t.enqueue(o.encode(": connected\n\n"));const r=setInterval(()=>{try{t.enqueue(o.encode(": keepalive\n\n"))}catch{clearInterval(r),cleanup()}},3e4);e.node.req.on("close",()=>{clearInterval(r),cleanup()})}});return new Response(r,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})});export{r as default};
